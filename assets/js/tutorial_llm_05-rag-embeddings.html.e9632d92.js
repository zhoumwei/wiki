"use strict";(self.webpackChunkmy_vuepress_site=self.webpackChunkmy_vuepress_site||[]).push([[556],{425:(n,s,a)=>{a.r(s),a.d(s,{comp:()=>b,data:()=>g});var e=a(641);const p=a.p+"assets/img/rag-paper.b797a52d.png",t=a.p+"assets/img/gpt-llama2.d6e4a2df.png",l=a.p+"assets/img/vector.7fde6caf.png",i=a.p+"assets/img/sbert.365694fc.png",o=a.p+"assets/img/sim.0eb5dac2.png",c=a.p+"assets/img/vectordb.eadce668.png",u=a.p+"assets/img/mteb.310f65d1.png",r=a.p+"assets/img/sbert-rerank.baa66dab.png",d=a.p+"assets/img/rag-fusion.73fc0ca7.jpeg",k=a.p+"assets/img/table_rag.a178033d.png",m=a.p+"assets/img/GraphRAG.af4e955f.png",v={},b=(0,a(6262).A)(v,[["render",function(n,s){return(0,e.uX)(),(0,e.CE)("div",null,[...s[0]||(s[0]=[(0,e.Fv)('<h1 id="_05-rag-embeddings-index" tabindex="-1"><a class="header-anchor" href="#_05-rag-embeddings-index"><span>05 Rag Embeddings Index</span></a></h1><h2 id="ğŸ’¡-è¿™èŠ‚è¯¾ä¼šå¸¦ç»™ä½ " tabindex="-1"><a class="header-anchor" href="#ğŸ’¡-è¿™èŠ‚è¯¾ä¼šå¸¦ç»™ä½ "><span>ğŸ’¡ è¿™èŠ‚è¯¾ä¼šå¸¦ç»™ä½ </span></a></h2><ol><li>å¦‚ä½•ç”¨ä½ çš„å‚åŸŸæ•°æ®è¡¥å…… LLM çš„èƒ½åŠ›</li><li>å¦‚ä½•æ„å»ºä½ çš„å‚åŸŸï¼ˆå‘é‡ï¼‰çŸ¥è¯†åº“</li><li>æ­å»ºä¸€å¥—å®Œæ•´ RAG ç³»ç»Ÿéœ€è¦å“ªäº›æ¨¡å—</li><li>æ­å»º RAG ç³»ç»Ÿæ—¶æ›´å¤šçš„æœ‰ç”¨æŠ€å·§</li></ol><p>å¼€å§‹ä¸Šè¯¾ï¼</p><h2 id="ğŸ“-è¿™èŠ‚è¯¾æ€ä¹ˆå­¦" tabindex="-1"><a class="header-anchor" href="#ğŸ“-è¿™èŠ‚è¯¾æ€ä¹ˆå­¦"><span>ğŸ“ è¿™èŠ‚è¯¾æ€ä¹ˆå­¦</span></a></h2><p>ä»£ç èƒ½åŠ›è¦æ±‚ï¼š<strong>ä¸­</strong>ï¼ŒAI/æ•°å­¦åŸºç¡€è¦æ±‚ï¼š<strong>ä½</strong></p><ol><li>æœ‰ç¼–ç¨‹åŸºç¡€çš„åŒå­¦ <ul><li>å…³æ³¨æŠ€æœ¯åŸç†å’Œæ–‡æœ¬å¤„ç†ä¸­å¸¸è§çš„é—®é¢˜ä¸æŠ€å·§</li></ul></li><li>æ²¡æœ‰ç¼–ç¨‹åŸºç¡€çš„åŒå­¦ <ul><li>å…³æ³¨å®è§‚åŸç†å’Œæ€è·¯</li><li><strong>æ€è·¯æ›´é‡è¦ï¼Œä»£ç åªæ˜¯å®ç°æƒ³æ³•çš„å·¥å…·</strong></li></ul></li></ol><h2 id="ä¸€ã€æ¾„æ¸…ä¸€ä¸ªæ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€æ¾„æ¸…ä¸€ä¸ªæ¦‚å¿µ"><span>ä¸€ã€æ¾„æ¸…ä¸€ä¸ªæ¦‚å¿µ</span></a></h2><p>RAG <strong>ä¸è¦</strong> å‚è€ƒä¸‹é¢è¿™å¼ å›¾ï¼ï¼ï¼</p><p><img src="'+p+'" alt="image"></p><p>è¿™å¼ å›¾æºè‡ªä¸€ä¸ª<a href="https://arxiv.org/pdf/2005.11401.pdf" target="_blank" rel="noopener noreferrer">ç ”ç©¶å·¥ä½œ</a></p><ul><li>æ­¤è®ºæ–‡ç¬¬ä¸€æ¬¡æå‡º RAG è¿™ä¸ªå«æ³•</li><li>åœ¨ç ”ç©¶ä¸­ï¼Œä½œè€…å°è¯•å°†æ£€ç´¢å’Œç”Ÿæˆåšåœ¨ä¸€ä¸ªæ¨¡å‹ä½“ç³»ä¸­</li></ul><p><strong>ä½†æ˜¯ï¼Œå®é™…ç”Ÿäº§ä¸­ï¼ŒRAG ä¸æ˜¯è¿™ä¹ˆåšçš„ï¼ï¼ï¼</strong></p><h2 id="äºŒã€ä»€ä¹ˆæ˜¯æ£€ç´¢å¢å¼ºçš„ç”Ÿæˆæ¨¡å‹-rag" tabindex="-1"><a class="header-anchor" href="#äºŒã€ä»€ä¹ˆæ˜¯æ£€ç´¢å¢å¼ºçš„ç”Ÿæˆæ¨¡å‹-rag"><span>äºŒã€ä»€ä¹ˆæ˜¯æ£€ç´¢å¢å¼ºçš„ç”Ÿæˆæ¨¡å‹ï¼ˆRAGï¼‰</span></a></h2><h3 id="_2-1ã€llm-å›ºæœ‰çš„å±€é™æ€§" tabindex="-1"><a class="header-anchor" href="#_2-1ã€llm-å›ºæœ‰çš„å±€é™æ€§"><span>2.1ã€LLM å›ºæœ‰çš„å±€é™æ€§</span></a></h3><ol><li>LLM çš„çŸ¥è¯†ä¸æ˜¯å®æ—¶çš„</li><li>LLM å¯èƒ½ä¸çŸ¥é“ä½ ç§æœ‰çš„é¢†åŸŸ/ä¸šåŠ¡çŸ¥è¯†</li></ol><p><img src="'+t+'" alt="image"></p><h3 id="_2-2ã€æ£€ç´¢å¢å¼ºç”Ÿæˆ" tabindex="-1"><a class="header-anchor" href="#_2-2ã€æ£€ç´¢å¢å¼ºç”Ÿæˆ"><span>2.2ã€æ£€ç´¢å¢å¼ºç”Ÿæˆ</span></a></h3><p>RAGï¼ˆRetrieval Augmented Generationï¼‰é¡¾åæ€ä¹‰ï¼Œé€šè¿‡<strong>æ£€ç´¢</strong>çš„æ–¹æ³•æ¥å¢å¼º<strong>ç”Ÿæˆæ¨¡å‹</strong>çš„èƒ½åŠ›ã€‚</p><p><video src="/wiki/tutorial/llm/assets/05-rag-embeddings/RAG.mp4" controls="controls" width="800px" style="margin-left:0px;"></video></p><blockquote><p>âœ… <strong>Tip:</strong> ç±»æ¯”ï¼šä½ å¯ä»¥æŠŠè¿™ä¸ªè¿‡ç¨‹æƒ³è±¡æˆå¼€å·è€ƒè¯•ã€‚è®© LLM å…ˆç¿»ä¹¦ï¼Œå†å›ç­”é—®é¢˜ã€‚</p></blockquote><h2 id="ä¸‰ã€rag-ç³»ç»Ÿçš„åŸºæœ¬æ­å»ºæµç¨‹" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€rag-ç³»ç»Ÿçš„åŸºæœ¬æ­å»ºæµç¨‹"><span>ä¸‰ã€RAG ç³»ç»Ÿçš„åŸºæœ¬æ­å»ºæµç¨‹</span></a></h2><p>å…ˆçœ‹æ•ˆæœï¼šhttp://localhost:9999/</p><p>æ­å»ºè¿‡ç¨‹ï¼š</p><ol><li>æ–‡æ¡£åŠ è½½ï¼Œå¹¶æŒ‰ä¸€å®šæ¡ä»¶<strong>åˆ‡å‰²</strong>æˆç‰‡æ®µ</li><li>å°†åˆ‡å‰²çš„æ–‡æœ¬ç‰‡æ®µçŒå…¥<strong>æ£€ç´¢å¼•æ“</strong></li><li>å°è£…<strong>æ£€ç´¢æ¥å£</strong></li><li>æ„å»º<strong>è°ƒç”¨æµç¨‹</strong>ï¼šQuery -&gt; æ£€ç´¢ -&gt; Prompt -&gt; LLM -&gt; å›å¤</li></ol><h3 id="_3-1ã€æ–‡æ¡£çš„åŠ è½½ä¸åˆ‡å‰²" tabindex="-1"><a class="header-anchor" href="#_3-1ã€æ–‡æ¡£çš„åŠ è½½ä¸åˆ‡å‰²"><span>3.1ã€æ–‡æ¡£çš„åŠ è½½ä¸åˆ‡å‰²</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># !pip install --upgrade openai</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># å®‰è£… pdf è§£æåº“</span></span>\n<span class="line"><span class="token comment"># !pip install pdfminer.six</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> pdfminer<span class="token punctuation">.</span>high_level <span class="token keyword">import</span> extract_pages</span>\n<span class="line"><span class="token keyword">from</span> pdfminer<span class="token punctuation">.</span>layout <span class="token keyword">import</span> LTTextContainer</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">extract_text_from_pdf</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> page_numbers<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> min_line_length<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token triple-quoted-string string">&#39;&#39;&#39;ä» PDF æ–‡ä»¶ä¸­ï¼ˆæŒ‰æŒ‡å®šé¡µç ï¼‰æå–æ–‡å­—&#39;&#39;&#39;</span></span>\n<span class="line">    paragraphs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>\n<span class="line">    <span class="token builtin">buffer</span> <span class="token operator">=</span> <span class="token string">&#39;&#39;</span></span>\n<span class="line">    full_text <span class="token operator">=</span> <span class="token string">&#39;&#39;</span></span>\n<span class="line">    <span class="token comment"># æå–å…¨éƒ¨æ–‡æœ¬</span></span>\n<span class="line">    <span class="token keyword">for</span> i<span class="token punctuation">,</span> page_layout <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>extract_pages<span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">        <span class="token comment"># å¦‚æœæŒ‡å®šäº†é¡µç èŒƒå›´ï¼Œè·³è¿‡èŒƒå›´å¤–çš„é¡µ</span></span>\n<span class="line">        <span class="token keyword">if</span> page_numbers <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> i <span class="token keyword">not</span> <span class="token keyword">in</span> page_numbers<span class="token punctuation">:</span></span>\n<span class="line">            <span class="token keyword">continue</span></span>\n<span class="line">        <span class="token keyword">for</span> element <span class="token keyword">in</span> page_layout<span class="token punctuation">:</span></span>\n<span class="line">            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> LTTextContainer<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">                full_text <span class="token operator">+=</span> element<span class="token punctuation">.</span>get_text<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;\\n&#39;</span></span>\n<span class="line">    <span class="token comment"># æŒ‰ç©ºè¡Œåˆ†éš”ï¼Œå°†æ–‡æœ¬é‡æ–°ç»„ç»‡æˆæ®µè½</span></span>\n<span class="line">    lines <span class="token operator">=</span> full_text<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&#39;\\n&#39;</span><span class="token punctuation">)</span></span>\n<span class="line">    <span class="token keyword">for</span> text <span class="token keyword">in</span> lines<span class="token punctuation">:</span></span>\n<span class="line">        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> min_line_length<span class="token punctuation">:</span></span>\n<span class="line">            <span class="token builtin">buffer</span> <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token string">&#39; &#39;</span><span class="token operator">+</span>text<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> text<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">&#39;-&#39;</span><span class="token punctuation">)</span> <span class="token keyword">else</span> text<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">&#39;-&#39;</span><span class="token punctuation">)</span></span>\n<span class="line">        <span class="token keyword">elif</span> <span class="token builtin">buffer</span><span class="token punctuation">:</span></span>\n<span class="line">            paragraphs<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">buffer</span><span class="token punctuation">)</span></span>\n<span class="line">            <span class="token builtin">buffer</span> <span class="token operator">=</span> <span class="token string">&#39;&#39;</span></span>\n<span class="line">    <span class="token keyword">if</span> <span class="token builtin">buffer</span><span class="token punctuation">:</span></span>\n<span class="line">        paragraphs<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">buffer</span><span class="token punctuation">)</span></span>\n<span class="line">    <span class="token keyword">return</span> paragraphs</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">paragraphs <span class="token operator">=</span> extract_text_from_pdf<span class="token punctuation">(</span><span class="token string">&quot;llama2.pdf&quot;</span><span class="token punctuation">,</span> min_line_length<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">for</span> para <span class="token keyword">in</span> paragraphs<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span>para<span class="token operator">+</span><span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">Llama 2: Open Foundation and Fine-Tuned Chat Models</span>\n<span class="line"></span>\n<span class="line"> Hugo Touvronâˆ— Louis Martinâ€  Kevin Stoneâ€  Peter Albert Amjad Almahairi Yasmine Babaei Nikolay Bashlykov Soumya Batra Prajjwal Bhargava Shruti Bhosale Dan Bikel Lukas Blecher Cristian Canton Ferrer Moya Chen Guillem Cucurull David Esiobu Jude Fernandes Jeremy Fu Wenyin Fu Brian Fuller Cynthia Gao Vedanuj Goswami Naman Goyal Anthony Hartshorn Saghar Hosseini Rui Hou Hakan Inan Marcin Kardas Viktor Kerkez Madian Khabsa Isabel Kloumann Artem Korenev Punit Singh Koura Marie-Anne Lachaux Thibaut Lavril Jenya Lee Diana Liskovich Yinghai Lu Yuning Mao Xavier Martinet Todor Mihaylov Pushkar Mishra Igor Molybog Yixin Nie Andrew Poulton Jeremy Reizenstein Rashi Rungta Kalyan Saladi Alan Schelten Ruan Silva Eric Michael Smith Ranjan Subramanian Xiaoqing Ellen Tan Binh Tang Ross Taylor Adina Williams Jian Xiang Kuan Puxin Xu Zheng Yan Iliyan Zarov Yuchen Zhang Angela Fan Melanie Kambadur Sharan Narang Aurelien Rodriguez Robert Stojnic Sergey Edunov Thomas Scialomâˆ—</span>\n<span class="line"></span>\n<span class="line"> GenAI, Meta</span>\n<span class="line"></span>\n<span class="line"> In this work, we develop and release Llama 2, a collection of pretrained and ï¬ne-tuned large language models (LLMs) ranging in scale from 7 billion to 70 billion parameters. Our ï¬ne-tuned LLMs, called Llama 2-Chat, are optimized for dialogue use cases. Our models outperform open-source chat models on most benchmarks we tested, and based onour human evaluations for helpfulness and safety, may be a suitable substitute for closed source models. We provide a detailed description of our approach to ï¬ne-tuning and safety improvements of Llama 2-Chat in order to enable the community to build on our work and contribute to the responsible development of LLMs.</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2ã€æ£€ç´¢å¼•æ“" tabindex="-1"><a class="header-anchor" href="#_3-2ã€æ£€ç´¢å¼•æ“"><span>3.2ã€æ£€ç´¢å¼•æ“</span></a></h3><p>å…ˆçœ‹ä¸€ä¸ªæœ€åŸºç¡€çš„å®ç°</p><h3 id="å®‰è£…-es-å®¢æˆ·ç«¯" tabindex="-1"><a class="header-anchor" href="#å®‰è£…-es-å®¢æˆ·ç«¯"><span>å®‰è£… ES å®¢æˆ·ç«¯</span></a></h3><blockquote><p>âœ… <strong>Tip:</strong> ä¸ºäº†å®éªŒå®¤æ€§èƒ½ ä»¥ä¸‹å®‰è£…åŒ…å·²ç»å†…ç½®å®éªŒå¹³å°</p></blockquote><p>#!pip install elasticsearch7</p><h3 id="å®‰è£…-nltk-æ–‡æœ¬å¤„ç†æ–¹æ³•åº“" tabindex="-1"><a class="header-anchor" href="#å®‰è£…-nltk-æ–‡æœ¬å¤„ç†æ–¹æ³•åº“"><span>å®‰è£… NLTKï¼ˆæ–‡æœ¬å¤„ç†æ–¹æ³•åº“ï¼‰</span></a></h3><p>#!pip install nltk</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> elasticsearch7 <span class="token keyword">import</span> Elasticsearch<span class="token punctuation">,</span> helpers</span>\n<span class="line"><span class="token keyword">from</span> nltk<span class="token punctuation">.</span>stem <span class="token keyword">import</span> PorterStemmer</span>\n<span class="line"><span class="token keyword">from</span> nltk<span class="token punctuation">.</span>tokenize <span class="token keyword">import</span> word_tokenize</span>\n<span class="line"><span class="token keyword">from</span> nltk<span class="token punctuation">.</span>corpus <span class="token keyword">import</span> stopwords</span>\n<span class="line"><span class="token keyword">import</span> nltk</span>\n<span class="line"><span class="token keyword">import</span> re</span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">import</span> warnings</span>\n<span class="line">warnings<span class="token punctuation">.</span>simplefilter<span class="token punctuation">(</span><span class="token string">&quot;ignore&quot;</span><span class="token punctuation">)</span>  <span class="token comment"># å±è”½ ES çš„ä¸€äº›Warnings</span></span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># å®éªŒå®¤å¹³å°å·²ç»å†…ç½®</span></span>\n<span class="line">nltk<span class="token punctuation">.</span>download<span class="token punctuation">(</span><span class="token string">&#39;punkt&#39;</span><span class="token punctuation">)</span>  <span class="token comment"># è‹±æ–‡åˆ‡è¯ã€è¯æ ¹ã€åˆ‡å¥ç­‰æ–¹æ³•</span></span>\n<span class="line">nltk<span class="token punctuation">.</span>download<span class="token punctuation">(</span><span class="token string">&#39;stopwords&#39;</span><span class="token punctuation">)</span>  <span class="token comment"># è‹±æ–‡åœç”¨è¯åº“</span></span>\n<span class="line">nltk<span class="token punctuation">.</span>download<span class="token punctuation">(</span><span class="token string">&#39;punkt_tab&#39;</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">[nltk_data] Downloading package punkt to /home/jovyan/nltk_data...</span>\n<span class="line">[nltk_data]   Package punkt is already up-to-date!</span>\n<span class="line">[nltk_data] Downloading package stopwords to /home/jovyan/nltk_data...</span>\n<span class="line">[nltk_data]   Package stopwords is already up-to-date!</span>\n<span class="line">[nltk_data] Downloading package punkt_tab to /home/jovyan/nltk_data...</span>\n<span class="line">[nltk_data]   Package punkt_tab is already up-to-date!</span>\n<span class="line">True</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">to_keywords</span><span class="token punctuation">(</span>input_string<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token triple-quoted-string string">&#39;&#39;&#39;ï¼ˆè‹±æ–‡ï¼‰æ–‡æœ¬åªä¿ç•™å…³é”®å­—&#39;&#39;&#39;</span></span>\n<span class="line">    <span class="token comment"># ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ›¿æ¢æ‰€æœ‰éå­—æ¯æ•°å­—çš„å­—ç¬¦ä¸ºç©ºæ ¼</span></span>\n<span class="line">    no_symbols <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r&#39;[^a-zA-Z0-9\\s]&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">,</span> input_string<span class="token punctuation">)</span></span>\n<span class="line">    word_tokens <span class="token operator">=</span> word_tokenize<span class="token punctuation">(</span>no_symbols<span class="token punctuation">)</span></span>\n<span class="line">    <span class="token comment"># åŠ è½½åœç”¨è¯è¡¨</span></span>\n<span class="line">    stop_words <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span>stopwords<span class="token punctuation">.</span>words<span class="token punctuation">(</span><span class="token string">&#39;english&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line">    ps <span class="token operator">=</span> PorterStemmer<span class="token punctuation">(</span><span class="token punctuation">)</span></span>\n<span class="line">    <span class="token comment"># å»åœç”¨è¯ï¼Œå–è¯æ ¹</span></span>\n<span class="line">    filtered_sentence <span class="token operator">=</span> <span class="token punctuation">[</span>ps<span class="token punctuation">.</span>stem<span class="token punctuation">(</span>w<span class="token punctuation">)</span></span>\n<span class="line">                         <span class="token keyword">for</span> w <span class="token keyword">in</span> word_tokens <span class="token keyword">if</span> <span class="token keyword">not</span> w<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> stop_words<span class="token punctuation">]</span></span>\n<span class="line">    <span class="token keyword">return</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>filtered_sentence<span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>â„¹ï¸ <strong>Info:</strong> æ­¤å¤„ to_keywords ä¸ºé’ˆå¯¹è‹±æ–‡çš„å®ç°ï¼Œé’ˆå¯¹ä¸­æ–‡çš„å®ç°è¯·å‚è€ƒ chinese_utils.py</p></blockquote><p>å°†æ–‡æœ¬çŒå…¥æ£€ç´¢å¼•æ“</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> os<span class="token punctuation">,</span> time</span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># å¼•å…¥é…ç½®æ–‡ä»¶</span></span>\n<span class="line">ELASTICSEARCH_BASE_URL <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">&#39;ELASTICSEARCH_BASE_URL&#39;</span><span class="token punctuation">)</span></span>\n<span class="line">ELASTICSEARCH_PASSWORD <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">&#39;ELASTICSEARCH_PASSWORD&#39;</span><span class="token punctuation">)</span></span>\n<span class="line">ELASTICSEARCH_NAME<span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">&#39;ELASTICSEARCH_NAME&#39;</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># tips: å¦‚æœæƒ³åœ¨æœ¬åœ°è¿è¡Œï¼Œè¯·åœ¨ä¸‹é¢ä¸€è¡Œ print(ELASTICSEARCH_BASE_URL) è·å–çœŸå®çš„é…ç½®</span></span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># 1. åˆ›å»ºElasticsearchè¿æ¥</span></span>\n<span class="line">es <span class="token operator">=</span> Elasticsearch<span class="token punctuation">(</span></span>\n<span class="line">    hosts<span class="token operator">=</span><span class="token punctuation">[</span>ELASTICSEARCH_BASE_URL<span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># æœåŠ¡åœ°å€ä¸ç«¯å£</span></span>\n<span class="line">    http_auth<span class="token operator">=</span><span class="token punctuation">(</span>ELASTICSEARCH_NAME<span class="token punctuation">,</span> ELASTICSEARCH_PASSWORD<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># ç”¨æˆ·åï¼Œå¯†ç </span></span>\n<span class="line"><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># 2. å®šä¹‰ç´¢å¼•åç§°</span></span>\n<span class="line">index_name <span class="token operator">=</span> <span class="token string">&quot;teacher_demo_index111&quot;</span></span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># 3. å¦‚æœç´¢å¼•å·²å­˜åœ¨ï¼Œåˆ é™¤å®ƒï¼ˆä»…ä¾›æ¼”ç¤ºï¼Œå®é™…åº”ç”¨æ—¶ä¸éœ€è¦è¿™æ­¥ï¼‰</span></span>\n<span class="line"><span class="token keyword">if</span> es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>index<span class="token operator">=</span>index_name<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">    es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>index<span class="token operator">=</span>index_name<span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># 4. åˆ›å»ºç´¢å¼•</span></span>\n<span class="line">es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>create<span class="token punctuation">(</span>index<span class="token operator">=</span>index_name<span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># 5. çŒåº“æŒ‡ä»¤</span></span>\n<span class="line">actions <span class="token operator">=</span> <span class="token punctuation">[</span></span>\n<span class="line">    <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token string">&quot;_index&quot;</span><span class="token punctuation">:</span> index_name<span class="token punctuation">,</span></span>\n<span class="line">        <span class="token string">&quot;_source&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token string">&quot;keywords&quot;</span><span class="token punctuation">:</span> to_keywords<span class="token punctuation">(</span>para<span class="token punctuation">)</span><span class="token punctuation">,</span></span>\n<span class="line">            <span class="token string">&quot;text&quot;</span><span class="token punctuation">:</span> para</span>\n<span class="line">        <span class="token punctuation">}</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line">    <span class="token keyword">for</span> para <span class="token keyword">in</span> paragraphs</span>\n<span class="line"><span class="token punctuation">]</span></span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># 6. æ–‡æœ¬çŒåº“</span></span>\n<span class="line">helpers<span class="token punctuation">.</span>bulk<span class="token punctuation">(</span>es<span class="token punctuation">,</span> actions<span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># çŒåº“æ˜¯å¼‚æ­¥çš„</span></span>\n<span class="line">time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®ç°å…³é”®å­—æ£€ç´¢</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">search</span><span class="token punctuation">(</span>query_string<span class="token punctuation">,</span> top_n<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token comment"># ES çš„æŸ¥è¯¢è¯­è¨€</span></span>\n<span class="line">    search_query <span class="token operator">=</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token string">&quot;match&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token string">&quot;keywords&quot;</span><span class="token punctuation">:</span> to_keywords<span class="token punctuation">(</span>query_string<span class="token punctuation">)</span></span>\n<span class="line">        <span class="token punctuation">}</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line">    res <span class="token operator">=</span> es<span class="token punctuation">.</span>search<span class="token punctuation">(</span>index<span class="token operator">=</span>index_name<span class="token punctuation">,</span> query<span class="token operator">=</span>search_query<span class="token punctuation">,</span> size<span class="token operator">=</span>top_n<span class="token punctuation">)</span></span>\n<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">[</span>hit<span class="token punctuation">[</span><span class="token string">&quot;_source&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">]</span> <span class="token keyword">for</span> hit <span class="token keyword">in</span> res<span class="token punctuation">[</span><span class="token string">&quot;hits&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;hits&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">results <span class="token operator">=</span> search<span class="token punctuation">(</span><span class="token string">&quot;how many parameters does llama 2 have?&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></span>\n<span class="line"><span class="token keyword">for</span> r <span class="token keyword">in</span> results<span class="token punctuation">:</span></span>\n<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token operator">+</span><span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">1. Llama 2, an updated version of Llama 1, trained on a new mix of publicly available data. We also increased the size of the pretraining corpus by 40%, doubled the context length of the model, and adopted grouped-query attention (Ainslie et al., 2023). We are releasing variants of Llama 2 with 7B, 13B, and 70B parameters. We have also trained 34B variants, which we report on in this paper but are not releasing.Â§</span>\n<span class="line"></span>\n<span class="line"> In this work, we develop and release Llama 2, a collection of pretrained and ï¬ne-tuned large language models (LLMs) ranging in scale from 7 billion to 70 billion parameters. Our ï¬ne-tuned LLMs, called Llama 2-Chat, are optimized for dialogue use cases. Our models outperform open-source chat models on most benchmarks we tested, and based onour human evaluations for helpfulness and safety, may be a suitable substitute for closed source models. We provide a detailed description of our approach to ï¬ne-tuning and safety improvements of Llama 2-Chat in order to enable the community to build on our work and contribute to the responsible development of LLMs.</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3ã€llm-æ¥å£å°è£…" tabindex="-1"><a class="header-anchor" href="#_3-3ã€llm-æ¥å£å°è£…"><span>3.3ã€LLM æ¥å£å°è£…</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> openai <span class="token keyword">import</span> OpenAI</span>\n<span class="line"><span class="token keyword">import</span> os</span>\n<span class="line"><span class="token comment"># åŠ è½½ç¯å¢ƒå˜é‡</span></span>\n<span class="line"><span class="token keyword">from</span> dotenv <span class="token keyword">import</span> load_dotenv<span class="token punctuation">,</span> find_dotenv</span>\n<span class="line">_ <span class="token operator">=</span> load_dotenv<span class="token punctuation">(</span>find_dotenv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># è¯»å–æœ¬åœ° .env æ–‡ä»¶ï¼Œé‡Œé¢å®šä¹‰äº† OPENAI_API_KEY</span></span>\n<span class="line"></span>\n<span class="line">client <span class="token operator">=</span> OpenAI<span class="token punctuation">(</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">get_completion</span><span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> model<span class="token operator">=</span><span class="token string">&quot;gpt-3.5-turbo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token triple-quoted-string string">&#39;&#39;&#39;å°è£… openai æ¥å£&#39;&#39;&#39;</span></span>\n<span class="line">    messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;role&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">:</span> prompt<span class="token punctuation">}</span><span class="token punctuation">]</span></span>\n<span class="line">    response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span></span>\n<span class="line">        model<span class="token operator">=</span>model<span class="token punctuation">,</span></span>\n<span class="line">        messages<span class="token operator">=</span>messages<span class="token punctuation">,</span></span>\n<span class="line">        temperature<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>  <span class="token comment"># æ¨¡å‹è¾“å‡ºçš„éšæœºæ€§ï¼Œ0 è¡¨ç¤ºéšæœºæ€§æœ€å°</span></span>\n<span class="line">    <span class="token punctuation">)</span></span>\n<span class="line">    <span class="token keyword">return</span> response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>content</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-4ã€prompt-æ¨¡æ¿" tabindex="-1"><a class="header-anchor" href="#_3-4ã€prompt-æ¨¡æ¿"><span>3.4ã€Prompt æ¨¡æ¿</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">build_prompt</span><span class="token punctuation">(</span>prompt_template<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token triple-quoted-string string">&#39;&#39;&#39;å°† Prompt æ¨¡æ¿èµ‹å€¼&#39;&#39;&#39;</span></span>\n<span class="line">    inputs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>\n<span class="line">    <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> kwargs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">all</span><span class="token punctuation">(</span><span class="token builtin">isinstance</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token keyword">for</span> elem <span class="token keyword">in</span> v<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">            val <span class="token operator">=</span> <span class="token string">&#39;\\n\\n&#39;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>v<span class="token punctuation">)</span></span>\n<span class="line">        <span class="token keyword">else</span><span class="token punctuation">:</span></span>\n<span class="line">            val <span class="token operator">=</span> v</span>\n<span class="line">        inputs<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> val</span>\n<span class="line">    <span class="token keyword">return</span> prompt_template<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token operator">**</span>inputs<span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">prompt_template <span class="token operator">=</span> <span class="token triple-quoted-string string">&quot;&quot;&quot;</span>\n<span class="line">ä½ æ˜¯ä¸€ä¸ªé—®ç­”æœºå™¨äººã€‚</span>\n<span class="line">ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ä¸‹è¿°ç»™å®šçš„å·²çŸ¥ä¿¡æ¯å›ç­”ç”¨æˆ·é—®é¢˜ã€‚</span>\n<span class="line"></span>\n<span class="line">å·²çŸ¥ä¿¡æ¯:</span>\n<span class="line">{context}</span>\n<span class="line"></span>\n<span class="line">ç”¨æˆ·é—®ï¼š</span>\n<span class="line">{query}</span>\n<span class="line"></span>\n<span class="line">å¦‚æœå·²çŸ¥ä¿¡æ¯ä¸åŒ…å«ç”¨æˆ·é—®é¢˜çš„ç­”æ¡ˆï¼Œæˆ–è€…å·²çŸ¥ä¿¡æ¯ä¸è¶³ä»¥å›ç­”ç”¨æˆ·çš„é—®é¢˜ï¼Œè¯·ç›´æ¥å›å¤&quot;æˆ‘æ— æ³•å›ç­”æ‚¨çš„é—®é¢˜&quot;ã€‚</span>\n<span class="line">è¯·ä¸è¦è¾“å‡ºå·²çŸ¥ä¿¡æ¯ä¸­ä¸åŒ…å«çš„ä¿¡æ¯æˆ–ç­”æ¡ˆã€‚</span>\n<span class="line">è¯·ç”¨ä¸­æ–‡å›ç­”ç”¨æˆ·é—®é¢˜ã€‚</span>\n<span class="line">&quot;&quot;&quot;</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-5ã€rag-pipeline-åˆæ¢" tabindex="-1"><a class="header-anchor" href="#_3-5ã€rag-pipeline-åˆæ¢"><span>3.5ã€RAG Pipeline åˆæ¢</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">user_query <span class="token operator">=</span> <span class="token string">&quot;how many parameters does llama 2 have?&quot;</span></span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># 1. æ£€ç´¢</span></span>\n<span class="line">search_results <span class="token operator">=</span> search<span class="token punctuation">(</span>user_query<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># 2. æ„å»º Prompt</span></span>\n<span class="line">prompt <span class="token operator">=</span> build_prompt<span class="token punctuation">(</span>prompt_template<span class="token punctuation">,</span> context<span class="token operator">=</span>search_results<span class="token punctuation">,</span> query<span class="token operator">=</span>user_query<span class="token punctuation">)</span></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;===Prompt===&quot;</span><span class="token punctuation">)</span></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>prompt<span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># 3. è°ƒç”¨ LLM</span></span>\n<span class="line">response <span class="token operator">=</span> get_completion<span class="token punctuation">(</span>prompt<span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;===å›å¤===&quot;</span><span class="token punctuation">)</span></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">===Prompt===</span>\n<span class="line"></span>\n<span class="line">ä½ æ˜¯ä¸€ä¸ªé—®ç­”æœºå™¨äººã€‚</span>\n<span class="line">ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ä¸‹è¿°ç»™å®šçš„å·²çŸ¥ä¿¡æ¯å›ç­”ç”¨æˆ·é—®é¢˜ã€‚</span>\n<span class="line"></span>\n<span class="line">å·²çŸ¥ä¿¡æ¯:</span>\n<span class="line"> 1. Llama 2, an updated version of Llama 1, trained on a new mix of publicly available data. We also increased the size of the pretraining corpus by 40%, doubled the context length of the model, and adopted grouped-query attention (Ainslie et al., 2023). We are releasing variants of Llama 2 with 7B, 13B, and 70B parameters. We have also trained 34B variants, which we report on in this paper but are not releasing.Â§</span>\n<span class="line"></span>\n<span class="line"> In this work, we develop and release Llama 2, a collection of pretrained and ï¬ne-tuned large language models (LLMs) ranging in scale from 7 billion to 70 billion parameters. Our ï¬ne-tuned LLMs, called Llama 2-Chat, are optimized for dialogue use cases. Our models outperform open-source chat models on most benchmarks we tested, and based onour human evaluations for helpfulness and safety, may be a suitable substitute for closed source models. We provide a detailed description of our approach to ï¬ne-tuning and safety improvements of Llama 2-Chat in order to enable the community to build on our work and contribute to the responsible development of LLMs.</span>\n<span class="line"></span>\n<span class="line">ç”¨æˆ·é—®ï¼š</span>\n<span class="line">how many parameters does llama 2 have?</span>\n<span class="line"></span>\n<span class="line">å¦‚æœå·²çŸ¥ä¿¡æ¯ä¸åŒ…å«ç”¨æˆ·é—®é¢˜çš„ç­”æ¡ˆï¼Œæˆ–è€…å·²çŸ¥ä¿¡æ¯ä¸è¶³ä»¥å›ç­”ç”¨æˆ·çš„é—®é¢˜ï¼Œè¯·ç›´æ¥å›å¤&quot;æˆ‘æ— æ³•å›ç­”æ‚¨çš„é—®é¢˜&quot;ã€‚</span>\n<span class="line">è¯·ä¸è¦è¾“å‡ºå·²çŸ¥ä¿¡æ¯ä¸­ä¸åŒ…å«çš„ä¿¡æ¯æˆ–ç­”æ¡ˆã€‚</span>\n<span class="line">è¯·ç”¨ä¸­æ–‡å›ç­”ç”¨æˆ·é—®é¢˜ã€‚</span>\n<span class="line"></span>\n<span class="line">===å›å¤===</span>\n<span class="line">Llama 2æœ‰7B, 13Bå’Œ70Bå‚æ•°ã€‚</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>â„¹ï¸ <strong>Info:</strong> æ‰©å±•é˜…è¯»ï¼š</p></blockquote><p>Elasticsearchï¼ˆç®€ç§°ESï¼‰æ˜¯ä¸€ä¸ªå¹¿æ³›åº”ç”¨çš„å¼€æºæœç´¢å¼•æ“: https://www.elastic.co/ å…³äºESçš„å®‰è£…ã€éƒ¨ç½²ç­‰çŸ¥è¯†ï¼Œç½‘ä¸Šå¯ä»¥æ‰¾åˆ°å¤§é‡èµ„æ–™ï¼Œä¾‹å¦‚: https://juejin.cn/post/7104875268166123528 å…³äºç»å…¸ä¿¡æ¯æ£€ç´¢æŠ€æœ¯çš„æ›´å¤šç»†èŠ‚ï¼Œå¯ä»¥å‚è€ƒ: https://nlp.stanford.edu/IR-book/information-retrieval-book.html</p><h3 id="_3-6ã€å…³é”®å­—æ£€ç´¢çš„å±€é™æ€§" tabindex="-1"><a class="header-anchor" href="#_3-6ã€å…³é”®å­—æ£€ç´¢çš„å±€é™æ€§"><span>3.6ã€å…³é”®å­—æ£€ç´¢çš„å±€é™æ€§</span></a></h3><p>åŒä¸€ä¸ªè¯­ä¹‰ï¼Œç”¨è¯ä¸åŒï¼Œå¯èƒ½å¯¼è‡´æ£€ç´¢ä¸åˆ°æœ‰æ•ˆçš„ç»“æœ</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># user_query=&quot;Does llama 2 have a chat version?&quot;</span></span>\n<span class="line">user_query <span class="token operator">=</span> <span class="token string">&quot;Does llama 2 have a conversational variant?&quot;</span></span>\n<span class="line"></span>\n<span class="line">search_results <span class="token operator">=</span> search<span class="token punctuation">(</span>user_query<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">for</span> res <span class="token keyword">in</span> search_results<span class="token punctuation">:</span></span>\n<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token operator">+</span><span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">1. Llama 2, an updated version of Llama 1, trained on a new mix of publicly available data. We also increased the size of the pretraining corpus by 40%, doubled the context length of the model, and adopted grouped-query attention (Ainslie et al., 2023). We are releasing variants of Llama 2 with 7B, 13B, and 70B parameters. We have also trained 34B variants, which we report on in this paper but are not releasing.Â§</span>\n<span class="line"></span>\n<span class="line"> variants of this model with 7B, 13B, and 70B parameters as well.</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="å››ã€å‘é‡æ£€ç´¢" tabindex="-1"><a class="header-anchor" href="#å››ã€å‘é‡æ£€ç´¢"><span>å››ã€å‘é‡æ£€ç´¢</span></a></h2><h3 id="_4-1ã€ä»€ä¹ˆæ˜¯å‘é‡" tabindex="-1"><a class="header-anchor" href="#_4-1ã€ä»€ä¹ˆæ˜¯å‘é‡"><span>4.1ã€ä»€ä¹ˆæ˜¯å‘é‡</span></a></h3><p>å‘é‡æ˜¯ä¸€ç§æœ‰å¤§å°å’Œæ–¹å‘çš„æ•°å­¦å¯¹è±¡ã€‚å®ƒå¯ä»¥è¡¨ç¤ºä¸ºä»ä¸€ä¸ªç‚¹åˆ°å¦ä¸€ä¸ªç‚¹çš„æœ‰å‘çº¿æ®µã€‚ä¾‹å¦‚ï¼ŒäºŒç»´ç©ºé—´ä¸­çš„å‘é‡å¯ä»¥è¡¨ç¤ºä¸º $(x,y)$ï¼Œè¡¨ç¤ºä»åŸç‚¹ $(0,0)$ åˆ°ç‚¹ $(x,y)$ çš„æœ‰å‘çº¿æ®µã€‚ <br><img src="'+l+'" alt="image"><br> ä»¥æ­¤ç±»æ¨ï¼Œæˆ‘å¯ä»¥ç”¨ä¸€ç»„åæ ‡ $(x_0, x_1, \\ldots, x_{N-1})$ è¡¨ç¤ºä¸€ä¸ª $N$ ç»´ç©ºé—´ä¸­çš„å‘é‡ï¼Œ$N$ å«å‘é‡çš„ç»´åº¦ã€‚</p><h3 id="_4-1-1ã€æ–‡æœ¬å‘é‡-text-embeddings" tabindex="-1"><a class="header-anchor" href="#_4-1-1ã€æ–‡æœ¬å‘é‡-text-embeddings"><span>4.1.1ã€æ–‡æœ¬å‘é‡ï¼ˆText Embeddingsï¼‰</span></a></h3><ol><li>å°†æ–‡æœ¬è½¬æˆä¸€ç»„ $N$ ç»´æµ®ç‚¹æ•°ï¼Œå³<strong>æ–‡æœ¬å‘é‡</strong>åˆå« Embeddings</li><li>å‘é‡ä¹‹é—´å¯ä»¥è®¡ç®—è·ç¦»ï¼Œè·ç¦»è¿œè¿‘å¯¹åº”<strong>è¯­ä¹‰ç›¸ä¼¼åº¦</strong>å¤§å°</li></ol><br> ![image](./assets/05-rag-embeddings/embeddings.png) <br><h3 id="_4-1-2ã€æ–‡æœ¬å‘é‡æ˜¯æ€ä¹ˆå¾—åˆ°çš„-é€‰" tabindex="-1"><a class="header-anchor" href="#_4-1-2ã€æ–‡æœ¬å‘é‡æ˜¯æ€ä¹ˆå¾—åˆ°çš„-é€‰"><span>4.1.2ã€æ–‡æœ¬å‘é‡æ˜¯æ€ä¹ˆå¾—åˆ°çš„ï¼ˆé€‰ï¼‰</span></a></h3><ol><li>æ„å»ºç›¸å…³ï¼ˆæ­£ç«‹ï¼‰ä¸ä¸ç›¸å…³ï¼ˆè´Ÿä¾‹ï¼‰çš„å¥å­å¯¹å„¿æ ·æœ¬</li><li>è®­ç»ƒåŒå¡”å¼æ¨¡å‹ï¼Œè®©æ­£ä¾‹é—´çš„è·ç¦»å°ï¼Œè´Ÿä¾‹é—´çš„è·ç¦»å¤§</li></ol><p>ä¾‹å¦‚ï¼š</p><p><img src="'+i+'" alt="image"></p><blockquote><p>â„¹ï¸ <strong>Info:</strong> æ‰©å±•é˜…è¯»ï¼šhttps://www.sbert.net</p></blockquote><h3 id="_4-2ã€å‘é‡é—´çš„ç›¸ä¼¼åº¦è®¡ç®—" tabindex="-1"><a class="header-anchor" href="#_4-2ã€å‘é‡é—´çš„ç›¸ä¼¼åº¦è®¡ç®—"><span>4.2ã€å‘é‡é—´çš„ç›¸ä¼¼åº¦è®¡ç®—</span></a></h3><p><img src="'+o+'" alt="image"></p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np</span>\n<span class="line"><span class="token keyword">from</span> numpy <span class="token keyword">import</span> dot</span>\n<span class="line"><span class="token keyword">from</span> numpy<span class="token punctuation">.</span>linalg <span class="token keyword">import</span> norm</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">cos_sim</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token triple-quoted-string string">&#39;&#39;&#39;ä½™å¼¦è·ç¦» -- è¶Šå¤§è¶Šç›¸ä¼¼&#39;&#39;&#39;</span></span>\n<span class="line">    <span class="token keyword">return</span> dot<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>norm<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token operator">*</span>norm<span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">def</span> <span class="token function">l2</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token triple-quoted-string string">&#39;&#39;&#39;æ¬§æ°è·ç¦» -- è¶Šå°è¶Šç›¸ä¼¼&#39;&#39;&#39;</span></span>\n<span class="line">    x <span class="token operator">=</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token operator">-</span>np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>b<span class="token punctuation">)</span></span>\n<span class="line">    <span class="token keyword">return</span> norm<span class="token punctuation">(</span>x<span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">get_embeddings</span><span class="token punctuation">(</span>texts<span class="token punctuation">,</span> model<span class="token operator">=</span><span class="token string">&quot;text-embedding-ada-002&quot;</span><span class="token punctuation">,</span> dimensions<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token triple-quoted-string string">&#39;&#39;&#39;å°è£… OpenAI çš„ Embedding æ¨¡å‹æ¥å£&#39;&#39;&#39;</span></span>\n<span class="line">    <span class="token keyword">if</span> model <span class="token operator">==</span> <span class="token string">&quot;text-embedding-ada-002&quot;</span><span class="token punctuation">:</span></span>\n<span class="line">        dimensions <span class="token operator">=</span> <span class="token boolean">None</span></span>\n<span class="line">    <span class="token keyword">if</span> dimensions<span class="token punctuation">:</span></span>\n<span class="line">        data <span class="token operator">=</span> client<span class="token punctuation">.</span>embeddings<span class="token punctuation">.</span>create<span class="token punctuation">(</span></span>\n<span class="line">            <span class="token builtin">input</span><span class="token operator">=</span>texts<span class="token punctuation">,</span> model<span class="token operator">=</span>model<span class="token punctuation">,</span> dimensions<span class="token operator">=</span>dimensions<span class="token punctuation">)</span><span class="token punctuation">.</span>data</span>\n<span class="line">    <span class="token keyword">else</span><span class="token punctuation">:</span></span>\n<span class="line">        data <span class="token operator">=</span> client<span class="token punctuation">.</span>embeddings<span class="token punctuation">.</span>create<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token operator">=</span>texts<span class="token punctuation">,</span> model<span class="token operator">=</span>model<span class="token punctuation">)</span><span class="token punctuation">.</span>data</span>\n<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">[</span>x<span class="token punctuation">.</span>embedding <span class="token keyword">for</span> x <span class="token keyword">in</span> data<span class="token punctuation">]</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">test_query <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;æµ‹è¯•æ–‡æœ¬&quot;</span><span class="token punctuation">]</span></span>\n<span class="line">vec <span class="token operator">=</span> get_embeddings<span class="token punctuation">(</span>test_query<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Total dimension: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>vec<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;First 10 elements: </span><span class="token interpolation"><span class="token punctuation">{</span>vec<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token format-spec">10]</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">Total dimension: 1536</span>\n<span class="line">First 10 elements: [-0.007280634716153145, -0.006147929932922125, -0.010664181783795357, 0.001484171487390995, -0.010678750462830067, 0.029253656044602394, -0.01976952701807022, 0.005444996990263462, -0.01687038503587246, -0.01207733154296875]</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># query = &quot;å›½é™…äº‰ç«¯&quot;</span></span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># ä¸”èƒ½æ”¯æŒè·¨è¯­è¨€</span></span>\n<span class="line">query <span class="token operator">=</span> <span class="token string">&quot;global conflicts&quot;</span></span>\n<span class="line"></span>\n<span class="line">documents <span class="token operator">=</span> <span class="token punctuation">[</span></span>\n<span class="line">    <span class="token string">&quot;è”åˆå›½å°±è‹ä¸¹è¾¾å°”å¯Œå°”åœ°åŒºå¤§è§„æ¨¡æš´åŠ›äº‹ä»¶å‘å‡ºè­¦å‘Š&quot;</span><span class="token punctuation">,</span></span>\n<span class="line">    <span class="token string">&quot;åœŸè€³å…¶ã€èŠ¬å…°ã€ç‘å…¸ä¸åŒ—çº¦ä»£è¡¨å°†ç»§ç»­å°±ç‘å…¸â€œå…¥çº¦â€é—®é¢˜è¿›è¡Œè°ˆåˆ¤&quot;</span><span class="token punctuation">,</span></span>\n<span class="line">    <span class="token string">&quot;æ—¥æœ¬å²é˜œå¸‚é™†ä¸Šè‡ªå«é˜Ÿå°„å‡»åœºå†…å‘ç”Ÿæªå‡»äº‹ä»¶ 3äººå—ä¼¤&quot;</span><span class="token punctuation">,</span></span>\n<span class="line">    <span class="token string">&quot;å›½å®¶æ¸¸æ³³ä¸­å¿ƒï¼ˆæ°´ç«‹æ–¹ï¼‰ï¼šæ¢å¤æ¸¸æ³³ã€å¬‰æ°´ä¹å›­ç­‰æ°´ä¸Šé¡¹ç›®è¿è¥&quot;</span><span class="token punctuation">,</span></span>\n<span class="line">    <span class="token string">&quot;æˆ‘å›½é¦–æ¬¡åœ¨ç©ºé—´ç«™å¼€å±•èˆ±å¤–è¾å°„ç”Ÿç‰©å­¦æš´éœ²å®éªŒ&quot;</span><span class="token punctuation">,</span></span>\n<span class="line"><span class="token punctuation">]</span></span>\n<span class="line"></span>\n<span class="line">query_vec <span class="token operator">=</span> get_embeddings<span class="token punctuation">(</span><span class="token punctuation">[</span>query<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>\n<span class="line">doc_vecs <span class="token operator">=</span> get_embeddings<span class="token punctuation">(</span>documents<span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Queryä¸è‡ªå·±çš„ä½™å¼¦è·ç¦»: {:.2f}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>cos_sim<span class="token punctuation">(</span>query_vec<span class="token punctuation">,</span> query_vec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Queryä¸Documentsçš„ä½™å¼¦è·ç¦»:&quot;</span><span class="token punctuation">)</span></span>\n<span class="line"><span class="token keyword">for</span> vec <span class="token keyword">in</span> doc_vecs<span class="token punctuation">:</span></span>\n<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span>cos_sim<span class="token punctuation">(</span>query_vec<span class="token punctuation">,</span> vec<span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Queryä¸è‡ªå·±çš„æ¬§æ°è·ç¦»: {:.2f}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>l2<span class="token punctuation">(</span>query_vec<span class="token punctuation">,</span> query_vec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Queryä¸Documentsçš„æ¬§æ°è·ç¦»:&quot;</span><span class="token punctuation">)</span></span>\n<span class="line"><span class="token keyword">for</span> vec <span class="token keyword">in</span> doc_vecs<span class="token punctuation">:</span></span>\n<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span>l2<span class="token punctuation">(</span>query_vec<span class="token punctuation">,</span> vec<span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">Queryä¸è‡ªå·±çš„ä½™å¼¦è·ç¦»: 1.00</span>\n<span class="line">Queryä¸Documentsçš„ä½™å¼¦è·ç¦»:</span>\n<span class="line">0.7622749944010915</span>\n<span class="line">0.7563038106493584</span>\n<span class="line">0.7426665802579038</span>\n<span class="line">0.7079273699608006</span>\n<span class="line">0.7254355321045072</span>\n<span class="line"></span>\n<span class="line">Queryä¸è‡ªå·±çš„æ¬§æ°è·ç¦»: 0.00</span>\n<span class="line">Queryä¸Documentsçš„æ¬§æ°è·ç¦»:</span>\n<span class="line">0.6895288502682277</span>\n<span class="line">0.6981349637998769</span>\n<span class="line">0.7174028746492277</span>\n<span class="line">0.7642939833636829</span>\n<span class="line">0.7410323668625171</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3ã€å‘é‡æ•°æ®åº“" tabindex="-1"><a class="header-anchor" href="#_4-3ã€å‘é‡æ•°æ®åº“"><span>4.3ã€å‘é‡æ•°æ®åº“</span></a></h3><p>å‘é‡æ•°æ®åº“ï¼Œæ˜¯ä¸“é—¨ä¸ºå‘é‡æ£€ç´¢è®¾è®¡çš„ä¸­é—´ä»¶</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># !pip install chromadb</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># ç”±äºå­¦ç”Ÿç«¯ä¸æ•™å¸ˆç«¯ç¯å¢ƒçš„åŒºåˆ«</span></span>\n<span class="line"><span class="token comment"># å¯¹pysqliteçš„å…¼å®¹å¤„ç†</span></span>\n<span class="line"><span class="token keyword">import</span> os</span>\n<span class="line"><span class="token keyword">if</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;CUR_ENV_IS_STUDENT&#39;</span><span class="token punctuation">,</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token keyword">import</span> sys</span>\n<span class="line">    <span class="token builtin">__import__</span><span class="token punctuation">(</span><span class="token string">&#39;pysqlite3&#39;</span><span class="token punctuation">)</span></span>\n<span class="line">    sys<span class="token punctuation">.</span>modules<span class="token punctuation">[</span><span class="token string">&#39;sqlite3&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> sys<span class="token punctuation">.</span>modules<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">&#39;pysqlite3&#39;</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œæˆ‘ä»¬åªå–ä¸¤é¡µï¼ˆç¬¬ä¸€ç« ï¼‰</span></span>\n<span class="line">paragraphs <span class="token operator">=</span> extract_text_from_pdf<span class="token punctuation">(</span></span>\n<span class="line">    <span class="token string">&quot;llama2.pdf&quot;</span><span class="token punctuation">,</span></span>\n<span class="line">    page_numbers<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>\n<span class="line">    min_line_length<span class="token operator">=</span><span class="token number">10</span></span>\n<span class="line"><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> chromadb</span>\n<span class="line"><span class="token keyword">from</span> chromadb<span class="token punctuation">.</span>config <span class="token keyword">import</span> Settings</span>\n<span class="line"></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">class</span> <span class="token class-name">MyVectorDBConnector</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> collection_name<span class="token punctuation">,</span> embedding_fn<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">        chroma_client <span class="token operator">=</span> chromadb<span class="token punctuation">.</span>Client<span class="token punctuation">(</span>Settings<span class="token punctuation">(</span>allow_reset<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">        <span class="token comment"># ä¸ºäº†æ¼”ç¤ºï¼Œå®é™…ä¸éœ€è¦æ¯æ¬¡ reset()</span></span>\n<span class="line">        chroma_client<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">        <span class="token comment"># åˆ›å»ºä¸€ä¸ª collection</span></span>\n<span class="line">        self<span class="token punctuation">.</span>collection <span class="token operator">=</span> chroma_client<span class="token punctuation">.</span>get_or_create_collection<span class="token punctuation">(</span></span>\n<span class="line">            name<span class="token operator">=</span>collection_name<span class="token punctuation">)</span></span>\n<span class="line">        self<span class="token punctuation">.</span>embedding_fn <span class="token operator">=</span> embedding_fn</span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">def</span> <span class="token function">add_documents</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> documents<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">        <span class="token triple-quoted-string string">&#39;&#39;&#39;å‘ collection ä¸­æ·»åŠ æ–‡æ¡£ä¸å‘é‡&#39;&#39;&#39;</span></span>\n<span class="line">        self<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>add<span class="token punctuation">(</span></span>\n<span class="line">            embeddings<span class="token operator">=</span>self<span class="token punctuation">.</span>embedding_fn<span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># æ¯ä¸ªæ–‡æ¡£çš„å‘é‡</span></span>\n<span class="line">            documents<span class="token operator">=</span>documents<span class="token punctuation">,</span>  <span class="token comment"># æ–‡æ¡£çš„åŸæ–‡</span></span>\n<span class="line">            ids<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f&quot;id</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># æ¯ä¸ªæ–‡æ¡£çš„ id</span></span>\n<span class="line">        <span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">def</span> <span class="token function">search</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token punctuation">,</span> top_n<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">        <span class="token triple-quoted-string string">&#39;&#39;&#39;æ£€ç´¢å‘é‡æ•°æ®åº“&#39;&#39;&#39;</span></span>\n<span class="line">        results <span class="token operator">=</span> self<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>query<span class="token punctuation">(</span></span>\n<span class="line">            query_embeddings<span class="token operator">=</span>self<span class="token punctuation">.</span>embedding_fn<span class="token punctuation">(</span><span class="token punctuation">[</span>query<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>\n<span class="line">            n_results<span class="token operator">=</span>top_n</span>\n<span class="line">        <span class="token punctuation">)</span></span>\n<span class="line">        <span class="token keyword">return</span> results</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># åˆ›å»ºä¸€ä¸ªå‘é‡æ•°æ®åº“å¯¹è±¡</span></span>\n<span class="line">vector_db <span class="token operator">=</span> MyVectorDBConnector<span class="token punctuation">(</span><span class="token string">&quot;demo&quot;</span><span class="token punctuation">,</span> get_embeddings<span class="token punctuation">)</span></span>\n<span class="line"><span class="token comment"># å‘å‘é‡æ•°æ®åº“ä¸­æ·»åŠ æ–‡æ¡£</span></span>\n<span class="line">vector_db<span class="token punctuation">.</span>add_documents<span class="token punctuation">(</span>paragraphs<span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">user_query <span class="token operator">=</span> <span class="token string">&quot;Llama 2æœ‰å¤šå°‘å‚æ•°&quot;</span></span>\n<span class="line"><span class="token comment"># user_query = &quot;Does Llama 2 have a conversational variant&quot;</span></span>\n<span class="line">results <span class="token operator">=</span> vector_db<span class="token punctuation">.</span>search<span class="token punctuation">(</span>user_query<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">for</span> para <span class="token keyword">in</span> results<span class="token punctuation">[</span><span class="token string">&#39;documents&#39;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span>para<span class="token operator">+</span><span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">1. Llama 2, an updated version of Llama 1, trained on a new mix of publicly available data. We also increased the size of the pretraining corpus by 40%, doubled the context length of the model, and adopted grouped-query attention (Ainslie et al., 2023). We are releasing variants of Llama 2 with 7B, 13B, and 70B parameters. We have also trained 34B variants, which we report on in this paper but are not releasing.Â§</span>\n<span class="line"></span>\n<span class="line"> In this work, we develop and release Llama 2, a family of pretrained and ï¬ne-tuned LLMs, Llama 2 and Llama 2-Chat, at scales up to 70B parameters. On the series of helpfulness and safety benchmarks we tested, Llama 2-Chat models generally perform better than existing open-source models. They also appear to be on par with some of the closed-source models, at least on the human evaluations we performed (see Figures 1 and 3). We have taken measures to increase the safety of these models, using safety-speciï¬c data annotation and tuning, as well as conducting red-teaming and employing iterative evaluations. Additionally, this paper contributes a thorough description of our ï¬ne-tuning methodology and approach to improving LLM safety. We hope that this openness will enable the community to reproduce ï¬ne-tuned LLMs and continue to improve the safety of those models, paving the way for more responsible development of LLMs. We also share novel observations we made during the development of Llama 2 and Llama 2-Chat, such as the emergence of tool usage and temporal organization of knowledge.</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>âœ… <strong>Tip:</strong> æ¾„æ¸…å‡ ä¸ªå…³é”®æ¦‚å¿µï¼š å‘é‡æ•°æ®åº“çš„æ„ä¹‰æ˜¯å¿«é€Ÿçš„æ£€ç´¢ï¼› å‘é‡æ•°æ®åº“æœ¬èº«ä¸ç”Ÿæˆå‘é‡ï¼Œå‘é‡æ˜¯ç”± Embedding æ¨¡å‹äº§ç”Ÿçš„ï¼› å‘é‡æ•°æ®åº“ä¸ä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“æ˜¯äº’è¡¥çš„ï¼Œä¸æ˜¯æ›¿ä»£å…³ç³»ï¼Œåœ¨å®é™…åº”ç”¨ä¸­æ ¹æ®å®é™…éœ€æ±‚ç»å¸¸åŒæ—¶ä½¿ç”¨ã€‚</p></blockquote><h3 id="_4-3-1ã€å‘é‡æ•°æ®åº“æœåŠ¡" tabindex="-1"><a class="header-anchor" href="#_4-3-1ã€å‘é‡æ•°æ®åº“æœåŠ¡"><span>4.3.1ã€å‘é‡æ•°æ®åº“æœåŠ¡</span></a></h3><p>Server ç«¯</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line">chroma run <span class="token parameter variable">--path</span> /db_path</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Client ç«¯</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> chromadb</span>\n<span class="line">chroma_client <span class="token operator">=</span> chromadb<span class="token punctuation">.</span>HttpClient<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">&#39;localhost&#39;</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8000</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-2ã€ä¸»æµå‘é‡æ•°æ®åº“åŠŸèƒ½å¯¹æ¯”" tabindex="-1"><a class="header-anchor" href="#_4-3-2ã€ä¸»æµå‘é‡æ•°æ®åº“åŠŸèƒ½å¯¹æ¯”"><span>4.3.2ã€ä¸»æµå‘é‡æ•°æ®åº“åŠŸèƒ½å¯¹æ¯”</span></a></h3><p><img src="'+c+'" alt="image"></p><ul><li>FAISS: Meta å¼€æºçš„å‘é‡æ£€ç´¢å¼•æ“ https://github.com/facebookresearch/faiss</li><li>Pinecone: å•†ç”¨å‘é‡æ•°æ®åº“ï¼Œåªæœ‰äº‘æœåŠ¡ https://www.pinecone.io/</li><li>Milvus: å¼€æºå‘é‡æ•°æ®åº“ï¼ŒåŒæ—¶æœ‰äº‘æœåŠ¡ https://milvus.io/</li><li>Weaviate: å¼€æºå‘é‡æ•°æ®åº“ï¼ŒåŒæ—¶æœ‰äº‘æœåŠ¡ https://weaviate.io/</li><li>Qdrant: å¼€æºå‘é‡æ•°æ®åº“ï¼ŒåŒæ—¶æœ‰äº‘æœåŠ¡ https://qdrant.tech/</li><li>PGVector: Postgres çš„å¼€æºå‘é‡æ£€ç´¢å¼•æ“ https://github.com/pgvector/pgvector</li><li>RediSearch: Redis çš„å¼€æºå‘é‡æ£€ç´¢å¼•æ“ https://github.com/RediSearch/RediSearch</li><li>ElasticSearch ä¹Ÿæ”¯æŒå‘é‡æ£€ç´¢ https://www.elastic.co/enterprise-search/vector-search</li></ul><h3 id="_4-4ã€åŸºäºå‘é‡æ£€ç´¢çš„-rag" tabindex="-1"><a class="header-anchor" href="#_4-4ã€åŸºäºå‘é‡æ£€ç´¢çš„-rag"><span>4.4ã€åŸºäºå‘é‡æ£€ç´¢çš„ RAG</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">RAG_Bot</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> vector_db<span class="token punctuation">,</span> llm_api<span class="token punctuation">,</span> n_results<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">        self<span class="token punctuation">.</span>vector_db <span class="token operator">=</span> vector_db</span>\n<span class="line">        self<span class="token punctuation">.</span>llm_api <span class="token operator">=</span> llm_api</span>\n<span class="line">        self<span class="token punctuation">.</span>n_results <span class="token operator">=</span> n_results</span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">def</span> <span class="token function">chat</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_query<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">        <span class="token comment"># 1. æ£€ç´¢</span></span>\n<span class="line">        search_results <span class="token operator">=</span> self<span class="token punctuation">.</span>vector_db<span class="token punctuation">.</span>search<span class="token punctuation">(</span>user_query<span class="token punctuation">,</span> self<span class="token punctuation">.</span>n_results<span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">        <span class="token comment"># 2. æ„å»º Prompt</span></span>\n<span class="line">        prompt <span class="token operator">=</span> build_prompt<span class="token punctuation">(</span></span>\n<span class="line">            prompt_template<span class="token punctuation">,</span> context<span class="token operator">=</span>search_results<span class="token punctuation">[</span><span class="token string">&#39;documents&#39;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> query<span class="token operator">=</span>user_query<span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">        <span class="token comment"># 3. è°ƒç”¨ LLM</span></span>\n<span class="line">        response <span class="token operator">=</span> self<span class="token punctuation">.</span>llm_api<span class="token punctuation">(</span>prompt<span class="token punctuation">)</span></span>\n<span class="line">        <span class="token keyword">return</span> response</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># åˆ›å»ºä¸€ä¸ªRAGæœºå™¨äºº</span></span>\n<span class="line">bot <span class="token operator">=</span> RAG_Bot<span class="token punctuation">(</span></span>\n<span class="line">    vector_db<span class="token punctuation">,</span></span>\n<span class="line">    llm_api<span class="token operator">=</span>get_completion</span>\n<span class="line"><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">user_query <span class="token operator">=</span> <span class="token string">&quot;llama 2æœ‰å¤šå°‘å‚æ•°?&quot;</span></span>\n<span class="line"></span>\n<span class="line">response <span class="token operator">=</span> bot<span class="token punctuation">.</span>chat<span class="token punctuation">(</span>user_query<span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">llama 2æœ‰7B, 13Bå’Œ70Bå‚æ•°ã€‚</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_4-5ã€å¦‚æœæƒ³è¦æ¢ä¸ªå›½äº§æ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#_4-5ã€å¦‚æœæƒ³è¦æ¢ä¸ªå›½äº§æ¨¡å‹"><span>4.5ã€å¦‚æœæƒ³è¦æ¢ä¸ªå›½äº§æ¨¡å‹</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> json</span>\n<span class="line"><span class="token keyword">import</span> requests</span>\n<span class="line"><span class="token keyword">import</span> os</span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># é€šè¿‡é‰´æƒæ¥å£è·å– access token</span></span>\n<span class="line"></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">def</span> <span class="token function">get_access_token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;</span>\n<span class="line">    ä½¿ç”¨ AKï¼ŒSK ç”Ÿæˆé‰´æƒç­¾åï¼ˆAccess Tokenï¼‰</span>\n<span class="line">    :return: access_tokenï¼Œæˆ–æ˜¯None(å¦‚æœé”™è¯¯)</span>\n<span class="line">    &quot;&quot;&quot;</span></span>\n<span class="line">    url <span class="token operator">=</span> <span class="token string">&quot;https://aip.baidubce.com/oauth/2.0/token&quot;</span></span>\n<span class="line">    params <span class="token operator">=</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token string">&quot;grant_type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;client_credentials&quot;</span><span class="token punctuation">,</span></span>\n<span class="line">        <span class="token string">&quot;client_id&quot;</span><span class="token punctuation">:</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">&#39;ERNIE_CLIENT_ID&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>\n<span class="line">        <span class="token string">&quot;client_secret&quot;</span><span class="token punctuation">:</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">&#39;ERNIE_CLIENT_SECRET&#39;</span><span class="token punctuation">)</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> params<span class="token operator">=</span>params<span class="token punctuation">)</span><span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;access_token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># è°ƒç”¨æ–‡å¿ƒåƒå¸† è°ƒç”¨ BGE Embedding æ¥å£</span></span>\n<span class="line"></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">def</span> <span class="token function">get_embeddings_bge</span><span class="token punctuation">(</span>prompts<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">    url <span class="token operator">=</span> <span class="token string">&quot;https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/embeddings/bge_large_en?access_token=&quot;</span> <span class="token operator">+</span> get_access_token<span class="token punctuation">(</span><span class="token punctuation">)</span></span>\n<span class="line">    payload <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span></span>\n<span class="line">        <span class="token string">&quot;input&quot;</span><span class="token punctuation">:</span> prompts</span>\n<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>\n<span class="line">    headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#39;Content-Type&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;application/json&#39;</span><span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>request<span class="token punctuation">(</span></span>\n<span class="line">        <span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> data<span class="token operator">=</span>payload<span class="token punctuation">)</span><span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span></span>\n<span class="line">    data <span class="token operator">=</span> response<span class="token punctuation">[</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">]</span></span>\n<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token string">&quot;embedding&quot;</span><span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> data<span class="token punctuation">]</span></span>\n<span class="line"></span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># è°ƒç”¨æ–‡å¿ƒ4.0å¯¹è¯æ¥å£</span></span>\n<span class="line"><span class="token keyword">def</span> <span class="token function">get_completion_ernie</span><span class="token punctuation">(</span>prompt<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line"></span>\n<span class="line">    url <span class="token operator">=</span> <span class="token string">&quot;https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/completions_pro?access_token=&quot;</span> <span class="token operator">+</span> get_access_token<span class="token punctuation">(</span><span class="token punctuation">)</span></span>\n<span class="line">    payload <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span></span>\n<span class="line">        <span class="token string">&quot;messages&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span></span>\n<span class="line">            <span class="token punctuation">{</span></span>\n<span class="line">                <span class="token string">&quot;role&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span></span>\n<span class="line">                <span class="token string">&quot;content&quot;</span><span class="token punctuation">:</span> prompt</span>\n<span class="line">            <span class="token punctuation">}</span></span>\n<span class="line">        <span class="token punctuation">]</span></span>\n<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">    headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#39;Content-Type&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;application/json&#39;</span><span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>request<span class="token punctuation">(</span></span>\n<span class="line">        <span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> data<span class="token operator">=</span>payload<span class="token punctuation">)</span><span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">return</span> response<span class="token punctuation">[</span><span class="token string">&quot;result&quot;</span><span class="token punctuation">]</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># åˆ›å»ºä¸€ä¸ªå‘é‡æ•°æ®åº“å¯¹è±¡</span></span>\n<span class="line">new_vector_db <span class="token operator">=</span> MyVectorDBConnector<span class="token punctuation">(</span></span>\n<span class="line">    <span class="token string">&quot;demo_ernie&quot;</span><span class="token punctuation">,</span></span>\n<span class="line">    embedding_fn<span class="token operator">=</span>get_embeddings_bge</span>\n<span class="line"><span class="token punctuation">)</span></span>\n<span class="line"><span class="token comment"># å‘å‘é‡æ•°æ®åº“ä¸­æ·»åŠ æ–‡æ¡£</span></span>\n<span class="line">new_vector_db<span class="token punctuation">.</span>add_documents<span class="token punctuation">(</span>paragraphs<span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># åˆ›å»ºä¸€ä¸ªRAGæœºå™¨äºº</span></span>\n<span class="line">new_bot <span class="token operator">=</span> RAG_Bot<span class="token punctuation">(</span></span>\n<span class="line">    new_vector_db<span class="token punctuation">,</span></span>\n<span class="line">    llm_api<span class="token operator">=</span>get_completion_ernie</span>\n<span class="line"><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">user_query <span class="token operator">=</span> <span class="token string">&quot;how many parameters does llama 2 have?&quot;</span></span>\n<span class="line"></span>\n<span class="line">response <span class="token operator">=</span> new_bot<span class="token punctuation">.</span>chat<span class="token punctuation">(</span>user_query<span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">Llama 2å…·æœ‰7Bã€13Bå’Œ70Bå‚æ•°ã€‚</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_4-6ã€openai-æ–°å‘å¸ƒçš„ä¸¤ä¸ª-embedding-æ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#_4-6ã€openai-æ–°å‘å¸ƒçš„ä¸¤ä¸ª-embedding-æ¨¡å‹"><span>4.6ã€OpenAI æ–°å‘å¸ƒçš„ä¸¤ä¸ª Embedding æ¨¡å‹</span></a></h3><p>2024 å¹´ 1 æœˆ 25 æ—¥ï¼ŒOpenAI æ–°å‘å¸ƒäº†ä¸¤ä¸ª Embedding æ¨¡å‹</p><ul><li>text-embedding-3-large</li><li>text-embedding-3-small</li></ul><p>å…¶æœ€å¤§ç‰¹ç‚¹æ˜¯ï¼Œæ”¯æŒè‡ªå®šä¹‰çš„ç¼©çŸ­å‘é‡ç»´åº¦ï¼Œä»è€Œåœ¨å‡ ä¹ä¸å½±å“æœ€ç»ˆæ•ˆæœçš„æƒ…å†µä¸‹é™ä½å‘é‡æ£€ç´¢ä¸ç›¸ä¼¼åº¦è®¡ç®—çš„å¤æ‚åº¦ã€‚</p><p>é€šä¿—çš„è¯´ï¼š<strong>è¶Šå¤§è¶Šå‡†ã€è¶Šå°è¶Šå¿«ã€‚</strong> å®˜æ–¹å…¬å¸ƒçš„è¯„æµ‹ç»“æœ:</p><p><img src="'+u+'" alt="image"></p><p>æ³¨ï¼š<a href="https://huggingface.co/blog/mteb" target="_blank" rel="noopener noreferrer">MTEB</a> æ˜¯ä¸€ä¸ªå¤§è§„æ¨¡å¤šä»»åŠ¡çš„ Embedding æ¨¡å‹å…¬å¼€è¯„æµ‹é›†</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">model <span class="token operator">=</span> <span class="token string">&quot;text-embedding-3-large&quot;</span></span>\n<span class="line">dimensions <span class="token operator">=</span> <span class="token number">128</span></span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># query = &quot;å›½é™…äº‰ç«¯&quot;</span></span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># ä¸”èƒ½æ”¯æŒè·¨è¯­è¨€</span></span>\n<span class="line">query <span class="token operator">=</span> <span class="token string">&quot;global conflicts&quot;</span></span>\n<span class="line"></span>\n<span class="line">documents <span class="token operator">=</span> <span class="token punctuation">[</span></span>\n<span class="line">    <span class="token string">&quot;è”åˆå›½å°±è‹ä¸¹è¾¾å°”å¯Œå°”åœ°åŒºå¤§è§„æ¨¡æš´åŠ›äº‹ä»¶å‘å‡ºè­¦å‘Š&quot;</span><span class="token punctuation">,</span></span>\n<span class="line">    <span class="token string">&quot;åœŸè€³å…¶ã€èŠ¬å…°ã€ç‘å…¸ä¸åŒ—çº¦ä»£è¡¨å°†ç»§ç»­å°±ç‘å…¸â€œå…¥çº¦â€é—®é¢˜è¿›è¡Œè°ˆåˆ¤&quot;</span><span class="token punctuation">,</span></span>\n<span class="line">    <span class="token string">&quot;æ—¥æœ¬å²é˜œå¸‚é™†ä¸Šè‡ªå«é˜Ÿå°„å‡»åœºå†…å‘ç”Ÿæªå‡»äº‹ä»¶ 3äººå—ä¼¤&quot;</span><span class="token punctuation">,</span></span>\n<span class="line">    <span class="token string">&quot;å›½å®¶æ¸¸æ³³ä¸­å¿ƒï¼ˆæ°´ç«‹æ–¹ï¼‰ï¼šæ¢å¤æ¸¸æ³³ã€å¬‰æ°´ä¹å›­ç­‰æ°´ä¸Šé¡¹ç›®è¿è¥&quot;</span><span class="token punctuation">,</span></span>\n<span class="line">    <span class="token string">&quot;æˆ‘å›½é¦–æ¬¡åœ¨ç©ºé—´ç«™å¼€å±•èˆ±å¤–è¾å°„ç”Ÿç‰©å­¦æš´éœ²å®éªŒ&quot;</span><span class="token punctuation">,</span></span>\n<span class="line"><span class="token punctuation">]</span></span>\n<span class="line"></span>\n<span class="line">query_vec <span class="token operator">=</span> get_embeddings<span class="token punctuation">(</span><span class="token punctuation">[</span>query<span class="token punctuation">]</span><span class="token punctuation">,</span> model<span class="token operator">=</span>model<span class="token punctuation">,</span> dimensions<span class="token operator">=</span>dimensions<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>\n<span class="line">doc_vecs <span class="token operator">=</span> get_embeddings<span class="token punctuation">(</span>documents<span class="token punctuation">,</span> model<span class="token operator">=</span>model<span class="token punctuation">,</span> dimensions<span class="token operator">=</span>dimensions<span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;å‘é‡ç»´åº¦: {}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>query_vec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Queryä¸Documentsçš„ä½™å¼¦è·ç¦»:&quot;</span><span class="token punctuation">)</span></span>\n<span class="line"><span class="token keyword">for</span> vec <span class="token keyword">in</span> doc_vecs<span class="token punctuation">:</span></span>\n<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span>cos_sim<span class="token punctuation">(</span>query_vec<span class="token punctuation">,</span> vec<span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Queryä¸Documentsçš„æ¬§æ°è·ç¦»:&quot;</span><span class="token punctuation">)</span></span>\n<span class="line"><span class="token keyword">for</span> vec <span class="token keyword">in</span> doc_vecs<span class="token punctuation">:</span></span>\n<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span>l2<span class="token punctuation">(</span>query_vec<span class="token punctuation">,</span> vec<span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">å‘é‡ç»´åº¦: 128</span>\n<span class="line"></span>\n<span class="line">Queryä¸Documentsçš„ä½™å¼¦è·ç¦»:</span>\n<span class="line">0.3341465461188056</span>\n<span class="line">0.35421753696892283</span>\n<span class="line">0.31378006817856735</span>\n<span class="line">0.21377702309282426</span>\n<span class="line">0.12870207920908178</span>\n<span class="line"></span>\n<span class="line">Queryä¸Documentsçš„æ¬§æ°è·ç¦»:</span>\n<span class="line">1.1539960610822753</span>\n<span class="line">1.136470458688705</span>\n<span class="line">1.1715118547835923</span>\n<span class="line">1.2539720770077676</span>\n<span class="line">1.3200742239193948</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>â„¹ï¸ <strong>Info:</strong> æ‰©å±•é˜…è¯»ï¼šè¿™ç§å¯å˜é•¿åº¦çš„ Embedding æŠ€æœ¯èƒŒåçš„åŸç†å«åš Matryoshka Representation Learning</p></blockquote><h2 id="äº”ã€å®æˆ˜-rag-ç³»ç»Ÿçš„è¿›é˜¶çŸ¥è¯†" tabindex="-1"><a class="header-anchor" href="#äº”ã€å®æˆ˜-rag-ç³»ç»Ÿçš„è¿›é˜¶çŸ¥è¯†"><span>äº”ã€å®æˆ˜ RAG ç³»ç»Ÿçš„è¿›é˜¶çŸ¥è¯†</span></a></h2><h3 id="_5-1ã€æ–‡æœ¬åˆ†å‰²çš„ç²’åº¦" tabindex="-1"><a class="header-anchor" href="#_5-1ã€æ–‡æœ¬åˆ†å‰²çš„ç²’åº¦"><span>5.1ã€æ–‡æœ¬åˆ†å‰²çš„ç²’åº¦</span></a></h3><p><strong>ç¼ºé™·</strong></p><ol><li>ç²’åº¦å¤ªå¤§å¯èƒ½å¯¼è‡´æ£€ç´¢ä¸ç²¾å‡†ï¼Œç²’åº¦å¤ªå°å¯èƒ½å¯¼è‡´ä¿¡æ¯ä¸å…¨é¢</li><li>é—®é¢˜çš„ç­”æ¡ˆå¯èƒ½è·¨è¶Šä¸¤ä¸ªç‰‡æ®µ</li></ol><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># åˆ›å»ºä¸€ä¸ªå‘é‡æ•°æ®åº“å¯¹è±¡</span></span>\n<span class="line">vector_db <span class="token operator">=</span> MyVectorDBConnector<span class="token punctuation">(</span><span class="token string">&quot;demo_text_split&quot;</span><span class="token punctuation">,</span> get_embeddings<span class="token punctuation">)</span></span>\n<span class="line"><span class="token comment"># å‘å‘é‡æ•°æ®åº“ä¸­æ·»åŠ æ–‡æ¡£</span></span>\n<span class="line">vector_db<span class="token punctuation">.</span>add_documents<span class="token punctuation">(</span>paragraphs<span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># åˆ›å»ºä¸€ä¸ªRAGæœºå™¨äºº</span></span>\n<span class="line">bot <span class="token operator">=</span> RAG_Bot<span class="token punctuation">(</span></span>\n<span class="line">    vector_db<span class="token punctuation">,</span></span>\n<span class="line">    llm_api<span class="token operator">=</span>get_completion</span>\n<span class="line"><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># user_query = &quot;llama 2æœ‰å•†ç”¨è®¸å¯åè®®å—&quot;</span></span>\n<span class="line">user_query<span class="token operator">=</span><span class="token string">&quot;llama 2 chatæœ‰å¤šå°‘å‚æ•°&quot;</span></span>\n<span class="line">search_results <span class="token operator">=</span> vector_db<span class="token punctuation">.</span>search<span class="token punctuation">(</span>user_query<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">for</span> doc <span class="token keyword">in</span> search_results<span class="token punctuation">[</span><span class="token string">&#39;documents&#39;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span>doc<span class="token operator">+</span><span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;====å›å¤====&quot;</span><span class="token punctuation">)</span></span>\n<span class="line">bot<span class="token punctuation">.</span>chat<span class="token punctuation">(</span>user_query<span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">In this work, we develop and release Llama 2, a family of pretrained and ï¬ne-tuned LLMs, Llama 2 and Llama 2-Chat, at scales up to 70B parameters. On the series of helpfulness and safety benchmarks we tested, Llama 2-Chat models generally perform better than existing open-source models. They also appear to be on par with some of the closed-source models, at least on the human evaluations we performed (see Figures 1 and 3). We have taken measures to increase the safety of these models, using safety-speciï¬c data annotation and tuning, as well as conducting red-teaming and employing iterative evaluations. Additionally, this paper contributes a thorough description of our ï¬ne-tuning methodology and approach to improving LLM safety. We hope that this openness will enable the community to reproduce ï¬ne-tuned LLMs and continue to improve the safety of those models, paving the way for more responsible development of LLMs. We also share novel observations we made during the development of Llama 2 and Llama 2-Chat, such as the emergence of tool usage and temporal organization of knowledge.</span>\n<span class="line"></span>\n<span class="line"> 2. Llama 2-Chat, a ï¬ne-tuned version of Llama 2 that is optimized for dialogue use cases. We release</span>\n<span class="line"></span>\n<span class="line">====å›å¤====</span>\n<span class="line">&#39;llama 2 chatæœ‰70Bä¸ªå‚æ•°ã€‚&#39;</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">for</span> p <span class="token keyword">in</span> paragraphs<span class="token punctuation">:</span></span>\n<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">Figure 1: Helpfulness human evaluation results for Llama 2-Chat compared to other open-source and closed-source models. Human raters compared model generations on ~4k prompts consisting of both single and multi-turn prompts. The 95% conï¬dence intervals for this evaluation are between 1% and 2%. More details in Section 3.4.2. While reviewing these results, it is important to note that human evaluations can be noisy due to limitations of the prompt set, subjectivity of the review guidelines, subjectivity of individual raters, and the inherent diï¬ƒculty of comparing generations.</span>\n<span class="line"></span>\n<span class="line"> Figure 2: Win-rate % for helpfulness andsafety between commercial-licensed baselines and Llama 2-Chat, according to GPT 4. To complement the human evaluation, we used a more capable model, not subject to our own guidance. Green area indicates our model is better according to GPT-4. To remove ties, we used win/(win + loss). The orders in which the model responses are presented to GPT-4 are randomly swapped to alleviate bias.</span>\n<span class="line"></span>\n<span class="line"> 1 Introduction</span>\n<span class="line"></span>\n<span class="line"> Large Language Models (LLMs) have shown great promise as highly capable AI assistants that excel in complex reasoning tasks requiring expert knowledge across a wide range of ï¬elds, including in specialized domains such as programming and creative writing. They enable interaction with humans through intuitive chat interfaces, which has led to rapid and widespread adoption among the general public.</span>\n<span class="line"></span>\n<span class="line"> The capabilities of LLMs are remarkable considering the seemingly straightforward nature of the training methodology. Auto-regressive transformers are pretrained on an extensive corpus of self-supervised data, followed by alignment with human preferences via techniques such as Reinforcement Learning with Human Feedback (RLHF). Although the training methodology is simple, high computational requirements have limited the development of LLMs to a few players. There have been public releases of pretrained LLMs (such as BLOOM (Scao et al., 2022), LLaMa-1 (Touvron et al., 2023), and Falcon (Penedo et al., 2023)) that match the performance of closed pretrained competitors like GPT-3 (Brown et al., 2020) and Chinchilla (Hoï¬€mann et al., 2022), but none of these models are suitable substitutes for closed â€œproductâ€ LLMs, such as ChatGPT, BARD, and Claude. These closed product LLMs are heavily ï¬ne-tuned to align with human preferences, which greatly enhances their usability and safety. This step can require signiï¬cant costs in compute and human annotation, and is often not transparent or easily reproducible, limiting progress within the community to advance AI alignment research.</span>\n<span class="line"></span>\n<span class="line"> In this work, we develop and release Llama 2, a family of pretrained and ï¬ne-tuned LLMs, Llama 2 and Llama 2-Chat, at scales up to 70B parameters. On the series of helpfulness and safety benchmarks we tested, Llama 2-Chat models generally perform better than existing open-source models. They also appear to be on par with some of the closed-source models, at least on the human evaluations we performed (see Figures 1 and 3). We have taken measures to increase the safety of these models, using safety-speciï¬c data annotation and tuning, as well as conducting red-teaming and employing iterative evaluations. Additionally, this paper contributes a thorough description of our ï¬ne-tuning methodology and approach to improving LLM safety. We hope that this openness will enable the community to reproduce ï¬ne-tuned LLMs and continue to improve the safety of those models, paving the way for more responsible development of LLMs. We also share novel observations we made during the development of Llama 2 and Llama 2-Chat, such as the emergence of tool usage and temporal organization of knowledge.</span>\n<span class="line"></span>\n<span class="line">Figure 3: Safety human evaluation results for Llama 2-Chat compared to other open-source and closed source models. Human raters judged model generations for safety violations across ~2,000 adversarial prompts consisting of both single and multi-turn prompts. More details can be found in Section 4.4. It is important to caveat these safety results with the inherent bias of LLM evaluations due to limitations of the prompt set, subjectivity of the review guidelines, and subjectivity of individual raters. Additionally, these safety evaluations are performed using content standards that are likely to be biased towards the Llama 2-Chat models.</span>\n<span class="line"></span>\n<span class="line"> We are releasing the following models to the general public for research and commercial useâ€¡:</span>\n<span class="line"></span>\n<span class="line"> 1. Llama 2, an updated version of Llama 1, trained on a new mix of publicly available data. We also increased the size of the pretraining corpus by 40%, doubled the context length of the model, and adopted grouped-query attention (Ainslie et al., 2023). We are releasing variants of Llama 2 with 7B, 13B, and 70B parameters. We have also trained 34B variants, which we report on in this paper but are not releasing.Â§</span>\n<span class="line"></span>\n<span class="line"> 2. Llama 2-Chat, a ï¬ne-tuned version of Llama 2 that is optimized for dialogue use cases. We release</span>\n<span class="line"></span>\n<span class="line"> variants of this model with 7B, 13B, and 70B parameters as well.</span>\n<span class="line"></span>\n<span class="line"> We believe that the open release of LLMs, when done safely, will be a net beneï¬t to society. Like all LLMs, Llama 2 is a new technology that carries potential risks with use (Bender et al., 2021b; Weidinger et al., 2021; Solaiman et al., 2023). Testing conducted to date has been in English and has not â€” and could not â€” cover all scenarios. Therefore, before deploying any applications of Llama 2-Chat, developers should perform safety testing and tuning tailored to their speciï¬c applications of the model. We provide a responsible use guideÂ¶ and code examplesâ€– to facilitate the safe deployment of Llama 2 and Llama 2-Chat. More details of our responsible release strategy can be found in Section 5.3.</span>\n<span class="line"></span>\n<span class="line"> The remainder of this paper describes our pretraining methodology (Section 2), ï¬ne-tuning methodology (Section 3), approach to model safety (Section 4), key observations and insights (Section 5), relevant related work (Section 6), and conclusions (Section 7).</span>\n<span class="line"></span>\n<span class="line"> â€¡https://ai.meta.com/resources/models-and-libraries/llama/ Â§We are delaying the release of the 34B model due to a lack of time to suï¬ƒciently red team. Â¶https://ai.meta.com/llama â€–https://github.com/facebookresearch/llama</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ”¹è¿›</strong>: æŒ‰ä¸€å®šç²’åº¦ï¼Œéƒ¨åˆ†é‡å å¼çš„åˆ‡å‰²æ–‡æœ¬ï¼Œä½¿ä¸Šä¸‹æ–‡æ›´å®Œæ•´</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> nltk<span class="token punctuation">.</span>tokenize <span class="token keyword">import</span> sent_tokenize</span>\n<span class="line"><span class="token keyword">import</span> json</span>\n<span class="line"></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">def</span> <span class="token function">split_text</span><span class="token punctuation">(</span>paragraphs<span class="token punctuation">,</span> chunk_size<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">,</span> overlap_size<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token triple-quoted-string string">&#39;&#39;&#39;æŒ‰æŒ‡å®š chunk_size å’Œ overlap_size äº¤å å‰²æ–‡æœ¬&#39;&#39;&#39;</span></span>\n<span class="line">    sentences <span class="token operator">=</span> <span class="token punctuation">[</span>s<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> p <span class="token keyword">in</span> paragraphs <span class="token keyword">for</span> s <span class="token keyword">in</span> sent_tokenize<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">]</span></span>\n<span class="line">    chunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>\n<span class="line">    i <span class="token operator">=</span> <span class="token number">0</span></span>\n<span class="line">    <span class="token keyword">while</span> i <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sentences<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">        chunk <span class="token operator">=</span> sentences<span class="token punctuation">[</span>i<span class="token punctuation">]</span></span>\n<span class="line">        overlap <span class="token operator">=</span> <span class="token string">&#39;&#39;</span></span>\n<span class="line">        prev_len <span class="token operator">=</span> <span class="token number">0</span></span>\n<span class="line">        prev <span class="token operator">=</span> i <span class="token operator">-</span> <span class="token number">1</span></span>\n<span class="line">        <span class="token comment"># å‘å‰è®¡ç®—é‡å éƒ¨åˆ†</span></span>\n<span class="line">        <span class="token keyword">while</span> prev <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token keyword">and</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sentences<span class="token punctuation">[</span>prev<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token builtin">len</span><span class="token punctuation">(</span>overlap<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> overlap_size<span class="token punctuation">:</span></span>\n<span class="line">            overlap <span class="token operator">=</span> sentences<span class="token punctuation">[</span>prev<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">&#39; &#39;</span> <span class="token operator">+</span> overlap</span>\n<span class="line">            prev <span class="token operator">-=</span> <span class="token number">1</span></span>\n<span class="line">        chunk <span class="token operator">=</span> overlap<span class="token operator">+</span>chunk</span>\n<span class="line">        <span class="token builtin">next</span> <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span></span>\n<span class="line">        <span class="token comment"># å‘åè®¡ç®—å½“å‰chunk</span></span>\n<span class="line">        <span class="token keyword">while</span> <span class="token builtin">next</span> <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sentences<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sentences<span class="token punctuation">[</span><span class="token builtin">next</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token builtin">len</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> chunk_size<span class="token punctuation">:</span></span>\n<span class="line">            chunk <span class="token operator">=</span> chunk <span class="token operator">+</span> <span class="token string">&#39; &#39;</span> <span class="token operator">+</span> sentences<span class="token punctuation">[</span><span class="token builtin">next</span><span class="token punctuation">]</span></span>\n<span class="line">            <span class="token builtin">next</span> <span class="token operator">+=</span> <span class="token number">1</span></span>\n<span class="line">        chunks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>chunk<span class="token punctuation">)</span></span>\n<span class="line">        i <span class="token operator">=</span> <span class="token builtin">next</span></span>\n<span class="line">    <span class="token keyword">return</span> chunks</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>â„¹ï¸ <strong>Info:</strong> æ­¤å¤„ sent_tokenize ä¸ºé’ˆå¯¹è‹±æ–‡çš„å®ç°ï¼Œé’ˆå¯¹ä¸­æ–‡çš„å®ç°è¯·å‚è€ƒ chinese_utils.py</p></blockquote><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">chunks <span class="token operator">=</span> split_text<span class="token punctuation">(</span>paragraphs<span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># åˆ›å»ºä¸€ä¸ªå‘é‡æ•°æ®åº“å¯¹è±¡</span></span>\n<span class="line">vector_db <span class="token operator">=</span> MyVectorDBConnector<span class="token punctuation">(</span><span class="token string">&quot;demo_text_split&quot;</span><span class="token punctuation">,</span> get_embeddings<span class="token punctuation">)</span></span>\n<span class="line"><span class="token comment"># å‘å‘é‡æ•°æ®åº“ä¸­æ·»åŠ æ–‡æ¡£</span></span>\n<span class="line">vector_db<span class="token punctuation">.</span>add_documents<span class="token punctuation">(</span>chunks<span class="token punctuation">)</span></span>\n<span class="line"><span class="token comment"># åˆ›å»ºä¸€ä¸ªRAGæœºå™¨äºº</span></span>\n<span class="line">bot <span class="token operator">=</span> RAG_Bot<span class="token punctuation">(</span></span>\n<span class="line">    vector_db<span class="token punctuation">,</span></span>\n<span class="line">    llm_api<span class="token operator">=</span>get_completion</span>\n<span class="line"><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># user_query = &quot;llama 2æœ‰å•†ç”¨è®¸å¯åè®®å—&quot;</span></span>\n<span class="line">user_query<span class="token operator">=</span><span class="token string">&quot;llama 2 chatæœ‰å¤šå°‘å‚æ•°&quot;</span></span>\n<span class="line"></span>\n<span class="line">search_results <span class="token operator">=</span> vector_db<span class="token punctuation">.</span>search<span class="token punctuation">(</span>user_query<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></span>\n<span class="line"><span class="token keyword">for</span> doc <span class="token keyword">in</span> search_results<span class="token punctuation">[</span><span class="token string">&#39;documents&#39;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span>doc<span class="token operator">+</span><span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">response <span class="token operator">=</span> bot<span class="token punctuation">.</span>chat<span class="token punctuation">(</span>user_query<span class="token punctuation">)</span></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;====å›å¤====&quot;</span><span class="token punctuation">)</span></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">2. Llama 2-Chat, a ï¬ne-tuned version of Llama 2 that is optimized for dialogue use cases. We release variants of this model with 7B, 13B, and 70B parameters as well. We believe that the open release of LLMs, when done safely, will be a net beneï¬t to society.</span>\n<span class="line"></span>\n<span class="line">In this work, we develop and release Llama 2, a family of pretrained and ï¬ne-tuned LLMs, Llama 2 and Llama 2-Chat, at scales up to 70B parameters. On the series of helpfulness and safety benchmarks we tested, Llama 2-Chat models generally perform better than existing open-source models.</span>\n<span class="line"></span>\n<span class="line">====å›å¤====</span>\n<span class="line">llama 2 chatæœ‰7B, 13Bå’Œ70Bå‚æ•°ã€‚</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2ã€æ£€ç´¢åæ’åº-é€‰" tabindex="-1"><a class="header-anchor" href="#_5-2ã€æ£€ç´¢åæ’åº-é€‰"><span>5.2ã€æ£€ç´¢åæ’åºï¼ˆé€‰ï¼‰</span></a></h3><p><strong>é—®é¢˜</strong>: æœ‰æ—¶ï¼Œæœ€åˆé€‚çš„ç­”æ¡ˆä¸ä¸€å®šæ’åœ¨æ£€ç´¢çš„æœ€å‰é¢</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">user_query <span class="token operator">=</span> <span class="token string">&quot;how safe is llama 2&quot;</span></span>\n<span class="line">search_results <span class="token operator">=</span> vector_db<span class="token punctuation">.</span>search<span class="token punctuation">(</span>user_query<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">for</span> doc <span class="token keyword">in</span> search_results<span class="token punctuation">[</span><span class="token string">&#39;documents&#39;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span>doc<span class="token operator">+</span><span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">response <span class="token operator">=</span> bot<span class="token punctuation">.</span>chat<span class="token punctuation">(</span>user_query<span class="token punctuation">)</span></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;====å›å¤====&quot;</span><span class="token punctuation">)</span></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">We believe that the open release of LLMs, when done safely, will be a net beneï¬t to society. Like all LLMs, Llama 2 is a new technology that carries potential risks with use (Bender et al., 2021b; Weidinger et al., 2021; Solaiman et al., 2023).</span>\n<span class="line"></span>\n<span class="line">We also share novel observations we made during the development of Llama 2 and Llama 2-Chat, such as the emergence of tool usage and temporal organization of knowledge. Figure 3: Safety human evaluation results for Llama 2-Chat compared to other open-source and closed source models.</span>\n<span class="line"></span>\n<span class="line">In this work, we develop and release Llama 2, a family of pretrained and ï¬ne-tuned LLMs, Llama 2 and Llama 2-Chat, at scales up to 70B parameters. On the series of helpfulness and safety benchmarks we tested, Llama 2-Chat models generally perform better than existing open-source models.</span>\n<span class="line"></span>\n<span class="line">Additionally, these safety evaluations are performed using content standards that are likely to be biased towards the Llama 2-Chat models. We are releasing the following models to the general public for research and commercial useâ€¡: 1.</span>\n<span class="line"></span>\n<span class="line">We provide a responsible use guideÂ¶ and code examplesâ€– to facilitate the safe deployment of Llama 2 and Llama 2-Chat. More details of our responsible release strategy can be found in Section 5.3.</span>\n<span class="line"></span>\n<span class="line">====å›å¤====</span>\n<span class="line">æ ¹æ®å·²çŸ¥ä¿¡æ¯ä¸­æåˆ°çš„å®‰å…¨äººç±»è¯„ä¼°ç»“æœï¼ŒLlama 2-Chatåœ¨å®‰å…¨æ€§æ–¹é¢ç›¸å¯¹äºå…¶ä»–å¼€æºå’Œé—­æºæ¨¡å‹è¡¨ç°è‰¯å¥½ã€‚</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ–¹æ¡ˆ</strong>:</p><ol><li>æ£€ç´¢æ—¶è¿‡æ‹›å›ä¸€éƒ¨åˆ†æ–‡æœ¬</li><li>é€šè¿‡ä¸€ä¸ªæ’åºæ¨¡å‹å¯¹ query å’Œ document é‡æ–°æ‰“åˆ†æ’åº</li></ol><p><img src="'+r+'" alt="image"></p><blockquote><p>âŒ <strong>Warning:</strong> ä»¥ä¸‹ä»£ç ä¸è¦åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œï¼Œä¼šæ­»æœºï¼å¯ä¸‹è½½å·¦ä¾§ rank.py åœ¨è‡ªå·±æœ¬åœ°è¿è¡Œã€‚</p></blockquote><blockquote><p>âš ï¸ <strong>Note:</strong> å¤‡æ³¨ï¼š ç”±äº huggingface è¢«å¢™ï¼Œæˆ‘ä»¬å·²ç»ä¸ºæ‚¨å‡†å¤‡å¥½äº†æœ¬ç« ç›¸å…³æ¨¡å‹ã€‚è¯·ç‚¹å‡»ä»¥ä¸‹ç½‘ç›˜é“¾æ¥è¿›è¡Œä¸‹è½½ï¼š</p></blockquote><p>é“¾æ¥: https://pan.baidu.com/s/1X0kfNKasvWqCLUEEyAvO-Q?pwd=3v6y æå–ç : 3v6y</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># !pip install sentence_transformers</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> sentence_transformers <span class="token keyword">import</span> CrossEncoder</span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># model = CrossEncoder(&#39;cross-encoder/ms-marco-MiniLM-L-6-v2&#39;, max_length=512) # è‹±æ–‡ï¼Œæ¨¡å‹è¾ƒå°</span></span>\n<span class="line">model <span class="token operator">=</span> CrossEncoder<span class="token punctuation">(</span><span class="token string">&#39;BAAI/bge-reranker-large&#39;</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">)</span> <span class="token comment"># å¤šè¯­è¨€ï¼Œå›½äº§ï¼Œæ¨¡å‹è¾ƒå¤§</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">user_query <span class="token operator">=</span> <span class="token string">&quot;how safe is llama 2&quot;</span></span>\n<span class="line"><span class="token comment"># user_query = &quot;llama 2å®‰å…¨æ€§å¦‚ä½•&quot;</span></span>\n<span class="line">scores <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span>user_query<span class="token punctuation">,</span> doc<span class="token punctuation">)</span></span>\n<span class="line">                       <span class="token keyword">for</span> doc <span class="token keyword">in</span> search_results<span class="token punctuation">[</span><span class="token string">&#39;documents&#39;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>\n<span class="line"><span class="token comment"># æŒ‰å¾—åˆ†æ’åº</span></span>\n<span class="line">sorted_list <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span></span>\n<span class="line">    <span class="token builtin">zip</span><span class="token punctuation">(</span>scores<span class="token punctuation">,</span> search_results<span class="token punctuation">[</span><span class="token string">&#39;documents&#39;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>\n<span class="line"><span class="token keyword">for</span> score<span class="token punctuation">,</span> doc <span class="token keyword">in</span> sorted_list<span class="token punctuation">:</span></span>\n<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>score<span class="token punctuation">}</span></span><span class="token string">\\t</span><span class="token interpolation"><span class="token punctuation">{</span>doc<span class="token punctuation">}</span></span><span class="token string">\\n&quot;</span></span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">0.918857753276825\tIn this work, we develop and release Llama 2, a family of pretrained and ï¬ne-tuned LLMs, Llama 2 and Llama 2-Chat, at scales up to 70B parameters. On the series of helpfulness and safety benchmarks we tested, Llama 2-Chat models generally perform better than existing open-source models.</span>\n<span class="line"></span>\n<span class="line">0.7791304588317871\tWe believe that the open release of LLMs, when done safely, will be a net beneï¬t to society. Like all LLMs, Llama 2 is a new technology that carries potential risks with use (Bender et al., 2021b; Weidinger et al., 2021; Solaiman et al., 2023).</span>\n<span class="line"></span>\n<span class="line">0.47571462392807007\tWe provide a responsible use guideÂ¶ and code examplesâ€– to facilitate the safe deployment of Llama 2 and Llama 2-Chat. More details of our responsible release strategy can be found in Section 5.3.</span>\n<span class="line"></span>\n<span class="line">0.47421783208847046\tWe also share novel observations we made during the development of Llama 2 and Llama 2-Chat, such as the emergence of tool usage and temporal organization of knowledge. Figure 3: Safety human evaluation results for Llama 2-Chat compared to other open-source and closed source models.</span>\n<span class="line"></span>\n<span class="line">0.16011707484722137\tAdditionally, these safety evaluations are performed using content standards that are likely to be biased towards the Llama 2-Chat models. We are releasing the following models to the general public for research and commercial useâ€¡: 1.</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä¸€äº›-rerank-çš„-api-æœåŠ¡" tabindex="-1"><a class="header-anchor" href="#ä¸€äº›-rerank-çš„-api-æœåŠ¡"><span>ä¸€äº› Rerank çš„ API æœåŠ¡</span></a></h4><ul><li><a href="https://cohere.com/rerank" target="_blank" rel="noopener noreferrer">Cohere Rerank</a>ï¼šæ”¯æŒå¤šè¯­è¨€</li><li><a href="https://jina.ai/reranker/" target="_blank" rel="noopener noreferrer">Jina Rerank</a>ï¼šç›®å‰åªæ”¯æŒè‹±æ–‡</li></ul><h3 id="_5-3ã€æ··åˆæ£€ç´¢-hybrid-search-é€‰" tabindex="-1"><a class="header-anchor" href="#_5-3ã€æ··åˆæ£€ç´¢-hybrid-search-é€‰"><span>5.3ã€æ··åˆæ£€ç´¢ï¼ˆHybrid Searchï¼‰ï¼ˆé€‰ï¼‰</span></a></h3><p>åœ¨<strong>å®é™…ç”Ÿäº§</strong>ä¸­ï¼Œä¼ ç»Ÿçš„å…³é”®å­—æ£€ç´¢ï¼ˆç¨€ç–è¡¨ç¤ºï¼‰ä¸å‘é‡æ£€ç´¢ï¼ˆç¨ å¯†è¡¨ç¤ºï¼‰å„æœ‰ä¼˜åŠ£ã€‚</p><p>ä¸¾ä¸ªå…·ä½“ä¾‹å­ï¼Œæ¯”å¦‚æ–‡æ¡£ä¸­åŒ…å«å¾ˆé•¿çš„ä¸“æœ‰åè¯ï¼Œå…³é”®å­—æ£€ç´¢å¾€å¾€æ›´ç²¾å‡†è€Œå‘é‡æ£€ç´¢å®¹æ˜“å¼•å…¥æ¦‚å¿µæ··æ·†ã€‚</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># èƒŒæ™¯è¯´æ˜ï¼šåœ¨åŒ»å­¦ä¸­â€œå°ç»†èƒè‚ºç™Œâ€å’Œâ€œéå°ç»†èƒè‚ºç™Œâ€æ˜¯ä¸¤ç§ä¸åŒçš„ç™Œç—‡</span></span>\n<span class="line"></span>\n<span class="line">query <span class="token operator">=</span> <span class="token string">&quot;éå°ç»†èƒè‚ºç™Œçš„æ‚£è€…&quot;</span></span>\n<span class="line"></span>\n<span class="line">documents <span class="token operator">=</span> <span class="token punctuation">[</span></span>\n<span class="line">    <span class="token string">&quot;ç›ä¸½æ‚£æœ‰è‚ºç™Œï¼Œç™Œç»†èƒå·²è½¬ç§»&quot;</span><span class="token punctuation">,</span></span>\n<span class="line">    <span class="token string">&quot;åˆ˜æŸè‚ºç™ŒIæœŸ&quot;</span><span class="token punctuation">,</span></span>\n<span class="line">    <span class="token string">&quot;å¼ æŸç»è¯Šæ–­ä¸ºéå°ç»†èƒè‚ºç™ŒIIIæœŸ&quot;</span><span class="token punctuation">,</span></span>\n<span class="line">    <span class="token string">&quot;å°ç»†èƒè‚ºç™Œæ˜¯è‚ºç™Œçš„ä¸€ç§&quot;</span></span>\n<span class="line"><span class="token punctuation">]</span></span>\n<span class="line"></span>\n<span class="line">query_vec <span class="token operator">=</span> get_embeddings<span class="token punctuation">(</span><span class="token punctuation">[</span>query<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>\n<span class="line">doc_vecs <span class="token operator">=</span> get_embeddings<span class="token punctuation">(</span>documents<span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Cosine distance:&quot;</span><span class="token punctuation">)</span></span>\n<span class="line"><span class="token keyword">for</span> vec <span class="token keyword">in</span> doc_vecs<span class="token punctuation">:</span></span>\n<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span>cos_sim<span class="token punctuation">(</span>query_vec<span class="token punctuation">,</span> vec<span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">Cosine distance:</span>\n<span class="line">0.8915268056308027</span>\n<span class="line">0.8895478505819983</span>\n<span class="line">0.9039165614288258</span>\n<span class="line">0.9131441645902685</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰€ä»¥ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦ç»“åˆä¸åŒçš„æ£€ç´¢ç®—æ³•ï¼Œæ¥è¾¾åˆ°æ¯”å•ä¸€æ£€ç´¢ç®—æ³•æ›´ä¼˜çš„æ•ˆæœã€‚è¿™å°±æ˜¯<strong>æ··åˆæ£€ç´¢</strong>ã€‚</p><p>æ··åˆæ£€ç´¢çš„æ ¸å¿ƒæ˜¯ï¼Œç»¼åˆæ–‡æ¡£ $d$ åœ¨ä¸åŒæ£€ç´¢ç®—æ³•ä¸‹çš„æ’åºåæ¬¡ï¼ˆrankï¼‰ï¼Œä¸ºå…¶ç”Ÿæˆæœ€ç»ˆæ’åºã€‚</p><p>ä¸€ä¸ªæœ€å¸¸ç”¨çš„ç®—æ³•å« <strong>Reciprocal Rank Fusionï¼ˆRRFï¼‰</strong></p><p>$rrf(d)=\\sum_{a\\in A}\\frac{1}{k+rank_a(d)}$</p><p>å…¶ä¸­ $A$ è¡¨ç¤ºæ‰€æœ‰ä½¿ç”¨çš„æ£€ç´¢ç®—æ³•çš„é›†åˆï¼Œ$rank_a(d)$ è¡¨ç¤ºä½¿ç”¨ç®—æ³• $a$ æ£€ç´¢æ—¶ï¼Œæ–‡æ¡£ $d$ çš„æ’åºï¼Œ$k$ æ˜¯ä¸ªå¸¸æ•°ã€‚</p><p>å¾ˆå¤šå‘é‡æ•°æ®åº“éƒ½æ”¯æŒæ··åˆæ£€ç´¢ï¼Œæ¯”å¦‚ <a href="https://weaviate.io/blog/hybrid-search-explained" target="_blank" rel="noopener noreferrer">Weaviate</a>ã€<a href="https://www.pinecone.io/learn/hybrid-search-intro/" target="_blank" rel="noopener noreferrer">Pinecone</a> ç­‰ã€‚ä¹Ÿå¯ä»¥æ ¹æ®ä¸Šè¿°åŸç†è‡ªå·±å®ç°ã€‚</p><h3 id="_5-3-1ã€æˆ‘ä»¬æ‰‹å†™ä¸ªç®€å•çš„ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#_5-3-1ã€æˆ‘ä»¬æ‰‹å†™ä¸ªç®€å•çš„ä¾‹å­"><span>5.3.1ã€æˆ‘ä»¬æ‰‹å†™ä¸ªç®€å•çš„ä¾‹å­</span></a></h3><ol><li>åŸºäºå…³é”®å­—æ£€ç´¢çš„æ’åº</li></ol><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> time</span>\n<span class="line"></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">class</span> <span class="token class-name">MyEsConnector</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> es_client<span class="token punctuation">,</span> index_name<span class="token punctuation">,</span> keyword_fn<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">        self<span class="token punctuation">.</span>es_client <span class="token operator">=</span> es_client</span>\n<span class="line">        self<span class="token punctuation">.</span>index_name <span class="token operator">=</span> index_name</span>\n<span class="line">        self<span class="token punctuation">.</span>keyword_fn <span class="token operator">=</span> keyword_fn</span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">def</span> <span class="token function">add_documents</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> documents<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">        <span class="token triple-quoted-string string">&#39;&#39;&#39;æ–‡æ¡£çŒåº“&#39;&#39;&#39;</span></span>\n<span class="line">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>es_client<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>index<span class="token operator">=</span>self<span class="token punctuation">.</span>index_name<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">            self<span class="token punctuation">.</span>es_client<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>index<span class="token operator">=</span>self<span class="token punctuation">.</span>index_name<span class="token punctuation">)</span></span>\n<span class="line">        self<span class="token punctuation">.</span>es_client<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>create<span class="token punctuation">(</span>index<span class="token operator">=</span>self<span class="token punctuation">.</span>index_name<span class="token punctuation">)</span></span>\n<span class="line">        actions <span class="token operator">=</span> <span class="token punctuation">[</span></span>\n<span class="line">            <span class="token punctuation">{</span></span>\n<span class="line">                <span class="token string">&quot;_index&quot;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>index_name<span class="token punctuation">,</span></span>\n<span class="line">                <span class="token string">&quot;_source&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>\n<span class="line">                    <span class="token string">&quot;keywords&quot;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>keyword_fn<span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">,</span></span>\n<span class="line">                    <span class="token string">&quot;text&quot;</span><span class="token punctuation">:</span> doc<span class="token punctuation">,</span></span>\n<span class="line">                    <span class="token string">&quot;id&quot;</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f&quot;doc_</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span></span>\n<span class="line">                <span class="token punctuation">}</span></span>\n<span class="line">            <span class="token punctuation">}</span></span>\n<span class="line">            <span class="token keyword">for</span> i<span class="token punctuation">,</span> doc <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>documents<span class="token punctuation">)</span></span>\n<span class="line">        <span class="token punctuation">]</span></span>\n<span class="line">        helpers<span class="token punctuation">.</span>bulk<span class="token punctuation">(</span>self<span class="token punctuation">.</span>es_client<span class="token punctuation">,</span> actions<span class="token punctuation">)</span></span>\n<span class="line">        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">def</span> <span class="token function">search</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query_string<span class="token punctuation">,</span> top_n<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">        <span class="token triple-quoted-string string">&#39;&#39;&#39;æ£€ç´¢&#39;&#39;&#39;</span></span>\n<span class="line">        search_query <span class="token operator">=</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token string">&quot;match&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>\n<span class="line">                <span class="token string">&quot;keywords&quot;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>keyword_fn<span class="token punctuation">(</span>query_string<span class="token punctuation">)</span></span>\n<span class="line">            <span class="token punctuation">}</span></span>\n<span class="line">        <span class="token punctuation">}</span></span>\n<span class="line">        res <span class="token operator">=</span> self<span class="token punctuation">.</span>es_client<span class="token punctuation">.</span>search<span class="token punctuation">(</span></span>\n<span class="line">            index<span class="token operator">=</span>self<span class="token punctuation">.</span>index_name<span class="token punctuation">,</span> query<span class="token operator">=</span>search_query<span class="token punctuation">,</span> size<span class="token operator">=</span>top_n<span class="token punctuation">)</span></span>\n<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span></span>\n<span class="line">            hit<span class="token punctuation">[</span><span class="token string">&quot;_source&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>\n<span class="line">                <span class="token string">&quot;text&quot;</span><span class="token punctuation">:</span> hit<span class="token punctuation">[</span><span class="token string">&quot;_source&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>\n<span class="line">                <span class="token string">&quot;rank&quot;</span><span class="token punctuation">:</span> i<span class="token punctuation">,</span></span>\n<span class="line">            <span class="token punctuation">}</span></span>\n<span class="line">            <span class="token keyword">for</span> i<span class="token punctuation">,</span> hit <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token string">&quot;hits&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;hits&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>\n<span class="line">        <span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> chinese_utils <span class="token keyword">import</span> to_keywords  <span class="token comment"># ä½¿ç”¨ä¸­æ–‡çš„å…³é”®å­—æå–å‡½æ•°</span></span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># å¼•å…¥é…ç½®æ–‡ä»¶</span></span>\n<span class="line">ELASTICSEARCH_BASE_URL <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">&#39;ELASTICSEARCH_BASE_URL&#39;</span><span class="token punctuation">)</span></span>\n<span class="line">ELASTICSEARCH_PASSWORD <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">&#39;ELASTICSEARCH_PASSWORD&#39;</span><span class="token punctuation">)</span></span>\n<span class="line">ELASTICSEARCH_NAME<span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">&#39;ELASTICSEARCH_NAME&#39;</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">es <span class="token operator">=</span> Elasticsearch<span class="token punctuation">(</span></span>\n<span class="line">    hosts<span class="token operator">=</span><span class="token punctuation">[</span>ELASTICSEARCH_BASE_URL<span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># æœåŠ¡åœ°å€ä¸ç«¯å£</span></span>\n<span class="line">    http_auth<span class="token operator">=</span><span class="token punctuation">(</span>ELASTICSEARCH_NAME<span class="token punctuation">,</span> ELASTICSEARCH_PASSWORD<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># ç”¨æˆ·åï¼Œå¯†ç </span></span>\n<span class="line"><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># åˆ›å»º ES è¿æ¥å™¨</span></span>\n<span class="line">es_connector <span class="token operator">=</span> MyEsConnector<span class="token punctuation">(</span>es<span class="token punctuation">,</span> <span class="token string">&quot;demo_es_rrf&quot;</span><span class="token punctuation">,</span> to_keywords<span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># æ–‡æ¡£çŒåº“</span></span>\n<span class="line">es_connector<span class="token punctuation">.</span>add_documents<span class="token punctuation">(</span>documents<span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># å…³é”®å­—æ£€ç´¢</span></span>\n<span class="line">keyword_search_results <span class="token operator">=</span> es_connector<span class="token punctuation">.</span>search<span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>keyword_search_results<span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">{</span>\n<span class="line">    &quot;doc_2&quot;: {</span>\n<span class="line">        &quot;text&quot;: &quot;å¼ æŸç»è¯Šæ–­ä¸ºéå°ç»†èƒè‚ºç™ŒIIIæœŸ&quot;,</span>\n<span class="line">        &quot;rank&quot;: 0</span>\n<span class="line">    },</span>\n<span class="line">    &quot;doc_0&quot;: {</span>\n<span class="line">        &quot;text&quot;: &quot;ç›ä¸½æ‚£æœ‰è‚ºç™Œï¼Œç™Œç»†èƒå·²è½¬ç§»&quot;,</span>\n<span class="line">        &quot;rank&quot;: 1</span>\n<span class="line">    },</span>\n<span class="line">    &quot;doc_3&quot;: {</span>\n<span class="line">        &quot;text&quot;: &quot;å°ç»†èƒè‚ºç™Œæ˜¯è‚ºç™Œçš„ä¸€ç§&quot;,</span>\n<span class="line">        &quot;rank&quot;: 2</span>\n<span class="line">    }</span>\n<span class="line">}</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>åŸºäºå‘é‡æ£€ç´¢çš„æ’åº</li></ol><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># åˆ›å»ºå‘é‡æ•°æ®åº“è¿æ¥å™¨</span></span>\n<span class="line">vecdb_connector <span class="token operator">=</span> MyVectorDBConnector<span class="token punctuation">(</span><span class="token string">&quot;demo_vec_rrf&quot;</span><span class="token punctuation">,</span> get_embeddings<span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># æ–‡æ¡£çŒåº“</span></span>\n<span class="line">vecdb_connector<span class="token punctuation">.</span>add_documents<span class="token punctuation">(</span>documents<span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># å‘é‡æ£€ç´¢</span></span>\n<span class="line">vector_search_results <span class="token operator">=</span> <span class="token punctuation">{</span></span>\n<span class="line">    <span class="token string">&quot;doc_&quot;</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>documents<span class="token punctuation">.</span>index<span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token string">&quot;text&quot;</span><span class="token punctuation">:</span> doc<span class="token punctuation">,</span></span>\n<span class="line">        <span class="token string">&quot;rank&quot;</span><span class="token punctuation">:</span> i</span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line">    <span class="token keyword">for</span> i<span class="token punctuation">,</span> doc <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span></span>\n<span class="line">        vecdb_connector<span class="token punctuation">.</span>search<span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">&quot;documents&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>\n<span class="line">    <span class="token punctuation">)</span></span>\n<span class="line"><span class="token punctuation">}</span>  <span class="token comment"># æŠŠç»“æœè½¬æˆè·Ÿä¸Šé¢å…³é”®å­—æ£€ç´¢ç»“æœä¸€æ ·çš„æ ¼å¼</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>vector_search_results<span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">{</span>\n<span class="line">    &quot;doc_3&quot;: {</span>\n<span class="line">        &quot;text&quot;: &quot;å°ç»†èƒè‚ºç™Œæ˜¯è‚ºç™Œçš„ä¸€ç§&quot;,</span>\n<span class="line">        &quot;rank&quot;: 0</span>\n<span class="line">    },</span>\n<span class="line">    &quot;doc_2&quot;: {</span>\n<span class="line">        &quot;text&quot;: &quot;å¼ æŸç»è¯Šæ–­ä¸ºéå°ç»†èƒè‚ºç™ŒIIIæœŸ&quot;,</span>\n<span class="line">        &quot;rank&quot;: 1</span>\n<span class="line">    },</span>\n<span class="line">    &quot;doc_0&quot;: {</span>\n<span class="line">        &quot;text&quot;: &quot;ç›ä¸½æ‚£æœ‰è‚ºç™Œï¼Œç™Œç»†èƒå·²è½¬ç§»&quot;,</span>\n<span class="line">        &quot;rank&quot;: 2</span>\n<span class="line">    }</span>\n<span class="line">}</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>åŸºäº RRF çš„èåˆæ’åº</li></ol><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">rrf</span><span class="token punctuation">(</span>ranks<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">    ret <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>\n<span class="line">    <span class="token comment"># éå†æ¯æ¬¡çš„æ’åºç»“æœ</span></span>\n<span class="line">    <span class="token keyword">for</span> rank <span class="token keyword">in</span> ranks<span class="token punctuation">:</span></span>\n<span class="line">        <span class="token comment"># éå†æ’åºä¸­æ¯ä¸ªå…ƒç´ </span></span>\n<span class="line">        <span class="token keyword">for</span> <span class="token builtin">id</span><span class="token punctuation">,</span> val <span class="token keyword">in</span> rank<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">            <span class="token keyword">if</span> <span class="token builtin">id</span> <span class="token keyword">not</span> <span class="token keyword">in</span> ret<span class="token punctuation">:</span></span>\n<span class="line">                ret<span class="token punctuation">[</span><span class="token builtin">id</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;score&quot;</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">:</span> val<span class="token punctuation">[</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>\n<span class="line">            <span class="token comment"># è®¡ç®— RRF å¾—åˆ†</span></span>\n<span class="line">            ret<span class="token punctuation">[</span><span class="token builtin">id</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;score&quot;</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1.0</span><span class="token operator">/</span><span class="token punctuation">(</span>k<span class="token operator">+</span>val<span class="token punctuation">[</span><span class="token string">&quot;rank&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>\n<span class="line">    <span class="token comment"># æŒ‰ RRF å¾—åˆ†æ’åºï¼Œå¹¶è¿”å›</span></span>\n<span class="line">    <span class="token keyword">return</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">sorted</span><span class="token punctuation">(</span>ret<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> item<span class="token punctuation">:</span> item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;score&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> json</span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># èåˆä¸¤æ¬¡æ£€ç´¢çš„æ’åºç»“æœ</span></span>\n<span class="line">reranked <span class="token operator">=</span> rrf<span class="token punctuation">(</span><span class="token punctuation">[</span>keyword_search_results<span class="token punctuation">,</span> vector_search_results<span class="token punctuation">]</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>reranked<span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">{</span>\n<span class="line">    &quot;doc_2&quot;: {</span>\n<span class="line">        &quot;score&quot;: 1.5,</span>\n<span class="line">        &quot;text&quot;: &quot;å¼ æŸç»è¯Šæ–­ä¸ºéå°ç»†èƒè‚ºç™ŒIIIæœŸ&quot;</span>\n<span class="line">    },</span>\n<span class="line">    &quot;doc_3&quot;: {</span>\n<span class="line">        &quot;score&quot;: 1.3333333333333333,</span>\n<span class="line">        &quot;text&quot;: &quot;å°ç»†èƒè‚ºç™Œæ˜¯è‚ºç™Œçš„ä¸€ç§&quot;</span>\n<span class="line">    },</span>\n<span class="line">    &quot;doc_0&quot;: {</span>\n<span class="line">        &quot;score&quot;: 0.8333333333333333,</span>\n<span class="line">        &quot;text&quot;: &quot;ç›ä¸½æ‚£æœ‰è‚ºç™Œï¼Œç™Œç»†èƒå·²è½¬ç§»&quot;</span>\n<span class="line">    }</span>\n<span class="line">}</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-4ã€rag-fusion-é€‰" tabindex="-1"><a class="header-anchor" href="#_5-4ã€rag-fusion-é€‰"><span>5.4ã€RAG-Fusionï¼ˆé€‰ï¼‰</span></a></h3><p>RAG-Fusion å°±æ˜¯åˆ©ç”¨äº† RRF çš„åŸç†æ¥æå‡æ£€ç´¢çš„å‡†ç¡®æ€§ã€‚</p><p><img src="'+d+'" alt="image"></p><p>åŸå§‹é¡¹ç›®ï¼ˆä¸€æ®µéå¸¸ç®€çŸ­çš„æ¼”ç¤ºä»£ç ï¼‰ï¼šhttps://github.com/Raudaschl/rag-fusion</p><h2 id="å…­ã€å‘é‡æ¨¡å‹çš„æœ¬åœ°åŠ è½½ä¸è¿è¡Œ" tabindex="-1"><a class="header-anchor" href="#å…­ã€å‘é‡æ¨¡å‹çš„æœ¬åœ°åŠ è½½ä¸è¿è¡Œ"><span>å…­ã€å‘é‡æ¨¡å‹çš„æœ¬åœ°åŠ è½½ä¸è¿è¡Œ</span></a></h2><blockquote><p>âŒ <strong>Warning:</strong> ä»¥ä¸‹ä»£ç ä¸è¦åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œï¼Œä¼šæ­»æœºï¼å¯ä¸‹è½½å·¦ä¾§ bge.py åœ¨è‡ªå·±æœ¬åœ°è¿è¡Œã€‚</p></blockquote><blockquote><p>âš ï¸ <strong>Note:</strong> å¤‡æ³¨ï¼š ç”±äº huggingface è¢«å¢™ï¼Œæˆ‘ä»¬å·²ç»ä¸ºæ‚¨å‡†å¤‡å¥½äº†æœ¬ç« ç›¸å…³æ¨¡å‹ã€‚è¯·ç‚¹å‡»ä»¥ä¸‹ç½‘ç›˜é“¾æ¥è¿›è¡Œä¸‹è½½ï¼š</p></blockquote><p>é“¾æ¥: https://pan.baidu.com/s/1X0kfNKasvWqCLUEEyAvO-Q?pwd=3v6y æå–ç : 3v6y</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> sentence_transformers <span class="token keyword">import</span> SentenceTransformer</span>\n<span class="line"></span>\n<span class="line">model_name <span class="token operator">=</span> <span class="token string">&#39;BAAI/bge-large-zh-v1.5&#39;</span> <span class="token comment">#ä¸­æ–‡</span></span>\n<span class="line"><span class="token comment"># model_name = &#39;moka-ai/m3e-base&#39;  # ä¸­è‹±åŒè¯­ï¼Œä½†æ•ˆæœä¸€èˆ¬</span></span>\n<span class="line"><span class="token comment"># model_name = &#39;BAAI/bge-m3&#39; # å¤šè¯­è¨€ï¼Œä½†æ•ˆæœä¸€èˆ¬</span></span>\n<span class="line"></span>\n<span class="line">model <span class="token operator">=</span> SentenceTransformer<span class="token punctuation">(</span>model_name<span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">query <span class="token operator">=</span> <span class="token string">&quot;å›½é™…äº‰ç«¯&quot;</span></span>\n<span class="line"><span class="token comment"># query = &quot;global conflicts&quot;</span></span>\n<span class="line"></span>\n<span class="line">documents <span class="token operator">=</span> <span class="token punctuation">[</span></span>\n<span class="line">    <span class="token string">&quot;è”åˆå›½å°±è‹ä¸¹è¾¾å°”å¯Œå°”åœ°åŒºå¤§è§„æ¨¡æš´åŠ›äº‹ä»¶å‘å‡ºè­¦å‘Š&quot;</span><span class="token punctuation">,</span></span>\n<span class="line">    <span class="token string">&quot;åœŸè€³å…¶ã€èŠ¬å…°ã€ç‘å…¸ä¸åŒ—çº¦ä»£è¡¨å°†ç»§ç»­å°±ç‘å…¸â€œå…¥çº¦â€é—®é¢˜è¿›è¡Œè°ˆåˆ¤&quot;</span><span class="token punctuation">,</span></span>\n<span class="line">    <span class="token string">&quot;æ—¥æœ¬å²é˜œå¸‚é™†ä¸Šè‡ªå«é˜Ÿå°„å‡»åœºå†…å‘ç”Ÿæªå‡»äº‹ä»¶ 3äººå—ä¼¤&quot;</span><span class="token punctuation">,</span></span>\n<span class="line">    <span class="token string">&quot;å›½å®¶æ¸¸æ³³ä¸­å¿ƒï¼ˆæ°´ç«‹æ–¹ï¼‰ï¼šæ¢å¤æ¸¸æ³³ã€å¬‰æ°´ä¹å›­ç­‰æ°´ä¸Šé¡¹ç›®è¿è¥&quot;</span><span class="token punctuation">,</span></span>\n<span class="line">    <span class="token string">&quot;æˆ‘å›½é¦–æ¬¡åœ¨ç©ºé—´ç«™å¼€å±•èˆ±å¤–è¾å°„ç”Ÿç‰©å­¦æš´éœ²å®éªŒ&quot;</span><span class="token punctuation">,</span></span>\n<span class="line"><span class="token punctuation">]</span></span>\n<span class="line"></span>\n<span class="line">query_vec <span class="token operator">=</span> model<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>query<span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">doc_vecs <span class="token operator">=</span> <span class="token punctuation">[</span></span>\n<span class="line">    model<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>doc<span class="token punctuation">)</span></span>\n<span class="line">    <span class="token keyword">for</span> doc <span class="token keyword">in</span> documents</span>\n<span class="line"><span class="token punctuation">]</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Cosine distance:&quot;</span><span class="token punctuation">)</span>  <span class="token comment"># è¶Šå¤§è¶Šç›¸ä¼¼</span></span>\n<span class="line"><span class="token comment"># print(cos_sim(query_vec, query_vec))</span></span>\n<span class="line"><span class="token keyword">for</span> vec <span class="token keyword">in</span> doc_vecs<span class="token punctuation">:</span></span>\n<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span>cos_sim<span class="token punctuation">(</span>query_vec<span class="token punctuation">,</span> vec<span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">Cosine distance:</span>\n<span class="line">0.4727645</span>\n<span class="line">0.38867012</span>\n<span class="line">0.3285629</span>\n<span class="line">0.316192</span>\n<span class="line">0.30938625</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>â„¹ï¸ <strong>Info:</strong> æ‰©å±•é˜…è¯»ï¼šhttps://github.com/FlagOpen/FlagEmbedding</p></blockquote><blockquote><p>âœ… <strong>Tip:</strong> åˆ’é‡ç‚¹ï¼š</p></blockquote><pre><code>    ä¸æ˜¯æ¯ä¸ª Embedding æ¨¡å‹éƒ½å¯¹ä½™å¼¦è·ç¦»å’Œæ¬§æ°è·ç¦»åŒæ—¶æœ‰æ•ˆ\n    å“ªç§ç›¸ä¼¼åº¦è®¡ç®—æœ‰æ•ˆè¦é˜…è¯»æ¨¡å‹çš„è¯´æ˜ï¼ˆé€šå¸¸éƒ½æ”¯æŒä½™å¼¦è·ç¦»è®¡ç®—ï¼‰\n</code></pre><blockquote><p>âš ï¸ <strong>Note:</strong> æ³¨æ„ï¼š</p></blockquote><pre><code>    æœ¬èŠ‚åªä»‹ç»äº†æ¨¡å‹åœ¨æœ¬åœ°å¦‚ä½•åŠ è½½ä¸è¿è¡Œã€‚\n    å…³äºå¦‚ä½•å°†æ¨¡å‹éƒ¨ç½²æˆæ”¯æŒå¹¶å‘è¯·æ±‚çš„ HTTP æœåŠ¡ï¼Œå°†åœ¨ç¬¬15è¯¾ä¸­è®²è§£ã€‚\n</code></pre><h2 id="ä¸ƒã€pdf-æ–‡æ¡£ä¸­çš„è¡¨æ ¼æ€ä¹ˆå¤„ç†-é€‰" tabindex="-1"><a class="header-anchor" href="#ä¸ƒã€pdf-æ–‡æ¡£ä¸­çš„è¡¨æ ¼æ€ä¹ˆå¤„ç†-é€‰"><span>ä¸ƒã€PDF æ–‡æ¡£ä¸­çš„è¡¨æ ¼æ€ä¹ˆå¤„ç†ï¼ˆé€‰ï¼‰</span></a></h2><p><img src="'+k+'" alt="image"></p><ol><li>å°†æ¯é¡µ PDF è½¬æˆå›¾ç‰‡</li></ol><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># !pip install PyMuPDF</span></span>\n<span class="line"><span class="token comment"># !pip install matplotlib</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> os</span>\n<span class="line"><span class="token keyword">import</span> fitz</span>\n<span class="line"><span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image</span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">def</span> <span class="token function">pdf2images</span><span class="token punctuation">(</span>pdf_file<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token triple-quoted-string string">&#39;&#39;&#39;å°† PDF æ¯é¡µè½¬æˆä¸€ä¸ª PNG å›¾åƒ&#39;&#39;&#39;</span></span>\n<span class="line">    <span class="token comment"># ä¿å­˜è·¯å¾„ä¸ºåŸ PDF æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰</span></span>\n<span class="line">    output_directory_path<span class="token punctuation">,</span> _ <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>pdf_file<span class="token punctuation">)</span></span>\n<span class="line">    </span>\n<span class="line">    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>output_directory_path<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>output_directory_path<span class="token punctuation">)</span></span>\n<span class="line">    </span>\n<span class="line">    <span class="token comment"># åŠ è½½ PDF æ–‡ä»¶</span></span>\n<span class="line">    pdf_document <span class="token operator">=</span> fitz<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>pdf_file<span class="token punctuation">)</span></span>\n<span class="line">    </span>\n<span class="line">    <span class="token comment"># æ¯é¡µè½¬ä¸€å¼ å›¾</span></span>\n<span class="line">    <span class="token keyword">for</span> page_number <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>pdf_document<span class="token punctuation">.</span>page_count<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">        <span class="token comment"># å–ä¸€é¡µ</span></span>\n<span class="line">        page <span class="token operator">=</span> pdf_document<span class="token punctuation">[</span>page_number<span class="token punctuation">]</span></span>\n<span class="line">    </span>\n<span class="line">        <span class="token comment"># è½¬å›¾åƒ</span></span>\n<span class="line">        pix <span class="token operator">=</span> page<span class="token punctuation">.</span>get_pixmap<span class="token punctuation">(</span><span class="token punctuation">)</span></span>\n<span class="line">    </span>\n<span class="line">        <span class="token comment"># ä»ä½å›¾åˆ›å»º PNG å¯¹è±¡</span></span>\n<span class="line">        image <span class="token operator">=</span> Image<span class="token punctuation">.</span>frombytes<span class="token punctuation">(</span><span class="token string">&quot;RGB&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>pix<span class="token punctuation">.</span>width<span class="token punctuation">,</span> pix<span class="token punctuation">.</span>height<span class="token punctuation">]</span><span class="token punctuation">,</span> pix<span class="token punctuation">.</span>samples<span class="token punctuation">)</span></span>\n<span class="line">    </span>\n<span class="line">        <span class="token comment"># ä¿å­˜ PNG æ–‡ä»¶</span></span>\n<span class="line">        image<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;./</span><span class="token interpolation"><span class="token punctuation">{</span>output_directory_path<span class="token punctuation">}</span></span><span class="token string">/page_</span><span class="token interpolation"><span class="token punctuation">{</span>page_number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">.png&quot;</span></span><span class="token punctuation">)</span></span>\n<span class="line">    </span>\n<span class="line">    <span class="token comment"># å…³é—­ PDF æ–‡ä»¶</span></span>\n<span class="line">    pdf_document<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image</span>\n<span class="line"><span class="token keyword">import</span> os</span>\n<span class="line"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt</span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">def</span> <span class="token function">show_images</span><span class="token punctuation">(</span>dir_path<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token triple-quoted-string string">&#39;&#39;&#39;æ˜¾ç¤ºç›®å½•ä¸‹çš„ PNG å›¾åƒ&#39;&#39;&#39;</span></span>\n<span class="line">    <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>dir_path<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">        <span class="token keyword">if</span> <span class="token builtin">file</span><span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">&#39;.png&#39;</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">            <span class="token comment"># æ‰“å¼€å›¾åƒ</span></span>\n<span class="line">            img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>dir_path<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span>\n<span class="line"></span>\n<span class="line">            <span class="token comment"># æ˜¾ç¤ºå›¾åƒ</span></span>\n<span class="line">            plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">)</span></span>\n<span class="line">            plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">&#39;off&#39;</span><span class="token punctuation">)</span>  <span class="token comment"># ä¸æ˜¾ç¤ºåæ ‡è½´</span></span>\n<span class="line">            plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">pdf2images<span class="token punctuation">(</span><span class="token string">&quot;llama2_page8.pdf&quot;</span><span class="token punctuation">)</span></span>\n<span class="line">show_images<span class="token punctuation">(</span><span class="token string">&quot;llama2_page8&quot;</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>è¯†åˆ«æ–‡æ¡£ï¼ˆå›¾ç‰‡ï¼‰ä¸­çš„è¡¨æ ¼</li></ol><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">MaxResize</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token triple-quoted-string string">&#39;&#39;&#39;ç¼©æ”¾å›¾åƒ&#39;&#39;&#39;</span></span>\n<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> max_size<span class="token operator">=</span><span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">        self<span class="token punctuation">.</span>max_size <span class="token operator">=</span> max_size</span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">        width<span class="token punctuation">,</span> height <span class="token operator">=</span> image<span class="token punctuation">.</span>size</span>\n<span class="line">        current_max_size <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span></span>\n<span class="line">        scale <span class="token operator">=</span> self<span class="token punctuation">.</span>max_size <span class="token operator">/</span> current_max_size</span>\n<span class="line">        resized_image <span class="token operator">=</span> image<span class="token punctuation">.</span>resize<span class="token punctuation">(</span></span>\n<span class="line">            <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>scale <span class="token operator">*</span> width<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>scale <span class="token operator">*</span> height<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line">        <span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">        <span class="token keyword">return</span> resized_image</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">as</span> transforms</span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># å›¾åƒé¢„å¤„ç†</span></span>\n<span class="line">detection_transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span></span>\n<span class="line">    <span class="token punctuation">[</span></span>\n<span class="line">        MaxResize<span class="token punctuation">(</span><span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>\n<span class="line">        transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>\n<span class="line">        transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>\n<span class="line">    <span class="token punctuation">]</span></span>\n<span class="line"><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>âŒ <strong>Warning:</strong> ä»¥ä¸‹ä»£ç ä¸è¦åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œï¼Œä¼šæ­»æœºï¼å¯ä¸‹è½½å·¦ä¾§ table_detection.py åœ¨è‡ªå·±æœ¬åœ°è¿è¡Œã€‚</p></blockquote><blockquote><p>âš ï¸ <strong>Note:</strong> å¤‡æ³¨ï¼š ç”±äº huggingface è¢«å¢™ï¼Œæˆ‘ä»¬å·²ç»ä¸ºæ‚¨å‡†å¤‡å¥½äº†æœ¬ç« ç›¸å…³æ¨¡å‹ã€‚è¯·ç‚¹å‡»ä»¥ä¸‹ç½‘ç›˜é“¾æ¥è¿›è¡Œä¸‹è½½ï¼š</p></blockquote><p>é“¾æ¥: https://pan.baidu.com/s/1X0kfNKasvWqCLUEEyAvO-Q?pwd=3v6y æå–ç : 3v6y</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> transformers <span class="token keyword">import</span> AutoModelForObjectDetection</span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># åŠ è½½ TableTransformer æ¨¡å‹</span></span>\n<span class="line">model <span class="token operator">=</span> AutoModelForObjectDetection<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span></span>\n<span class="line">    <span class="token string">&quot;microsoft/table-transformer-detection&quot;</span></span>\n<span class="line"><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># è¯†åˆ«åçš„åæ ‡æ¢ç®—ä¸åå¤„ç†</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">def</span> <span class="token function">box_cxcywh_to_xyxy</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token triple-quoted-string string">&#39;&#39;&#39;åæ ‡è½¬æ¢&#39;&#39;&#39;</span></span>\n<span class="line">    x_c<span class="token punctuation">,</span> y_c<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> x<span class="token punctuation">.</span>unbind<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span></span>\n<span class="line">    b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>x_c <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> w<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>y_c <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x_c <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> w<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>y_c <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> h<span class="token punctuation">)</span><span class="token punctuation">]</span></span>\n<span class="line">    <span class="token keyword">return</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>b<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">def</span> <span class="token function">rescale_bboxes</span><span class="token punctuation">(</span>out_bbox<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token triple-quoted-string string">&#39;&#39;&#39;åŒºåŸŸç¼©æ”¾&#39;&#39;&#39;</span></span>\n<span class="line">    width<span class="token punctuation">,</span> height <span class="token operator">=</span> size</span>\n<span class="line">    boxes <span class="token operator">=</span> box_cxcywh_to_xyxy<span class="token punctuation">(</span>out_bbox<span class="token punctuation">)</span></span>\n<span class="line">    boxes <span class="token operator">=</span> boxes <span class="token operator">*</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span></span>\n<span class="line">        <span class="token punctuation">[</span>width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32</span>\n<span class="line">    <span class="token punctuation">)</span></span>\n<span class="line">    <span class="token keyword">return</span> boxes</span>\n<span class="line"></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">def</span> <span class="token function">outputs_to_objects</span><span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> img_size<span class="token punctuation">,</span> id2label<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token triple-quoted-string string">&#39;&#39;&#39;ä»æ¨¡å‹è¾“å‡ºä¸­å–å®šä½æ¡†åæ ‡&#39;&#39;&#39;</span></span>\n<span class="line">    m <span class="token operator">=</span> outputs<span class="token punctuation">.</span>logits<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span></span>\n<span class="line">    pred_labels <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>\n<span class="line">    pred_scores <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>values<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>\n<span class="line">    pred_bboxes <span class="token operator">=</span> outputs<span class="token punctuation">[</span><span class="token string">&quot;pred_boxes&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>\n<span class="line">    pred_bboxes <span class="token operator">=</span> <span class="token punctuation">[</span></span>\n<span class="line">        elem<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> elem <span class="token keyword">in</span> rescale_bboxes<span class="token punctuation">(</span>pred_bboxes<span class="token punctuation">,</span> img_size<span class="token punctuation">)</span></span>\n<span class="line">    <span class="token punctuation">]</span></span>\n<span class="line"></span>\n<span class="line">    objects <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>\n<span class="line">    <span class="token keyword">for</span> label<span class="token punctuation">,</span> score<span class="token punctuation">,</span> bbox <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>pred_labels<span class="token punctuation">,</span> pred_scores<span class="token punctuation">,</span> pred_bboxes<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">        class_label <span class="token operator">=</span> id2label<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">]</span></span>\n<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> class_label <span class="token operator">==</span> <span class="token string">&quot;no object&quot;</span><span class="token punctuation">:</span></span>\n<span class="line">            objects<span class="token punctuation">.</span>append<span class="token punctuation">(</span></span>\n<span class="line">                <span class="token punctuation">{</span></span>\n<span class="line">                    <span class="token string">&quot;label&quot;</span><span class="token punctuation">:</span> class_label<span class="token punctuation">,</span></span>\n<span class="line">                    <span class="token string">&quot;score&quot;</span><span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span><span class="token punctuation">,</span></span>\n<span class="line">                    <span class="token string">&quot;bbox&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">(</span>elem<span class="token punctuation">)</span> <span class="token keyword">for</span> elem <span class="token keyword">in</span> bbox<span class="token punctuation">]</span><span class="token punctuation">,</span></span>\n<span class="line">                <span class="token punctuation">}</span></span>\n<span class="line">            <span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">return</span> objects</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> torch</span>\n<span class="line"></span>\n<span class="line"><span class="token comment"># è¯†åˆ«è¡¨æ ¼ï¼Œå¹¶å°†è¡¨æ ¼éƒ¨åˆ†å•ç‹¬å­˜ä¸ºå›¾åƒæ–‡ä»¶</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">def</span> <span class="token function">detect_and_crop_save_table</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token comment"># åŠ è½½å›¾åƒï¼ˆPDFé¡µï¼‰    </span></span>\n<span class="line">    image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">    filename<span class="token punctuation">,</span> _ <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token comment"># è¾“å‡ºè·¯å¾„</span></span>\n<span class="line">    cropped_table_directory <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;table_images&quot;</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>cropped_table_directory<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>cropped_table_directory<span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token comment"># é¢„å¤„ç†</span></span>\n<span class="line">    pixel_values <span class="token operator">=</span> detection_transform<span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token comment"># è¯†åˆ«è¡¨æ ¼</span></span>\n<span class="line">    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">        outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>pixel_values<span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token comment"># åå¤„ç†ï¼Œå¾—åˆ°è¡¨æ ¼å­åŒºåŸŸ</span></span>\n<span class="line">    id2label <span class="token operator">=</span> model<span class="token punctuation">.</span>config<span class="token punctuation">.</span>id2label</span>\n<span class="line">    id2label<span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>config<span class="token punctuation">.</span>id2label<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;no object&quot;</span></span>\n<span class="line">    detected_tables <span class="token operator">=</span> outputs_to_objects<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> image<span class="token punctuation">.</span>size<span class="token punctuation">,</span> id2label<span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;number of tables detected </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>detected_tables<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">for</span> idx <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>detected_tables<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">        <span class="token comment"># å°†è¯†åˆ«ä»çš„è¡¨æ ¼åŒºåŸŸå•ç‹¬å­˜ä¸ºå›¾åƒ</span></span>\n<span class="line">        cropped_table <span class="token operator">=</span> image<span class="token punctuation">.</span>crop<span class="token punctuation">(</span>detected_tables<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;bbox&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>\n<span class="line">        cropped_table<span class="token punctuation">.</span>save<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>cropped_table_directory<span class="token punctuation">,</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>filename<span class="token punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span><span class="token string">.png&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">detect_and_crop_save_table<span class="token punctuation">(</span><span class="token string">&quot;llama2_page8/page_1.png&quot;</span><span class="token punctuation">)</span></span>\n<span class="line">show_images<span class="token punctuation">(</span><span class="token string">&quot;llama2_page8/table_images&quot;</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">number of tables detected 2</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ol start="3"><li>åŸºäº GPT-4 Vision API åšè¡¨æ ¼é—®ç­”</li></ol><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> base64</span>\n<span class="line"><span class="token keyword">from</span> openai <span class="token keyword">import</span> OpenAI</span>\n<span class="line"></span>\n<span class="line">client <span class="token operator">=</span> OpenAI<span class="token punctuation">(</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">def</span> <span class="token function">encode_image</span><span class="token punctuation">(</span>image_path<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">  <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>image_path<span class="token punctuation">,</span> <span class="token string">&quot;rb&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> image_file<span class="token punctuation">:</span></span>\n<span class="line">    <span class="token keyword">return</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>image_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">def</span> <span class="token function">image_qa</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> image_path<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">    base64_image <span class="token operator">=</span> encode_image<span class="token punctuation">(</span>image_path<span class="token punctuation">)</span></span>\n<span class="line">    response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span></span>\n<span class="line">        model<span class="token operator">=</span><span class="token string">&quot;gpt-4o&quot;</span><span class="token punctuation">,</span></span>\n<span class="line">        temperature<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span></span>\n<span class="line">        seed<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">,</span></span>\n<span class="line">        messages<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span></span>\n<span class="line">            <span class="token string">&quot;role&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span></span>\n<span class="line">              <span class="token string">&quot;content&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span></span>\n<span class="line">                  <span class="token punctuation">{</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">:</span> query<span class="token punctuation">}</span><span class="token punctuation">,</span></span>\n<span class="line">                  <span class="token punctuation">{</span></span>\n<span class="line">                      <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;image_url&quot;</span><span class="token punctuation">,</span></span>\n<span class="line">                      <span class="token string">&quot;image_url&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>\n<span class="line">                          <span class="token string">&quot;url&quot;</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f&quot;data:image/jpeg;base64,</span><span class="token interpolation"><span class="token punctuation">{</span>base64_image<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span></span>\n<span class="line">                      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>\n<span class="line">                  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>\n<span class="line">              <span class="token punctuation">]</span><span class="token punctuation">,</span></span>\n<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>\n<span class="line">    <span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">return</span> response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>content</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">response <span class="token operator">=</span> image_qa<span class="token punctuation">(</span><span class="token string">&quot;å“ªä¸ªæ¨¡å‹åœ¨AGI Evalæ•°æ®é›†ä¸Šè¡¨ç°æœ€å¥½ã€‚å¾—åˆ†å¤šå°‘&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;llama2_page8/table_images/page_1_0.png&quot;</span><span class="token punctuation">)</span></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">åœ¨AGI Evalæ•°æ®é›†ä¸Šè¡¨ç°æœ€å¥½çš„æ¨¡å‹æ˜¯LLaMA 2 70Bï¼Œå¾—åˆ†ä¸º54.2ã€‚</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ol start="4"><li>ç”¨ GPT-4 Vision ç”Ÿæˆè¡¨æ ¼ï¼ˆå›¾åƒï¼‰æè¿°ï¼Œå¹¶å‘é‡åŒ–ç”¨äºæ£€ç´¢</li></ol><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> chromadb</span>\n<span class="line"><span class="token keyword">from</span> chromadb<span class="token punctuation">.</span>config <span class="token keyword">import</span> Settings</span>\n<span class="line"></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">class</span> <span class="token class-name">NewVectorDBConnector</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> collection_name<span class="token punctuation">,</span> embedding_fn<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">        chroma_client <span class="token operator">=</span> chromadb<span class="token punctuation">.</span>Client<span class="token punctuation">(</span>Settings<span class="token punctuation">(</span>allow_reset<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">        <span class="token comment"># ä¸ºäº†æ¼”ç¤ºï¼Œå®é™…ä¸éœ€è¦æ¯æ¬¡ reset()</span></span>\n<span class="line">        chroma_client<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">        <span class="token comment"># åˆ›å»ºä¸€ä¸ª collection</span></span>\n<span class="line">        self<span class="token punctuation">.</span>collection <span class="token operator">=</span> chroma_client<span class="token punctuation">.</span>get_or_create_collection<span class="token punctuation">(</span></span>\n<span class="line">            name<span class="token operator">=</span>collection_name<span class="token punctuation">)</span></span>\n<span class="line">        self<span class="token punctuation">.</span>embedding_fn <span class="token operator">=</span> embedding_fn</span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">def</span> <span class="token function">add_documents</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> documents<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">        <span class="token triple-quoted-string string">&#39;&#39;&#39;å‘ collection ä¸­æ·»åŠ æ–‡æ¡£ä¸å‘é‡&#39;&#39;&#39;</span></span>\n<span class="line">        self<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>add<span class="token punctuation">(</span></span>\n<span class="line">            embeddings<span class="token operator">=</span>self<span class="token punctuation">.</span>embedding_fn<span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># æ¯ä¸ªæ–‡æ¡£çš„å‘é‡</span></span>\n<span class="line">            documents<span class="token operator">=</span>documents<span class="token punctuation">,</span>  <span class="token comment"># æ–‡æ¡£çš„åŸæ–‡</span></span>\n<span class="line">            ids<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f&quot;id</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># æ¯ä¸ªæ–‡æ¡£çš„ id</span></span>\n<span class="line">        <span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">def</span> <span class="token function">add_images</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image_paths<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">        <span class="token triple-quoted-string string">&#39;&#39;&#39;å‘ collection ä¸­æ·»åŠ å›¾åƒ&#39;&#39;&#39;</span></span>\n<span class="line">        documents <span class="token operator">=</span> <span class="token punctuation">[</span></span>\n<span class="line">            image_qa<span class="token punctuation">(</span><span class="token string">&quot;è¯·ç®€è¦æè¿°å›¾ç‰‡ä¸­çš„ä¿¡æ¯&quot;</span><span class="token punctuation">,</span>image<span class="token punctuation">)</span></span>\n<span class="line">            <span class="token keyword">for</span> image <span class="token keyword">in</span> image_paths</span>\n<span class="line">        <span class="token punctuation">]</span></span>\n<span class="line">        self<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>add<span class="token punctuation">(</span></span>\n<span class="line">            embeddings<span class="token operator">=</span>self<span class="token punctuation">.</span>embedding_fn<span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># æ¯ä¸ªæ–‡æ¡£çš„å‘é‡</span></span>\n<span class="line">            documents<span class="token operator">=</span>documents<span class="token punctuation">,</span>  <span class="token comment"># æ–‡æ¡£çš„åŸæ–‡</span></span>\n<span class="line">            ids<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f&quot;id</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># æ¯ä¸ªæ–‡æ¡£çš„ id</span></span>\n<span class="line">            metadatas<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;image&quot;</span><span class="token punctuation">:</span> image<span class="token punctuation">}</span> <span class="token keyword">for</span> image <span class="token keyword">in</span> image_paths<span class="token punctuation">]</span> <span class="token comment"># ç”¨ metadata æ ‡è®°æºå›¾åƒè·¯å¾„</span></span>\n<span class="line">        <span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">def</span> <span class="token function">search</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token punctuation">,</span> top_n<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">        <span class="token triple-quoted-string string">&#39;&#39;&#39;æ£€ç´¢å‘é‡æ•°æ®åº“&#39;&#39;&#39;</span></span>\n<span class="line">        results <span class="token operator">=</span> self<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>query<span class="token punctuation">(</span></span>\n<span class="line">            query_embeddings<span class="token operator">=</span>self<span class="token punctuation">.</span>embedding_fn<span class="token punctuation">(</span><span class="token punctuation">[</span>query<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>\n<span class="line">            n_results<span class="token operator">=</span>top_n</span>\n<span class="line">        <span class="token punctuation">)</span></span>\n<span class="line">        <span class="token keyword">return</span> results</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">images <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>\n<span class="line">dir_path <span class="token operator">=</span> <span class="token string">&quot;llama2_page8/table_images&quot;</span></span>\n<span class="line"><span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>dir_path<span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">    <span class="token keyword">if</span> <span class="token builtin">file</span><span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">&#39;.png&#39;</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>\n<span class="line">        <span class="token comment"># æ‰“å¼€å›¾åƒ</span></span>\n<span class="line">        images<span class="token punctuation">.</span>append<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>dir_path<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line"></span>\n<span class="line">new_db_connector <span class="token operator">=</span> NewVectorDBConnector<span class="token punctuation">(</span><span class="token string">&quot;table_demo&quot;</span><span class="token punctuation">,</span>get_embeddings<span class="token punctuation">)</span></span>\n<span class="line">new_db_connector<span class="token punctuation">.</span>add_images<span class="token punctuation">(</span>images<span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">query  <span class="token operator">=</span> <span class="token string">&quot;å“ªä¸ªæ¨¡å‹åœ¨AGI Evalæ•°æ®é›†ä¸Šè¡¨ç°æœ€å¥½ã€‚å¾—åˆ†å¤šå°‘&quot;</span></span>\n<span class="line"></span>\n<span class="line">results <span class="token operator">=</span> new_db_connector<span class="token punctuation">.</span>search<span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></span>\n<span class="line">metadata <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token string">&quot;metadatas&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;====æ£€ç´¢ç»“æœ====&quot;</span><span class="token punctuation">)</span></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;====å›å¤====&quot;</span><span class="token punctuation">)</span></span>\n<span class="line">response <span class="token operator">=</span> image_qa<span class="token punctuation">(</span>query<span class="token punctuation">,</span>metadata<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;image&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>\n<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">====æ£€ç´¢ç»“æœ====</span>\n<span class="line">[{&#39;image&#39;: &#39;llama2_page8/table_images/page_1_0.png&#39;}]</span>\n<span class="line">====å›å¤====</span>\n<span class="line">åœ¨AGI Evalæ•°æ®é›†ä¸Šè¡¨ç°æœ€å¥½çš„æ¨¡å‹æ˜¯LLaMA 2 70Bï¼Œå¾—åˆ†ä¸º54.2ã€‚</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ä¸€äº›é¢å‘-rag-çš„æ–‡æ¡£è§£æè¾…åŠ©å·¥å…·" tabindex="-1"><a class="header-anchor" href="#ä¸€äº›é¢å‘-rag-çš„æ–‡æ¡£è§£æè¾…åŠ©å·¥å…·"><span>ä¸€äº›é¢å‘ RAG çš„æ–‡æ¡£è§£æè¾…åŠ©å·¥å…·</span></a></h3><ul><li><a href="https://pymupdf.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer">PyMuPDF</a>: PDF æ–‡ä»¶å¤„ç†åŸºç¡€åº“ï¼Œå¸¦æœ‰åŸºäºè§„åˆ™çš„è¡¨æ ¼ä¸å›¾åƒæŠ½å–ï¼ˆä¸å‡†ï¼‰</li><li><a href="https://github.com/infiniflow/ragflow" target="_blank" rel="noopener noreferrer">RAGFlow</a>: ä¸€æ¬¾åŸºäºæ·±åº¦æ–‡æ¡£ç†è§£æ„å»ºçš„å¼€æº RAG å¼•æ“ï¼Œæ”¯æŒå¤šç§æ–‡æ¡£æ ¼å¼</li><li><a href="https://unstructured.io/" target="_blank" rel="noopener noreferrer">Unstructured.io</a>: ä¸€ä¸ªå¼€æº+SaaSå½¢å¼çš„æ–‡æ¡£è§£æåº“ï¼Œæ”¯æŒå¤šç§æ–‡æ¡£æ ¼å¼</li><li><a href="https://docs.llamaindex.ai/en/stable/llama_cloud/llama_parse/" target="_blank" rel="noopener noreferrer">LlamaParse</a>ï¼šä»˜è´¹ API æœåŠ¡ï¼Œç”± LlamaIndex å®˜æ–¹æä¾›ï¼Œè§£æä¸ä¿è¯100%å‡†ç¡®ï¼Œå®æµ‹å¶æœ‰æ–‡å­—ä¸¢å¤±æˆ–é”™ä½å‘ç”Ÿ</li><li><a href="https://mathpix.com/" target="_blank" rel="noopener noreferrer">Mathpix</a>ï¼šä»˜è´¹ API æœåŠ¡ï¼Œæ•ˆæœè¾ƒå¥½ï¼Œå¯è§£ææ®µè½ç»“æ„ã€è¡¨æ ¼ã€å…¬å¼ç­‰ï¼Œè´µï¼</li></ul><p>åœ¨å·¥ç¨‹ä¸Šï¼ŒPDF è§£ææœ¬èº«æ˜¯ä¸ªå¤æ‚ä¸”çç¢çš„å·¥ä½œã€‚ä»¥ä¸Šå·¥å…·éƒ½ä¸å®Œç¾ï¼Œå»ºè®®åœ¨è‡ªå·±å®é™…åœºæ™¯æµ‹è¯•åé€‰æ‹©ä½¿ç”¨ã€‚</p><h3 id="å…«ã€è¯´è¯´-graphrag" tabindex="-1"><a class="header-anchor" href="#å…«ã€è¯´è¯´-graphrag"><span>å…«ã€è¯´è¯´ GraphRAG</span></a></h3><p><img src="'+m+'" alt="image"></p><ol><li><strong>ä»€ä¹ˆæ˜¯ GraphRAG</strong>ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯å°†çŸ¥è¯†é¢„å…ˆå¤„ç†æˆçŸ¥è¯†å›¾è°±</li><li><strong>ä¼˜ç‚¹</strong>ï¼šé€‚åˆå¤æ‚é—®é¢˜ï¼Œå°¤å…¶æ˜¯ä»¥æŸ¥è¯¢ä¸ºä¸­å¿ƒçš„æ€»ç»“ï¼Œä¾‹å¦‚ï¼šâ€œXXXå›¢é˜Ÿå»å¹´æœ‰å“ªäº›è´¡çŒ®â€</li><li><strong>ç¼ºç‚¹</strong>ï¼šçŸ¥è¯†å›¾è°±çš„æ„å»ºã€æ¸…æ´—ã€ç»´æŠ¤æ›´æ–°ç­‰éƒ½æœ‰å¯è§‚çš„æˆæœ¬</li><li><strong>å»ºè®®</strong>ï¼š <ul><li>GraphRAG ä¸æ˜¯ä¸‡èƒ½è‰¯è¯</li><li>é¢†ä¼šå…¶æ ¸å¿ƒæ€æƒ³</li><li>é‡åˆ°ä¼ ç»Ÿ RAG æ— è®ºå¦‚ä½•ä¼˜åŒ–éƒ½ä¸å¥½è§£å†³çš„é—®é¢˜æ—¶ï¼Œé…Œæƒ…ä½¿ç”¨</li></ul></li></ol><h2 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“"><span>æ€»ç»“</span></a></h2><h3 id="rag-çš„æµç¨‹" tabindex="-1"><a class="header-anchor" href="#rag-çš„æµç¨‹"><span>RAG çš„æµç¨‹</span></a></h3><ul><li>ç¦»çº¿æ­¥éª¤ï¼š <ol><li>æ–‡æ¡£åŠ è½½</li><li>æ–‡æ¡£åˆ‡åˆ†</li><li>å‘é‡åŒ–</li><li>çŒå…¥å‘é‡æ•°æ®åº“</li></ol></li><li>åœ¨çº¿æ­¥éª¤ï¼š <ol><li>è·å¾—ç”¨æˆ·é—®é¢˜</li><li>ç”¨æˆ·é—®é¢˜å‘é‡åŒ–</li><li>æ£€ç´¢å‘é‡æ•°æ®åº“</li><li>å°†æ£€ç´¢ç»“æœå’Œç”¨æˆ·é—®é¢˜å¡«å…¥ Prompt æ¨¡ç‰ˆ</li><li>ç”¨æœ€ç»ˆè·å¾—çš„ Prompt è°ƒç”¨ LLM</li><li>ç”± LLM ç”Ÿæˆå›å¤</li></ol></li></ul><h3 id="æˆ‘ç”¨äº†ä¸€ä¸ªå¼€æºçš„-rag-ä¸å¥½ä½¿æ€ä¹ˆåŠ" tabindex="-1"><a class="header-anchor" href="#æˆ‘ç”¨äº†ä¸€ä¸ªå¼€æºçš„-rag-ä¸å¥½ä½¿æ€ä¹ˆåŠ"><span>æˆ‘ç”¨äº†ä¸€ä¸ªå¼€æºçš„ RAGï¼Œä¸å¥½ä½¿æ€ä¹ˆåŠï¼Ÿ</span></a></h3><ol><li>æ£€æŸ¥é¢„å¤„ç†æ•ˆæœï¼šæ–‡æ¡£åŠ è½½æ˜¯å¦æ­£ç¡®ï¼Œåˆ‡å‰²çš„æ˜¯å¦åˆç†</li><li>æµ‹è¯•æ£€ç´¢æ•ˆæœï¼šé—®é¢˜æ£€ç´¢å›æ¥çš„æ–‡æœ¬ç‰‡æ®µæ˜¯å¦åŒ…å«ç­”æ¡ˆ</li><li>æµ‹è¯•å¤§æ¨¡å‹èƒ½åŠ›ï¼šç»™å®šé—®é¢˜å’ŒåŒ…å«ç­”æ¡ˆæ–‡æœ¬ç‰‡æ®µçš„å‰æä¸‹ï¼Œå¤§æ¨¡å‹èƒ½ä¸èƒ½æ­£ç¡®å›ç­”é—®é¢˜</li></ol><h2 id="ä½œä¸š" tabindex="-1"><a class="header-anchor" href="#ä½œä¸š"><span>ä½œä¸š</span></a></h2><p>åšä¸ªè‡ªå·±çš„ ChatPDFã€‚éœ€æ±‚ï¼š</p><ol><li>ä»æœ¬åœ°åŠ è½½ PDF æ–‡ä»¶ï¼ŒåŸºäº PDF çš„å†…å®¹å¯¹è¯</li><li>å¯ä»¥æ— å‰ç«¯ï¼Œåªè¦èƒ½åœ¨å‘½ä»¤è¡Œè¿è¡Œå°±è¡Œ</li><li>å…¶å®ƒéšæ„å‘æŒ¥</li></ol>',261)])])}]]),g=JSON.parse('{"path":"/tutorial/llm/05-rag-embeddings.html","title":"05 Rag Embeddings   Index","lang":"zh-CN","frontmatter":{},"headers":[{"level":2,"title":"ğŸ’¡ è¿™èŠ‚è¯¾ä¼šå¸¦ç»™ä½ ","slug":"ğŸ’¡-è¿™èŠ‚è¯¾ä¼šå¸¦ç»™ä½ ","link":"#ğŸ’¡-è¿™èŠ‚è¯¾ä¼šå¸¦ç»™ä½ ","children":[]},{"level":2,"title":"ğŸ“ è¿™èŠ‚è¯¾æ€ä¹ˆå­¦","slug":"ğŸ“-è¿™èŠ‚è¯¾æ€ä¹ˆå­¦","link":"#ğŸ“-è¿™èŠ‚è¯¾æ€ä¹ˆå­¦","children":[]},{"level":2,"title":"ä¸€ã€æ¾„æ¸…ä¸€ä¸ªæ¦‚å¿µ","slug":"ä¸€ã€æ¾„æ¸…ä¸€ä¸ªæ¦‚å¿µ","link":"#ä¸€ã€æ¾„æ¸…ä¸€ä¸ªæ¦‚å¿µ","children":[]},{"level":2,"title":"äºŒã€ä»€ä¹ˆæ˜¯æ£€ç´¢å¢å¼ºçš„ç”Ÿæˆæ¨¡å‹ï¼ˆRAGï¼‰","slug":"äºŒã€ä»€ä¹ˆæ˜¯æ£€ç´¢å¢å¼ºçš„ç”Ÿæˆæ¨¡å‹-rag","link":"#äºŒã€ä»€ä¹ˆæ˜¯æ£€ç´¢å¢å¼ºçš„ç”Ÿæˆæ¨¡å‹-rag","children":[{"level":3,"title":"2.1ã€LLM å›ºæœ‰çš„å±€é™æ€§","slug":"_2-1ã€llm-å›ºæœ‰çš„å±€é™æ€§","link":"#_2-1ã€llm-å›ºæœ‰çš„å±€é™æ€§","children":[]},{"level":3,"title":"2.2ã€æ£€ç´¢å¢å¼ºç”Ÿæˆ","slug":"_2-2ã€æ£€ç´¢å¢å¼ºç”Ÿæˆ","link":"#_2-2ã€æ£€ç´¢å¢å¼ºç”Ÿæˆ","children":[]}]},{"level":2,"title":"ä¸‰ã€RAG ç³»ç»Ÿçš„åŸºæœ¬æ­å»ºæµç¨‹","slug":"ä¸‰ã€rag-ç³»ç»Ÿçš„åŸºæœ¬æ­å»ºæµç¨‹","link":"#ä¸‰ã€rag-ç³»ç»Ÿçš„åŸºæœ¬æ­å»ºæµç¨‹","children":[{"level":3,"title":"3.1ã€æ–‡æ¡£çš„åŠ è½½ä¸åˆ‡å‰²","slug":"_3-1ã€æ–‡æ¡£çš„åŠ è½½ä¸åˆ‡å‰²","link":"#_3-1ã€æ–‡æ¡£çš„åŠ è½½ä¸åˆ‡å‰²","children":[]},{"level":3,"title":"3.2ã€æ£€ç´¢å¼•æ“","slug":"_3-2ã€æ£€ç´¢å¼•æ“","link":"#_3-2ã€æ£€ç´¢å¼•æ“","children":[]},{"level":3,"title":"å®‰è£… ES å®¢æˆ·ç«¯","slug":"å®‰è£…-es-å®¢æˆ·ç«¯","link":"#å®‰è£…-es-å®¢æˆ·ç«¯","children":[]},{"level":3,"title":"å®‰è£… NLTKï¼ˆæ–‡æœ¬å¤„ç†æ–¹æ³•åº“ï¼‰","slug":"å®‰è£…-nltk-æ–‡æœ¬å¤„ç†æ–¹æ³•åº“","link":"#å®‰è£…-nltk-æ–‡æœ¬å¤„ç†æ–¹æ³•åº“","children":[]},{"level":3,"title":"3.3ã€LLM æ¥å£å°è£…","slug":"_3-3ã€llm-æ¥å£å°è£…","link":"#_3-3ã€llm-æ¥å£å°è£…","children":[]},{"level":3,"title":"3.4ã€Prompt æ¨¡æ¿","slug":"_3-4ã€prompt-æ¨¡æ¿","link":"#_3-4ã€prompt-æ¨¡æ¿","children":[]},{"level":3,"title":"3.5ã€RAG Pipeline åˆæ¢","slug":"_3-5ã€rag-pipeline-åˆæ¢","link":"#_3-5ã€rag-pipeline-åˆæ¢","children":[]},{"level":3,"title":"3.6ã€å…³é”®å­—æ£€ç´¢çš„å±€é™æ€§","slug":"_3-6ã€å…³é”®å­—æ£€ç´¢çš„å±€é™æ€§","link":"#_3-6ã€å…³é”®å­—æ£€ç´¢çš„å±€é™æ€§","children":[]}]},{"level":2,"title":"å››ã€å‘é‡æ£€ç´¢","slug":"å››ã€å‘é‡æ£€ç´¢","link":"#å››ã€å‘é‡æ£€ç´¢","children":[{"level":3,"title":"4.1ã€ä»€ä¹ˆæ˜¯å‘é‡","slug":"_4-1ã€ä»€ä¹ˆæ˜¯å‘é‡","link":"#_4-1ã€ä»€ä¹ˆæ˜¯å‘é‡","children":[]},{"level":3,"title":"4.1.1ã€æ–‡æœ¬å‘é‡ï¼ˆText Embeddingsï¼‰","slug":"_4-1-1ã€æ–‡æœ¬å‘é‡-text-embeddings","link":"#_4-1-1ã€æ–‡æœ¬å‘é‡-text-embeddings","children":[]},{"level":3,"title":"4.1.2ã€æ–‡æœ¬å‘é‡æ˜¯æ€ä¹ˆå¾—åˆ°çš„ï¼ˆé€‰ï¼‰","slug":"_4-1-2ã€æ–‡æœ¬å‘é‡æ˜¯æ€ä¹ˆå¾—åˆ°çš„-é€‰","link":"#_4-1-2ã€æ–‡æœ¬å‘é‡æ˜¯æ€ä¹ˆå¾—åˆ°çš„-é€‰","children":[]},{"level":3,"title":"4.2ã€å‘é‡é—´çš„ç›¸ä¼¼åº¦è®¡ç®—","slug":"_4-2ã€å‘é‡é—´çš„ç›¸ä¼¼åº¦è®¡ç®—","link":"#_4-2ã€å‘é‡é—´çš„ç›¸ä¼¼åº¦è®¡ç®—","children":[]},{"level":3,"title":"4.3ã€å‘é‡æ•°æ®åº“","slug":"_4-3ã€å‘é‡æ•°æ®åº“","link":"#_4-3ã€å‘é‡æ•°æ®åº“","children":[]},{"level":3,"title":"4.3.1ã€å‘é‡æ•°æ®åº“æœåŠ¡","slug":"_4-3-1ã€å‘é‡æ•°æ®åº“æœåŠ¡","link":"#_4-3-1ã€å‘é‡æ•°æ®åº“æœåŠ¡","children":[]},{"level":3,"title":"4.3.2ã€ä¸»æµå‘é‡æ•°æ®åº“åŠŸèƒ½å¯¹æ¯”","slug":"_4-3-2ã€ä¸»æµå‘é‡æ•°æ®åº“åŠŸèƒ½å¯¹æ¯”","link":"#_4-3-2ã€ä¸»æµå‘é‡æ•°æ®åº“åŠŸèƒ½å¯¹æ¯”","children":[]},{"level":3,"title":"4.4ã€åŸºäºå‘é‡æ£€ç´¢çš„ RAG","slug":"_4-4ã€åŸºäºå‘é‡æ£€ç´¢çš„-rag","link":"#_4-4ã€åŸºäºå‘é‡æ£€ç´¢çš„-rag","children":[]},{"level":3,"title":"4.5ã€å¦‚æœæƒ³è¦æ¢ä¸ªå›½äº§æ¨¡å‹","slug":"_4-5ã€å¦‚æœæƒ³è¦æ¢ä¸ªå›½äº§æ¨¡å‹","link":"#_4-5ã€å¦‚æœæƒ³è¦æ¢ä¸ªå›½äº§æ¨¡å‹","children":[]},{"level":3,"title":"4.6ã€OpenAI æ–°å‘å¸ƒçš„ä¸¤ä¸ª Embedding æ¨¡å‹","slug":"_4-6ã€openai-æ–°å‘å¸ƒçš„ä¸¤ä¸ª-embedding-æ¨¡å‹","link":"#_4-6ã€openai-æ–°å‘å¸ƒçš„ä¸¤ä¸ª-embedding-æ¨¡å‹","children":[]}]},{"level":2,"title":"äº”ã€å®æˆ˜ RAG ç³»ç»Ÿçš„è¿›é˜¶çŸ¥è¯†","slug":"äº”ã€å®æˆ˜-rag-ç³»ç»Ÿçš„è¿›é˜¶çŸ¥è¯†","link":"#äº”ã€å®æˆ˜-rag-ç³»ç»Ÿçš„è¿›é˜¶çŸ¥è¯†","children":[{"level":3,"title":"5.1ã€æ–‡æœ¬åˆ†å‰²çš„ç²’åº¦","slug":"_5-1ã€æ–‡æœ¬åˆ†å‰²çš„ç²’åº¦","link":"#_5-1ã€æ–‡æœ¬åˆ†å‰²çš„ç²’åº¦","children":[]},{"level":3,"title":"5.2ã€æ£€ç´¢åæ’åºï¼ˆé€‰ï¼‰","slug":"_5-2ã€æ£€ç´¢åæ’åº-é€‰","link":"#_5-2ã€æ£€ç´¢åæ’åº-é€‰","children":[]},{"level":3,"title":"5.3ã€æ··åˆæ£€ç´¢ï¼ˆHybrid Searchï¼‰ï¼ˆé€‰ï¼‰","slug":"_5-3ã€æ··åˆæ£€ç´¢-hybrid-search-é€‰","link":"#_5-3ã€æ··åˆæ£€ç´¢-hybrid-search-é€‰","children":[]},{"level":3,"title":"5.3.1ã€æˆ‘ä»¬æ‰‹å†™ä¸ªç®€å•çš„ä¾‹å­","slug":"_5-3-1ã€æˆ‘ä»¬æ‰‹å†™ä¸ªç®€å•çš„ä¾‹å­","link":"#_5-3-1ã€æˆ‘ä»¬æ‰‹å†™ä¸ªç®€å•çš„ä¾‹å­","children":[]},{"level":3,"title":"5.4ã€RAG-Fusionï¼ˆé€‰ï¼‰","slug":"_5-4ã€rag-fusion-é€‰","link":"#_5-4ã€rag-fusion-é€‰","children":[]}]},{"level":2,"title":"å…­ã€å‘é‡æ¨¡å‹çš„æœ¬åœ°åŠ è½½ä¸è¿è¡Œ","slug":"å…­ã€å‘é‡æ¨¡å‹çš„æœ¬åœ°åŠ è½½ä¸è¿è¡Œ","link":"#å…­ã€å‘é‡æ¨¡å‹çš„æœ¬åœ°åŠ è½½ä¸è¿è¡Œ","children":[]},{"level":2,"title":"ä¸ƒã€PDF æ–‡æ¡£ä¸­çš„è¡¨æ ¼æ€ä¹ˆå¤„ç†ï¼ˆé€‰ï¼‰","slug":"ä¸ƒã€pdf-æ–‡æ¡£ä¸­çš„è¡¨æ ¼æ€ä¹ˆå¤„ç†-é€‰","link":"#ä¸ƒã€pdf-æ–‡æ¡£ä¸­çš„è¡¨æ ¼æ€ä¹ˆå¤„ç†-é€‰","children":[{"level":3,"title":"ä¸€äº›é¢å‘ RAG çš„æ–‡æ¡£è§£æè¾…åŠ©å·¥å…·","slug":"ä¸€äº›é¢å‘-rag-çš„æ–‡æ¡£è§£æè¾…åŠ©å·¥å…·","link":"#ä¸€äº›é¢å‘-rag-çš„æ–‡æ¡£è§£æè¾…åŠ©å·¥å…·","children":[]},{"level":3,"title":"å…«ã€è¯´è¯´ GraphRAG","slug":"å…«ã€è¯´è¯´-graphrag","link":"#å…«ã€è¯´è¯´-graphrag","children":[]}]},{"level":2,"title":"æ€»ç»“","slug":"æ€»ç»“","link":"#æ€»ç»“","children":[{"level":3,"title":"RAG çš„æµç¨‹","slug":"rag-çš„æµç¨‹","link":"#rag-çš„æµç¨‹","children":[]},{"level":3,"title":"æˆ‘ç”¨äº†ä¸€ä¸ªå¼€æºçš„ RAGï¼Œä¸å¥½ä½¿æ€ä¹ˆåŠï¼Ÿ","slug":"æˆ‘ç”¨äº†ä¸€ä¸ªå¼€æºçš„-rag-ä¸å¥½ä½¿æ€ä¹ˆåŠ","link":"#æˆ‘ç”¨äº†ä¸€ä¸ªå¼€æºçš„-rag-ä¸å¥½ä½¿æ€ä¹ˆåŠ","children":[]}]},{"level":2,"title":"ä½œä¸š","slug":"ä½œä¸š","link":"#ä½œä¸š","children":[]}],"git":{"contributors":[{"name":"mingwzh","username":"mingwzh","email":"1127699551@qq.com","commits":1,"url":"https://github.com/mingwzh"}],"changelog":[{"hash":"7258500d8133e8f6ce13b85788bbb7693b4d4c48","time":1768575286000,"email":"1127699551@qq.com","author":"mingwzh","message":"docs(tutorial): æ·»åŠ RAGæ£€ç´¢å¢å¼ºç”Ÿæˆæ¨¡å‹å®Œæ•´å®æˆ˜æ•™ç¨‹"}]},"filePathRelative":"tutorial/llm/05-rag-embeddings.md"}')}}]);