<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.20" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>智能营销解决方案 | 知识库</title><meta name="description" content="涵盖Java、Spring、Vue、Node.js等技术知识">
    <link rel="stylesheet" href="/wiki/assets/css/styles.2a121ef9.css">
    <link rel="preload" href="/wiki/assets/js/runtime~app.46b38a58.js" as="script"><link rel="preload" href="/wiki/assets/css/styles.2a121ef9.css" as="style"><link rel="preload" href="/wiki/assets/js/768.e6d4205d.js" as="script"><link rel="preload" href="/wiki/assets/js/app.34e6f7f1.js" as="script">
    <link rel="prefetch" href="/wiki/assets/js/solution_smart-marketing_index.html.c6a04243.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_high-availability_index.html.1ef390b5.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_react_index.html.4aacb360.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_aiops_index.html.9565eae6.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_swift_index.html.26390310.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_embedded_index.html.1d42b838.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_nodejs_index.html.42d74f45.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_python_index.html.e9a522b3.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_spring-boot_index.html.38761574.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_java_jdk-changes_index.html.25824bdf.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_r_index.html.16153cc5.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_vue_index.html.63167ab5.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_java_concurrency_index.html.e362b849.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_java_advanced_index.html.71c33c5c.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_spring-cloud_index.html.fd0f185e.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_message-queue_index.html.b4b3c3e6.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_big-data_index.html.bbd64ec0.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_llm_index.html.09e48380.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_database_index.html.14a46108.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_java_basic_index.html.bddf19ef.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_ml_index.html.7188e38d.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_java_collections_index.html.0c5ba651.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_rl_index.html.6c114c3c.js" as="script"><link rel="prefetch" href="/wiki/assets/js/get-started.html.c4557635.js" as="script"><link rel="prefetch" href="/wiki/assets/js/index.html.c33a2346.js" as="script"><link rel="prefetch" href="/wiki/assets/js/404.html.a5b4614e.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/wiki/"><img class="vp-site-logo" src="/wiki/logo/logo.svg" alt="知识库"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">知识库</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/wiki/" aria-label="首页"><!--[--><!--[--><!--]--><!--]-->首页<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/wiki/get-started.html" aria-label="开始阅读"><!--[--><!--[--><!--]--><!--]-->开始阅读<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="Java"><span class="title">Java</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="Java"><span class="title">Java</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/basic/" aria-label="Java基础"><!--[--><!--[--><!--]--><!--]-->Java基础<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/advanced/" aria-label="Java高级"><!--[--><!--[--><!--]--><!--]-->Java高级<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/collections/" aria-label="Java集合详解"><!--[--><!--[--><!--]--><!--]-->Java集合详解<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/concurrency/" aria-label="Java多线程详解"><!--[--><!--[--><!--]--><!--]-->Java多线程详解<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/jdk-changes/" aria-label="JDK版本变化详解"><!--[--><!--[--><!--]--><!--]-->JDK版本变化详解<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="Spring"><span class="title">Spring</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="Spring"><span class="title">Spring</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/spring-boot/" aria-label="Spring Boot"><!--[--><!--[--><!--]--><!--]-->Spring Boot<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/spring-cloud/" aria-label="Spring Cloud"><!--[--><!--[--><!--]--><!--]-->Spring Cloud<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="解决方案"><span class="title">解决方案</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="解决方案"><span class="title">解决方案</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/solution/aiops/" aria-label="AIOps"><!--[--><!--[--><!--]--><!--]-->AIOps<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/solution/high-availability/" aria-label="高可用架构"><!--[--><!--[--><!--]--><!--]-->高可用架构<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link route-link-active auto-link" href="/wiki/solution/smart-marketing/" aria-label="智能营销"><!--[--><!--[--><!--]--><!--]-->智能营销<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/wiki/" aria-label="首页"><!--[--><!--[--><!--]--><!--]-->首页<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/wiki/get-started.html" aria-label="开始阅读"><!--[--><!--[--><!--]--><!--]-->开始阅读<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="Java"><span class="title">Java</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="Java"><span class="title">Java</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/basic/" aria-label="Java基础"><!--[--><!--[--><!--]--><!--]-->Java基础<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/advanced/" aria-label="Java高级"><!--[--><!--[--><!--]--><!--]-->Java高级<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/collections/" aria-label="Java集合详解"><!--[--><!--[--><!--]--><!--]-->Java集合详解<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/concurrency/" aria-label="Java多线程详解"><!--[--><!--[--><!--]--><!--]-->Java多线程详解<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/jdk-changes/" aria-label="JDK版本变化详解"><!--[--><!--[--><!--]--><!--]-->JDK版本变化详解<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="Spring"><span class="title">Spring</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="Spring"><span class="title">Spring</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/spring-boot/" aria-label="Spring Boot"><!--[--><!--[--><!--]--><!--]-->Spring Boot<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/spring-cloud/" aria-label="Spring Cloud"><!--[--><!--[--><!--]--><!--]-->Spring Cloud<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="解决方案"><span class="title">解决方案</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="解决方案"><span class="title">解决方案</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/solution/aiops/" aria-label="AIOps"><!--[--><!--[--><!--]--><!--]-->AIOps<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/solution/high-availability/" aria-label="高可用架构"><!--[--><!--[--><!--]--><!--]-->高可用架构<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link route-link-active auto-link" href="/wiki/solution/smart-marketing/" aria-label="智能营销"><!--[--><!--[--><!--]--><!--]-->智能营销<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><a class="route-link route-link-active auto-link vp-sidebar-item vp-sidebar-heading active" href="/wiki/solution/smart-marketing/" aria-label="智能营销解决方案"><!--[--><!--[--><!--]--><!--]-->智能营销解决方案<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div><h1 id="智能营销解决方案" tabindex="-1"><a class="header-anchor" href="#智能营销解决方案"><span>智能营销解决方案</span></a></h1><h2 id="_1-智能营销概述" tabindex="-1"><a class="header-anchor" href="#_1-智能营销概述"><span>1. 智能营销概述</span></a></h2><h3 id="q1-什么是智能营销-它解决了什么问题" tabindex="-1"><a class="header-anchor" href="#q1-什么是智能营销-它解决了什么问题"><span>Q1: 什么是智能营销？它解决了什么问题？</span></a></h3><p><strong>答：</strong> 智能营销（Smart Marketing）是运用人工智能、大数据分析、机器学习等技术，实现精准用户洞察、个性化推荐、自动化营销和效果优化的现代化营销方式。</p><p>解决的问题：</p><ul><li><strong>用户画像不精准</strong>：传统营销缺乏对用户的深度理解</li><li><strong>营销内容同质化</strong>：无法提供个性化的产品和服务推荐</li><li><strong>投放效率低下</strong>：广告投放缺乏精准定向，ROI不高</li><li><strong>营销时机把握不准</strong>：无法在最佳时机触达用户</li><li><strong>效果评估困难</strong>：缺乏有效的数据支撑和实时反馈机制</li></ul><h3 id="q2-智能营销的核心能力有哪些" tabindex="-1"><a class="header-anchor" href="#q2-智能营销的核心能力有哪些"><span>Q2: 智能营销的核心能力有哪些？</span></a></h3><p><strong>答：</strong> 智能营销的核心能力包括：</p><ol><li><p><strong>用户洞察</strong>：</p><ul><li>360度用户画像构建</li><li>用户行为分析和预测</li><li>用户分群和标签体系</li></ul></li><li><p><strong>个性化推荐</strong>：</p><ul><li>协同过滤算法</li><li>内容推荐系统</li><li>实时个性化引擎</li></ul></li><li><p><strong>精准投放</strong>：</p><ul><li>程序化广告投放</li><li>多渠道协同投放</li><li>动态创意优化</li></ul></li><li><p><strong>营销自动化</strong>：</p><ul><li>营销工作流自动化</li><li>智能客服和聊天机器人</li><li>生命周期营销管理</li></ul></li><li><p><strong>效果优化</strong>：</p><ul><li>A/B测试和多变量测试</li><li>实时效果监控</li><li>ROI优化算法</li></ul></li></ol><h3 id="q3-智能营销的技术架构" tabindex="-1"><a class="header-anchor" href="#q3-智能营销的技术架构"><span>Q3: 智能营销的技术架构？</span></a></h3><p><strong>答：</strong> 智能营销的典型技术架构分为以下几层：</p><ol><li><p><strong>数据层</strong>：</p><ul><li>数据采集：用户行为数据、交易数据、第三方数据</li><li>数据存储：数据仓库、数据湖、实时数据库</li><li>数据处理：ETL、流处理、批处理</li></ul></li><li><p><strong>平台层</strong>：</p><ul><li>用户画像平台：标签体系、人群管理</li><li>算法平台：推荐算法、预测模型</li><li>营销编排：工作流引擎、任务调度</li></ul></li><li><p><strong>应用层</strong>：</p><ul><li>个性化推荐：商品推荐、内容推荐</li><li>精准营销：广告投放、邮件营销</li><li>智能客服：聊天机器人、语音助手</li></ul></li><li><p><strong>交互层</strong>：</p><ul><li>营销控制台：可视化配置、效果监控</li><li>数据看板：实时报表、趋势分析</li><li>API接口：系统集成、第三方接入</li></ul></li></ol><h2 id="_2-用户画像与标签体系" tabindex="-1"><a class="header-anchor" href="#_2-用户画像与标签体系"><span>2. 用户画像与标签体系</span></a></h2><h3 id="q4-如何构建360度用户画像" tabindex="-1"><a class="header-anchor" href="#q4-如何构建360度用户画像"><span>Q4: 如何构建360度用户画像？</span></a></h3><p><strong>答：</strong> 360度用户画像需要整合多维度用户数据：</p><p><strong>用户画像数据维度</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">UserProfileBuilder</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>data_sources <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;behavioral&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>collect_behavioral_data<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;demographic&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>collect_demographic_data<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;transactional&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>collect_transactional_data<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;social&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>collect_social_data<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;psychographic&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>collect_psychographic_data</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">build_user_profile</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;构建完整的用户画像&quot;&quot;&quot;</span></span>
<span class="line">        profile <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;basic_info&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_get_basic_info<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;behavioral_traits&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_analyze_behavioral_traits<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;purchase_patterns&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_analyze_purchase_patterns<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;interest_preferences&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_analyze_interests<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;lifecycle_stage&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_determine_lifecycle_stage<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;value_segment&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_segment_user_value<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;risk_profile&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_assess_risk_profile<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> profile</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_analyze_behavioral_traits</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;分析行为特征&quot;&quot;&quot;</span></span>
<span class="line">        behaviors <span class="token operator">=</span> self<span class="token punctuation">.</span>collect_behavioral_data<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;activity_level&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_calculate_activity_level<span class="token punctuation">(</span>behaviors<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;engagement_score&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_calculate_engagement_score<span class="token punctuation">(</span>behaviors<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;device_preference&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_determine_device_preference<span class="token punctuation">(</span>behaviors<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;channel_affinity&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_analyze_channel_affinity<span class="token punctuation">(</span>behaviors<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;time_patterns&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_analyze_time_patterns<span class="token punctuation">(</span>behaviors<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_analyze_purchase_patterns</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;分析购买模式&quot;&quot;&quot;</span></span>
<span class="line">        transactions <span class="token operator">=</span> self<span class="token punctuation">.</span>collect_transactional_data<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;purchase_frequency&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_calculate_purchase_frequency<span class="token punctuation">(</span>transactions<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;avg_order_value&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_calculate_avg_order_value<span class="token punctuation">(</span>transactions<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;preferred_categories&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_identify_preferred_categories<span class="token punctuation">(</span>transactions<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;seasonal_patterns&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_analyze_seasonal_patterns<span class="token punctuation">(</span>transactions<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;payment_preferences&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_analyze_payment_preferences<span class="token punctuation">(</span>transactions<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="q5-用户标签体系设计" tabindex="-1"><a class="header-anchor" href="#q5-用户标签体系设计"><span>Q5: 用户标签体系设计？</span></a></h3><p><strong>答：</strong> 用户标签体系是用户画像的核心组成部分：</p><p><strong>标签分类体系</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">TagSystem</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>tag_categories <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;demographics&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&#39;age_group&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;18-24&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;25-34&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;35-44&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;45-54&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;55+&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;gender&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;male&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;female&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;other&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;location&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;first_tier_city&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;second_tier_city&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;third_tier_city&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;rural&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;education&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;high_school&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;bachelor&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;master&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;phd&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;occupation&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;student&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;professional&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;manager&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;entrepreneur&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;retired&#39;</span><span class="token punctuation">]</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;behavioral&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&#39;activity_level&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;very_active&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;active&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;moderate&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;low&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;inactive&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;engagement_type&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;browser&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;buyer&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;reviewer&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;sharer&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;loyal_customer&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;visit_frequency&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;daily&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;weekly&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;monthly&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;occasional&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;session_duration&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;short&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;medium&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;long&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;conversion_likelihood&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;high&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;medium&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;low&#39;</span><span class="token punctuation">]</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;transactional&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&#39;customer_value&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;vip&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;premium&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;standard&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;potential&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;spending_power&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;high&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;medium&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;low&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;purchase_frequency&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;frequent&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;regular&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;occasional&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;new&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;brand_loyalty&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;loyal&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;switcher&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;explorer&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;payment_method&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;credit_card&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;debit_card&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;mobile_payment&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;cash_on_delivery&#39;</span><span class="token punctuation">]</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;psychographic&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&#39;lifestyle&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;urban_professional&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;family_oriented&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;adventure_seeker&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;homebody&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;interests&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;technology&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;fashion&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;sports&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;travel&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;food&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;books&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;values&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;quality&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;price&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;convenience&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;brand&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;sustainability&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;shopping_style&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;impulse&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;research&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;deal_hunter&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;brand_loyal&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;media_consumption&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;social_media&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;traditional_media&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;online_news&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;blogs&#39;</span><span class="token punctuation">]</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">generate_dynamic_tags</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_profile<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;生成动态标签&quot;&quot;&quot;</span></span>
<span class="line">        dynamic_tags <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 基于RFM模型生成标签</span></span>
<span class="line">        rfm_score <span class="token operator">=</span> self<span class="token punctuation">.</span>_calculate_rfm_score<span class="token punctuation">(</span>user_profile<span class="token punctuation">)</span></span>
<span class="line">        dynamic_tags<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_rfm_tags<span class="token punctuation">(</span>rfm_score<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 基于行为模式生成标签</span></span>
<span class="line">        behavioral_score <span class="token operator">=</span> self<span class="token punctuation">.</span>_calculate_behavioral_score<span class="token punctuation">(</span>user_profile<span class="token punctuation">)</span></span>
<span class="line">        dynamic_tags<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_behavioral_tags<span class="token punctuation">(</span>behavioral_score<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 基于生命周期生成标签</span></span>
<span class="line">        lifecycle_stage <span class="token operator">=</span> self<span class="token punctuation">.</span>_determine_lifecycle_stage<span class="token punctuation">(</span>user_profile<span class="token punctuation">)</span></span>
<span class="line">        dynamic_tags<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#39;lifecycle_</span><span class="token interpolation"><span class="token punctuation">{</span>lifecycle_stage<span class="token punctuation">}</span></span><span class="token string">&#39;</span></span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> dynamic_tags</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_calculate_rfm_score</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_profile<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;计算RFM分数&quot;&quot;&quot;</span></span>
<span class="line">        recency <span class="token operator">=</span> user_profile<span class="token punctuation">[</span><span class="token string">&#39;transactional&#39;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&#39;days_since_last_purchase&#39;</span><span class="token punctuation">]</span></span>
<span class="line">        frequency <span class="token operator">=</span> user_profile<span class="token punctuation">[</span><span class="token string">&#39;transactional&#39;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&#39;purchase_frequency&#39;</span><span class="token punctuation">]</span></span>
<span class="line">        monetary <span class="token operator">=</span> user_profile<span class="token punctuation">[</span><span class="token string">&#39;transactional&#39;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&#39;avg_order_value&#39;</span><span class="token punctuation">]</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 标准化评分（1-5分）</span></span>
<span class="line">        r_score <span class="token operator">=</span> self<span class="token punctuation">.</span>_score_recency<span class="token punctuation">(</span>recency<span class="token punctuation">)</span></span>
<span class="line">        f_score <span class="token operator">=</span> self<span class="token punctuation">.</span>_score_frequency<span class="token punctuation">(</span>frequency<span class="token punctuation">)</span></span>
<span class="line">        m_score <span class="token operator">=</span> self<span class="token punctuation">.</span>_score_monetary<span class="token punctuation">(</span>monetary<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&#39;recency&#39;</span><span class="token punctuation">:</span> r_score<span class="token punctuation">,</span> <span class="token string">&#39;frequency&#39;</span><span class="token punctuation">:</span> f_score<span class="token punctuation">,</span> <span class="token string">&#39;monetary&#39;</span><span class="token punctuation">:</span> m_score<span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="q6-用户分群与细分" tabindex="-1"><a class="header-anchor" href="#q6-用户分群与细分"><span>Q6: 用户分群与细分？</span></a></h3><p><strong>答：</strong> 用户分群是实现精准营销的基础：</p><p><strong>聚类分析算法</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np</span>
<span class="line"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>cluster <span class="token keyword">import</span> KMeans</span>
<span class="line"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> StandardScaler</span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">UserSegmentation</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>scaler <span class="token operator">=</span> StandardScaler<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>clustering_model <span class="token operator">=</span> <span class="token boolean">None</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">segment_users</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_features<span class="token punctuation">,</span> n_clusters<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;用户分群&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token comment"># 数据标准化</span></span>
<span class="line">        scaled_features <span class="token operator">=</span> self<span class="token punctuation">.</span>scaler<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>user_features<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># K-means聚类</span></span>
<span class="line">        self<span class="token punctuation">.</span>clustering_model <span class="token operator">=</span> KMeans<span class="token punctuation">(</span>n_clusters<span class="token operator">=</span>n_clusters<span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span></span>
<span class="line">        cluster_labels <span class="token operator">=</span> self<span class="token punctuation">.</span>clustering_model<span class="token punctuation">.</span>fit_predict<span class="token punctuation">(</span>scaled_features<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 分析各群体特征</span></span>
<span class="line">        segments <span class="token operator">=</span> self<span class="token punctuation">.</span>_analyze_segments<span class="token punctuation">(</span>user_features<span class="token punctuation">,</span> cluster_labels<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;cluster_labels&#39;</span><span class="token punctuation">:</span> cluster_labels<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;segments&#39;</span><span class="token punctuation">:</span> segments<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;model&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>clustering_model</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_analyze_segments</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> features<span class="token punctuation">,</span> labels<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;分析各群体特征&quot;&quot;&quot;</span></span>
<span class="line">        segments <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">        unique_labels <span class="token operator">=</span> np<span class="token punctuation">.</span>unique<span class="token punctuation">(</span>labels<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">for</span> label <span class="token keyword">in</span> unique_labels<span class="token punctuation">:</span></span>
<span class="line">            segment_indices <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>labels <span class="token operator">==</span> label<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>
<span class="line">            segment_features <span class="token operator">=</span> features<span class="token punctuation">[</span>segment_indices<span class="token punctuation">]</span></span>
<span class="line">            </span>
<span class="line">            segments<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f&#39;segment_</span><span class="token interpolation"><span class="token punctuation">{</span>label<span class="token punctuation">}</span></span><span class="token string">&#39;</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&#39;size&#39;</span><span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span>segment_indices<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;percentage&#39;</span><span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span>segment_indices<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>features<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;characteristics&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_extract_characteristics<span class="token punctuation">(</span>segment_features<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;marketing_strategy&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_suggest_marketing_strategy<span class="token punctuation">(</span>label<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> segments</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_extract_characteristics</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> segment_features<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;提取群体特征&quot;&quot;&quot;</span></span>
<span class="line">        characteristics <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 计算各项指标的均值和标准差</span></span>
<span class="line">        means <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>segment_features<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">        stds <span class="token operator">=</span> np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>segment_features<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        characteristics<span class="token punctuation">[</span><span class="token string">&#39;avg_values&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> means<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        characteristics<span class="token punctuation">[</span><span class="token string">&#39;std_deviation&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> stds<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        characteristics<span class="token punctuation">[</span><span class="token string">&#39;feature_importance&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>_calculate_feature_importance<span class="token punctuation">(</span>segment_features<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> characteristics</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">predict_segment</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> new_user_features<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;预测新用户所属群体&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>clustering_model <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">&quot;Clustering model not trained yet&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        scaled_features <span class="token operator">=</span> self<span class="token punctuation">.</span>scaler<span class="token punctuation">.</span>transform<span class="token punctuation">(</span><span class="token punctuation">[</span>new_user_features<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        predicted_cluster <span class="token operator">=</span> self<span class="token punctuation">.</span>clustering_model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>scaled_features<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> predicted_cluster</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-个性化推荐系统" tabindex="-1"><a class="header-anchor" href="#_3-个性化推荐系统"><span>3. 个性化推荐系统</span></a></h2><h3 id="q7-推荐算法原理与实现" tabindex="-1"><a class="header-anchor" href="#q7-推荐算法原理与实现"><span>Q7: 推荐算法原理与实现？</span></a></h3><p><strong>答：</strong> 个性化推荐系统的核心算法包括：</p><p><strong>协同过滤算法</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np</span>
<span class="line"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>pairwise <span class="token keyword">import</span> cosine_similarity</span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">CollaborativeFiltering</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>user_item_matrix <span class="token operator">=</span> <span class="token boolean">None</span></span>
<span class="line">        self<span class="token punctuation">.</span>item_similarity_matrix <span class="token operator">=</span> <span class="token boolean">None</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">build_user_item_matrix</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> interactions<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;构建用户-物品交互矩阵&quot;&quot;&quot;</span></span>
<span class="line">        users <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>interaction<span class="token punctuation">[</span><span class="token string">&#39;user_id&#39;</span><span class="token punctuation">]</span> <span class="token keyword">for</span> interaction <span class="token keyword">in</span> interactions<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        items <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>interaction<span class="token punctuation">[</span><span class="token string">&#39;item_id&#39;</span><span class="token punctuation">]</span> <span class="token keyword">for</span> interaction <span class="token keyword">in</span> interactions<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 创建用户和物品的索引映射</span></span>
<span class="line">        user_to_idx <span class="token operator">=</span> <span class="token punctuation">{</span>user<span class="token punctuation">:</span> idx <span class="token keyword">for</span> idx<span class="token punctuation">,</span> user <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">}</span></span>
<span class="line">        item_to_idx <span class="token operator">=</span> <span class="token punctuation">{</span>item<span class="token punctuation">:</span> idx <span class="token keyword">for</span> idx<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 初始化矩阵</span></span>
<span class="line">        matrix <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 填充交互数据</span></span>
<span class="line">        <span class="token keyword">for</span> interaction <span class="token keyword">in</span> interactions<span class="token punctuation">:</span></span>
<span class="line">            user_idx <span class="token operator">=</span> user_to_idx<span class="token punctuation">[</span>interaction<span class="token punctuation">[</span><span class="token string">&#39;user_id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">]</span></span>
<span class="line">            item_idx <span class="token operator">=</span> item_to_idx<span class="token punctuation">[</span>interaction<span class="token punctuation">[</span><span class="token string">&#39;item_id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">]</span></span>
<span class="line">            matrix<span class="token punctuation">[</span>user_idx<span class="token punctuation">]</span><span class="token punctuation">[</span>item_idx<span class="token punctuation">]</span> <span class="token operator">=</span> interaction<span class="token punctuation">[</span><span class="token string">&#39;rating&#39;</span><span class="token punctuation">]</span></span>
<span class="line">        </span>
<span class="line">        self<span class="token punctuation">.</span>user_item_matrix <span class="token operator">=</span> matrix</span>
<span class="line">        self<span class="token punctuation">.</span>user_to_idx <span class="token operator">=</span> user_to_idx</span>
<span class="line">        self<span class="token punctuation">.</span>item_to_idx <span class="token operator">=</span> item_to_idx</span>
<span class="line">        self<span class="token punctuation">.</span>idx_to_user <span class="token operator">=</span> <span class="token punctuation">{</span>idx<span class="token punctuation">:</span> user <span class="token keyword">for</span> user<span class="token punctuation">,</span> idx <span class="token keyword">in</span> user_to_idx<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>
<span class="line">        self<span class="token punctuation">.</span>idx_to_item <span class="token operator">=</span> <span class="token punctuation">{</span>idx<span class="token punctuation">:</span> item <span class="token keyword">for</span> item<span class="token punctuation">,</span> idx <span class="token keyword">in</span> item_to_idx<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> matrix</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">compute_item_similarity</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;计算物品相似度矩阵&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>user_item_matrix <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">&quot;User-item matrix not built yet&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 使用余弦相似度计算物品间相似度</span></span>
<span class="line">        self<span class="token punctuation">.</span>item_similarity_matrix <span class="token operator">=</span> cosine_similarity<span class="token punctuation">(</span>self<span class="token punctuation">.</span>user_item_matrix<span class="token punctuation">.</span>T<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> self<span class="token punctuation">.</span>item_similarity_matrix</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">recommend_items_user_based</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> n_recommendations<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;基于用户的协同过滤推荐&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token keyword">if</span> user_id <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>user_to_idx<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        </span>
<span class="line">        user_idx <span class="token operator">=</span> self<span class="token punctuation">.</span>user_to_idx<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span></span>
<span class="line">        user_ratings <span class="token operator">=</span> self<span class="token punctuation">.</span>user_item_matrix<span class="token punctuation">[</span>user_idx<span class="token punctuation">]</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 找到相似用户</span></span>
<span class="line">        user_similarities <span class="token operator">=</span> cosine_similarity<span class="token punctuation">(</span><span class="token punctuation">[</span>user_ratings<span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>user_item_matrix<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 预测评分</span></span>
<span class="line">        predicted_ratings <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>self<span class="token punctuation">.</span>user_item_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">for</span> item_idx <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>user_item_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">if</span> user_ratings<span class="token punctuation">[</span>item_idx<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># 用户未评分的物品</span></span>
<span class="line">                weighted_sum <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">                similarity_sum <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">                </span>
<span class="line">                <span class="token keyword">for</span> other_user_idx <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>user_item_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">                    <span class="token keyword">if</span> other_user_idx <span class="token operator">!=</span> user_idx <span class="token keyword">and</span> self<span class="token punctuation">.</span>user_item_matrix<span class="token punctuation">[</span>other_user_idx<span class="token punctuation">]</span><span class="token punctuation">[</span>item_idx<span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span></span>
<span class="line">                        similarity <span class="token operator">=</span> user_similarities<span class="token punctuation">[</span>other_user_idx<span class="token punctuation">]</span></span>
<span class="line">                        rating <span class="token operator">=</span> self<span class="token punctuation">.</span>user_item_matrix<span class="token punctuation">[</span>other_user_idx<span class="token punctuation">]</span><span class="token punctuation">[</span>item_idx<span class="token punctuation">]</span></span>
<span class="line">                        weighted_sum <span class="token operator">+=</span> similarity <span class="token operator">*</span> rating</span>
<span class="line">                        similarity_sum <span class="token operator">+=</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>similarity<span class="token punctuation">)</span></span>
<span class="line">                </span>
<span class="line">                <span class="token keyword">if</span> similarity_sum <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span></span>
<span class="line">                    predicted_ratings<span class="token punctuation">[</span>item_idx<span class="token punctuation">]</span> <span class="token operator">=</span> weighted_sum <span class="token operator">/</span> similarity_sum</span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 获取推荐物品</span></span>
<span class="line">        recommended_items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        top_indices <span class="token operator">=</span> np<span class="token punctuation">.</span>argsort<span class="token punctuation">(</span>predicted_ratings<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span>n_recommendations<span class="token punctuation">]</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">for</span> idx <span class="token keyword">in</span> top_indices<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">if</span> predicted_ratings<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span></span>
<span class="line">                recommended_items<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token string">&#39;item_id&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>idx_to_item<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&#39;predicted_rating&#39;</span><span class="token punctuation">:</span> predicted_ratings<span class="token punctuation">[</span>idx<span class="token punctuation">]</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> recommended_items</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>内容推荐算法</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>feature_extraction<span class="token punctuation">.</span>text <span class="token keyword">import</span> TfidfVectorizer</span>
<span class="line"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>pairwise <span class="token keyword">import</span> linear_kernel</span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">ContentBasedRecommender</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>tfidf_vectorizer <span class="token operator">=</span> TfidfVectorizer<span class="token punctuation">(</span>stop_words<span class="token operator">=</span><span class="token string">&#39;english&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>item_profiles <span class="token operator">=</span> <span class="token boolean">None</span></span>
<span class="line">        self<span class="token punctuation">.</span>item_similarity_matrix <span class="token operator">=</span> <span class="token boolean">None</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">build_item_profiles</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> items<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;构建物品内容画像&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token comment"># 合并物品的各种文本特征</span></span>
<span class="line">        item_descriptions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token keyword">for</span> item <span class="token keyword">in</span> items<span class="token punctuation">:</span></span>
<span class="line">            description <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>item<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;title&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>item<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;description&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> &quot;</span></span></span>
<span class="line">            description <span class="token operator">+=</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>item<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;categories&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39; &#39;</span></span>
<span class="line">            description <span class="token operator">+=</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>item<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;tags&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            item_descriptions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>description<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 计算TF-IDF向量</span></span>
<span class="line">        tfidf_matrix <span class="token operator">=</span> self<span class="token punctuation">.</span>tfidf_vectorizer<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>item_descriptions<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        self<span class="token punctuation">.</span>item_profiles <span class="token operator">=</span> tfidf_matrix</span>
<span class="line">        self<span class="token punctuation">.</span>items <span class="token operator">=</span> items</span>
<span class="line">        self<span class="token punctuation">.</span>item_ids <span class="token operator">=</span> <span class="token punctuation">[</span>item<span class="token punctuation">[</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">]</span> <span class="token keyword">for</span> item <span class="token keyword">in</span> items<span class="token punctuation">]</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> tfidf_matrix</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">compute_item_similarity</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;计算物品相似度&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>item_profiles <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">&quot;Item profiles not built yet&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 计算余弦相似度</span></span>
<span class="line">        self<span class="token punctuation">.</span>item_similarity_matrix <span class="token operator">=</span> linear_kernel<span class="token punctuation">(</span>self<span class="token punctuation">.</span>item_profiles<span class="token punctuation">,</span> self<span class="token punctuation">.</span>item_profiles<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> self<span class="token punctuation">.</span>item_similarity_matrix</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">recommend_items</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item_id<span class="token punctuation">,</span> n_recommendations<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;基于内容的推荐&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token keyword">if</span> item_id <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>item_ids<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 找到物品索引</span></span>
<span class="line">        item_idx <span class="token operator">=</span> self<span class="token punctuation">.</span>item_ids<span class="token punctuation">.</span>index<span class="token punctuation">(</span>item_id<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 获取相似度分数</span></span>
<span class="line">        similarity_scores <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>item_similarity_matrix<span class="token punctuation">[</span>item_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 按相似度排序</span></span>
<span class="line">        similarity_scores <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>similarity_scores<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 获取推荐物品</span></span>
<span class="line">        recommendations <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>idx<span class="token punctuation">,</span> score<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>similarity_scores<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span>n_recommendations<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 跳过自己</span></span>
<span class="line">            <span class="token keyword">if</span> score <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span></span>
<span class="line">                recommendations<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token string">&#39;item_id&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>item_ids<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&#39;similarity_score&#39;</span><span class="token punctuation">:</span> score<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&#39;item_info&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>items<span class="token punctuation">[</span>idx<span class="token punctuation">]</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> recommendations</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="q8-实时推荐引擎" tabindex="-1"><a class="header-anchor" href="#q8-实时推荐引擎"><span>Q8: 实时推荐引擎？</span></a></h3><p><strong>答：</strong> 实时推荐引擎需要快速响应用户行为变化：</p><p><strong>实时推荐系统架构</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> redis</span>
<span class="line"><span class="token keyword">import</span> json</span>
<span class="line"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta</span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">RealTimeRecommender</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> redis_client<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>redis <span class="token operator">=</span> redis_client</span>
<span class="line">        self<span class="token punctuation">.</span>cf_recommender <span class="token operator">=</span> CollaborativeFiltering<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>content_recommender <span class="token operator">=</span> ContentBasedRecommender<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">update_user_behavior</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> item_id<span class="token punctuation">,</span> action<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;更新用户行为数据&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token keyword">if</span> timestamp <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span></span>
<span class="line">            timestamp <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 存储用户最近行为</span></span>
<span class="line">        behavior_key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;user:</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">:recent_behaviors&quot;</span></span></span>
<span class="line">        behavior_data <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;item_id&#39;</span><span class="token punctuation">:</span> item_id<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;action&#39;</span><span class="token punctuation">:</span> action<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;timestamp&#39;</span><span class="token punctuation">:</span> timestamp</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 使用Redis列表存储最近100个行为</span></span>
<span class="line">        self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>lpush<span class="token punctuation">(</span>behavior_key<span class="token punctuation">,</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>behavior_data<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>ltrim<span class="token punctuation">(</span>behavior_key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 更新用户兴趣标签</span></span>
<span class="line">        self<span class="token punctuation">.</span>_update_user_interests<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> item_id<span class="token punctuation">,</span> action<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 触发实时推荐计算</span></span>
<span class="line">        self<span class="token punctuation">.</span>_trigger_real_time_recommendations<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_update_user_interests</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> item_id<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;更新用户兴趣标签&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token comment"># 获取物品标签</span></span>
<span class="line">        item_tags <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_item_tags<span class="token punctuation">(</span>item_id<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 根据行为类型调整权重</span></span>
<span class="line">        weight_multiplier <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;view&#39;</span><span class="token punctuation">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;click&#39;</span><span class="token punctuation">:</span> <span class="token number">1.5</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;purchase&#39;</span><span class="token punctuation">:</span> <span class="token number">2.0</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;favorite&#39;</span><span class="token punctuation">:</span> <span class="token number">1.8</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;share&#39;</span><span class="token punctuation">:</span> <span class="token number">1.7</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>action<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 更新用户标签权重</span></span>
<span class="line">        <span class="token keyword">for</span> tag <span class="token keyword">in</span> item_tags<span class="token punctuation">:</span></span>
<span class="line">            tag_key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;user:</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">:tag_weights:</span><span class="token interpolation"><span class="token punctuation">{</span>tag<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span></span>
<span class="line">            current_weight <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>get<span class="token punctuation">(</span>tag_key<span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">            new_weight <span class="token operator">=</span> current_weight <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> weight_multiplier<span class="token punctuation">)</span></span>
<span class="line">            self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>tag_key<span class="token punctuation">,</span> new_weight<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get_real_time_recommendations</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> n_recommendations<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;获取实时推荐&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token comment"># 检查缓存</span></span>
<span class="line">        cache_key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;user:</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">:recommendations&quot;</span></span></span>
<span class="line">        cached_recommendations <span class="token operator">=</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>get<span class="token punctuation">(</span>cache_key<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> cached_recommendations<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>cached_recommendations<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 计算实时推荐</span></span>
<span class="line">        recommendations <span class="token operator">=</span> self<span class="token punctuation">.</span>_compute_real_time_recommendations<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> n_recommendations<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 缓存结果（5分钟过期）</span></span>
<span class="line">        self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>setex<span class="token punctuation">(</span>cache_key<span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>recommendations<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> recommendations</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_compute_real_time_recommendations</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> n_recommendations<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;计算实时推荐&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token comment"># 1. 基于用户最近行为推荐</span></span>
<span class="line">        recent_items <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_recent_interacted_items<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 2. 基于用户兴趣标签推荐</span></span>
<span class="line">        interest_based_items <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_interest_based_recommendations<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 3. 基于热门物品推荐</span></span>
<span class="line">        trending_items <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_trending_items<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 4. 混合推荐结果</span></span>
<span class="line">        recommendations <span class="token operator">=</span> self<span class="token punctuation">.</span>_merge_recommendations<span class="token punctuation">(</span><span class="token punctuation">[</span></span>
<span class="line">            recent_items<span class="token punctuation">,</span></span>
<span class="line">            interest_based_items<span class="token punctuation">,</span></span>
<span class="line">            trending_items</span>
<span class="line">        <span class="token punctuation">]</span><span class="token punctuation">,</span> n_recommendations<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> recommendations</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_get_recent_interacted_items</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> limit<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;获取最近交互的物品&quot;&quot;&quot;</span></span>
<span class="line">        behavior_key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;user:</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">:recent_behaviors&quot;</span></span></span>
<span class="line">        recent_behaviors <span class="token operator">=</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>lrange<span class="token punctuation">(</span>behavior_key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> limit<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        item_ids <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token keyword">for</span> behavior_json <span class="token keyword">in</span> recent_behaviors<span class="token punctuation">:</span></span>
<span class="line">            behavior <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>behavior_json<span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment"># 基于最近交互的物品推荐相似物品</span></span>
<span class="line">            similar_items <span class="token operator">=</span> self<span class="token punctuation">.</span>content_recommender<span class="token punctuation">.</span>recommend_items<span class="token punctuation">(</span></span>
<span class="line">                behavior<span class="token punctuation">[</span><span class="token string">&#39;item_id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span></span>
<span class="line">            <span class="token punctuation">)</span></span>
<span class="line">            item_ids<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">[</span>item<span class="token punctuation">[</span><span class="token string">&#39;item_id&#39;</span><span class="token punctuation">]</span> <span class="token keyword">for</span> item <span class="token keyword">in</span> similar_items<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>item_ids<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span>limit<span class="token punctuation">]</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_get_interest_based_recommendations</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> limit<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;基于兴趣的推荐&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token comment"># 获取用户标签权重</span></span>
<span class="line">        tag_pattern <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;user:</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">:tag_weights:*&quot;</span></span></span>
<span class="line">        tag_keys <span class="token operator">=</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>keys<span class="token punctuation">(</span>tag_pattern<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        weighted_items <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">for</span> tag_key <span class="token keyword">in</span> tag_keys<span class="token punctuation">:</span></span>
<span class="line">            tag <span class="token operator">=</span> tag_key<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&#39;:&#39;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span></span>
<span class="line">            weight <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>get<span class="token punctuation">(</span>tag_key<span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment"># 获取具有该标签的热门物品</span></span>
<span class="line">            items_with_tag <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_items_by_tag<span class="token punctuation">(</span>tag<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">for</span> item_id <span class="token keyword">in</span> items_with_tag<span class="token punctuation">:</span></span>
<span class="line">                <span class="token keyword">if</span> item_id <span class="token keyword">not</span> <span class="token keyword">in</span> weighted_items<span class="token punctuation">:</span></span>
<span class="line">                    weighted_items<span class="token punctuation">[</span>item_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">                weighted_items<span class="token punctuation">[</span>item_id<span class="token punctuation">]</span> <span class="token operator">+=</span> weight</span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 按权重排序</span></span>
<span class="line">        sorted_items <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>weighted_items<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">[</span>item_id <span class="token keyword">for</span> item_id<span class="token punctuation">,</span> weight <span class="token keyword">in</span> sorted_items<span class="token punctuation">[</span><span class="token punctuation">:</span>limit<span class="token punctuation">]</span><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-精准营销投放" tabindex="-1"><a class="header-anchor" href="#_4-精准营销投放"><span>4. 精准营销投放</span></a></h2><h3 id="q9-程序化广告投放系统" tabindex="-1"><a class="header-anchor" href="#q9-程序化广告投放系统"><span>Q9: 程序化广告投放系统？</span></a></h3><p><strong>答：</strong> 程序化广告投放系统实现自动化竞价和投放：</p><p><strong>RTB（实时竞价）系统</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> uuid</span>
<span class="line"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime</span>
<span class="line"><span class="token keyword">from</span> dataclasses <span class="token keyword">import</span> dataclass</span>
<span class="line"></span>
<span class="line"><span class="token decorator annotation punctuation">@dataclass</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">BidRequest</span><span class="token punctuation">:</span></span>
<span class="line">    auction_id<span class="token punctuation">:</span> <span class="token builtin">str</span></span>
<span class="line">    user_id<span class="token punctuation">:</span> <span class="token builtin">str</span></span>
<span class="line">    device_info<span class="token punctuation">:</span> <span class="token builtin">dict</span></span>
<span class="line">    geo_info<span class="token punctuation">:</span> <span class="token builtin">dict</span></span>
<span class="line">    ad_slot<span class="token punctuation">:</span> <span class="token builtin">dict</span></span>
<span class="line">    timestamp<span class="token punctuation">:</span> datetime</span>
<span class="line"></span>
<span class="line"><span class="token decorator annotation punctuation">@dataclass</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">BidResponse</span><span class="token punctuation">:</span></span>
<span class="line">    auction_id<span class="token punctuation">:</span> <span class="token builtin">str</span></span>
<span class="line">    bid_price<span class="token punctuation">:</span> <span class="token builtin">float</span></span>
<span class="line">    ad_creative<span class="token punctuation">:</span> <span class="token builtin">str</span></span>
<span class="line">    targeting_criteria<span class="token punctuation">:</span> <span class="token builtin">dict</span></span>
<span class="line">    win_notice_url<span class="token punctuation">:</span> <span class="token builtin">str</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">ProgrammaticAdPlatform</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>bidder <span class="token operator">=</span> RealTimeBidder<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>campaign_manager <span class="token operator">=</span> CampaignManager<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>user_profiler <span class="token operator">=</span> UserProfileBuilder<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>ad_server <span class="token operator">=</span> AdServer<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">handle_bid_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> bid_request<span class="token punctuation">:</span> BidRequest<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> BidResponse<span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;处理竞价请求&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token comment"># 1. 用户画像分析</span></span>
<span class="line">        user_profile <span class="token operator">=</span> self<span class="token punctuation">.</span>user_profiler<span class="token punctuation">.</span>get_user_profile<span class="token punctuation">(</span>bid_request<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 2. 匹配活跃广告活动</span></span>
<span class="line">        active_campaigns <span class="token operator">=</span> self<span class="token punctuation">.</span>campaign_manager<span class="token punctuation">.</span>get_active_campaigns<span class="token punctuation">(</span></span>
<span class="line">            bid_request<span class="token punctuation">.</span>ad_slot<span class="token punctuation">,</span> user_profile</span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> active_campaigns<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">None</span>  <span class="token comment"># 无匹配广告</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 3. 计算竞价价格</span></span>
<span class="line">        winning_campaign <span class="token operator">=</span> self<span class="token punctuation">.</span>_select_winning_campaign<span class="token punctuation">(</span></span>
<span class="line">            active_campaigns<span class="token punctuation">,</span> user_profile<span class="token punctuation">,</span> bid_request</span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> winning_campaign<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">None</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 4. 生成竞价响应</span></span>
<span class="line">        bid_response <span class="token operator">=</span> BidResponse<span class="token punctuation">(</span></span>
<span class="line">            auction_id<span class="token operator">=</span>bid_request<span class="token punctuation">.</span>auction_id<span class="token punctuation">,</span></span>
<span class="line">            bid_price<span class="token operator">=</span>self<span class="token punctuation">.</span>_calculate_bid_price<span class="token punctuation">(</span>winning_campaign<span class="token punctuation">,</span> user_profile<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            ad_creative<span class="token operator">=</span>winning_campaign<span class="token punctuation">.</span>creative_id<span class="token punctuation">,</span></span>
<span class="line">            targeting_criteria<span class="token operator">=</span>winning_campaign<span class="token punctuation">.</span>targeting<span class="token punctuation">,</span></span>
<span class="line">            win_notice_url<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f&quot;/win_notice/</span><span class="token interpolation"><span class="token punctuation">{</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> bid_response</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_select_winning_campaign</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> campaigns<span class="token punctuation">,</span> user_profile<span class="token punctuation">,</span> bid_request<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;选择获胜广告活动&quot;&quot;&quot;</span></span>
<span class="line">        campaign_scores <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">for</span> campaign <span class="token keyword">in</span> campaigns<span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 计算匹配度分数</span></span>
<span class="line">            relevance_score <span class="token operator">=</span> self<span class="token punctuation">.</span>_calculate_relevance_score<span class="token punctuation">(</span></span>
<span class="line">                campaign<span class="token punctuation">.</span>targeting<span class="token punctuation">,</span> user_profile<span class="token punctuation">,</span> bid_request</span>
<span class="line">            <span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment"># 计算预算充足度</span></span>
<span class="line">            budget_score <span class="token operator">=</span> self<span class="token punctuation">.</span>_calculate_budget_score<span class="token punctuation">(</span>campaign<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment"># 计算历史表现</span></span>
<span class="line">            performance_score <span class="token operator">=</span> self<span class="token punctuation">.</span>_calculate_performance_score<span class="token punctuation">(</span>campaign<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment"># 综合评分</span></span>
<span class="line">            total_score <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">                relevance_score <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">+</span></span>
<span class="line">                budget_score <span class="token operator">*</span> <span class="token number">0.3</span> <span class="token operator">+</span></span>
<span class="line">                performance_score <span class="token operator">*</span> <span class="token number">0.2</span></span>
<span class="line">            <span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            campaign_scores<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>campaign<span class="token punctuation">,</span> total_score<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 选择最高分的广告活动</span></span>
<span class="line">        <span class="token keyword">if</span> campaign_scores<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token builtin">max</span><span class="token punctuation">(</span>campaign_scores<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">None</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_calculate_bid_price</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> campaign<span class="token punctuation">,</span> user_profile<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;计算竞价价格&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token comment"># 基础出价</span></span>
<span class="line">        base_bid <span class="token operator">=</span> campaign<span class="token punctuation">.</span>base_bid</span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 用户价值调整</span></span>
<span class="line">        user_value_multiplier <span class="token operator">=</span> self<span class="token punctuation">.</span>_calculate_user_value<span class="token punctuation">(</span>user_profile<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 时间因素调整</span></span>
<span class="line">        time_multiplier <span class="token operator">=</span> self<span class="token punctuation">.</span>_calculate_time_factor<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 竞争对手分析调整</span></span>
<span class="line">        competition_multiplier <span class="token operator">=</span> self<span class="token punctuation">.</span>_analyze_competition<span class="token punctuation">(</span>campaign<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        final_bid <span class="token operator">=</span> base_bid <span class="token operator">*</span> user_value_multiplier <span class="token operator">*</span> time_multiplier <span class="token operator">*</span> competition_multiplier</span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 确保不超过预算限制</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token builtin">min</span><span class="token punctuation">(</span>final_bid<span class="token punctuation">,</span> campaign<span class="token punctuation">.</span>daily_budget_remaining <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">handle_win_notification</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> auction_id<span class="token punctuation">,</span> winning_price<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;处理竞价获胜通知&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token comment"># 记录花费</span></span>
<span class="line">        self<span class="token punctuation">.</span>campaign_manager<span class="token punctuation">.</span>record_spend<span class="token punctuation">(</span>auction_id<span class="token punctuation">,</span> winning_price<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 更新统计数据</span></span>
<span class="line">        self<span class="token punctuation">.</span>_update_campaign_stats<span class="token punctuation">(</span>auction_id<span class="token punctuation">,</span> winning_price<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 触发广告展示</span></span>
<span class="line">        self<span class="token punctuation">.</span>ad_server<span class="token punctuation">.</span>serve_ad<span class="token punctuation">(</span>auction_id<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="q10-多渠道协同营销" tabindex="-1"><a class="header-anchor" href="#q10-多渠道协同营销"><span>Q10: 多渠道协同营销？</span></a></h3><p><strong>答：</strong> 多渠道协同营销实现全触点用户覆盖：</p><p><strong>跨渠道营销编排</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> enum <span class="token keyword">import</span> Enum</span>
<span class="line"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta</span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">ChannelType</span><span class="token punctuation">(</span>Enum<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    EMAIL <span class="token operator">=</span> <span class="token string">&quot;email&quot;</span></span>
<span class="line">    SMS <span class="token operator">=</span> <span class="token string">&quot;sms&quot;</span></span>
<span class="line">    PUSH_NOTIFICATION <span class="token operator">=</span> <span class="token string">&quot;push&quot;</span></span>
<span class="line">    WECHAT <span class="token operator">=</span> <span class="token string">&quot;wechat&quot;</span></span>
<span class="line">    DISPLAY_AD <span class="token operator">=</span> <span class="token string">&quot;display_ad&quot;</span></span>
<span class="line">    SOCIAL_MEDIA <span class="token operator">=</span> <span class="token string">&quot;social_media&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">CrossChannelOrchestrator</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>channels <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            ChannelType<span class="token punctuation">.</span>EMAIL<span class="token punctuation">:</span> EmailChannel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            ChannelType<span class="token punctuation">.</span>SMS<span class="token punctuation">:</span> SMSChannel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            ChannelType<span class="token punctuation">.</span>PUSH_NOTIFICATION<span class="token punctuation">:</span> PushNotificationChannel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            ChannelType<span class="token punctuation">.</span>WECHAT<span class="token punctuation">:</span> WeChatChannel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            ChannelType<span class="token punctuation">.</span>DISPLAY_AD<span class="token punctuation">:</span> DisplayAdChannel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            ChannelType<span class="token punctuation">.</span>SOCIAL_MEDIA<span class="token punctuation">:</span> SocialMediaChannel<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        self<span class="token punctuation">.</span>journey_manager <span class="token operator">=</span> CustomerJourneyManager<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">create_marketing_journey</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> campaign_goal<span class="token punctuation">,</span> channels_sequence<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;创建跨渠道营销旅程&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token keyword">if</span> channels_sequence <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 基于用户偏好和行为自动选择渠道</span></span>
<span class="line">            channels_sequence <span class="token operator">=</span> self<span class="token punctuation">.</span>_optimize_channel_sequence<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> campaign_goal<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        journey <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;journey_id&#39;</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;user_id&#39;</span><span class="token punctuation">:</span> user_id<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;goal&#39;</span><span class="token punctuation">:</span> campaign_goal<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;channels&#39;</span><span class="token punctuation">:</span> channels_sequence<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;created_at&#39;</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;status&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;planned&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;executed_steps&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 保存旅程配置</span></span>
<span class="line">        self<span class="token punctuation">.</span>journey_manager<span class="token punctuation">.</span>save_journey<span class="token punctuation">(</span>journey<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> journey</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">execute_journey_step</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> journey_id<span class="token punctuation">,</span> step_index<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;执行旅程步骤&quot;&quot;&quot;</span></span>
<span class="line">        journey <span class="token operator">=</span> self<span class="token punctuation">.</span>journey_manager<span class="token punctuation">.</span>get_journey<span class="token punctuation">(</span>journey_id<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> journey <span class="token keyword">or</span> step_index <span class="token operator">&gt;=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>journey<span class="token punctuation">[</span><span class="token string">&#39;channels&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">False</span></span>
<span class="line">        </span>
<span class="line">        channel_type <span class="token operator">=</span> journey<span class="token punctuation">[</span><span class="token string">&#39;channels&#39;</span><span class="token punctuation">]</span><span class="token punctuation">[</span>step_index<span class="token punctuation">]</span></span>
<span class="line">        channel <span class="token operator">=</span> self<span class="token punctuation">.</span>channels<span class="token punctuation">.</span>get<span class="token punctuation">(</span>channel_type<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> channel<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">False</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 个性化内容生成</span></span>
<span class="line">        personalized_content <span class="token operator">=</span> self<span class="token punctuation">.</span>_generate_personalized_content<span class="token punctuation">(</span></span>
<span class="line">            journey<span class="token punctuation">[</span><span class="token string">&#39;user_id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> channel_type<span class="token punctuation">,</span> journey<span class="token punctuation">[</span><span class="token string">&#39;goal&#39;</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 发送消息</span></span>
<span class="line">        send_result <span class="token operator">=</span> channel<span class="token punctuation">.</span>send_message<span class="token punctuation">(</span></span>
<span class="line">            journey<span class="token punctuation">[</span><span class="token string">&#39;user_id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> </span>
<span class="line">            personalized_content<span class="token punctuation">,</span></span>
<span class="line">            journey_id</span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 记录执行结果</span></span>
<span class="line">        execution_record <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;step_index&#39;</span><span class="token punctuation">:</span> step_index<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;channel&#39;</span><span class="token punctuation">:</span> channel_type<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;sent_at&#39;</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;result&#39;</span><span class="token punctuation">:</span> send_result<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;content_preview&#39;</span><span class="token punctuation">:</span> personalized_content<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;subject&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        self<span class="token punctuation">.</span>journey_manager<span class="token punctuation">.</span>record_step_execution<span class="token punctuation">(</span>journey_id<span class="token punctuation">,</span> execution_record<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> send_result<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;success&#39;</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_optimize_channel_sequence</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> campaign_goal<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;优化渠道序列&quot;&quot;&quot;</span></span>
<span class="line">        user_profile <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_user_profile<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 基于用户偏好排序渠道</span></span>
<span class="line">        channel_preferences <span class="token operator">=</span> user_profile<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;channel_preferences&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 基于营销目标选择渠道</span></span>
<span class="line">        goal_based_channels <span class="token operator">=</span> self<span class="token punctuation">.</span>_channels_for_goal<span class="token punctuation">(</span>campaign_goal<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 结合用户偏好和目标需求排序</span></span>
<span class="line">        weighted_channels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token keyword">for</span> channel <span class="token keyword">in</span> goal_based_channels<span class="token punctuation">:</span></span>
<span class="line">            preference_score <span class="token operator">=</span> channel_preferences<span class="token punctuation">.</span>get<span class="token punctuation">(</span>channel<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span></span>
<span class="line">            goal_relevance <span class="token operator">=</span> self<span class="token punctuation">.</span>_channel_goal_relevance<span class="token punctuation">(</span>channel<span class="token punctuation">,</span> campaign_goal<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            total_score <span class="token operator">=</span> preference_score <span class="token operator">*</span> <span class="token number">0.6</span> <span class="token operator">+</span> goal_relevance <span class="token operator">*</span> <span class="token number">0.4</span></span>
<span class="line">            weighted_channels<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> total_score<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 按分数排序</span></span>
<span class="line">        sorted_channels <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>weighted_channels<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">[</span>channel <span class="token keyword">for</span> channel<span class="token punctuation">,</span> score <span class="token keyword">in</span> sorted_channels<span class="token punctuation">]</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_generate_personalized_content</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> channel_type<span class="token punctuation">,</span> goal<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;生成个性化内容&quot;&quot;&quot;</span></span>
<span class="line">        user_profile <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_user_profile<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        content_templates <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            ChannelType<span class="token punctuation">.</span>EMAIL<span class="token punctuation">:</span> self<span class="token punctuation">.</span>_email_template<span class="token punctuation">,</span></span>
<span class="line">            ChannelType<span class="token punctuation">.</span>SMS<span class="token punctuation">:</span> self<span class="token punctuation">.</span>_sms_template<span class="token punctuation">,</span></span>
<span class="line">            ChannelType<span class="token punctuation">.</span>PUSH_NOTIFICATION<span class="token punctuation">:</span> self<span class="token punctuation">.</span>_push_template<span class="token punctuation">,</span></span>
<span class="line">            ChannelType<span class="token punctuation">.</span>WECHAT<span class="token punctuation">:</span> self<span class="token punctuation">.</span>_wechat_template</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        template_func <span class="token operator">=</span> content_templates<span class="token punctuation">.</span>get<span class="token punctuation">(</span>channel_type<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> template_func<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> template_func<span class="token punctuation">(</span>user_profile<span class="token punctuation">,</span> goal<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&#39;message&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;Hello!&#39;</span><span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_email_template</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_profile<span class="token punctuation">,</span> goal<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;邮件模板&quot;&quot;&quot;</span></span>
<span class="line">        user_name <span class="token operator">=</span> user_profile<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;basic_info&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;用户&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> goal <span class="token operator">==</span> <span class="token string">&#39;re_engagement&#39;</span><span class="token punctuation">:</span></span>
<span class="line">            subject <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>user_name<span class="token punctuation">}</span></span><span class="token string">，我们想念您！回来享受专属优惠&quot;</span></span></span>
<span class="line">            body <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;&quot;&quot;</span>
<span class="line">            亲爱的</span><span class="token interpolation"><span class="token punctuation">{</span>user_name<span class="token punctuation">}</span></span><span class="token string">，</span>
<span class="line">            </span>
<span class="line">            很久没见到您了，我们为您准备了专属回归礼包！</span>
<span class="line">            </span>
<span class="line">            🔥 限时优惠：全场商品8折</span>
<span class="line">            🎁 专属礼品：价值100元优惠券</span>
<span class="line">            🚀 免费配送：订单满299元包邮</span>
<span class="line">            </span>
<span class="line">            点击下方链接立即查看：</span>
<span class="line">            [立即查看优惠](https://example.com/offer)</span>
<span class="line">            </span>
<span class="line">            期待您的回归！</span>
<span class="line">            &quot;&quot;&quot;</span></span></span>
<span class="line">        <span class="token keyword">elif</span> goal <span class="token operator">==</span> <span class="token string">&#39;upsell&#39;</span><span class="token punctuation">:</span></span>
<span class="line">            subject <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>user_name<span class="token punctuation">}</span></span><span class="token string">，为您推荐新品&quot;</span></span></span>
<span class="line">            body <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;&quot;&quot;</span>
<span class="line">            亲爱的</span><span class="token interpolation"><span class="token punctuation">{</span>user_name<span class="token punctuation">}</span></span><span class="token string">，</span>
<span class="line">            </span>
<span class="line">            根据您的浏览记录，我们为您精选了几款新品：</span>
<span class="line">            </span>
<span class="line">            🌟 热门推荐</span>
<span class="line">            - [产品A](https://example.com/product-a)</span>
<span class="line">            - [产品B](https://example.com/product-b)</span>
<span class="line">            </span>
<span class="line">            专属优惠：新品首购立减50元！</span>
<span class="line">            </span>
<span class="line">            [立即查看](https://example.com/new-arrivals)</span>
<span class="line">            &quot;&quot;&quot;</span></span></span>
<span class="line">        <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">            subject <span class="token operator">=</span> <span class="token string">&quot;为您精心挑选的内容&quot;</span></span>
<span class="line">            body <span class="token operator">=</span> <span class="token string">&quot;感谢您的关注！&quot;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;subject&#39;</span><span class="token punctuation">:</span> subject<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;body&#39;</span><span class="token punctuation">:</span> body<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;personalization_tags&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;user_name&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;recommendations&#39;</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-营销自动化" tabindex="-1"><a class="header-anchor" href="#_5-营销自动化"><span>5. 营销自动化</span></a></h2><h3 id="q11-营销工作流引擎" tabindex="-1"><a class="header-anchor" href="#q11-营销工作流引擎"><span>Q11: 营销工作流引擎？</span></a></h3><p><strong>答：</strong> 营销工作流引擎实现营销活动的自动化执行：</p><p><strong>可视化工作流设计器</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> abc <span class="token keyword">import</span> ABC<span class="token punctuation">,</span> abstractmethod</span>
<span class="line"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Dict<span class="token punctuation">,</span> List<span class="token punctuation">,</span> Any</span>
<span class="line"><span class="token keyword">import</span> json</span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">WorkflowNode</span><span class="token punctuation">(</span>ABC<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;工作流节点基类&quot;&quot;&quot;</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> node_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> config<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>node_id <span class="token operator">=</span> node_id</span>
<span class="line">        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name</span>
<span class="line">        self<span class="token punctuation">.</span>config <span class="token operator">=</span> config</span>
<span class="line">        self<span class="token punctuation">.</span>next_nodes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">    </span>
<span class="line">    <span class="token decorator annotation punctuation">@abstractmethod</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">pass</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">add_next_node</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>next_nodes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>node<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">TriggerNode</span><span class="token punctuation">(</span>WorkflowNode<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;触发器节点&quot;&quot;&quot;</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">        trigger_type <span class="token operator">=</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;trigger_type&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        trigger_condition <span class="token operator">=</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;condition&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 检查触发条件</span></span>
<span class="line">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_check_trigger_condition<span class="token punctuation">(</span>trigger_type<span class="token punctuation">,</span> trigger_condition<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&#39;triggered&#39;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">&#39;next_nodes&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>next_nodes<span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&#39;triggered&#39;</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">&#39;next_nodes&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_check_trigger_condition</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> trigger_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> condition<span class="token punctuation">:</span> Dict<span class="token punctuation">,</span> context<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">if</span> trigger_type <span class="token operator">==</span> <span class="token string">&#39;user_behavior&#39;</span><span class="token punctuation">:</span></span>
<span class="line">            user_id <span class="token operator">=</span> context<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;user_id&#39;</span><span class="token punctuation">)</span></span>
<span class="line">            behavior <span class="token operator">=</span> context<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;behavior&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment"># 检查用户行为是否符合条件</span></span>
<span class="line">            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_match_behavior_condition<span class="token punctuation">(</span>behavior<span class="token punctuation">,</span> condition<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">elif</span> trigger_type <span class="token operator">==</span> <span class="token string">&#39;scheduled&#39;</span><span class="token punctuation">:</span></span>
<span class="line">            current_time <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            scheduled_time <span class="token operator">=</span> condition<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;time&#39;</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment"># 检查是否到达预定时间</span></span>
<span class="line">            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_is_scheduled_time<span class="token punctuation">(</span>current_time<span class="token punctuation">,</span> scheduled_time<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">elif</span> trigger_type <span class="token operator">==</span> <span class="token string">&#39;data_threshold&#39;</span><span class="token punctuation">:</span></span>
<span class="line">            data_value <span class="token operator">=</span> context<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;data_value&#39;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">            threshold <span class="token operator">=</span> condition<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;threshold&#39;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">            operator <span class="token operator">=</span> condition<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;operator&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;gt&#39;</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment"># 检查数据阈值条件</span></span>
<span class="line">            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_compare_with_threshold<span class="token punctuation">(</span>data_value<span class="token punctuation">,</span> threshold<span class="token punctuation">,</span> operator<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">False</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">ActionNode</span><span class="token punctuation">(</span>WorkflowNode<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;动作节点&quot;&quot;&quot;</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">        action_type <span class="token operator">=</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;action_type&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        action_params <span class="token operator">=</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;params&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 执行具体动作</span></span>
<span class="line">        result <span class="token operator">=</span> self<span class="token punctuation">.</span>_execute_action<span class="token punctuation">(</span>action_type<span class="token punctuation">,</span> action_params<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;action_type&#39;</span><span class="token punctuation">:</span> action_type<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;result&#39;</span><span class="token punctuation">:</span> result<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;next_nodes&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>next_nodes</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_execute_action</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> action_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> params<span class="token punctuation">:</span> Dict<span class="token punctuation">,</span> context<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">if</span> action_type <span class="token operator">==</span> <span class="token string">&#39;send_email&#39;</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_send_email<span class="token punctuation">(</span>params<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">elif</span> action_type <span class="token operator">==</span> <span class="token string">&#39;send_sms&#39;</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_send_sms<span class="token punctuation">(</span>params<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">elif</span> action_type <span class="token operator">==</span> <span class="token string">&#39;update_user_tag&#39;</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_update_user_tag<span class="token punctuation">(</span>params<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">elif</span> action_type <span class="token operator">==</span> <span class="token string">&#39;assign_score&#39;</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_assign_user_score<span class="token punctuation">(</span>params<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">elif</span> action_type <span class="token operator">==</span> <span class="token string">&#39;trigger_webhook&#39;</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_trigger_webhook<span class="token punctuation">(</span>params<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&#39;success&#39;</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">&#39;error&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;Unknown action type&#39;</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">DecisionNode</span><span class="token punctuation">(</span>WorkflowNode<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;决策节点&quot;&quot;&quot;</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">        decision_rules <span class="token operator">=</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;rules&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        default_branch <span class="token operator">=</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;default_branch&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 评估决策规则</span></span>
<span class="line">        matched_branch <span class="token operator">=</span> self<span class="token punctuation">.</span>_evaluate_decision_rules<span class="token punctuation">(</span>decision_rules<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> matched_branch<span class="token punctuation">:</span></span>
<span class="line">            next_node <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_node_by_branch<span class="token punctuation">(</span>matched_branch<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&#39;decision&#39;</span><span class="token punctuation">:</span> matched_branch<span class="token punctuation">,</span> <span class="token string">&#39;next_nodes&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>next_node<span class="token punctuation">]</span> <span class="token keyword">if</span> next_node <span class="token keyword">else</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 使用默认分支</span></span>
<span class="line">            default_node <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_node_by_branch<span class="token punctuation">(</span>default_branch<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&#39;decision&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;default&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;next_nodes&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>default_node<span class="token punctuation">]</span> <span class="token keyword">if</span> default_node <span class="token keyword">else</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_evaluate_decision_rules</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> rules<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">,</span> context<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">for</span> rule <span class="token keyword">in</span> rules<span class="token punctuation">:</span></span>
<span class="line">            condition <span class="token operator">=</span> rule<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;condition&#39;</span><span class="token punctuation">)</span></span>
<span class="line">            branch <span class="token operator">=</span> rule<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;branch&#39;</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">if</span> self<span class="token punctuation">.</span>_evaluate_condition<span class="token punctuation">(</span>condition<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">                <span class="token keyword">return</span> branch</span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">None</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">MarketingWorkflowEngine</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;营销工作流引擎&quot;&quot;&quot;</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>workflows <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">        self<span class="token punctuation">.</span>node_types <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;trigger&#39;</span><span class="token punctuation">:</span> TriggerNode<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;action&#39;</span><span class="token punctuation">:</span> ActionNode<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;decision&#39;</span><span class="token punctuation">:</span> DecisionNode</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">create_workflow</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> workflow_definition<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;创建工作流&quot;&quot;&quot;</span></span>
<span class="line">        workflow_id <span class="token operator">=</span> workflow_definition<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 解析节点定义</span></span>
<span class="line">        nodes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">for</span> node_def <span class="token keyword">in</span> workflow_definition<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;nodes&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            node_type <span class="token operator">=</span> node_def<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;type&#39;</span><span class="token punctuation">)</span></span>
<span class="line">            node_class <span class="token operator">=</span> self<span class="token punctuation">.</span>node_types<span class="token punctuation">.</span>get<span class="token punctuation">(</span>node_type<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">if</span> node_class<span class="token punctuation">:</span></span>
<span class="line">                node <span class="token operator">=</span> node_class<span class="token punctuation">(</span></span>
<span class="line">                    node_def<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                    node_def<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                    node_def<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;config&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">)</span></span>
<span class="line">                nodes<span class="token punctuation">[</span>node<span class="token punctuation">.</span>node_id<span class="token punctuation">]</span> <span class="token operator">=</span> node</span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 建立节点连接关系</span></span>
<span class="line">        <span class="token keyword">for</span> connection <span class="token keyword">in</span> workflow_definition<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;connections&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            from_node_id <span class="token operator">=</span> connection<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;from&#39;</span><span class="token punctuation">)</span></span>
<span class="line">            to_node_id <span class="token operator">=</span> connection<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;to&#39;</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">if</span> from_node_id <span class="token keyword">in</span> nodes <span class="token keyword">and</span> to_node_id <span class="token keyword">in</span> nodes<span class="token punctuation">:</span></span>
<span class="line">                nodes<span class="token punctuation">[</span>from_node_id<span class="token punctuation">]</span><span class="token punctuation">.</span>add_next_node<span class="token punctuation">(</span>nodes<span class="token punctuation">[</span>to_node_id<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        self<span class="token punctuation">.</span>workflows<span class="token punctuation">[</span>workflow_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;definition&#39;</span><span class="token punctuation">:</span> workflow_definition<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;nodes&#39;</span><span class="token punctuation">:</span> nodes<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;status&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;active&#39;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> workflow_id</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">execute_workflow</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> workflow_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> trigger_context<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;执行工作流&quot;&quot;&quot;</span></span>
<span class="line">        workflow <span class="token operator">=</span> self<span class="token punctuation">.</span>workflows<span class="token punctuation">.</span>get<span class="token punctuation">(</span>workflow_id<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> workflow<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Workflow </span><span class="token interpolation"><span class="token punctuation">{</span>workflow_id<span class="token punctuation">}</span></span><span class="token string"> not found&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> workflow<span class="token punctuation">[</span><span class="token string">&#39;status&#39;</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">&#39;active&#39;</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Workflow </span><span class="token interpolation"><span class="token punctuation">{</span>workflow_id<span class="token punctuation">}</span></span><span class="token string"> is not active&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 从触发器节点开始执行</span></span>
<span class="line">        start_nodes <span class="token operator">=</span> self<span class="token punctuation">.</span>_find_start_nodes<span class="token punctuation">(</span>workflow<span class="token punctuation">[</span><span class="token string">&#39;nodes&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        execution_context <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;workflow_id&#39;</span><span class="token punctuation">:</span> workflow_id<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;start_time&#39;</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;trigger_context&#39;</span><span class="token punctuation">:</span> trigger_context<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;execution_path&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;variables&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 并行执行所有起始节点</span></span>
<span class="line">        <span class="token keyword">for</span> start_node <span class="token keyword">in</span> start_nodes<span class="token punctuation">:</span></span>
<span class="line">            self<span class="token punctuation">.</span>_execute_node<span class="token punctuation">(</span>start_node<span class="token punctuation">,</span> execution_context<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_execute_node</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> node<span class="token punctuation">:</span> WorkflowNode<span class="token punctuation">,</span> context<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;执行单个节点&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 记录执行路径</span></span>
<span class="line">            context<span class="token punctuation">[</span><span class="token string">&#39;execution_path&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&#39;node_id&#39;</span><span class="token punctuation">:</span> node<span class="token punctuation">.</span>node_id<span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;node_name&#39;</span><span class="token punctuation">:</span> node<span class="token punctuation">.</span>name<span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;start_time&#39;</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment"># 执行节点</span></span>
<span class="line">            result <span class="token operator">=</span> node<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>context<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment"># 更新结束时间</span></span>
<span class="line">            context<span class="token punctuation">[</span><span class="token string">&#39;execution_path&#39;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&#39;end_time&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            context<span class="token punctuation">[</span><span class="token string">&#39;execution_path&#39;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&#39;result&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> result</span>
<span class="line">            </span>
<span class="line">            <span class="token comment"># 执行后续节点</span></span>
<span class="line">            <span class="token keyword">for</span> next_node <span class="token keyword">in</span> result<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;next_nodes&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">                self<span class="token punctuation">.</span>_execute_node<span class="token punctuation">(</span>next_node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">                </span>
<span class="line">        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 记录错误并继续执行其他分支</span></span>
<span class="line">            context<span class="token punctuation">[</span><span class="token string">&#39;execution_path&#39;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span></span>
<span class="line">            self<span class="token punctuation">.</span>_log_execution_error<span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">,</span> e<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="q12-智能客服与聊天机器人" tabindex="-1"><a class="header-anchor" href="#q12-智能客服与聊天机器人"><span>Q12: 智能客服与聊天机器人？</span></a></h3><p><strong>答：</strong> 智能客服系统提升用户服务体验：</p><p><strong>对话管理引擎</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> re</span>
<span class="line"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Dict<span class="token punctuation">,</span> List<span class="token punctuation">,</span> Tuple</span>
<span class="line"><span class="token keyword">from</span> dataclasses <span class="token keyword">import</span> dataclass</span>
<span class="line"></span>
<span class="line"><span class="token decorator annotation punctuation">@dataclass</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Intent</span><span class="token punctuation">:</span></span>
<span class="line">    name<span class="token punctuation">:</span> <span class="token builtin">str</span></span>
<span class="line">    confidence<span class="token punctuation">:</span> <span class="token builtin">float</span></span>
<span class="line">    entities<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"><span class="token decorator annotation punctuation">@dataclass</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">DialogState</span><span class="token punctuation">:</span></span>
<span class="line">    session_id<span class="token punctuation">:</span> <span class="token builtin">str</span></span>
<span class="line">    current_intent<span class="token punctuation">:</span> <span class="token builtin">str</span></span>
<span class="line">    entities<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span></span>
<span class="line">    conversation_history<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span></span>
<span class="line">    context_variables<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">ChatbotEngine</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>intent_classifier <span class="token operator">=</span> IntentClassifier<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>entity_extractor <span class="token operator">=</span> EntityExtractor<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>dialog_manager <span class="token operator">=</span> DialogManager<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>response_generator <span class="token operator">=</span> ResponseGenerator<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>session_store <span class="token operator">=</span> SessionStore<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">process_user_message</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> session_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> user_message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;处理用户消息&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token comment"># 获取会话状态</span></span>
<span class="line">        dialog_state <span class="token operator">=</span> self<span class="token punctuation">.</span>session_store<span class="token punctuation">.</span>get_session<span class="token punctuation">(</span>session_id<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> dialog_state<span class="token punctuation">:</span></span>
<span class="line">            dialog_state <span class="token operator">=</span> DialogState<span class="token punctuation">(</span></span>
<span class="line">                session_id<span class="token operator">=</span>session_id<span class="token punctuation">,</span></span>
<span class="line">                current_intent<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span></span>
<span class="line">                entities<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                conversation_history<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                context_variables<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 意图识别</span></span>
<span class="line">        intent <span class="token operator">=</span> self<span class="token punctuation">.</span>intent_classifier<span class="token punctuation">.</span>classify<span class="token punctuation">(</span>user_message<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 实体抽取</span></span>
<span class="line">        entities <span class="token operator">=</span> self<span class="token punctuation">.</span>entity_extractor<span class="token punctuation">.</span>extract<span class="token punctuation">(</span>user_message<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 更新对话状态</span></span>
<span class="line">        dialog_state <span class="token operator">=</span> self<span class="token punctuation">.</span>_update_dialog_state<span class="token punctuation">(</span></span>
<span class="line">            dialog_state<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> entities<span class="token punctuation">,</span> user_message</span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 生成回复</span></span>
<span class="line">        response <span class="token operator">=</span> self<span class="token punctuation">.</span>response_generator<span class="token punctuation">.</span>generate<span class="token punctuation">(</span></span>
<span class="line">            intent<span class="token punctuation">,</span> entities<span class="token punctuation">,</span> dialog_state</span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 保存会话状态</span></span>
<span class="line">        self<span class="token punctuation">.</span>session_store<span class="token punctuation">.</span>save_session<span class="token punctuation">(</span>dialog_state<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> response</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_update_dialog_state</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state<span class="token punctuation">:</span> DialogState<span class="token punctuation">,</span> intent<span class="token punctuation">:</span> Intent<span class="token punctuation">,</span> </span>
<span class="line">                           entities<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">,</span> user_message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> DialogState<span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;更新对话状态&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token comment"># 更新意图</span></span>
<span class="line">        <span class="token keyword">if</span> intent<span class="token punctuation">.</span>confidence <span class="token operator">&gt;</span> <span class="token number">0.7</span><span class="token punctuation">:</span>  <span class="token comment"># 置信度阈值</span></span>
<span class="line">            state<span class="token punctuation">.</span>current_intent <span class="token operator">=</span> intent<span class="token punctuation">.</span>name</span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 合并实体</span></span>
<span class="line">        state<span class="token punctuation">.</span>entities<span class="token punctuation">.</span>update<span class="token punctuation">(</span>entities<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 更新对话历史</span></span>
<span class="line">        state<span class="token punctuation">.</span>conversation_history<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;turn&#39;</span><span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>conversation_history<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;user_message&#39;</span><span class="token punctuation">:</span> user_message<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;intent&#39;</span><span class="token punctuation">:</span> intent<span class="token punctuation">.</span>name <span class="token keyword">if</span> intent<span class="token punctuation">.</span>confidence <span class="token operator">&gt;</span> <span class="token number">0.7</span> <span class="token keyword">else</span> <span class="token boolean">None</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;entities&#39;</span><span class="token punctuation">:</span> entities<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;timestamp&#39;</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 更新上下文变量</span></span>
<span class="line">        state <span class="token operator">=</span> self<span class="token punctuation">.</span>dialog_manager<span class="token punctuation">.</span>update_context<span class="token punctuation">(</span>state<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> entities<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> state</span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">IntentClassifier</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;意图分类器&quot;&quot;&quot;</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>intents <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;greeting&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span></span>
<span class="line">                <span class="token string">r&#39;你好|您好|hi|hello|早上好|下午好|晚上好&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">r&#39;在吗|有人吗&#39;</span></span>
<span class="line">            <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;product_inquiry&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span></span>
<span class="line">                <span class="token string">r&#39;我想了解.*产品&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">r&#39;.*产品.*怎么样&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">r&#39;有没有.*产品&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">r&#39;.*产品的.*信息&#39;</span></span>
<span class="line">            <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;order_status&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span></span>
<span class="line">                <span class="token string">r&#39;我的订单.*状态&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">r&#39;订单.*到哪了&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">r&#39;查询订单.*号&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">r&#39;物流信息&#39;</span></span>
<span class="line">            <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;complaint&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span></span>
<span class="line">                <span class="token string">r&#39;投诉|不满意|问题|坏了|不好&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">r&#39;退款|退货&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">r&#39;客服.*在哪里&#39;</span></span>
<span class="line">            <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;purchase&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span></span>
<span class="line">                <span class="token string">r&#39;我要买|我想买|购买|下单&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">r&#39;价格.*多少&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">r&#39;怎么付款&#39;</span></span>
<span class="line">            <span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">classify</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Intent<span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;分类用户意图&quot;&quot;&quot;</span></span>
<span class="line">        best_intent <span class="token operator">=</span> <span class="token boolean">None</span></span>
<span class="line">        best_confidence <span class="token operator">=</span> <span class="token number">0.0</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">for</span> intent_name<span class="token punctuation">,</span> patterns <span class="token keyword">in</span> self<span class="token punctuation">.</span>intents<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">for</span> pattern <span class="token keyword">in</span> patterns<span class="token punctuation">:</span></span>
<span class="line">                <span class="token keyword">if</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> message<span class="token punctuation">,</span> re<span class="token punctuation">.</span>IGNORECASE<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">                    confidence <span class="token operator">=</span> self<span class="token punctuation">.</span>_calculate_confidence<span class="token punctuation">(</span>message<span class="token punctuation">,</span> pattern<span class="token punctuation">)</span></span>
<span class="line">                    <span class="token keyword">if</span> confidence <span class="token operator">&gt;</span> best_confidence<span class="token punctuation">:</span></span>
<span class="line">                        best_confidence <span class="token operator">=</span> confidence</span>
<span class="line">                        best_intent <span class="token operator">=</span> intent_name</span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> Intent<span class="token punctuation">(</span></span>
<span class="line">            name<span class="token operator">=</span>best_intent <span class="token keyword">or</span> <span class="token string">&#39;unknown&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            confidence<span class="token operator">=</span>best_confidence<span class="token punctuation">,</span></span>
<span class="line">            entities<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_calculate_confidence</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> pattern<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">float</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;计算置信度&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token comment"># 简单的置信度计算</span></span>
<span class="line">        <span class="token keyword">match</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> message<span class="token punctuation">,</span> re<span class="token punctuation">.</span>IGNORECASE<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">match</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 匹配文本越长，置信度越高</span></span>
<span class="line">            match_length <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            message_length <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token builtin">min</span><span class="token punctuation">(</span>match_length <span class="token operator">/</span> message_length<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">0.0</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">ResponseGenerator</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;回复生成器&quot;&quot;&quot;</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>responses <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;greeting&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span></span>
<span class="line">                <span class="token string">&quot;您好！很高兴为您服务，请问有什么可以帮助您的吗？&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;您好，欢迎咨询！请问您想了解什么？&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;Hi！有什么我可以帮您的吗？&quot;</span></span>
<span class="line">            <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;product_inquiry&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span></span>
<span class="line">                <span class="token string">&quot;关于{product}产品，我可以为您提供详细信息。请问您想了解产品的哪些方面呢？&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;我们有多款{product}产品，您具体想了解哪一款呢？&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;让我为您介绍一下{product}产品...&quot;</span></span>
<span class="line">            <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;order_status&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span></span>
<span class="line">                <span class="token string">&quot;请提供您的订单号，我来帮您查询订单状态。&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;为了查询您的订单，请告诉我订单号码。&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;请输入订单号，我马上为您查询物流信息。&quot;</span></span>
<span class="line">            <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;complaint&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span></span>
<span class="line">                <span class="token string">&quot;非常抱歉给您带来了不便，我会尽力帮您解决问题。&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;很抱歉听到您遇到了问题，请详细描述一下情况。&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;我理解您的困扰，让我们一起来解决这个问题。&quot;</span></span>
<span class="line">            <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;purchase&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span></span>
<span class="line">                <span class="token string">&quot;很高兴您想要购买我们的产品！请问您想了解哪款产品呢？&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;我们有很多优质的产品可供选择，您有特别感兴趣的商品吗？&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;购买流程很简单，我可以为您详细介绍。&quot;</span></span>
<span class="line">            <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;unknown&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span></span>
<span class="line">                <span class="token string">&quot;抱歉，我不太明白您的意思。您可以换个说法或者问我其他问题。&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;我没有理解您的问题，能否请您再解释得清楚一些？&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;这个问题我暂时无法回答，已经记录下来会尽快回复您。&quot;</span></span>
<span class="line">            <span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">generate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> intent<span class="token punctuation">:</span> Intent<span class="token punctuation">,</span> entities<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">,</span> </span>
<span class="line">                dialog_state<span class="token punctuation">:</span> DialogState<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;生成回复&quot;&quot;&quot;</span></span>
<span class="line">        intent_name <span class="token operator">=</span> intent<span class="token punctuation">.</span>name</span>
<span class="line">        possible_responses <span class="token operator">=</span> self<span class="token punctuation">.</span>responses<span class="token punctuation">.</span>get<span class="token punctuation">(</span>intent_name<span class="token punctuation">,</span> self<span class="token punctuation">.</span>responses<span class="token punctuation">[</span><span class="token string">&#39;unknown&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 随机选择一个回复模板</span></span>
<span class="line">        response_template <span class="token operator">=</span> possible_responses<span class="token punctuation">[</span><span class="token builtin">hash</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>dialog_state<span class="token punctuation">.</span>session_id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>possible_responses<span class="token punctuation">)</span><span class="token punctuation">]</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 替换模板中的变量</span></span>
<span class="line">        response <span class="token operator">=</span> response_template</span>
<span class="line">        <span class="token keyword">for</span> entity_name<span class="token punctuation">,</span> entity_value <span class="token keyword">in</span> entities<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            response <span class="token operator">=</span> response<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#39;{{</span><span class="token interpolation"><span class="token punctuation">{</span>entity_name<span class="token punctuation">}</span></span><span class="token string">}}&#39;</span></span><span class="token punctuation">,</span> entity_value<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> response</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-效果优化与a-b测试" tabindex="-1"><a class="header-anchor" href="#_6-效果优化与a-b测试"><span>6. 效果优化与A/B测试</span></a></h2><h3 id="q13-a-b测试框架设计" tabindex="-1"><a class="header-anchor" href="#q13-a-b测试框架设计"><span>Q13: A/B测试框架设计？</span></a></h3><p><strong>答：</strong> A/B测试框架帮助优化营销效果：</p><p><strong>实验管理平台</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> hashlib</span>
<span class="line"><span class="token keyword">import</span> random</span>
<span class="line"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime</span>
<span class="line"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Dict<span class="token punctuation">,</span> List<span class="token punctuation">,</span> Any</span>
<span class="line"><span class="token keyword">from</span> dataclasses <span class="token keyword">import</span> dataclass</span>
<span class="line"></span>
<span class="line"><span class="token decorator annotation punctuation">@dataclass</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Experiment</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token builtin">str</span></span>
<span class="line">    name<span class="token punctuation">:</span> <span class="token builtin">str</span></span>
<span class="line">    description<span class="token punctuation">:</span> <span class="token builtin">str</span></span>
<span class="line">    hypothesis<span class="token punctuation">:</span> <span class="token builtin">str</span></span>
<span class="line">    variants<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span></span>
<span class="line">    metrics<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span></span>
<span class="line">    start_date<span class="token punctuation">:</span> datetime</span>
<span class="line">    end_date<span class="token punctuation">:</span> datetime</span>
<span class="line">    status<span class="token punctuation">:</span> <span class="token builtin">str</span>  <span class="token comment"># draft, running, completed</span></span>
<span class="line">    audience_allocation<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">]</span>  <span class="token comment"># variant_id: percentage</span></span>
<span class="line"></span>
<span class="line"><span class="token decorator annotation punctuation">@dataclass</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">ExperimentResult</span><span class="token punctuation">:</span></span>
<span class="line">    experiment_id<span class="token punctuation">:</span> <span class="token builtin">str</span></span>
<span class="line">    variant_results<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span></span>
<span class="line">    statistical_significance<span class="token punctuation">:</span> <span class="token builtin">bool</span></span>
<span class="line">    winner_variant<span class="token punctuation">:</span> <span class="token builtin">str</span></span>
<span class="line">    confidence_interval<span class="token punctuation">:</span> <span class="token builtin">float</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">ABTestingFramework</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>experiments <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">        self<span class="token punctuation">.</span>event_tracker <span class="token operator">=</span> EventTracker<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>statistics_calculator <span class="token operator">=</span> StatisticsCalculator<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">create_experiment</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> experiment_config<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;创建A/B测试实验&quot;&quot;&quot;</span></span>
<span class="line">        experiment_id <span class="token operator">=</span> experiment_config<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        experiment <span class="token operator">=</span> Experiment<span class="token punctuation">(</span></span>
<span class="line">            <span class="token builtin">id</span><span class="token operator">=</span>experiment_id<span class="token punctuation">,</span></span>
<span class="line">            name<span class="token operator">=</span>experiment_config<span class="token punctuation">[</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            description<span class="token operator">=</span>experiment_config<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;description&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            hypothesis<span class="token operator">=</span>experiment_config<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;hypothesis&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            variants<span class="token operator">=</span>experiment_config<span class="token punctuation">[</span><span class="token string">&#39;variants&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            metrics<span class="token operator">=</span>experiment_config<span class="token punctuation">[</span><span class="token string">&#39;metrics&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            start_date<span class="token operator">=</span>datetime<span class="token punctuation">.</span>fromisoformat<span class="token punctuation">(</span>experiment_config<span class="token punctuation">[</span><span class="token string">&#39;start_date&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            end_date<span class="token operator">=</span>datetime<span class="token punctuation">.</span>fromisoformat<span class="token punctuation">(</span>experiment_config<span class="token punctuation">[</span><span class="token string">&#39;end_date&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            status<span class="token operator">=</span><span class="token string">&#39;draft&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            audience_allocation<span class="token operator">=</span>experiment_config<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;audience_allocation&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        self<span class="token punctuation">.</span>experiments<span class="token punctuation">[</span>experiment_id<span class="token punctuation">]</span> <span class="token operator">=</span> experiment</span>
<span class="line">        <span class="token keyword">return</span> experiment_id</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">start_experiment</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> experiment_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;启动实验&quot;&quot;&quot;</span></span>
<span class="line">        experiment <span class="token operator">=</span> self<span class="token punctuation">.</span>experiments<span class="token punctuation">.</span>get<span class="token punctuation">(</span>experiment_id<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> experiment<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Experiment </span><span class="token interpolation"><span class="token punctuation">{</span>experiment_id<span class="token punctuation">}</span></span><span class="token string"> not found&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> experiment<span class="token punctuation">.</span>status <span class="token operator">!=</span> <span class="token string">&#39;draft&#39;</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Experiment </span><span class="token interpolation"><span class="token punctuation">{</span>experiment_id<span class="token punctuation">}</span></span><span class="token string"> is not in draft status&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        experiment<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">&#39;running&#39;</span></span>
<span class="line">        self<span class="token punctuation">.</span>_log_experiment_status_change<span class="token punctuation">(</span>experiment_id<span class="token punctuation">,</span> <span class="token string">&#39;started&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">assign_variant</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> experiment_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;为用户分配实验变体&quot;&quot;&quot;</span></span>
<span class="line">        experiment <span class="token operator">=</span> self<span class="token punctuation">.</span>experiments<span class="token punctuation">.</span>get<span class="token punctuation">(</span>experiment_id<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> experiment <span class="token keyword">or</span> experiment<span class="token punctuation">.</span>status <span class="token operator">!=</span> <span class="token string">&#39;running&#39;</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token string">&#39;control&#39;</span>  <span class="token comment"># 默认返回对照组</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 基于用户ID和实验ID生成稳定的哈希值</span></span>
<span class="line">        hash_input <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>experiment_id<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span></span>
<span class="line">        hash_value <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span>hash_input<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span></span>
<span class="line">        percentage <span class="token operator">=</span> <span class="token punctuation">(</span>hash_value <span class="token operator">%</span> <span class="token number">10000</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100.0</span>  <span class="token comment"># 0-100之间的百分比</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 根据预设的分配比例分配变体</span></span>
<span class="line">        cumulative_percentage <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">        <span class="token keyword">for</span> variant_id<span class="token punctuation">,</span> allocation <span class="token keyword">in</span> experiment<span class="token punctuation">.</span>audience_allocation<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            cumulative_percentage <span class="token operator">+=</span> allocation</span>
<span class="line">            <span class="token keyword">if</span> percentage <span class="token operator">&lt;=</span> cumulative_percentage<span class="token punctuation">:</span></span>
<span class="line">                <span class="token keyword">return</span> variant_id</span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&#39;control&#39;</span>  <span class="token comment"># 默认返回对照组</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">track_event</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> experiment_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> variant_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> </span>
<span class="line">                   user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> event_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> event_properties<span class="token punctuation">:</span> Dict <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;跟踪实验事件&quot;&quot;&quot;</span></span>
<span class="line">        self<span class="token punctuation">.</span>event_tracker<span class="token punctuation">.</span>track_event<span class="token punctuation">(</span></span>
<span class="line">            experiment_id<span class="token operator">=</span>experiment_id<span class="token punctuation">,</span></span>
<span class="line">            variant_id<span class="token operator">=</span>variant_id<span class="token punctuation">,</span></span>
<span class="line">            user_id<span class="token operator">=</span>user_id<span class="token punctuation">,</span></span>
<span class="line">            event_name<span class="token operator">=</span>event_name<span class="token punctuation">,</span></span>
<span class="line">            event_properties<span class="token operator">=</span>event_properties <span class="token keyword">or</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">analyze_experiment</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> experiment_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> ExperimentResult<span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;分析实验结果&quot;&quot;&quot;</span></span>
<span class="line">        experiment <span class="token operator">=</span> self<span class="token punctuation">.</span>experiments<span class="token punctuation">.</span>get<span class="token punctuation">(</span>experiment_id<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> experiment<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Experiment </span><span class="token interpolation"><span class="token punctuation">{</span>experiment_id<span class="token punctuation">}</span></span><span class="token string"> not found&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> experiment<span class="token punctuation">.</span>status <span class="token operator">!=</span> <span class="token string">&#39;completed&#39;</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Experiment </span><span class="token interpolation"><span class="token punctuation">{</span>experiment_id<span class="token punctuation">}</span></span><span class="token string"> is not completed yet&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 获取实验数据</span></span>
<span class="line">        experiment_data <span class="token operator">=</span> self<span class="token punctuation">.</span>event_tracker<span class="token punctuation">.</span>get_experiment_data<span class="token punctuation">(</span>experiment_id<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 计算各变体的指标</span></span>
<span class="line">        variant_results <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">for</span> variant_id <span class="token keyword">in</span> experiment<span class="token punctuation">.</span>audience_allocation<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            variant_data <span class="token operator">=</span> experiment_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span>variant_id<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">            variant_results<span class="token punctuation">[</span>variant_id<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>_calculate_variant_metrics<span class="token punctuation">(</span></span>
<span class="line">                variant_data<span class="token punctuation">,</span> experiment<span class="token punctuation">.</span>metrics</span>
<span class="line">            <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 统计显著性检验</span></span>
<span class="line">        significance_result <span class="token operator">=</span> self<span class="token punctuation">.</span>statistics_calculator<span class="token punctuation">.</span>check_significance<span class="token punctuation">(</span></span>
<span class="line">            variant_results<span class="token punctuation">,</span> experiment<span class="token punctuation">.</span>metrics</span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 确定获胜变体</span></span>
<span class="line">        winner_variant <span class="token operator">=</span> self<span class="token punctuation">.</span>_determine_winner<span class="token punctuation">(</span>variant_results<span class="token punctuation">,</span> experiment<span class="token punctuation">.</span>metrics<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        result <span class="token operator">=</span> ExperimentResult<span class="token punctuation">(</span></span>
<span class="line">            experiment_id<span class="token operator">=</span>experiment_id<span class="token punctuation">,</span></span>
<span class="line">            variant_results<span class="token operator">=</span>variant_results<span class="token punctuation">,</span></span>
<span class="line">            statistical_significance<span class="token operator">=</span>significance_result<span class="token punctuation">[</span><span class="token string">&#39;significant&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            winner_variant<span class="token operator">=</span>winner_variant<span class="token punctuation">,</span></span>
<span class="line">            confidence_interval<span class="token operator">=</span>significance_result<span class="token punctuation">[</span><span class="token string">&#39;confidence&#39;</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> result</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_calculate_variant_metrics</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> variant_data<span class="token punctuation">:</span> Dict<span class="token punctuation">,</span> metrics<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;计算变体指标&quot;&quot;&quot;</span></span>
<span class="line">        results <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">for</span> metric <span class="token keyword">in</span> metrics<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">if</span> metric <span class="token operator">==</span> <span class="token string">&#39;conversion_rate&#39;</span><span class="token punctuation">:</span></span>
<span class="line">                conversions <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token punctuation">[</span>e <span class="token keyword">for</span> e <span class="token keyword">in</span> variant_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;events&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> </span>
<span class="line">                                 <span class="token keyword">if</span> e<span class="token punctuation">[</span><span class="token string">&#39;event_name&#39;</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&#39;conversion&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">                total_visitors <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span>e<span class="token punctuation">[</span><span class="token string">&#39;user_id&#39;</span><span class="token punctuation">]</span> <span class="token keyword">for</span> e <span class="token keyword">in</span> variant_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;events&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                results<span class="token punctuation">[</span>metric<span class="token punctuation">]</span> <span class="token operator">=</span> conversions <span class="token operator">/</span> total_visitors <span class="token keyword">if</span> total_visitors <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">elif</span> metric <span class="token operator">==</span> <span class="token string">&#39;revenue_per_visitor&#39;</span><span class="token punctuation">:</span></span>
<span class="line">                total_revenue <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span>e<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;properties&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;revenue&#39;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> </span>
<span class="line">                                   <span class="token keyword">for</span> e <span class="token keyword">in</span> variant_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;events&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">                total_visitors <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span>e<span class="token punctuation">[</span><span class="token string">&#39;user_id&#39;</span><span class="token punctuation">]</span> <span class="token keyword">for</span> e <span class="token keyword">in</span> variant_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;events&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                results<span class="token punctuation">[</span>metric<span class="token punctuation">]</span> <span class="token operator">=</span> total_revenue <span class="token operator">/</span> total_visitors <span class="token keyword">if</span> total_visitors <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">elif</span> metric <span class="token operator">==</span> <span class="token string">&#39;click_through_rate&#39;</span><span class="token punctuation">:</span></span>
<span class="line">                clicks <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token punctuation">[</span>e <span class="token keyword">for</span> e <span class="token keyword">in</span> variant_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;events&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> </span>
<span class="line">                            <span class="token keyword">if</span> e<span class="token punctuation">[</span><span class="token string">&#39;event_name&#39;</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&#39;click&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">                impressions <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token punctuation">[</span>e <span class="token keyword">for</span> e <span class="token keyword">in</span> variant_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;events&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> </span>
<span class="line">                                 <span class="token keyword">if</span> e<span class="token punctuation">[</span><span class="token string">&#39;event_name&#39;</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&#39;impression&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">                results<span class="token punctuation">[</span>metric<span class="token punctuation">]</span> <span class="token operator">=</span> clicks <span class="token operator">/</span> impressions <span class="token keyword">if</span> impressions <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> results</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_determine_winner</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> variant_results<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Dict<span class="token punctuation">]</span><span class="token punctuation">,</span> metrics<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;确定获胜变体&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> variant_results<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token string">&#39;control&#39;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 假设第一个指标是最重要的优化目标</span></span>
<span class="line">        primary_metric <span class="token operator">=</span> metrics<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">if</span> metrics <span class="token keyword">else</span> <span class="token string">&#39;conversion_rate&#39;</span></span>
<span class="line">        </span>
<span class="line">        best_variant <span class="token operator">=</span> <span class="token string">&#39;control&#39;</span></span>
<span class="line">        best_value <span class="token operator">=</span> variant_results<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;control&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>primary_metric<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">for</span> variant_id<span class="token punctuation">,</span> metrics_dict <span class="token keyword">in</span> variant_results<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            value <span class="token operator">=</span> metrics_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span>primary_metric<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> value <span class="token operator">&gt;</span> best_value<span class="token punctuation">:</span></span>
<span class="line">                best_value <span class="token operator">=</span> value</span>
<span class="line">                best_variant <span class="token operator">=</span> variant_id</span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> best_variant</span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">StatisticsCalculator</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;统计计算器&quot;&quot;&quot;</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">check_significance</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> variant_results<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Dict<span class="token punctuation">]</span><span class="token punctuation">,</span> </span>
<span class="line">                          metrics<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;检查统计显著性&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>variant_results<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&#39;significant&#39;</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">&#39;confidence&#39;</span><span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 简化的显著性检验（实际应用中应使用更复杂的统计方法）</span></span>
<span class="line">        control_results <span class="token operator">=</span> variant_results<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;control&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        variant_ids <span class="token operator">=</span> <span class="token punctuation">[</span>vid <span class="token keyword">for</span> vid <span class="token keyword">in</span> variant_results<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> vid <span class="token operator">!=</span> <span class="token string">&#39;control&#39;</span><span class="token punctuation">]</span></span>
<span class="line">        </span>
<span class="line">        significant <span class="token operator">=</span> <span class="token boolean">False</span></span>
<span class="line">        max_confidence <span class="token operator">=</span> <span class="token number">0.0</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">for</span> variant_id <span class="token keyword">in</span> variant_ids<span class="token punctuation">:</span></span>
<span class="line">            variant_results_data <span class="token operator">=</span> variant_results<span class="token punctuation">.</span>get<span class="token punctuation">(</span>variant_id<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment"># 对每个指标进行检验</span></span>
<span class="line">            <span class="token keyword">for</span> metric <span class="token keyword">in</span> metrics<span class="token punctuation">:</span></span>
<span class="line">                control_value <span class="token operator">=</span> control_results<span class="token punctuation">.</span>get<span class="token punctuation">(</span>metric<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">                variant_value <span class="token operator">=</span> variant_results_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span>metric<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">                </span>
<span class="line">                <span class="token keyword">if</span> control_value <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span></span>
<span class="line">                    improvement <span class="token operator">=</span> <span class="token punctuation">(</span>variant_value <span class="token operator">-</span> control_value<span class="token punctuation">)</span> <span class="token operator">/</span> control_value</span>
<span class="line">                    </span>
<span class="line">                    <span class="token comment"># 简化的置信度计算</span></span>
<span class="line">                    confidence <span class="token operator">=</span> self<span class="token punctuation">.</span>_calculate_simple_confidence<span class="token punctuation">(</span></span>
<span class="line">                        improvement<span class="token punctuation">,</span> control_value<span class="token punctuation">,</span> variant_value</span>
<span class="line">                    <span class="token punctuation">)</span></span>
<span class="line">                    </span>
<span class="line">                    <span class="token keyword">if</span> confidence <span class="token operator">&gt;</span> max_confidence<span class="token punctuation">:</span></span>
<span class="line">                        max_confidence <span class="token operator">=</span> confidence</span>
<span class="line">                    </span>
<span class="line">                    <span class="token comment"># 如果改善超过5%且置信度超过90%，认为显著</span></span>
<span class="line">                    <span class="token keyword">if</span> improvement <span class="token operator">&gt;</span> <span class="token number">0.05</span> <span class="token keyword">and</span> confidence <span class="token operator">&gt;</span> <span class="token number">0.9</span><span class="token punctuation">:</span></span>
<span class="line">                        significant <span class="token operator">=</span> <span class="token boolean">True</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;significant&#39;</span><span class="token punctuation">:</span> significant<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;confidence&#39;</span><span class="token punctuation">:</span> max_confidence</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_calculate_simple_confidence</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> improvement<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">,</span> </span>
<span class="line">                                  control_value<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">,</span> variant_value<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">float</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;简化的置信度计算&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token comment"># 这是一个非常简化的实现，实际应用中应使用统计检验方法</span></span>
<span class="line">        <span class="token comment"># 如t检验、卡方检验等</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 基于改善幅度和基准值的简单估算</span></span>
<span class="line">        base_confidence <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token builtin">abs</span><span class="token punctuation">(</span>improvement<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span>  <span class="token comment"># 改善越大，置信度越高</span></span>
<span class="line">        value_confidence <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>control_value <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span>    <span class="token comment"># 基准值越大，置信度越高</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span>base_confidence <span class="token operator">+</span> value_confidence<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="q14-实时效果监控与优化" tabindex="-1"><a class="header-anchor" href="#q14-实时效果监控与优化"><span>Q14: 实时效果监控与优化？</span></a></h3><p><strong>答：</strong> 实时监控系统确保营销活动效果可视化：</p><p><strong>实时监控仪表板</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> asyncio</span>
<span class="line"><span class="token keyword">import</span> websockets</span>
<span class="line"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta</span>
<span class="line"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict<span class="token punctuation">,</span> deque</span>
<span class="line"><span class="token keyword">import</span> json</span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">RealTimeMonitoringDashboard</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>metrics_store <span class="token operator">=</span> MetricsStore<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>alert_manager <span class="token operator">=</span> AlertManager<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>websocket_connections <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>real_time_processors <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;conversion_rate&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_process_conversion_rate<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;revenue&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_process_revenue<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;traffic&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_process_traffic<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;engagement&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_process_engagement</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">start_real_time_monitoring</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;启动实时监控&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token comment"># 启动WebSocket服务器</span></span>
<span class="line">        start_server <span class="token operator">=</span> websockets<span class="token punctuation">.</span>serve<span class="token punctuation">(</span>self<span class="token punctuation">.</span>websocket_handler<span class="token punctuation">,</span> <span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span> <span class="token number">8765</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">await</span> start_server</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">websocket_handler</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> websocket<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;WebSocket连接处理器&quot;&quot;&quot;</span></span>
<span class="line">        self<span class="token punctuation">.</span>websocket_connections<span class="token punctuation">.</span>add<span class="token punctuation">(</span>websocket<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">async</span> <span class="token keyword">for</span> message <span class="token keyword">in</span> websocket<span class="token punctuation">:</span></span>
<span class="line">                <span class="token comment"># 处理客户端消息</span></span>
<span class="line">                <span class="token keyword">await</span> self<span class="token punctuation">.</span>_handle_client_message<span class="token punctuation">(</span>websocket<span class="token punctuation">,</span> message<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">finally</span><span class="token punctuation">:</span></span>
<span class="line">            self<span class="token punctuation">.</span>websocket_connections<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>websocket<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_handle_client_message</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> websocket<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;处理客户端消息&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">            data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>message<span class="token punctuation">)</span></span>
<span class="line">            action <span class="token operator">=</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;action&#39;</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">if</span> action <span class="token operator">==</span> <span class="token string">&#39;subscribe&#39;</span><span class="token punctuation">:</span></span>
<span class="line">                <span class="token comment"># 订阅特定指标</span></span>
<span class="line">                metrics <span class="token operator">=</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;metrics&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token keyword">await</span> self<span class="token punctuation">.</span>_subscribe_to_metrics<span class="token punctuation">(</span>websocket<span class="token punctuation">,</span> metrics<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">elif</span> action <span class="token operator">==</span> <span class="token string">&#39;unsubscribe&#39;</span><span class="token punctuation">:</span></span>
<span class="line">                <span class="token comment"># 取消订阅</span></span>
<span class="line">                metrics <span class="token operator">=</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;metrics&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token keyword">await</span> self<span class="token punctuation">.</span>_unsubscribe_from_metrics<span class="token punctuation">(</span>websocket<span class="token punctuation">,</span> metrics<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">except</span> json<span class="token punctuation">.</span>JSONDecodeError<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;Invalid JSON&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">process_real_time_event</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> event_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> event_data<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;处理实时事件&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token comment"># 存储事件数据</span></span>
<span class="line">        self<span class="token punctuation">.</span>metrics_store<span class="token punctuation">.</span>store_event<span class="token punctuation">(</span>event_type<span class="token punctuation">,</span> event_data<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 处理特定类型的事件</span></span>
<span class="line">        processor <span class="token operator">=</span> self<span class="token punctuation">.</span>real_time_processors<span class="token punctuation">.</span>get<span class="token punctuation">(</span>event_type<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> processor<span class="token punctuation">:</span></span>
<span class="line">            processed_metrics <span class="token operator">=</span> processor<span class="token punctuation">(</span>event_data<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment"># 检查告警条件</span></span>
<span class="line">            alerts <span class="token operator">=</span> self<span class="token punctuation">.</span>alert_manager<span class="token punctuation">.</span>check_alerts<span class="token punctuation">(</span>processed_metrics<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> alerts<span class="token punctuation">:</span></span>
<span class="line">                <span class="token keyword">await</span> self<span class="token punctuation">.</span>_broadcast_alerts<span class="token punctuation">(</span>alerts<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment"># 广播实时指标更新</span></span>
<span class="line">            <span class="token keyword">await</span> self<span class="token punctuation">.</span>_broadcast_metrics_update<span class="token punctuation">(</span>event_type<span class="token punctuation">,</span> processed_metrics<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_process_conversion_rate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> event_data<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;处理转化率指标&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token comment"># 计算实时转化率</span></span>
<span class="line">        time_window <span class="token operator">=</span> timedelta<span class="token punctuation">(</span>minutes<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span></span>
<span class="line">        recent_conversions <span class="token operator">=</span> self<span class="token punctuation">.</span>metrics_store<span class="token punctuation">.</span>get_events<span class="token punctuation">(</span></span>
<span class="line">            <span class="token string">&#39;conversion&#39;</span><span class="token punctuation">,</span> </span>
<span class="line">            datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> time_window</span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        recent_visits <span class="token operator">=</span> self<span class="token punctuation">.</span>metrics_store<span class="token punctuation">.</span>get_events<span class="token punctuation">(</span></span>
<span class="line">            <span class="token string">&#39;visit&#39;</span><span class="token punctuation">,</span> </span>
<span class="line">            datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> time_window</span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        conversion_rate <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">            <span class="token builtin">len</span><span class="token punctuation">(</span>recent_conversions<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>recent_visits<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> </span>
<span class="line">            <span class="token keyword">if</span> recent_visits <span class="token keyword">else</span> <span class="token number">0</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 计算同比和环比变化</span></span>
<span class="line">        prev_period_conversions <span class="token operator">=</span> self<span class="token punctuation">.</span>metrics_store<span class="token punctuation">.</span>get_events<span class="token punctuation">(</span></span>
<span class="line">            <span class="token string">&#39;conversion&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> time_window <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span></span>
<span class="line">            datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> time_window</span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        prev_period_visits <span class="token operator">=</span> self<span class="token punctuation">.</span>metrics_store<span class="token punctuation">.</span>get_events<span class="token punctuation">(</span></span>
<span class="line">            <span class="token string">&#39;visit&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> time_window <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span></span>
<span class="line">            datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> time_window</span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        prev_conversion_rate <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">            <span class="token builtin">len</span><span class="token punctuation">(</span>prev_period_conversions<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>prev_period_visits<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span></span>
<span class="line">            <span class="token keyword">if</span> prev_period_visits <span class="token keyword">else</span> <span class="token number">0</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        trend <span class="token operator">=</span> conversion_rate <span class="token operator">-</span> prev_conversion_rate</span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;current_rate&#39;</span><span class="token punctuation">:</span> conversion_rate<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;previous_rate&#39;</span><span class="token punctuation">:</span> prev_conversion_rate<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;trend&#39;</span><span class="token punctuation">:</span> trend<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;sample_size&#39;</span><span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span>recent_visits<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_process_revenue</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> event_data<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;处理收入指标&quot;&quot;&quot;</span></span>
<span class="line">        time_window <span class="token operator">=</span> timedelta<span class="token punctuation">(</span>hours<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">        recent_revenue_events <span class="token operator">=</span> self<span class="token punctuation">.</span>metrics_store<span class="token punctuation">.</span>get_events<span class="token punctuation">(</span></span>
<span class="line">            <span class="token string">&#39;revenue&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> time_window</span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        total_revenue <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span></span>
<span class="line">            event<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;amount&#39;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">for</span> event <span class="token keyword">in</span> recent_revenue_events</span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 计算客单价</span></span>
<span class="line">        conversion_events <span class="token operator">=</span> self<span class="token punctuation">.</span>metrics_store<span class="token punctuation">.</span>get_events<span class="token punctuation">(</span></span>
<span class="line">            <span class="token string">&#39;conversion&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> time_window</span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        avg_order_value <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">            total_revenue <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>conversion_events<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> conversion_events <span class="token keyword">else</span> <span class="token number">0</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;hourly_revenue&#39;</span><span class="token punctuation">:</span> total_revenue<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;avg_order_value&#39;</span><span class="token punctuation">:</span> avg_order_value<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;transaction_count&#39;</span><span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span>conversion_events<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_broadcast_metrics_update</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> metric_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> metrics<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;广播指标更新&quot;&quot;&quot;</span></span>
<span class="line">        update_message <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;type&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;metrics_update&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;metric_type&#39;</span><span class="token punctuation">:</span> metric_type<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;data&#39;</span><span class="token punctuation">:</span> metrics<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;timestamp&#39;</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 向所有连接的客户端广播</span></span>
<span class="line">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>websocket_connections<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span></span>
<span class="line">                <span class="token operator">*</span><span class="token punctuation">[</span>conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>update_message<span class="token punctuation">)</span><span class="token punctuation">)</span> </span>
<span class="line">                  <span class="token keyword">for</span> conn <span class="token keyword">in</span> self<span class="token punctuation">.</span>websocket_connections<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                return_exceptions<span class="token operator">=</span><span class="token boolean">True</span></span>
<span class="line">            <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_broadcast_alerts</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> alerts<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;广播告警信息&quot;&quot;&quot;</span></span>
<span class="line">        alert_message <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;type&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;alerts&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;data&#39;</span><span class="token punctuation">:</span> alerts<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;timestamp&#39;</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>websocket_connections<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span></span>
<span class="line">                <span class="token operator">*</span><span class="token punctuation">[</span>conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>alert_message<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                  <span class="token keyword">for</span> conn <span class="token keyword">in</span> self<span class="token punctuation">.</span>websocket_connections<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                return_exceptions<span class="token operator">=</span><span class="token boolean">True</span></span>
<span class="line">            <span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">MetricsStore</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;指标存储&quot;&quot;&quot;</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 使用内存存储近期数据，生产环境应使用Redis或时序数据库</span></span>
<span class="line">        self<span class="token punctuation">.</span>events <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>deque<span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>max_events_per_type <span class="token operator">=</span> <span class="token number">10000</span>  <span class="token comment"># 每种事件类型最多存储10000条</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">store_event</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> event_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> event_data<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;存储事件&quot;&quot;&quot;</span></span>
<span class="line">        event_data<span class="token punctuation">[</span><span class="token string">&#39;timestamp&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>events<span class="token punctuation">[</span>event_type<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>event_data<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 限制存储数量</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>events<span class="token punctuation">[</span>event_type<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>max_events_per_type<span class="token punctuation">:</span></span>
<span class="line">            self<span class="token punctuation">.</span>events<span class="token punctuation">[</span>event_type<span class="token punctuation">]</span><span class="token punctuation">.</span>popleft<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get_events</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> event_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> start_time<span class="token punctuation">:</span> datetime <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span> </span>
<span class="line">                   end_time<span class="token punctuation">:</span> datetime <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;获取事件&quot;&quot;&quot;</span></span>
<span class="line">        events <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>events<span class="token punctuation">[</span>event_type<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> start_time<span class="token punctuation">:</span></span>
<span class="line">            events <span class="token operator">=</span> <span class="token punctuation">[</span>e <span class="token keyword">for</span> e <span class="token keyword">in</span> events <span class="token keyword">if</span> e<span class="token punctuation">[</span><span class="token string">&#39;timestamp&#39;</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span> start_time<span class="token punctuation">]</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> end_time<span class="token punctuation">:</span></span>
<span class="line">            events <span class="token operator">=</span> <span class="token punctuation">[</span>e <span class="token keyword">for</span> e <span class="token keyword">in</span> events <span class="token keyword">if</span> e<span class="token punctuation">[</span><span class="token string">&#39;timestamp&#39;</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> end_time<span class="token punctuation">]</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> events</span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">AlertManager</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;告警管理器&quot;&quot;&quot;</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>alert_rules <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&#39;name&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;conversion_rate_drop&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;metric&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;conversion_rate&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;condition&#39;</span><span class="token punctuation">:</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token string">&#39;trend&#39;</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span>  <span class="token comment"># 转化率下降超过10%</span></span>
<span class="line">                <span class="token string">&#39;severity&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;high&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;message&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;转化率急剧下降，请立即检查！&#39;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&#39;name&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;revenue_spike&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;metric&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;revenue&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;condition&#39;</span><span class="token punctuation">:</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token string">&#39;hourly_revenue&#39;</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">100000</span><span class="token punctuation">,</span>  <span class="token comment"># 小时收入超过10万</span></span>
<span class="line">                <span class="token string">&#39;severity&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;info&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;message&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;收入创新高！&#39;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&#39;name&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;low_traffic&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;metric&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;traffic&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;condition&#39;</span><span class="token punctuation">:</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token string">&#39;visitors&#39;</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">,</span>  <span class="token comment"># 访客数低于100</span></span>
<span class="line">                <span class="token string">&#39;severity&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;medium&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;message&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;流量异常偏低，请检查推广渠道。&#39;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">]</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">check_alerts</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> metrics<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;检查告警条件&quot;&quot;&quot;</span></span>
<span class="line">        alerts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">for</span> rule <span class="token keyword">in</span> self<span class="token punctuation">.</span>alert_rules<span class="token punctuation">:</span></span>
<span class="line">            metric_data <span class="token operator">=</span> metrics<span class="token punctuation">.</span>get<span class="token punctuation">(</span>rule<span class="token punctuation">[</span><span class="token string">&#39;metric&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> metric_data <span class="token keyword">and</span> rule<span class="token punctuation">[</span><span class="token string">&#39;condition&#39;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>metric_data<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">                alerts<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token string">&#39;rule_name&#39;</span><span class="token punctuation">:</span> rule<span class="token punctuation">[</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&#39;severity&#39;</span><span class="token punctuation">:</span> rule<span class="token punctuation">[</span><span class="token string">&#39;severity&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&#39;message&#39;</span><span class="token punctuation">:</span> rule<span class="token punctuation">[</span><span class="token string">&#39;message&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&#39;metric&#39;</span><span class="token punctuation">:</span> rule<span class="token punctuation">[</span><span class="token string">&#39;metric&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&#39;value&#39;</span><span class="token punctuation">:</span> metric_data<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&#39;timestamp&#39;</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> alerts</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-数据隐私与合规" tabindex="-1"><a class="header-anchor" href="#_7-数据隐私与合规"><span>7. 数据隐私与合规</span></a></h2><h3 id="q15-用户数据保护与隐私合规" tabindex="-1"><a class="header-anchor" href="#q15-用户数据保护与隐私合规"><span>Q15: 用户数据保护与隐私合规？</span></a></h3><p><strong>答：</strong> 确保用户数据安全和隐私合规是智能营销的基础：</p><p><strong>数据隐私保护框架</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> hashlib</span>
<span class="line"><span class="token keyword">import</span> hmac</span>
<span class="line"><span class="token keyword">from</span> cryptography<span class="token punctuation">.</span>fernet <span class="token keyword">import</span> Fernet</span>
<span class="line"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Dict<span class="token punctuation">,</span> Any<span class="token punctuation">,</span> Optional</span>
<span class="line"><span class="token keyword">import</span> json</span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">DataPrivacyManager</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>encryption_key <span class="token operator">=</span> self<span class="token punctuation">.</span>_load_or_generate_key<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>cipher_suite <span class="token operator">=</span> Fernet<span class="token punctuation">(</span>self<span class="token punctuation">.</span>encryption_key<span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>consent_manager <span class="token operator">=</span> ConsentManager<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>data_minimizer <span class="token operator">=</span> DataMinimizer<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">encrypt_sensitive_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;加密敏感数据&quot;&quot;&quot;</span></span>
<span class="line">        encrypted_data <span class="token operator">=</span> self<span class="token punctuation">.</span>cipher_suite<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> encrypted_data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">decrypt_sensitive_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> encrypted_data<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;解密敏感数据&quot;&quot;&quot;</span></span>
<span class="line">        decrypted_data <span class="token operator">=</span> self<span class="token punctuation">.</span>cipher_suite<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>encrypted_data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> decrypted_data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">anonymize_user_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_data<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;匿名化用户数据&quot;&quot;&quot;</span></span>
<span class="line">        anonymized_data <span class="token operator">=</span> user_data<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 匿名化敏感字段</span></span>
<span class="line">        sensitive_fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;phone&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;email&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;address&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;id_card&#39;</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token keyword">for</span> field <span class="token keyword">in</span> sensitive_fields<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">if</span> field <span class="token keyword">in</span> anonymized_data<span class="token punctuation">:</span></span>
<span class="line">                anonymized_data<span class="token punctuation">[</span>field<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>_anonymize_field<span class="token punctuation">(</span></span>
<span class="line">                    anonymized_data<span class="token punctuation">[</span>field<span class="token punctuation">]</span></span>
<span class="line">                <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> anonymized_data</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_anonymize_field</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;匿名化单个字段&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token string">&#39;@&#39;</span> <span class="token keyword">in</span> value<span class="token punctuation">:</span>  <span class="token comment"># 邮箱</span></span>
<span class="line">            parts <span class="token operator">=</span> value<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&#39;@&#39;</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token format-spec">2]</span><span class="token punctuation">}</span></span><span class="token string">***@</span><span class="token interpolation"><span class="token punctuation">{</span>parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span></span>
<span class="line">        <span class="token keyword">elif</span> value<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">&#39;-&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isdigit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 电话号码</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token format-spec">3]</span><span class="token punctuation">}</span></span><span class="token string">****</span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token format-spec">]</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">7</span> <span class="token keyword">else</span> <span class="token string">&quot;***&quot;</span></span>
<span class="line">        <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># 其他敏感信息</span></span>
<span class="line">            <span class="token keyword">return</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span>value<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">process_user_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> </span>
<span class="line">                           request_data<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;处理用户数据权利请求&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token keyword">if</span> request_type <span class="token operator">==</span> <span class="token string">&#39;data_access&#39;</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_handle_data_access_request<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">elif</span> request_type <span class="token operator">==</span> <span class="token string">&#39;data_deletion&#39;</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_handle_data_deletion_request<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">elif</span> request_type <span class="token operator">==</span> <span class="token string">&#39;data_portability&#39;</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_handle_data_portability_request<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">elif</span> request_type <span class="token operator">==</span> <span class="token string">&#39;consent_withdrawal&#39;</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_handle_consent_withdrawal<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> request_data<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Unsupported request type: </span><span class="token interpolation"><span class="token punctuation">{</span>request_type<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_handle_data_access_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;处理数据访问请求&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token comment"># 检查用户同意状态</span></span>
<span class="line">        consent_status <span class="token operator">=</span> self<span class="token punctuation">.</span>consent_manager<span class="token punctuation">.</span>get_user_consent<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> consent_status<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;data_access&#39;</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&#39;success&#39;</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;error&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;User has not consented to data access&#39;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 获取用户数据</span></span>
<span class="line">        user_data <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_user_data<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 最小化数据输出</span></span>
<span class="line">        minimized_data <span class="token operator">=</span> self<span class="token punctuation">.</span>data_minimizer<span class="token punctuation">.</span>minimize_for_access<span class="token punctuation">(</span>user_data<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;success&#39;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;data&#39;</span><span class="token punctuation">:</span> minimized_data<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;timestamp&#39;</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_handle_data_deletion_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;处理数据删除请求&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token comment"># 检查是否有法律义务保留数据</span></span>
<span class="line">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_has_legal_retention_obligation<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&#39;success&#39;</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;error&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;Legal retention obligation prevents deletion&#39;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 执行数据删除</span></span>
<span class="line">        deletion_result <span class="token operator">=</span> self<span class="token punctuation">.</span>_delete_user_data<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 记录删除操作</span></span>
<span class="line">        self<span class="token punctuation">.</span>_log_deletion_operation<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> deletion_result<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;success&#39;</span><span class="token punctuation">:</span> deletion_result<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;message&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;User data has been deleted&#39;</span> <span class="token keyword">if</span> deletion_result <span class="token keyword">else</span> <span class="token string">&#39;Deletion failed&#39;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">ensure_compliance</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> marketing_activity<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;确保营销活动合规&quot;&quot;&quot;</span></span>
<span class="line">        user_id <span class="token operator">=</span> marketing_activity<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;user_id&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        activity_type <span class="token operator">=</span> marketing_activity<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;activity_type&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 检查用户同意状态</span></span>
<span class="line">        consent_status <span class="token operator">=</span> self<span class="token punctuation">.</span>consent_manager<span class="token punctuation">.</span>get_user_consent<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 检查特定活动类型的同意</span></span>
<span class="line">        required_consents <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;email_marketing&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;email&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;sms_marketing&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;sms&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;personalized_ads&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;targeted_advertising&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;data_sharing&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;data_sharing&#39;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        required_consent <span class="token operator">=</span> required_consents<span class="token punctuation">.</span>get<span class="token punctuation">(</span>activity_type<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> required_consent <span class="token keyword">and</span> <span class="token keyword">not</span> consent_status<span class="token punctuation">.</span>get<span class="token punctuation">(</span>required_consent<span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">False</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 检查数据使用目的</span></span>
<span class="line">        intended_use <span class="token operator">=</span> marketing_activity<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;purpose&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> intended_use <span class="token keyword">and</span> <span class="token keyword">not</span> consent_status<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#39;purpose_</span><span class="token interpolation"><span class="token punctuation">{</span>intended_use<span class="token punctuation">}</span></span><span class="token string">&#39;</span></span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">False</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">True</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">ConsentManager</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;用户同意管理器&quot;&quot;&quot;</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>consent_store <span class="token operator">=</span> ConsentStore<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">record_user_consent</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> consent_data<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;记录用户同意&quot;&quot;&quot;</span></span>
<span class="line">        consent_record <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;user_id&#39;</span><span class="token punctuation">:</span> user_id<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;consent_data&#39;</span><span class="token punctuation">:</span> consent_data<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;timestamp&#39;</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;version&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;1.0&#39;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 计算同意记录的签名以确保完整性</span></span>
<span class="line">        consent_record<span class="token punctuation">[</span><span class="token string">&#39;signature&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>_sign_consent_record<span class="token punctuation">(</span>consent_record<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> self<span class="token punctuation">.</span>consent_store<span class="token punctuation">.</span>save_consent<span class="token punctuation">(</span>consent_record<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get_user_consent</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;获取用户同意状态&quot;&quot;&quot;</span></span>
<span class="line">        consent_record <span class="token operator">=</span> self<span class="token punctuation">.</span>consent_store<span class="token punctuation">.</span>get_latest_consent<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> consent_record<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 验证签名</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_verify_consent_signature<span class="token punctuation">(</span>consent_record<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">&quot;Consent record signature verification failed&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> consent_record<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;consent_data&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">withdraw_consent</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> consent_types<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;撤销用户同意&quot;&quot;&quot;</span></span>
<span class="line">        current_consent <span class="token operator">=</span> self<span class="token punctuation">.</span>get_user_consent<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 更新同意状态</span></span>
<span class="line">        <span class="token keyword">for</span> consent_type <span class="token keyword">in</span> consent_types<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">if</span> consent_type <span class="token keyword">in</span> current_consent<span class="token punctuation">:</span></span>
<span class="line">                current_consent<span class="token punctuation">[</span>consent_type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 记录更新</span></span>
<span class="line">        <span class="token keyword">return</span> self<span class="token punctuation">.</span>record_user_consent<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> current_consent<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_sign_consent_record</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> record<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;对同意记录进行签名&quot;&quot;&quot;</span></span>
<span class="line">        record_copy <span class="token operator">=</span> record<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        record_copy<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">&#39;signature&#39;</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>  <span class="token comment"># 移除签名字段</span></span>
<span class="line">        </span>
<span class="line">        record_string <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>record_copy<span class="token punctuation">,</span> sort_keys<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line">        signature <span class="token operator">=</span> hmac<span class="token punctuation">.</span>new<span class="token punctuation">(</span></span>
<span class="line">            <span class="token string">b&#39;secret_key_for_signing&#39;</span><span class="token punctuation">,</span>  <span class="token comment"># 实际应用中应使用安全的密钥管理</span></span>
<span class="line">            record_string<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            hashlib<span class="token punctuation">.</span>sha256</span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> signature</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_verify_consent_signature</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> record<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;验证同意记录签名&quot;&quot;&quot;</span></span>
<span class="line">        original_signature <span class="token operator">=</span> record<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;signature&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> original_signature<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">False</span></span>
<span class="line">        </span>
<span class="line">        record_copy <span class="token operator">=</span> record<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        record_copy<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">&#39;signature&#39;</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        calculated_signature <span class="token operator">=</span> self<span class="token punctuation">.</span>_sign_consent_record<span class="token punctuation">(</span>record_copy<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> hmac<span class="token punctuation">.</span>compare_digest<span class="token punctuation">(</span>original_signature<span class="token punctuation">,</span> calculated_signature<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">GDPRComplianceChecker</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;GDPR合规检查器&quot;&quot;&quot;</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>privacy_manager <span class="token operator">=</span> DataPrivacyManager<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>consent_manager <span class="token operator">=</span> ConsentManager<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">check_compliance</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> marketing_campaign<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;检查GDPR合规性&quot;&quot;&quot;</span></span>
<span class="line">        compliance_report <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;compliant&#39;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;violations&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;recommendations&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 检查数据处理合法性</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_check_legal_basis<span class="token punctuation">(</span>marketing_campaign<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            compliance_report<span class="token punctuation">[</span><span class="token string">&#39;compliant&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span></span>
<span class="line">            compliance_report<span class="token punctuation">[</span><span class="token string">&#39;violations&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">&#39;No legal basis for data processing&#39;</span><span class="token punctuation">)</span></span>
<span class="line">            compliance_report<span class="token punctuation">[</span><span class="token string">&#39;recommendations&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">&#39;Obtain explicit consent or establish legitimate interest&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 检查用户同意</span></span>
<span class="line">        user_id <span class="token operator">=</span> marketing_campaign<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;target_audience&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;user_id&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> user_id<span class="token punctuation">:</span></span>
<span class="line">            consent_status <span class="token operator">=</span> self<span class="token punctuation">.</span>consent_manager<span class="token punctuation">.</span>get_user_consent<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token keyword">not</span> consent_status<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;marketing&#39;</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">                compliance_report<span class="token punctuation">[</span><span class="token string">&#39;compliant&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span></span>
<span class="line">                compliance_report<span class="token punctuation">[</span><span class="token string">&#39;violations&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">&#39;No marketing consent obtained&#39;</span><span class="token punctuation">)</span></span>
<span class="line">                compliance_report<span class="token punctuation">[</span><span class="token string">&#39;recommendations&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">&#39;Request marketing consent from user&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 检查数据最小化原则</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_check_data_minimization<span class="token punctuation">(</span>marketing_campaign<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            compliance_report<span class="token punctuation">[</span><span class="token string">&#39;violations&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">&#39;Data minimization principle violated&#39;</span><span class="token punctuation">)</span></span>
<span class="line">            compliance_report<span class="token punctuation">[</span><span class="token string">&#39;recommendations&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">&#39;Collect only necessary personal data&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 检查存储期限</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_check_storage_limitation<span class="token punctuation">(</span>marketing_campaign<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            compliance_report<span class="token punctuation">[</span><span class="token string">&#39;violations&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">&#39;Storage limitation principle violated&#39;</span><span class="token punctuation">)</span></span>
<span class="line">            compliance_report<span class="token punctuation">[</span><span class="token string">&#39;recommendations&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">&#39;Implement data retention policies&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> compliance_report</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_check_legal_basis</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> campaign<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;检查数据处理的法律依据&quot;&quot;&quot;</span></span>
<span class="line">        legal_bases <span class="token operator">=</span> campaign<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;legal_basis&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        valid_bases <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;consent&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;contract&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;legal_obligation&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;vital_interest&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;public_task&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;legitimate_interest&#39;</span><span class="token punctuation">]</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token builtin">any</span><span class="token punctuation">(</span>basis <span class="token keyword">in</span> valid_bases <span class="token keyword">for</span> basis <span class="token keyword">in</span> legal_bases<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_check_data_minimization</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> campaign<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;检查数据最小化原则&quot;&quot;&quot;</span></span>
<span class="line">        collected_data <span class="token operator">=</span> campaign<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;collected_data&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        necessary_data <span class="token operator">=</span> campaign<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;necessary_data&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 检查收集的数据是否超出必要范围</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token builtin">set</span><span class="token punctuation">(</span>collected_data<span class="token punctuation">)</span><span class="token punctuation">.</span>issubset<span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>necessary_data<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_check_storage_limitation</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> campaign<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;检查存储期限限制&quot;&quot;&quot;</span></span>
<span class="line">        retention_period <span class="token operator">=</span> campaign<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;data_retention_period&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> retention_period<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">False</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 检查是否设置了合理的数据保留期限</span></span>
<span class="line">        max_retention_days <span class="token operator">=</span> <span class="token number">365</span> <span class="token operator">*</span> <span class="token number">3</span>  <span class="token comment"># 最长3年</span></span>
<span class="line">        <span class="token keyword">return</span> retention_period <span class="token operator">&lt;=</span> max_retention_days</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="q16-智能营销平台安全架构" tabindex="-1"><a class="header-anchor" href="#q16-智能营销平台安全架构"><span>Q16: 智能营销平台安全架构？</span></a></h3><p><strong>答：</strong> 构建安全的智能营销平台架构：</p><p><strong>零信任安全架构</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> jwt</span>
<span class="line"><span class="token keyword">from</span> cryptography<span class="token punctuation">.</span>hazmat<span class="token punctuation">.</span>primitives <span class="token keyword">import</span> hashes</span>
<span class="line"><span class="token keyword">from</span> cryptography<span class="token punctuation">.</span>hazmat<span class="token punctuation">.</span>primitives<span class="token punctuation">.</span>kdf<span class="token punctuation">.</span>pbkdf2 <span class="token keyword">import</span> PBKDF2HMAC</span>
<span class="line"><span class="token keyword">import</span> base64</span>
<span class="line"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Dict<span class="token punctuation">,</span> List<span class="token punctuation">,</span> Optional</span>
<span class="line"><span class="token keyword">import</span> time</span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">ZeroTrustSecurityFramework</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>identity_provider <span class="token operator">=</span> IdentityProvider<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>access_controller <span class="token operator">=</span> AccessController<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>threat_detector <span class="token operator">=</span> ThreatDetector<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>audit_logger <span class="token operator">=</span> AuditLogger<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">authenticate_user</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> credentials<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;用户身份认证&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token comment"># 多因素认证</span></span>
<span class="line">        auth_result <span class="token operator">=</span> self<span class="token punctuation">.</span>identity_provider<span class="token punctuation">.</span>authenticate<span class="token punctuation">(</span>credentials<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> auth_result<span class="token punctuation">[</span><span class="token string">&#39;success&#39;</span><span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">            self<span class="token punctuation">.</span>audit_logger<span class="token punctuation">.</span>log_authentication_failure<span class="token punctuation">(</span>credentials<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;username&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> auth_result</span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 生成JWT令牌</span></span>
<span class="line">        token <span class="token operator">=</span> self<span class="token punctuation">.</span>_generate_jwt_token<span class="token punctuation">(</span></span>
<span class="line">            auth_result<span class="token punctuation">[</span><span class="token string">&#39;user_id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            auth_result<span class="token punctuation">[</span><span class="token string">&#39;permissions&#39;</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        self<span class="token punctuation">.</span>audit_logger<span class="token punctuation">.</span>log_authentication_success<span class="token punctuation">(</span></span>
<span class="line">            auth_result<span class="token punctuation">[</span><span class="token string">&#39;user_id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            credentials<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;username&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><!----><!----></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script src="/wiki/assets/js/runtime~app.46b38a58.js" defer></script><script src="/wiki/assets/js/768.e6d4205d.js" defer></script><script src="/wiki/assets/js/app.34e6f7f1.js" defer></script>
  </body>
</html>
