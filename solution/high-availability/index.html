<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.20" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>ToC业务高可用解决方案 | 知识库</title><meta name="description" content="涵盖Java、Spring、Vue、Node.js等技术知识">
    <link rel="stylesheet" href="/wiki/assets/css/styles.2a121ef9.css">
    <link rel="preload" href="/wiki/assets/js/runtime~app.de5fe002.js" as="script"><link rel="preload" href="/wiki/assets/css/styles.2a121ef9.css" as="style"><link rel="preload" href="/wiki/assets/js/768.e6d4205d.js" as="script"><link rel="preload" href="/wiki/assets/js/app.ae84ebda.js" as="script">
    <link rel="prefetch" href="/wiki/assets/js/solution_smart-marketing_index.html.c6a04243.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_high-availability_index.html.1ef390b5.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_react_index.html.4aacb360.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_aiops_index.html.9565eae6.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_swift_index.html.26390310.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_embedded_index.html.1d42b838.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_nodejs_index.html.42d74f45.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_python_index.html.e9a522b3.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_spring-boot_index.html.38761574.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_java_jdk-changes_index.html.25824bdf.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_finops_tools.html.f03a4487.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_llm_01-intro.html.d02af743.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_r_index.html.16153cc5.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_vue_index.html.63167ab5.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_java_concurrency_index.html.e362b849.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_java_advanced_index.html.71c33c5c.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_spring-cloud_index.html.fd0f185e.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_message-queue_index.html.b4b3c3e6.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_big-data_index.html.bbd64ec0.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_database_index.html.14a46108.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_java_basic_index.html.bddf19ef.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_ml_index.html.7188e38d.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_llm_index.html.b42c7983.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_java_collections_index.html.0c5ba651.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_rl_index.html.6c114c3c.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_finops_implementation.html.5e17714b.js" as="script"><link rel="prefetch" href="/wiki/assets/js/get-started.html.c4557635.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_finops_kubecost-installation.html.ab8b0c04.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_finops_risk-trends.html.6525c9fc.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_finops_case-studies.html.08c4404f.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_finops_index.html.f1c67882.js" as="script"><link rel="prefetch" href="/wiki/assets/js/index.html.6a2169db.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_finops_concept.html.0854ee3f.js" as="script"><link rel="prefetch" href="/wiki/assets/js/404.html.a5b4614e.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/wiki/"><img class="vp-site-logo" src="/wiki/logo/logo.svg" alt="知识库"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">知识库</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/wiki/" aria-label="首页"><!--[--><!--[--><!--]--><!--]-->首页<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/wiki/get-started.html" aria-label="开始阅读"><!--[--><!--[--><!--]--><!--]-->开始阅读<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="Java"><span class="title">Java</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="Java"><span class="title">Java</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/basic/" aria-label="Java基础"><!--[--><!--[--><!--]--><!--]-->Java基础<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/advanced/" aria-label="Java高级"><!--[--><!--[--><!--]--><!--]-->Java高级<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/collections/" aria-label="Java集合详解"><!--[--><!--[--><!--]--><!--]-->Java集合详解<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/concurrency/" aria-label="Java多线程详解"><!--[--><!--[--><!--]--><!--]-->Java多线程详解<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/jdk-changes/" aria-label="JDK版本变化详解"><!--[--><!--[--><!--]--><!--]-->JDK版本变化详解<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="Spring"><span class="title">Spring</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="Spring"><span class="title">Spring</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/spring-boot/" aria-label="Spring Boot"><!--[--><!--[--><!--]--><!--]-->Spring Boot<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/spring-cloud/" aria-label="Spring Cloud"><!--[--><!--[--><!--]--><!--]-->Spring Cloud<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="解决方案"><span class="title">解决方案</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="解决方案"><span class="title">解决方案</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/solution/aiops/" aria-label="AIOps"><!--[--><!--[--><!--]--><!--]-->AIOps<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/solution/finops/" aria-label="FinOps"><!--[--><!--[--><!--]--><!--]-->FinOps<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link route-link-active auto-link" href="/wiki/solution/high-availability/" aria-label="高可用架构"><!--[--><!--[--><!--]--><!--]-->高可用架构<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/solution/smart-marketing/" aria-label="智能营销"><!--[--><!--[--><!--]--><!--]-->智能营销<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/wiki/" aria-label="首页"><!--[--><!--[--><!--]--><!--]-->首页<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/wiki/get-started.html" aria-label="开始阅读"><!--[--><!--[--><!--]--><!--]-->开始阅读<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="Java"><span class="title">Java</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="Java"><span class="title">Java</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/basic/" aria-label="Java基础"><!--[--><!--[--><!--]--><!--]-->Java基础<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/advanced/" aria-label="Java高级"><!--[--><!--[--><!--]--><!--]-->Java高级<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/collections/" aria-label="Java集合详解"><!--[--><!--[--><!--]--><!--]-->Java集合详解<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/concurrency/" aria-label="Java多线程详解"><!--[--><!--[--><!--]--><!--]-->Java多线程详解<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/jdk-changes/" aria-label="JDK版本变化详解"><!--[--><!--[--><!--]--><!--]-->JDK版本变化详解<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="Spring"><span class="title">Spring</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="Spring"><span class="title">Spring</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/spring-boot/" aria-label="Spring Boot"><!--[--><!--[--><!--]--><!--]-->Spring Boot<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/spring-cloud/" aria-label="Spring Cloud"><!--[--><!--[--><!--]--><!--]-->Spring Cloud<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="解决方案"><span class="title">解决方案</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="解决方案"><span class="title">解决方案</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/solution/aiops/" aria-label="AIOps"><!--[--><!--[--><!--]--><!--]-->AIOps<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/solution/finops/" aria-label="FinOps"><!--[--><!--[--><!--]--><!--]-->FinOps<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link route-link-active auto-link" href="/wiki/solution/high-availability/" aria-label="高可用架构"><!--[--><!--[--><!--]--><!--]-->高可用架构<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/solution/smart-marketing/" aria-label="智能营销"><!--[--><!--[--><!--]--><!--]-->智能营销<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><a class="route-link route-link-active auto-link vp-sidebar-item vp-sidebar-heading active" href="/wiki/solution/high-availability/" aria-label="高可用架构解决方案"><!--[--><!--[--><!--]--><!--]-->高可用架构解决方案<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div><h1 id="toc业务高可用解决方案" tabindex="-1"><a class="header-anchor" href="#toc业务高可用解决方案"><span>ToC业务高可用解决方案</span></a></h1><h2 id="_1-高可用架构基础" tabindex="-1"><a class="header-anchor" href="#_1-高可用架构基础"><span>1. 高可用架构基础</span></a></h2><h3 id="q1-什么是高可用性-toc业务为什么需要高可用" tabindex="-1"><a class="header-anchor" href="#q1-什么是高可用性-toc业务为什么需要高可用"><span>Q1: 什么是高可用性？ToC业务为什么需要高可用？</span></a></h3><p><strong>答：</strong> 高可用性（High Availability, HA）是指系统在面对各种故障时仍能持续提供服务的能力，通常用可用性百分比来衡量。</p><p>ToC业务需要高可用的原因：</p><ul><li><strong>用户体验</strong>：用户对服务中断容忍度极低，直接影响用户满意度和留存率</li><li><strong>商业损失</strong>：服务中断直接导致收入损失，如电商交易、广告展示等</li><li><strong>品牌声誉</strong>：频繁故障损害品牌形象和用户信任</li><li><strong>竞争优势</strong>：高可用成为差异化竞争的重要因素</li></ul><p>可用性等级标准：</p><ul><li>99%：每年宕机约3.65天</li><li>99.9%：每年宕机约8.76小时</li><li>99.99%：每年宕机约52.6分钟</li><li>99.999%：每年宕机约5.26分钟</li></ul><h3 id="q2-高可用架构设计原则" tabindex="-1"><a class="header-anchor" href="#q2-高可用架构设计原则"><span>Q2: 高可用架构设计原则？</span></a></h3><p><strong>答：</strong> 高可用架构设计的核心原则：</p><ol><li><strong>冗余设计</strong>：</li></ol><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code><span class="line"><span class="token comment"># 多可用区部署示例</span></span>
<span class="line"><span class="token key atrule">regions</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">region</span><span class="token punctuation">:</span> cn<span class="token punctuation">-</span>north<span class="token punctuation">-</span><span class="token number">1</span></span>
<span class="line">    <span class="token key atrule">zones</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">zone</span><span class="token punctuation">:</span> cn<span class="token punctuation">-</span>north<span class="token punctuation">-</span>1a</span>
<span class="line">        <span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> web_server</span>
<span class="line">          <span class="token punctuation">-</span> database_master</span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">zone</span><span class="token punctuation">:</span> cn<span class="token punctuation">-</span>north<span class="token punctuation">-</span>1b</span>
<span class="line">        <span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> web_server</span>
<span class="line">          <span class="token punctuation">-</span> database_slave</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><strong>故障隔离</strong>：</li></ol><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">CircuitBreaker</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> failure_threshold<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>failure_count <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">        self<span class="token punctuation">.</span>failure_threshold <span class="token operator">=</span> failure_threshold</span>
<span class="line">        self<span class="token punctuation">.</span>timeout <span class="token operator">=</span> timeout</span>
<span class="line">        self<span class="token punctuation">.</span>last_failure_time <span class="token operator">=</span> <span class="token boolean">None</span></span>
<span class="line">        self<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">&quot;CLOSED&quot;</span>  <span class="token comment"># CLOSED, OPEN, HALF_OPEN</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">call</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> func<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>state <span class="token operator">==</span> <span class="token string">&quot;OPEN&quot;</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">if</span> self<span class="token punctuation">.</span>_should_attempt_reset<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">                <span class="token keyword">return</span> self<span class="token punctuation">.</span>_attempt_half_open<span class="token punctuation">(</span>func<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwargs<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">                <span class="token keyword">raise</span> ServiceUnavailable<span class="token punctuation">(</span><span class="token string">&quot;Circuit breaker is OPEN&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">            result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span></span>
<span class="line">            self<span class="token punctuation">.</span>_on_success<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> result</span>
<span class="line">        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></span>
<span class="line">            self<span class="token punctuation">.</span>_on_failure<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">raise</span> e</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_on_failure</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>failure_count <span class="token operator">+=</span> <span class="token number">1</span></span>
<span class="line">        self<span class="token punctuation">.</span>last_failure_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>failure_count <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>failure_threshold<span class="token punctuation">:</span></span>
<span class="line">            self<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">&quot;OPEN&quot;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_on_success</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>failure_count <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>state <span class="token operator">==</span> <span class="token string">&quot;HALF_OPEN&quot;</span><span class="token punctuation">:</span></span>
<span class="line">            self<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">&quot;CLOSED&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><strong>优雅降级</strong>：</li></ol><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">DegradationManager</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>strategies <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;normal&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>normal_mode<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;degraded&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>degraded_mode<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;emergency&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>emergency_mode</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">handle_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        current_mode <span class="token operator">=</span> self<span class="token punctuation">.</span>get_current_mode<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        strategy <span class="token operator">=</span> self<span class="token punctuation">.</span>strategies<span class="token punctuation">.</span>get<span class="token punctuation">(</span>current_mode<span class="token punctuation">,</span> self<span class="token punctuation">.</span>normal_mode<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> strategy<span class="token punctuation">(</span>request<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">degraded_mode</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 简化处理逻辑</span></span>
<span class="line">        <span class="token comment"># 禁用非核心功能</span></span>
<span class="line">        <span class="token comment"># 返回缓存数据</span></span>
<span class="line">        <span class="token comment"># 降低服务质量但仍保持可用</span></span>
<span class="line">        <span class="token keyword">return</span> self<span class="token punctuation">.</span>simplified_response<span class="token punctuation">(</span>request<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="q3-高可用架构的核心组件" tabindex="-1"><a class="header-anchor" href="#q3-高可用架构的核心组件"><span>Q3: 高可用架构的核心组件？</span></a></h3><p><strong>答：</strong> 高可用架构的核心组件包括：</p><ol><li><strong>负载均衡器</strong>：</li></ol><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx"><pre><code><span class="line"><span class="token directive"><span class="token keyword">upstream</span> backend_servers</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">least_conn</span></span><span class="token punctuation">;</span>  <span class="token comment"># 最少连接数算法</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">server</span> 10.0.0.1:8080 max_fails=3 fail_timeout=30s</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">server</span> 10.0.0.2:8080 max_fails=3 fail_timeout=30s</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">server</span> 10.0.0.3:8080 max_fails=3 fail_timeout=30s</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">proxy_pass</span> http://backend_servers</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">proxy_connect_timeout</span> <span class="token number">5s</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">proxy_send_timeout</span> <span class="token number">10s</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">proxy_read_timeout</span> <span class="token number">10s</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><strong>服务注册与发现</strong>：</li></ol><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">ServiceRegistry</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>services <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">        self<span class="token punctuation">.</span>health_check_interval <span class="token operator">=</span> <span class="token number">30</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">register_service</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> service_name<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        service_id <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>service_name<span class="token punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token punctuation">{</span>host<span class="token punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token punctuation">{</span>port<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span></span>
<span class="line">        self<span class="token punctuation">.</span>services<span class="token punctuation">[</span>service_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;name&#39;</span><span class="token punctuation">:</span> service_name<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;host&#39;</span><span class="token punctuation">:</span> host<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;port&#39;</span><span class="token punctuation">:</span> port<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;status&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;UP&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;last_heartbeat&#39;</span><span class="token punctuation">:</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> service_id</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">heartbeat</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> service_id<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">if</span> service_id <span class="token keyword">in</span> self<span class="token punctuation">.</span>services<span class="token punctuation">:</span></span>
<span class="line">            self<span class="token punctuation">.</span>services<span class="token punctuation">[</span>service_id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&#39;last_heartbeat&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get_healthy_services</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> service_name<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        current_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        healthy_services <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">for</span> service <span class="token keyword">in</span> self<span class="token punctuation">.</span>services<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>service<span class="token punctuation">[</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">]</span> <span class="token operator">==</span> service_name <span class="token keyword">and</span> </span>
<span class="line">                service<span class="token punctuation">[</span><span class="token string">&#39;status&#39;</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&#39;UP&#39;</span> <span class="token keyword">and</span></span>
<span class="line">                current_time <span class="token operator">-</span> service<span class="token punctuation">[</span><span class="token string">&#39;last_heartbeat&#39;</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>health_check_interval <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">                healthy_services<span class="token punctuation">.</span>append<span class="token punctuation">(</span>service<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> healthy_services</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-数据库高可用方案" tabindex="-1"><a class="header-anchor" href="#_2-数据库高可用方案"><span>2. 数据库高可用方案</span></a></h2><h3 id="q4-数据库主从复制与读写分离" tabindex="-1"><a class="header-anchor" href="#q4-数据库主从复制与读写分离"><span>Q4: 数据库主从复制与读写分离？</span></a></h3><p><strong>答：</strong> 数据库高可用的核心方案之一是主从复制和读写分离：</p><p><strong>MySQL主从复制配置</strong>：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code><span class="line"><span class="token comment">-- 主库配置 (my.cnf)</span></span>
<span class="line"><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span></span>
<span class="line">server<span class="token operator">-</span>id <span class="token operator">=</span> <span class="token number">1</span></span>
<span class="line">log<span class="token operator">-</span>bin <span class="token operator">=</span> mysql<span class="token operator">-</span>bin</span>
<span class="line">binlog<span class="token operator">-</span>format <span class="token operator">=</span> <span class="token keyword">ROW</span></span>
<span class="line">sync_binlog <span class="token operator">=</span> <span class="token number">1</span></span>
<span class="line">innodb_flush_log_at_trx_commit <span class="token operator">=</span> <span class="token number">1</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 从库配置 (my.cnf)</span></span>
<span class="line"><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span></span>
<span class="line">server<span class="token operator">-</span>id <span class="token operator">=</span> <span class="token number">2</span></span>
<span class="line">relay<span class="token operator">-</span>log <span class="token operator">=</span> relay<span class="token operator">-</span>bin</span>
<span class="line">read_only <span class="token operator">=</span> <span class="token number">1</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>应用层读写分离</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">DatabaseRouter</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>master_db <span class="token operator">=</span> self<span class="token punctuation">.</span>_connect_master<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>slave_dbs <span class="token operator">=</span> self<span class="token punctuation">.</span>_connect_slaves<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>current_slave_index <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get_write_connection</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> self<span class="token punctuation">.</span>master_db</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get_read_connection</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 轮询选择从库</span></span>
<span class="line">        slave <span class="token operator">=</span> self<span class="token punctuation">.</span>slave_dbs<span class="token punctuation">[</span>self<span class="token punctuation">.</span>current_slave_index<span class="token punctuation">]</span></span>
<span class="line">        self<span class="token punctuation">.</span>current_slave_index <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>current_slave_index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>slave_dbs<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> slave</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">execute_query</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sql<span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> write<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">if</span> write<span class="token punctuation">:</span></span>
<span class="line">            conn <span class="token operator">=</span> self<span class="token punctuation">.</span>get_write_connection<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment"># 写操作同时同步到从库</span></span>
<span class="line">            self<span class="token punctuation">.</span>_sync_to_slaves<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> params<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">            conn <span class="token operator">=</span> self<span class="token punctuation">.</span>get_read_connection<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        cursor <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> params<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="q5-数据库集群方案" tabindex="-1"><a class="header-anchor" href="#q5-数据库集群方案"><span>Q5: 数据库集群方案？</span></a></h3><p><strong>答：</strong> 数据库集群提供更高的可用性和扩展性：</p><p><strong>MySQL Group Replication</strong>：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code><span class="line"><span class="token comment">-- 启用Group Replication</span></span>
<span class="line"><span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> group_replication_bootstrap_group<span class="token operator">=</span><span class="token keyword">ON</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">START</span> GROUP_REPLICATION<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> group_replication_bootstrap_group<span class="token operator">=</span><span class="token keyword">OFF</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 查看集群状态</span></span>
<span class="line"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> performance_schema<span class="token punctuation">.</span>replication_group_members<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 配置多主模式</span></span>
<span class="line"><span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> group_replication_single_primary_mode <span class="token operator">=</span> <span class="token keyword">OFF</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> group_replication_enforce_update_everywhere_checks <span class="token operator">=</span> <span class="token keyword">ON</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>应用层数据库集群访问</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">ClusterDatabaseManager</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>cluster_nodes <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">            <span class="token punctuation">{</span><span class="token string">&#39;host&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;db1.example.com&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;port&#39;</span><span class="token punctuation">:</span> <span class="token number">3306</span><span class="token punctuation">,</span> <span class="token string">&#39;role&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;primary&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">{</span><span class="token string">&#39;host&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;db2.example.com&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;port&#39;</span><span class="token punctuation">:</span> <span class="token number">3306</span><span class="token punctuation">,</span> <span class="token string">&#39;role&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;secondary&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">{</span><span class="token string">&#39;host&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;db3.example.com&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;port&#39;</span><span class="token punctuation">:</span> <span class="token number">3306</span><span class="token punctuation">,</span> <span class="token string">&#39;role&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;secondary&#39;</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">]</span></span>
<span class="line">        self<span class="token punctuation">.</span>connections <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">        self<span class="token punctuation">.</span>_initialize_connections<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_initialize_connections</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">for</span> node <span class="token keyword">in</span> self<span class="token punctuation">.</span>cluster_nodes<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">                conn <span class="token operator">=</span> self<span class="token punctuation">.</span>_create_connection<span class="token punctuation">(</span>node<span class="token punctuation">)</span></span>
<span class="line">                self<span class="token punctuation">.</span>connections<span class="token punctuation">[</span>node<span class="token punctuation">[</span><span class="token string">&#39;host&#39;</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token string">&#39;connection&#39;</span><span class="token punctuation">:</span> conn<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&#39;status&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;healthy&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&#39;last_check&#39;</span><span class="token punctuation">:</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></span>
<span class="line">                self<span class="token punctuation">.</span>connections<span class="token punctuation">[</span>node<span class="token punctuation">[</span><span class="token string">&#39;host&#39;</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token string">&#39;connection&#39;</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&#39;status&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;unhealthy&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&#39;last_check&#39;</span><span class="token punctuation">:</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get_connection</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> operation_type<span class="token operator">=</span><span class="token string">&#39;read&#39;</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        healthy_nodes <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_healthy_nodes<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> operation_type <span class="token operator">==</span> <span class="token string">&#39;write&#39;</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 写操作选择主节点</span></span>
<span class="line">            primary_node <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_primary_node<span class="token punctuation">(</span>healthy_nodes<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> primary_node<span class="token punctuation">:</span></span>
<span class="line">                <span class="token keyword">return</span> self<span class="token punctuation">.</span>connections<span class="token punctuation">[</span>primary_node<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&#39;connection&#39;</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 读操作可以选择任意健康节点</span></span>
<span class="line">            <span class="token keyword">if</span> healthy_nodes<span class="token punctuation">:</span></span>
<span class="line">                <span class="token comment"># 简单轮询负载均衡</span></span>
<span class="line">                selected_node <span class="token operator">=</span> healthy_nodes<span class="token punctuation">[</span><span class="token builtin">hash</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>healthy_nodes<span class="token punctuation">)</span><span class="token punctuation">]</span></span>
<span class="line">                <span class="token keyword">return</span> self<span class="token punctuation">.</span>connections<span class="token punctuation">[</span>selected_node<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&#39;connection&#39;</span><span class="token punctuation">]</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">&quot;No healthy database node available&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="q6-数据库分库分表策略" tabindex="-1"><a class="header-anchor" href="#q6-数据库分库分表策略"><span>Q6: 数据库分库分表策略？</span></a></h3><p><strong>答：</strong> 面对大数据量和高并发，分库分表是必要手段：</p><p><strong>水平分片策略</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">ShardingStrategy</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> shard_count<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>shard_count <span class="token operator">=</span> shard_count</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get_shard_key</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;基于用户ID的分片键计算&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token keyword">return</span> user_id <span class="token operator">%</span> self<span class="token punctuation">.</span>shard_count</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get_database_name</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> shard_key<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;获取数据库名称&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f&quot;user_db_</span><span class="token interpolation"><span class="token punctuation">{</span>shard_key <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span>  <span class="token comment"># 每4个分片一个数据库</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get_table_name</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> shard_key<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;获取表名称&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f&quot;user_info_</span><span class="token interpolation"><span class="token punctuation">{</span>shard_key <span class="token operator">%</span> <span class="token number">4</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span>  <span class="token comment"># 每个数据库4张表</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">ShardedDatabaseManager</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>sharding_strategy <span class="token operator">=</span> ShardingStrategy<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>connection_pools <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">        self<span class="token punctuation">.</span>_initialize_pools<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_initialize_pools</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 初始化所有分片的连接池</span></span>
<span class="line">        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            db_name <span class="token operator">=</span> self<span class="token punctuation">.</span>sharding_strategy<span class="token punctuation">.</span>get_database_name<span class="token punctuation">(</span>i<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> db_name <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>connection_pools<span class="token punctuation">:</span></span>
<span class="line">                self<span class="token punctuation">.</span>connection_pools<span class="token punctuation">[</span>db_name<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>_create_connection_pool<span class="token punctuation">(</span>db_name<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get_user_info</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        shard_key <span class="token operator">=</span> self<span class="token punctuation">.</span>sharding_strategy<span class="token punctuation">.</span>get_shard_key<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span></span>
<span class="line">        db_name <span class="token operator">=</span> self<span class="token punctuation">.</span>sharding_strategy<span class="token punctuation">.</span>get_database_name<span class="token punctuation">(</span>shard_key<span class="token punctuation">)</span></span>
<span class="line">        table_name <span class="token operator">=</span> self<span class="token punctuation">.</span>sharding_strategy<span class="token punctuation">.</span>get_table_name<span class="token punctuation">(</span>shard_key<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        connection <span class="token operator">=</span> self<span class="token punctuation">.</span>connection_pools<span class="token punctuation">[</span>db_name<span class="token punctuation">]</span><span class="token punctuation">.</span>get_connection<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">            cursor <span class="token operator">=</span> connection<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            sql <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;SELECT * FROM </span><span class="token interpolation"><span class="token punctuation">{</span>table_name<span class="token punctuation">}</span></span><span class="token string"> WHERE user_id = %s&quot;</span></span></span>
<span class="line">            cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> cursor<span class="token punctuation">.</span>fetchone<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">finally</span><span class="token punctuation">:</span></span>
<span class="line">            connection<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-缓存高可用方案" tabindex="-1"><a class="header-anchor" href="#_3-缓存高可用方案"><span>3. 缓存高可用方案</span></a></h2><h3 id="q7-redis高可用集群方案" tabindex="-1"><a class="header-anchor" href="#q7-redis高可用集群方案"><span>Q7: Redis高可用集群方案？</span></a></h3><p><strong>答：</strong> Redis高可用主要通过Redis Cluster和Sentinel实现：</p><p><strong>Redis Cluster配置</strong>：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token comment"># redis-cluster.conf</span></span>
<span class="line">port <span class="token number">7000</span></span>
<span class="line">cluster-enabled <span class="token function">yes</span></span>
<span class="line">cluster-config-file nodes.conf</span>
<span class="line">cluster-node-timeout <span class="token number">5000</span></span>
<span class="line">appendonly <span class="token function">yes</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 启动集群节点</span></span>
<span class="line">redis-server redis-cluster.conf</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 创建集群</span></span>
<span class="line">redis-cli <span class="token parameter variable">--cluster</span> create <span class="token number">127.0</span>.0.1:7000 <span class="token number">127.0</span>.0.1:7001 <span class="token number">127.0</span>.0.1:7002 <span class="token punctuation">\</span></span>
<span class="line">  <span class="token number">127.0</span>.0.1:7003 <span class="token number">127.0</span>.0.1:7004 <span class="token number">127.0</span>.0.1:7005 <span class="token punctuation">\</span></span>
<span class="line">  --cluster-replicas <span class="token number">1</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>应用层Redis集群访问</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> redis</span>
<span class="line"><span class="token keyword">from</span> redis<span class="token punctuation">.</span>cluster <span class="token keyword">import</span> RedisCluster</span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">RedisClusterManager</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> startup_nodes<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>cluster <span class="token operator">=</span> RedisCluster<span class="token punctuation">(</span></span>
<span class="line">            startup_nodes<span class="token operator">=</span>startup_nodes<span class="token punctuation">,</span></span>
<span class="line">            decode_responses<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></span>
<span class="line">            skip_full_coverage_check<span class="token operator">=</span><span class="token boolean">True</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> self<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">except</span> redis<span class="token punctuation">.</span>RedisError <span class="token keyword">as</span> e<span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 降级到本地缓存或数据库</span></span>
<span class="line">            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_fallback_get<span class="token punctuation">(</span>key<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">set</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> ex<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> self<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> ex<span class="token operator">=</span>ex<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">except</span> redis<span class="token punctuation">.</span>RedisError <span class="token keyword">as</span> e<span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 记录错误但不影响主流程</span></span>
<span class="line">            self<span class="token punctuation">.</span>_log_error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Redis set failed: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">False</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_fallback_get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 实现降级逻辑</span></span>
<span class="line">        <span class="token comment"># 可以查询本地缓存、数据库等</span></span>
<span class="line">        <span class="token keyword">pass</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="q8-多级缓存架构" tabindex="-1"><a class="header-anchor" href="#q8-多级缓存架构"><span>Q8: 多级缓存架构？</span></a></h3><p><strong>答：</strong> 多级缓存架构提供更好的性能和可用性：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">MultiLevelCache</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># L1: 本地缓存（最快的访问）</span></span>
<span class="line">        self<span class="token punctuation">.</span>l1_cache <span class="token operator">=</span> LocalCache<span class="token punctuation">(</span>max_size<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># L2: 分布式缓存（共享缓存）</span></span>
<span class="line">        self<span class="token punctuation">.</span>l2_cache <span class="token operator">=</span> RedisClusterManager<span class="token punctuation">(</span>startup_nodes<span class="token operator">=</span><span class="token punctuation">[</span></span>
<span class="line">            <span class="token punctuation">{</span><span class="token string">&quot;host&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;port&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;7000&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">{</span><span class="token string">&quot;host&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;port&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;7001&quot;</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># L3: 数据库（持久化存储）</span></span>
<span class="line">        self<span class="token punctuation">.</span>database <span class="token operator">=</span> DatabaseManager<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># L1缓存查询</span></span>
<span class="line">        value <span class="token operator">=</span> self<span class="token punctuation">.</span>l1_cache<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> value <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> value</span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># L2缓存查询</span></span>
<span class="line">        value <span class="token operator">=</span> self<span class="token punctuation">.</span>l2_cache<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> value <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 回种到L1缓存</span></span>
<span class="line">            self<span class="token punctuation">.</span>l1_cache<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> ttl<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> value</span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># L3数据库查询</span></span>
<span class="line">        value <span class="token operator">=</span> self<span class="token punctuation">.</span>database<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> value <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 回种到L1和L2缓存</span></span>
<span class="line">            self<span class="token punctuation">.</span>l1_cache<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> ttl<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">)</span></span>
<span class="line">            self<span class="token punctuation">.</span>l2_cache<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> ex<span class="token operator">=</span><span class="token number">600</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> value</span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">None</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">set</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> ttl<span class="token operator">=</span><span class="token number">600</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 同时写入各级缓存</span></span>
<span class="line">        self<span class="token punctuation">.</span>l1_cache<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> ttl<span class="token operator">=</span><span class="token builtin">min</span><span class="token punctuation">(</span>ttl<span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>l2_cache<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> ex<span class="token operator">=</span>ttl<span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment"># 异步写入数据库</span></span>
<span class="line">        self<span class="token punctuation">.</span>_async_write_to_db<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">LocalCache</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> max_size<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">        self<span class="token punctuation">.</span>max_size <span class="token operator">=</span> max_size</span>
<span class="line">        self<span class="token punctuation">.</span>access_times <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">if</span> key <span class="token keyword">in</span> self<span class="token punctuation">.</span>cache<span class="token punctuation">:</span></span>
<span class="line">            self<span class="token punctuation">.</span>access_times<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> self<span class="token punctuation">.</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">None</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">set</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> ttl<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>cache<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>max_size<span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># LRU淘汰策略</span></span>
<span class="line">            self<span class="token punctuation">.</span>_evict_lru<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        self<span class="token punctuation">.</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value</span>
<span class="line">        self<span class="token punctuation">.</span>access_times<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 设置过期时间</span></span>
<span class="line">        threading<span class="token punctuation">.</span>Timer<span class="token punctuation">(</span>ttl<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_expire_key<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_evict_lru</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>access_times<span class="token punctuation">:</span></span>
<span class="line">            oldest_key <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>access_times<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </span>
<span class="line">                           key<span class="token operator">=</span><span class="token keyword">lambda</span> k<span class="token punctuation">:</span> self<span class="token punctuation">.</span>access_times<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">del</span> self<span class="token punctuation">.</span>cache<span class="token punctuation">[</span>oldest_key<span class="token punctuation">]</span></span>
<span class="line">            <span class="token keyword">del</span> self<span class="token punctuation">.</span>access_times<span class="token punctuation">[</span>oldest_key<span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-消息队列高可用" tabindex="-1"><a class="header-anchor" href="#_4-消息队列高可用"><span>4. 消息队列高可用</span></a></h2><h3 id="q9-kafka高可用集群部署" tabindex="-1"><a class="header-anchor" href="#q9-kafka高可用集群部署"><span>Q9: Kafka高可用集群部署？</span></a></h3><p><strong>答：</strong> Kafka通过多副本机制实现高可用：</p><p><strong>Kafka集群配置</strong>：</p><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties"><pre><code><span class="line"><span class="token comment"># server.properties</span></span>
<span class="line"><span class="token key attr-name">broker.id</span><span class="token punctuation">=</span><span class="token value attr-value">0</span></span>
<span class="line"><span class="token key attr-name">listeners</span><span class="token punctuation">=</span><span class="token value attr-value">PLAINTEXT://:9092</span></span>
<span class="line"><span class="token key attr-name">advertised.listeners</span><span class="token punctuation">=</span><span class="token value attr-value">PLAINTEXT://localhost:9092</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># Zookeeper配置</span></span>
<span class="line"><span class="token key attr-name">zookeeper.connect</span><span class="token punctuation">=</span><span class="token value attr-value">localhost:2181,localhost:2182,localhost:2183</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 副本配置</span></span>
<span class="line"><span class="token key attr-name">num.replica.fetchers</span><span class="token punctuation">=</span><span class="token value attr-value">4</span></span>
<span class="line"><span class="token key attr-name">replica.lag.time.max.ms</span><span class="token punctuation">=</span><span class="token value attr-value">30000</span></span>
<span class="line"><span class="token key attr-name">replica.socket.timeout.ms</span><span class="token punctuation">=</span><span class="token value attr-value">30000</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 日志配置</span></span>
<span class="line"><span class="token key attr-name">log.retention.hours</span><span class="token punctuation">=</span><span class="token value attr-value">168</span></span>
<span class="line"><span class="token key attr-name">log.segment.bytes</span><span class="token punctuation">=</span><span class="token value attr-value">1073741824</span></span>
<span class="line"><span class="token key attr-name">log.retention.check.interval.ms</span><span class="token punctuation">=</span><span class="token value attr-value">300000</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 分区配置</span></span>
<span class="line"><span class="token key attr-name">num.partitions</span><span class="token punctuation">=</span><span class="token value attr-value">16</span></span>
<span class="line"><span class="token key attr-name">default.replication.factor</span><span class="token punctuation">=</span><span class="token value attr-value">3</span></span>
<span class="line"><span class="token key attr-name">min.insync.replicas</span><span class="token punctuation">=</span><span class="token value attr-value">2</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>应用层Kafka高可用访问</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> kafka <span class="token keyword">import</span> KafkaProducer<span class="token punctuation">,</span> KafkaConsumer</span>
<span class="line"><span class="token keyword">from</span> kafka<span class="token punctuation">.</span>errors <span class="token keyword">import</span> KafkaError</span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">HighAvailableKafkaClient</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> bootstrap_servers<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>bootstrap_servers <span class="token operator">=</span> bootstrap_servers</span>
<span class="line">        self<span class="token punctuation">.</span>producer <span class="token operator">=</span> <span class="token boolean">None</span></span>
<span class="line">        self<span class="token punctuation">.</span>_initialize_producer<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_initialize_producer</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">            self<span class="token punctuation">.</span>producer <span class="token operator">=</span> KafkaProducer<span class="token punctuation">(</span></span>
<span class="line">                bootstrap_servers<span class="token operator">=</span>self<span class="token punctuation">.</span>bootstrap_servers<span class="token punctuation">,</span></span>
<span class="line">                acks<span class="token operator">=</span><span class="token string">&#39;all&#39;</span><span class="token punctuation">,</span>  <span class="token comment"># 等待所有副本确认</span></span>
<span class="line">                retries<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span></span>
<span class="line">                retry_backoff_ms<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span></span>
<span class="line">                compression_type<span class="token operator">=</span><span class="token string">&#39;snappy&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                batch_size<span class="token operator">=</span><span class="token number">16384</span><span class="token punctuation">,</span></span>
<span class="line">                linger_ms<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span></span>
<span class="line">                buffer_memory<span class="token operator">=</span><span class="token number">33554432</span></span>
<span class="line">            <span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></span>
<span class="line">            self<span class="token punctuation">.</span>_handle_kafka_error<span class="token punctuation">(</span>e<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">send_message</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> message<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">            future <span class="token operator">=</span> self<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>send<span class="token punctuation">(</span>topic<span class="token punctuation">,</span> key<span class="token operator">=</span>key<span class="token punctuation">,</span> value<span class="token operator">=</span>message<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment"># 等待发送结果</span></span>
<span class="line">            record_metadata <span class="token operator">=</span> future<span class="token punctuation">.</span>get<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&#39;success&#39;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;topic&#39;</span><span class="token punctuation">:</span> record_metadata<span class="token punctuation">.</span>topic<span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;partition&#39;</span><span class="token punctuation">:</span> record_metadata<span class="token punctuation">.</span>partition<span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;offset&#39;</span><span class="token punctuation">:</span> record_metadata<span class="token punctuation">.</span>offset</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">except</span> KafkaError <span class="token keyword">as</span> e<span class="token punctuation">:</span></span>
<span class="line">            self<span class="token punctuation">.</span>_handle_kafka_error<span class="token punctuation">(</span>e<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&#39;success&#39;</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">&#39;error&#39;</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&#39;success&#39;</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">&#39;error&#39;</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">create_consumer</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> topics<span class="token punctuation">,</span> group_id<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> KafkaConsumer<span class="token punctuation">(</span></span>
<span class="line">            <span class="token operator">*</span>topics<span class="token punctuation">,</span></span>
<span class="line">            bootstrap_servers<span class="token operator">=</span>self<span class="token punctuation">.</span>bootstrap_servers<span class="token punctuation">,</span></span>
<span class="line">            group_id<span class="token operator">=</span>group_id<span class="token punctuation">,</span></span>
<span class="line">            enable_auto_commit<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></span>
<span class="line">            auto_commit_interval_ms<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span></span>
<span class="line">            auto_offset_reset<span class="token operator">=</span><span class="token string">&#39;earliest&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            session_timeout_ms<span class="token operator">=</span><span class="token number">30000</span><span class="token punctuation">,</span></span>
<span class="line">            heartbeat_interval_ms<span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">,</span></span>
<span class="line">            max_poll_records<span class="token operator">=</span><span class="token number">500</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="q10-消息队列可靠性保证" tabindex="-1"><a class="header-anchor" href="#q10-消息队列可靠性保证"><span>Q10: 消息队列可靠性保证？</span></a></h3><p><strong>答：</strong> 消息队列的可靠性保证机制：</p><p><strong>生产者可靠性</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">ReliableMessageProducer</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>kafka_client <span class="token operator">=</span> HighAvailableKafkaClient<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;localhost:9092&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>message_store <span class="token operator">=</span> DatabaseMessageStore<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>retry_queue <span class="token operator">=</span> RetryQueue<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">send_reliable_message</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> message<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 1. 持久化消息到数据库</span></span>
<span class="line">        message_id <span class="token operator">=</span> self<span class="token punctuation">.</span>message_store<span class="token punctuation">.</span>save_message<span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;topic&#39;</span><span class="token punctuation">:</span> topic<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;key&#39;</span><span class="token punctuation">:</span> key<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;message&#39;</span><span class="token punctuation">:</span> message<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;status&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;sending&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;created_at&#39;</span><span class="token punctuation">:</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 2. 发送到Kafka</span></span>
<span class="line">        result <span class="token operator">=</span> self<span class="token punctuation">.</span>kafka_client<span class="token punctuation">.</span>send_message<span class="token punctuation">(</span>topic<span class="token punctuation">,</span> message<span class="token punctuation">,</span> key<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> result<span class="token punctuation">[</span><span class="token string">&#39;success&#39;</span><span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 3. 更新消息状态为已发送</span></span>
<span class="line">            self<span class="token punctuation">.</span>message_store<span class="token punctuation">.</span>update_status<span class="token punctuation">(</span>message_id<span class="token punctuation">,</span> <span class="token string">&#39;sent&#39;</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> result</span>
<span class="line">        <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 4. 发送失败，加入重试队列</span></span>
<span class="line">            self<span class="token punctuation">.</span>message_store<span class="token punctuation">.</span>update_status<span class="token punctuation">(</span>message_id<span class="token punctuation">,</span> <span class="token string">&#39;failed&#39;</span><span class="token punctuation">)</span></span>
<span class="line">            self<span class="token punctuation">.</span>retry_queue<span class="token punctuation">.</span>add_message<span class="token punctuation">(</span>message_id<span class="token punctuation">,</span> retry_count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> result</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">process_retry_queue</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;处理重试队列&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span></span>
<span class="line">            message_info <span class="token operator">=</span> self<span class="token punctuation">.</span>retry_queue<span class="token punctuation">.</span>get_next_message<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token keyword">not</span> message_info<span class="token punctuation">:</span></span>
<span class="line">                time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token keyword">continue</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment"># 重试发送</span></span>
<span class="line">            result <span class="token operator">=</span> self<span class="token punctuation">.</span>kafka_client<span class="token punctuation">.</span>send_message<span class="token punctuation">(</span></span>
<span class="line">                message_info<span class="token punctuation">[</span><span class="token string">&#39;topic&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                message_info<span class="token punctuation">[</span><span class="token string">&#39;message&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                message_info<span class="token punctuation">[</span><span class="token string">&#39;key&#39;</span><span class="token punctuation">]</span></span>
<span class="line">            <span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">if</span> result<span class="token punctuation">[</span><span class="token string">&#39;success&#39;</span><span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">                self<span class="token punctuation">.</span>message_store<span class="token punctuation">.</span>update_status<span class="token punctuation">(</span>message_info<span class="token punctuation">[</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&#39;sent&#39;</span><span class="token punctuation">)</span></span>
<span class="line">                self<span class="token punctuation">.</span>retry_queue<span class="token punctuation">.</span>remove_message<span class="token punctuation">(</span>message_info<span class="token punctuation">[</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">                <span class="token comment"># 增加重试次数</span></span>
<span class="line">                new_retry_count <span class="token operator">=</span> message_info<span class="token punctuation">[</span><span class="token string">&#39;retry_count&#39;</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span></span>
<span class="line">                <span class="token keyword">if</span> new_retry_count <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">:</span>  <span class="token comment"># 最多重试3次</span></span>
<span class="line">                    self<span class="token punctuation">.</span>retry_queue<span class="token punctuation">.</span>update_retry_count<span class="token punctuation">(</span></span>
<span class="line">                        message_info<span class="token punctuation">[</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> </span>
<span class="line">                        new_retry_count</span>
<span class="line">                    <span class="token punctuation">)</span></span>
<span class="line">                <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">                    <span class="token comment"># 超过重试次数，标记为永久失败</span></span>
<span class="line">                    self<span class="token punctuation">.</span>message_store<span class="token punctuation">.</span>update_status<span class="token punctuation">(</span></span>
<span class="line">                        message_info<span class="token punctuation">[</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> </span>
<span class="line">                        <span class="token string">&#39;permanently_failed&#39;</span></span>
<span class="line">                    <span class="token punctuation">)</span></span>
<span class="line">                    self<span class="token punctuation">.</span>_alert_permanent_failure<span class="token punctuation">(</span>message_info<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>消费者可靠性</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">ReliableMessageConsumer</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> topics<span class="token punctuation">,</span> group_id<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>consumer <span class="token operator">=</span> KafkaConsumerFactory<span class="token punctuation">.</span>create_consumer<span class="token punctuation">(</span>topics<span class="token punctuation">,</span> group_id<span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>message_processor <span class="token operator">=</span> MessageProcessor<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>dlq_producer <span class="token operator">=</span> DeadLetterQueueProducer<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">consume_messages</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">for</span> message <span class="token keyword">in</span> self<span class="token punctuation">.</span>consumer<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">                <span class="token comment"># 1. 处理消息</span></span>
<span class="line">                result <span class="token operator">=</span> self<span class="token punctuation">.</span>message_processor<span class="token punctuation">.</span>process<span class="token punctuation">(</span>message<span class="token punctuation">)</span></span>
<span class="line">                </span>
<span class="line">                <span class="token keyword">if</span> result<span class="token punctuation">.</span>success<span class="token punctuation">:</span></span>
<span class="line">                    <span class="token comment"># 2. 手动提交偏移量</span></span>
<span class="line">                    self<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">                    <span class="token comment"># 3. 处理失败，发送到死信队列</span></span>
<span class="line">                    self<span class="token punctuation">.</span>_send_to_dlq<span class="token punctuation">(</span>message<span class="token punctuation">,</span> result<span class="token punctuation">.</span>error<span class="token punctuation">)</span></span>
<span class="line">                    </span>
<span class="line">            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></span>
<span class="line">                <span class="token comment"># 4. 异常处理</span></span>
<span class="line">                self<span class="token punctuation">.</span>_handle_processing_exception<span class="token punctuation">(</span>message<span class="token punctuation">,</span> e<span class="token punctuation">)</span></span>
<span class="line">                </span>
<span class="line">                <span class="token comment"># 5. 发送到死信队列</span></span>
<span class="line">                self<span class="token punctuation">.</span>_send_to_dlq<span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_send_to_dlq</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;发送消息到死信队列&quot;&quot;&quot;</span></span>
<span class="line">        dlq_message <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;original_topic&#39;</span><span class="token punctuation">:</span> message<span class="token punctuation">.</span>topic<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;original_partition&#39;</span><span class="token punctuation">:</span> message<span class="token punctuation">.</span>partition<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;original_offset&#39;</span><span class="token punctuation">:</span> message<span class="token punctuation">.</span>offset<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;key&#39;</span><span class="token punctuation">:</span> message<span class="token punctuation">.</span>key<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;value&#39;</span><span class="token punctuation">:</span> message<span class="token punctuation">.</span>value<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;error&#39;</span><span class="token punctuation">:</span> error<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;timestamp&#39;</span><span class="token punctuation">:</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        self<span class="token punctuation">.</span>dlq_producer<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">&#39;dead_letter_queue&#39;</span><span class="token punctuation">,</span> dlq_message<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-微服务高可用" tabindex="-1"><a class="header-anchor" href="#_5-微服务高可用"><span>5. 微服务高可用</span></a></h2><h3 id="q11-服务网格高可用方案" tabindex="-1"><a class="header-anchor" href="#q11-服务网格高可用方案"><span>Q11: 服务网格高可用方案？</span></a></h3><p><strong>答：</strong> 服务网格通过Sidecar代理实现服务间通信的高可用：</p><p><strong>Istio配置示例</strong>：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code><span class="line"><span class="token comment"># DestinationRule定义服务的负载均衡策略</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">host</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service</span>
<span class="line">  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">simple</span><span class="token punctuation">:</span> LEAST_CONN</span>
<span class="line">    <span class="token key atrule">connectionPool</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">tcp</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">maxConnections</span><span class="token punctuation">:</span> <span class="token number">100</span></span>
<span class="line">      <span class="token key atrule">http</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">http1MaxPendingRequests</span><span class="token punctuation">:</span> <span class="token number">1000</span></span>
<span class="line">        <span class="token key atrule">maxRequestsPerConnection</span><span class="token punctuation">:</span> <span class="token number">10</span></span>
<span class="line">    <span class="token key atrule">outlierDetection</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">consecutive5xxErrors</span><span class="token punctuation">:</span> <span class="token number">5</span></span>
<span class="line">      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 1m</span>
<span class="line">      <span class="token key atrule">baseEjectionTime</span><span class="token punctuation">:</span> 5m</span>
<span class="line">  <span class="token key atrule">subsets</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1</span>
<span class="line">    <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1</span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2</span>
<span class="line">    <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">version</span><span class="token punctuation">:</span> v2</span>
<span class="line"></span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token comment"># VirtualService定义路由规则</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">hosts</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> user<span class="token punctuation">-</span>service</span>
<span class="line">  <span class="token key atrule">http</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">host</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service</span>
<span class="line">        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1</span>
<span class="line">      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">90</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">host</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service</span>
<span class="line">        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2</span>
<span class="line">      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">10</span></span>
<span class="line">  <span class="token comment"># 故障注入用于测试高可用</span></span>
<span class="line">  <span class="token key atrule">fault</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">delay</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">percentage</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">0.1</span></span>
<span class="line">      <span class="token key atrule">fixedDelay</span><span class="token punctuation">:</span> 5s</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>应用层服务调用</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">MeshAwareServiceClient</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>service_discovery <span class="token operator">=</span> ServiceDiscovery<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>circuit_breaker <span class="token operator">=</span> CircuitBreaker<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>retry_policy <span class="token operator">=</span> RetryPolicy<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">call_service</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> service_name<span class="token punctuation">,</span> endpoint<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 1. 服务发现获取实例列表</span></span>
<span class="line">        instances <span class="token operator">=</span> self<span class="token punctuation">.</span>service_discovery<span class="token punctuation">.</span>get_healthy_instances<span class="token punctuation">(</span>service_name<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> instances<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> ServiceUnavailable<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;No healthy instances for </span><span class="token interpolation"><span class="token punctuation">{</span>service_name<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 2. 负载均衡选择实例</span></span>
<span class="line">        instance <span class="token operator">=</span> self<span class="token punctuation">.</span>_load_balance<span class="token punctuation">(</span>instances<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 3. 熔断器保护</span></span>
<span class="line">        <span class="token keyword">def</span> <span class="token function">make_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_make_http_request<span class="token punctuation">(</span>instance<span class="token punctuation">,</span> endpoint<span class="token punctuation">,</span> data<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 4. 带重试的熔断保护调用</span></span>
<span class="line">        <span class="token keyword">return</span> self<span class="token punctuation">.</span>retry_policy<span class="token punctuation">.</span>execute_with_retry<span class="token punctuation">(</span></span>
<span class="line">            <span class="token keyword">lambda</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>circuit_breaker<span class="token punctuation">.</span>call<span class="token punctuation">(</span>make_request<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_load_balance</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instances<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;负载均衡算法&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token comment"># 实现最少连接数、轮询等算法</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token builtin">min</span><span class="token punctuation">(</span>instances<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> inst<span class="token punctuation">:</span> inst<span class="token punctuation">.</span>current_connections<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_make_http_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> endpoint<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;发起HTTP请求&quot;&quot;&quot;</span></span>
<span class="line">        url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;http://</span><span class="token interpolation"><span class="token punctuation">{</span>instance<span class="token punctuation">.</span>host<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{</span>instance<span class="token punctuation">.</span>port<span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{</span>endpoint<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span></span>
<span class="line">        <span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">            response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> json<span class="token operator">=</span>data<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span></span>
<span class="line">            response<span class="token punctuation">.</span>raise_for_status<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">except</span> requests<span class="token punctuation">.</span>RequestException <span class="token keyword">as</span> e<span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 记录实例失败</span></span>
<span class="line">            self<span class="token punctuation">.</span>service_discovery<span class="token punctuation">.</span>record_instance_failure<span class="token punctuation">(</span>instance<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">raise</span> e</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="q12-微服务容错设计" tabindex="-1"><a class="header-anchor" href="#q12-微服务容错设计"><span>Q12: 微服务容错设计？</span></a></h3><p><strong>答：</strong> 微服务容错设计的关键模式：</p><p><strong>Bulkhead模式</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> threading</span>
<span class="line"><span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">import</span> ThreadPoolExecutor</span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Bulkhead</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> max_concurrent_calls<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> max_queue_size<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>semaphore <span class="token operator">=</span> threading<span class="token punctuation">.</span>Semaphore<span class="token punctuation">(</span>max_concurrent_calls<span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>executor <span class="token operator">=</span> ThreadPoolExecutor<span class="token punctuation">(</span></span>
<span class="line">            max_workers<span class="token operator">=</span>max_concurrent_calls<span class="token punctuation">,</span></span>
<span class="line">            queue_size<span class="token operator">=</span>max_queue_size</span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> func<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>semaphore<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span>blocking<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">                future <span class="token operator">=</span> self<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span></span>
<span class="line">                <span class="token keyword">return</span> future<span class="token punctuation">.</span>result<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span>  <span class="token comment"># 30秒超时</span></span>
<span class="line">            <span class="token keyword">finally</span><span class="token punctuation">:</span></span>
<span class="line">                self<span class="token punctuation">.</span>semaphore<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> BulkheadRejectedException<span class="token punctuation">(</span><span class="token string">&quot;Bulkhead limit exceeded&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">UserService</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 为不同服务调用设置不同的舱壁</span></span>
<span class="line">        self<span class="token punctuation">.</span>user_db_bulkhead <span class="token operator">=</span> Bulkhead<span class="token punctuation">(</span>max_concurrent_calls<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>external_api_bulkhead <span class="token operator">=</span> Bulkhead<span class="token punctuation">(</span>max_concurrent_calls<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get_user_profile</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 数据库调用使用独立舱壁</span></span>
<span class="line">        <span class="token keyword">return</span> self<span class="token punctuation">.</span>user_db_bulkhead<span class="token punctuation">.</span>execute<span class="token punctuation">(</span></span>
<span class="line">            self<span class="token punctuation">.</span>_fetch_user_from_db<span class="token punctuation">,</span> user_id</span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get_external_user_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 外部API调用使用独立舱壁</span></span>
<span class="line">        <span class="token keyword">return</span> self<span class="token punctuation">.</span>external_api_bulkhead<span class="token punctuation">.</span>execute<span class="token punctuation">(</span></span>
<span class="line">            self<span class="token punctuation">.</span>_call_external_api<span class="token punctuation">,</span> user_id</span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Timeout模式</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> signal</span>
<span class="line"><span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps</span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">TimeoutError</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">pass</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">timeout</span><span class="token punctuation">(</span>seconds<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token decorator annotation punctuation">@wraps</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">def</span> <span class="token function">timeout_handler</span><span class="token punctuation">(</span>signum<span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">                <span class="token keyword">raise</span> TimeoutError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Function </span><span class="token interpolation"><span class="token punctuation">{</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string"> timed out after </span><span class="token interpolation"><span class="token punctuation">{</span>seconds<span class="token punctuation">}</span></span><span class="token string"> seconds&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment"># 设置信号处理器</span></span>
<span class="line">            old_handler <span class="token operator">=</span> signal<span class="token punctuation">.</span>signal<span class="token punctuation">(</span>signal<span class="token punctuation">.</span>SIGALRM<span class="token punctuation">,</span> timeout_handler<span class="token punctuation">)</span></span>
<span class="line">            signal<span class="token punctuation">.</span>alarm<span class="token punctuation">(</span>seconds<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">                result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span></span>
<span class="line">                <span class="token keyword">return</span> result</span>
<span class="line">            <span class="token keyword">finally</span><span class="token punctuation">:</span></span>
<span class="line">                <span class="token comment"># 恢复原来的信号处理器</span></span>
<span class="line">                signal<span class="token punctuation">.</span>alarm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">                signal<span class="token punctuation">.</span>signal<span class="token punctuation">(</span>signal<span class="token punctuation">.</span>SIGALRM<span class="token punctuation">,</span> old_handler<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> wrapper</span>
<span class="line">    <span class="token keyword">return</span> decorator</span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">OrderService</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>payment_client <span class="token operator">=</span> PaymentServiceClient<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>inventory_client <span class="token operator">=</span> InventoryServiceClient<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token decorator annotation punctuation">@timeout</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment"># 5秒超时</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">process_payment</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> order_id<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> self<span class="token punctuation">.</span>payment_client<span class="token punctuation">.</span>charge<span class="token punctuation">(</span>order_id<span class="token punctuation">,</span> amount<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token decorator annotation punctuation">@timeout</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>  <span class="token comment"># 3秒超时</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">check_inventory</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> product_id<span class="token punctuation">,</span> quantity<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> self<span class="token punctuation">.</span>inventory_client<span class="token punctuation">.</span>get_stock<span class="token punctuation">(</span>product_id<span class="token punctuation">,</span> quantity<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-容器化与云原生高可用" tabindex="-1"><a class="header-anchor" href="#_6-容器化与云原生高可用"><span>6. 容器化与云原生高可用</span></a></h2><h3 id="q13-kubernetes高可用部署" tabindex="-1"><a class="header-anchor" href="#q13-kubernetes高可用部署"><span>Q13: Kubernetes高可用部署？</span></a></h3><p><strong>答：</strong> Kubernetes通过多控制平面节点实现高可用：</p><p><strong>Kubernetes高可用架构</strong>：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code><span class="line"><span class="token comment"># kube-apiserver高可用配置</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>apiserver</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">containers</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>apiserver</span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> k8s.gcr.io/kube<span class="token punctuation">-</span>apiserver<span class="token punctuation">:</span>v1.21.0</span>
<span class="line">    <span class="token key atrule">command</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> kube<span class="token punctuation">-</span>apiserver</span>
<span class="line">    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>advertise<span class="token punctuation">-</span>address=$(POD_IP)</span>
<span class="line">    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>allow<span class="token punctuation">-</span>privileged=true</span>
<span class="line">    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>authorization<span class="token punctuation">-</span>mode=Node<span class="token punctuation">,</span>RBAC</span>
<span class="line">    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>enable<span class="token punctuation">-</span>admission<span class="token punctuation">-</span>plugins=NodeRestriction</span>
<span class="line">    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>enable<span class="token punctuation">-</span>bootstrap<span class="token punctuation">-</span>token<span class="token punctuation">-</span>auth=true</span>
<span class="line">    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>etcd<span class="token punctuation">-</span>cafile=/etc/kubernetes/pki/etcd/ca.crt</span>
<span class="line">    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>etcd<span class="token punctuation">-</span>certfile=/etc/kubernetes/pki/apiserver<span class="token punctuation">-</span>etcd<span class="token punctuation">-</span>client.crt</span>
<span class="line">    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>etcd<span class="token punctuation">-</span>keyfile=/etc/kubernetes/pki/apiserver<span class="token punctuation">-</span>etcd<span class="token punctuation">-</span>client.key</span>
<span class="line">    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>etcd<span class="token punctuation">-</span>servers=https<span class="token punctuation">:</span>//10.0.0.1<span class="token punctuation">:</span><span class="token number">2379</span><span class="token punctuation">,</span>https<span class="token punctuation">:</span>//10.0.0.2<span class="token punctuation">:</span><span class="token number">2379</span><span class="token punctuation">,</span>https<span class="token punctuation">:</span>//10.0.0.3<span class="token punctuation">:</span><span class="token number">2379</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>service<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>ip<span class="token punctuation">-</span>range=10.96.0.0/12</span>
<span class="line">    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>service<span class="token punctuation">-</span>node<span class="token punctuation">-</span>port<span class="token punctuation">-</span>range=30000<span class="token punctuation">-</span><span class="token number">32767</span></span>
<span class="line">    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">path</span><span class="token punctuation">:</span> /livez</span>
<span class="line">        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6443</span></span>
<span class="line">        <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTPS</span>
<span class="line">      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">15</span></span>
<span class="line">      <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">15</span></span>
<span class="line">    <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">path</span><span class="token punctuation">:</span> /readyz</span>
<span class="line">        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6443</span></span>
<span class="line">        <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTPS</span>
<span class="line">      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span></span>
<span class="line">      <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">15</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>应用部署高可用配置</strong>：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code><span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>  <span class="token comment"># 至少3个副本</span></span>
<span class="line">  <span class="token key atrule">selector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">app</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service</span>
<span class="line">  <span class="token key atrule">template</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">app</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service</span>
<span class="line">    <span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">affinity</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">preferredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span></span>
<span class="line">            <span class="token key atrule">podAffinityTerm</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span></span>
<span class="line">                <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span></span>
<span class="line">                <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> app</span>
<span class="line">                  <span class="token key atrule">operator</span><span class="token punctuation">:</span> In</span>
<span class="line">                  <span class="token key atrule">values</span><span class="token punctuation">:</span></span>
<span class="line">                  <span class="token punctuation">-</span> user<span class="token punctuation">-</span>service</span>
<span class="line">              <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname</span>
<span class="line">      <span class="token key atrule">containers</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service</span>
<span class="line">        <span class="token key atrule">image</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service<span class="token punctuation">:</span>latest</span>
<span class="line">        <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span></span>
<span class="line">        <span class="token key atrule">resources</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">requests</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;256Mi&quot;</span></span>
<span class="line">            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;250m&quot;</span></span>
<span class="line">          <span class="token key atrule">limits</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;512Mi&quot;</span></span>
<span class="line">            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;500m&quot;</span></span>
<span class="line">        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">path</span><span class="token punctuation">:</span> /health</span>
<span class="line">            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span></span>
<span class="line">          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span></span>
<span class="line">          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span></span>
<span class="line">        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">path</span><span class="token punctuation">:</span> /ready</span>
<span class="line">            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span></span>
<span class="line">          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span></span>
<span class="line">          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span></span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">selector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">app</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service</span>
<span class="line">  <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span></span>
<span class="line">    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span></span>
<span class="line">  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="q14-服务监控与告警" tabindex="-1"><a class="header-anchor" href="#q14-服务监控与告警"><span>Q14: 服务监控与告警？</span></a></h3><p><strong>答：</strong> 全面的监控和告警体系是高可用的重要保障：</p><p><strong>Prometheus监控配置</strong>：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code><span class="line"><span class="token comment"># Prometheus配置</span></span>
<span class="line"><span class="token key atrule">global</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">scrape_interval</span><span class="token punctuation">:</span> 15s</span>
<span class="line">  <span class="token key atrule">evaluation_interval</span><span class="token punctuation">:</span> 15s</span>
<span class="line"></span>
<span class="line"><span class="token key atrule">rule_files</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token string">&quot;alert.rules.yml&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token key atrule">scrape_configs</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">&#39;kubernetes-pods&#39;</span></span>
<span class="line">    <span class="token key atrule">kubernetes_sd_configs</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> pod</span>
<span class="line">    <span class="token key atrule">relabel_configs</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_pod_annotation_prometheus_io_scrape<span class="token punctuation">]</span></span>
<span class="line">      <span class="token key atrule">action</span><span class="token punctuation">:</span> keep</span>
<span class="line">      <span class="token key atrule">regex</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__address__<span class="token punctuation">,</span> __meta_kubernetes_pod_annotation_prometheus_io_port<span class="token punctuation">]</span></span>
<span class="line">      <span class="token key atrule">action</span><span class="token punctuation">:</span> replace</span>
<span class="line">      <span class="token key atrule">regex</span><span class="token punctuation">:</span> (<span class="token punctuation">[</span>^<span class="token punctuation">:</span><span class="token punctuation">]</span>+)(<span class="token punctuation">?</span><span class="token punctuation">:</span><span class="token punctuation">:</span>\d+)<span class="token punctuation">?</span>;(\d+)</span>
<span class="line">      <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $1<span class="token punctuation">:</span>$2</span>
<span class="line">      <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __address__</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 告警规则</span></span>
<span class="line"><span class="token key atrule">groups</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> example</span>
<span class="line">  <span class="token key atrule">rules</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> HighErrorRate</span>
<span class="line">    <span class="token key atrule">expr</span><span class="token punctuation">:</span> rate(http_requests_total<span class="token punctuation">{</span>status=~&quot;5..&quot;<span class="token punctuation">}</span><span class="token punctuation">[</span>5m<span class="token punctuation">]</span>) <span class="token punctuation">&gt;</span> 0.05</span>
<span class="line">    <span class="token key atrule">for</span><span class="token punctuation">:</span> 10m</span>
<span class="line">    <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">severity</span><span class="token punctuation">:</span> critical</span>
<span class="line">    <span class="token key atrule">annotations</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">&quot;High error rate for {{ $labels.job }}&quot;</span></span>
<span class="line">      <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">&quot;{{ $value }}% of requests are failing&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>应用层监控埋点</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> prometheus_client</span>
<span class="line"><span class="token keyword">from</span> prometheus_client <span class="token keyword">import</span> Counter<span class="token punctuation">,</span> Histogram<span class="token punctuation">,</span> Gauge</span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">MetricsCollector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 请求计数器</span></span>
<span class="line">        self<span class="token punctuation">.</span>requests_total <span class="token operator">=</span> Counter<span class="token punctuation">(</span></span>
<span class="line">            <span class="token string">&#39;http_requests_total&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;Total HTTP requests&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">[</span><span class="token string">&#39;method&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;endpoint&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;status&#39;</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 请求延迟直方图</span></span>
<span class="line">        self<span class="token punctuation">.</span>request_duration <span class="token operator">=</span> Histogram<span class="token punctuation">(</span></span>
<span class="line">            <span class="token string">&#39;http_request_duration_seconds&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;HTTP request duration in seconds&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">[</span><span class="token string">&#39;method&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;endpoint&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            buckets<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 在线用户数</span></span>
<span class="line">        self<span class="token punctuation">.</span>online_users <span class="token operator">=</span> Gauge<span class="token punctuation">(</span></span>
<span class="line">            <span class="token string">&#39;online_users&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;Number of online users&#39;</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 数据库连接数</span></span>
<span class="line">        self<span class="token punctuation">.</span>db_connections <span class="token operator">=</span> Gauge<span class="token punctuation">(</span></span>
<span class="line">            <span class="token string">&#39;database_connections&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;Number of active database connections&#39;</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">record_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> method<span class="token punctuation">,</span> endpoint<span class="token punctuation">,</span> status<span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>requests_total<span class="token punctuation">.</span>labels<span class="token punctuation">(</span>method<span class="token punctuation">,</span> endpoint<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">.</span>inc<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>request_duration<span class="token punctuation">.</span>labels<span class="token punctuation">(</span>method<span class="token punctuation">,</span> endpoint<span class="token punctuation">)</span><span class="token punctuation">.</span>observe<span class="token punctuation">(</span>duration<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">set_online_users</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>online_users<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">set_db_connections</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>db_connections<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># Flask应用中使用</span></span>
<span class="line"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request</span>
<span class="line"><span class="token keyword">import</span> time</span>
<span class="line"></span>
<span class="line">app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span></span>
<span class="line">metrics <span class="token operator">=</span> MetricsCollector<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>before_request</span></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">before_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    request<span class="token punctuation">.</span>start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>after_request</span></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">after_request</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    duration <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> request<span class="token punctuation">.</span>start_time</span>
<span class="line">    metrics<span class="token punctuation">.</span>record_request<span class="token punctuation">(</span></span>
<span class="line">        request<span class="token punctuation">.</span>method<span class="token punctuation">,</span></span>
<span class="line">        request<span class="token punctuation">.</span>path<span class="token punctuation">,</span></span>
<span class="line">        response<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span></span>
<span class="line">        duration</span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> response</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-灾备与应急响应" tabindex="-1"><a class="header-anchor" href="#_7-灾备与应急响应"><span>7. 灾备与应急响应</span></a></h2><h3 id="q15-多活架构与灾备方案" tabindex="-1"><a class="header-anchor" href="#q15-多活架构与灾备方案"><span>Q15: 多活架构与灾备方案？</span></a></h3><p><strong>答：</strong> 多活架构和灾备方案确保业务连续性：</p><p><strong>同城双活架构</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">MultiActiveArchitecture</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>data_centers <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;dc1&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&#39;region&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;cn-north-1&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;zone&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;cn-north-1a&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;services&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;web&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;api&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;database&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;status&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;active&#39;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;dc2&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&#39;region&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;cn-north-1&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;zone&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;cn-north-1b&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;services&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;web&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;api&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;database&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&#39;status&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;active&#39;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        self<span class="token punctuation">.</span>global_load_balancer <span class="token operator">=</span> GlobalLoadBalancer<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">route_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 基于用户地理位置路由</span></span>
<span class="line">        user_region <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_user_region<span class="token punctuation">(</span>request<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 健康检查</span></span>
<span class="line">        healthy_dcs <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_healthy_data_centers<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> healthy_dcs<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> ServiceUnavailable<span class="token punctuation">(</span><span class="token string">&quot;No healthy data centers&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 优先选择同地域数据中心</span></span>
<span class="line">        preferred_dc <span class="token operator">=</span> self<span class="token punctuation">.</span>_find_preferred_dc<span class="token punctuation">(</span>user_region<span class="token punctuation">,</span> healthy_dcs<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> self<span class="token punctuation">.</span>global_load_balancer<span class="token punctuation">.</span>route_to_dc<span class="token punctuation">(</span>preferred_dc<span class="token punctuation">,</span> request<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">failover</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> failed_dc<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;故障切换&quot;&quot;&quot;</span></span>
<span class="line">        self<span class="token punctuation">.</span>data_centers<span class="token punctuation">[</span>failed_dc<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&#39;status&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&#39;failed&#39;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 重新路由流量</span></span>
<span class="line">        self<span class="token punctuation">.</span>global_load_balancer<span class="token punctuation">.</span>exclude_dc<span class="token punctuation">(</span>failed_dc<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 启动数据同步</span></span>
<span class="line">        self<span class="token punctuation">.</span>_start_data_sync_recovery<span class="token punctuation">(</span>failed_dc<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 通知运维团队</span></span>
<span class="line">        self<span class="token punctuation">.</span>_alert_operations_team<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Data center </span><span class="token interpolation"><span class="token punctuation">{</span>failed_dc<span class="token punctuation">}</span></span><span class="token string"> failed&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>异地灾备方案</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">DisasterRecoveryPlan</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>primary_site <span class="token operator">=</span> <span class="token string">&quot;beijing&quot;</span></span>
<span class="line">        self<span class="token punctuation">.</span>standby_site <span class="token operator">=</span> <span class="token string">&quot;shanghai&quot;</span></span>
<span class="line">        self<span class="token punctuation">.</span>disaster_recovery_site <span class="token operator">=</span> <span class="token string">&quot;guangzhou&quot;</span></span>
<span class="line">        </span>
<span class="line">        self<span class="token punctuation">.</span>data_replication <span class="token operator">=</span> DataReplicator<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>health_checker <span class="token operator">=</span> HealthChecker<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">execute_failover</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> failure_type<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;执行故障切换&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token keyword">if</span> failure_type <span class="token operator">==</span> <span class="token string">&quot;REGIONAL_DISASTER&quot;</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 区域性灾难，切换到异地灾备</span></span>
<span class="line">            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_failover_to_dr_site<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">elif</span> failure_type <span class="token operator">==</span> <span class="token string">&quot;SITE_FAILURE&quot;</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 站点故障，切换到备用站点</span></span>
<span class="line">            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_failover_to_standby_site<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 单点故障，本地恢复</span></span>
<span class="line">            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_local_recovery<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_failover_to_dr_site</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;切换到灾备站点&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token comment"># 1. 停止主站点服务</span></span>
<span class="line">        self<span class="token punctuation">.</span>_stop_services<span class="token punctuation">(</span>self<span class="token punctuation">.</span>primary_site<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 2. 提升灾备站点数据</span></span>
<span class="line">        self<span class="token punctuation">.</span>data_replication<span class="token punctuation">.</span>promote_dr_site<span class="token punctuation">(</span>self<span class="token punctuation">.</span>disaster_recovery_site<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 3. 启动灾备站点服务</span></span>
<span class="line">        self<span class="token punctuation">.</span>_start_services<span class="token punctuation">(</span>self<span class="token punctuation">.</span>disaster_recovery_site<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 4. 更新DNS指向</span></span>
<span class="line">        self<span class="token punctuation">.</span>_update_dns_routing<span class="token punctuation">(</span>self<span class="token punctuation">.</span>disaster_recovery_site<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 5. 通知相关人员</span></span>
<span class="line">        self<span class="token punctuation">.</span>_notify_stakeholders<span class="token punctuation">(</span><span class="token string">&quot;Failover to DR site completed&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;status&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;SUCCESS&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;new_primary&#39;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>disaster_recovery_site<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;estimated_downtime&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;30 minutes&#39;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="q16-应急响应与故障演练" tabindex="-1"><a class="header-anchor" href="#q16-应急响应与故障演练"><span>Q16: 应急响应与故障演练？</span></a></h3><p><strong>答：</strong> 系统化的应急响应和定期演练确保高可用能力：</p><p><strong>应急响应流程</strong>：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">IncidentResponseManager</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>incident_handlers <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;DATABASE_FAILURE&#39;</span><span class="token punctuation">:</span> DatabaseIncidentHandler<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;SERVICE_OUTAGE&#39;</span><span class="token punctuation">:</span> ServiceIncidentHandler<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;SECURITY_BREACH&#39;</span><span class="token punctuation">:</span> SecurityIncidentHandler<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        self<span class="token punctuation">.</span>communication_channels <span class="token operator">=</span> CommunicationChannels<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">handle_incident</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> incident<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;处理突发事件&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token comment"># 1. 事件分级</span></span>
<span class="line">        severity <span class="token operator">=</span> self<span class="token punctuation">.</span>_assess_severity<span class="token punctuation">(</span>incident<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 2. 通知相关人员</span></span>
<span class="line">        self<span class="token punctuation">.</span>_notify_team<span class="token punctuation">(</span>incident<span class="token punctuation">,</span> severity<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 3. 启动应急预案</span></span>
<span class="line">        handler <span class="token operator">=</span> self<span class="token punctuation">.</span>incident_handlers<span class="token punctuation">.</span>get<span class="token punctuation">(</span>incident<span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> handler<span class="token punctuation">:</span></span>
<span class="line">            response_plan <span class="token operator">=</span> handler<span class="token punctuation">.</span>create_response_plan<span class="token punctuation">(</span>incident<span class="token punctuation">)</span></span>
<span class="line">            execution_result <span class="token operator">=</span> handler<span class="token punctuation">.</span>execute_plan<span class="token punctuation">(</span>response_plan<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment"># 4. 持续监控</span></span>
<span class="line">            self<span class="token punctuation">.</span>_monitor_recovery<span class="token punctuation">(</span>execution_result<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment"># 5. 事后总结</span></span>
<span class="line">            self<span class="token punctuation">.</span>_post_incident_review<span class="token punctuation">(</span>incident<span class="token punctuation">,</span> execution_result<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">return</span> execution_result</span>
<span class="line">        <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> UnknownIncidentType<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;No handler for incident type: </span><span class="token interpolation"><span class="token punctuation">{</span>incident<span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">_assess_severity</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> incident<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;评估事件严重程度&quot;&quot;&quot;</span></span>
<span class="line">        scoring_factors <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;impact_users&#39;</span><span class="token punctuation">:</span> incident<span class="token punctuation">.</span>affected_users <span class="token operator">/</span> incident<span class="token punctuation">.</span>total_users<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;revenue_impact&#39;</span><span class="token punctuation">:</span> incident<span class="token punctuation">.</span>revenue_loss_per_hour<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;duration&#39;</span><span class="token punctuation">:</span> incident<span class="token punctuation">.</span>duration_minutes<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;escalation_level&#39;</span><span class="token punctuation">:</span> incident<span class="token punctuation">.</span>escalation_level</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        total_score <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>scoring_factors<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> total_score <span class="token operator">&gt;</span> <span class="token number">0.8</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token string">&#39;CRITICAL&#39;</span></span>
<span class="line">        <span class="token keyword">elif</span> total_score <span class="token operator">&gt;</span> <span class="token number">0.5</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token string">&#39;HIGH&#39;</span></span>
<span class="line">        <span class="token keyword">elif</span> total_score <span class="token operator">&gt;</span> <span class="token number">0.2</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token string">&#39;MEDIUM&#39;</span></span>
<span class="line">        <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token string">&#39;LOW&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">ChaosEngineering</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>experiments <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        self<span class="token punctuation">.</span>safety_guardrails <span class="token operator">=</span> SafetyGuardrails<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">run_chaos_experiment</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> experiment_config<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">&quot;&quot;&quot;运行混沌工程实验&quot;&quot;&quot;</span></span>
<span class="line">        <span class="token comment"># 1. 验证安全防护措施</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>safety_guardrails<span class="token punctuation">.</span>validate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> SafetyValidationFailed<span class="token punctuation">(</span><span class="token string">&quot;Safety guardrails validation failed&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 2. 设置监控和告警</span></span>
<span class="line">        monitors <span class="token operator">=</span> self<span class="token punctuation">.</span>_setup_experiment_monitors<span class="token punctuation">(</span>experiment_config<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 3. 执行故障注入</span></span>
<span class="line">        <span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">            experiment_result <span class="token operator">=</span> self<span class="token punctuation">.</span>_inject_fault<span class="token punctuation">(</span>experiment_config<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment"># 4. 观察系统行为</span></span>
<span class="line">            observations <span class="token operator">=</span> self<span class="token punctuation">.</span>_collect_observations<span class="token punctuation">(</span>monitors<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment"># 5. 验证系统恢复能力</span></span>
<span class="line">            recovery_result <span class="token operator">=</span> self<span class="token punctuation">.</span>_verify_recovery<span class="token punctuation">(</span>observations<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment"># 6. 生成实验报告</span></span>
<span class="line">            report <span class="token operator">=</span> self<span class="token punctuation">.</span>_generate_report<span class="token punctuation">(</span></span>
<span class="line">                experiment_config<span class="token punctuation">,</span> </span>
<span class="line">                experiment_result<span class="token punctuation">,</span> </span>
<span class="line">                observations<span class="token punctuation">,</span> </span>
<span class="line">                recovery_result</span>
<span class="line">            <span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">return</span> report</span>
<span class="line">            </span>
<span class="line">        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 7. 紧急回滚</span></span>
<span class="line">            self<span class="token punctuation">.</span>_emergency_rollback<span class="token punctuation">(</span>experiment_config<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">raise</span> e</span>
<span class="line">        <span class="token keyword">finally</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 8. 清理实验环境</span></span>
<span class="line">            self<span class="token punctuation">.</span>_cleanup_experiment<span class="token punctuation">(</span>experiment_config<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过以上全面的ToC业务高可用解决方案，可以构建一个稳定、可靠的在线服务系统，确保用户体验和业务连续性。</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><!----><!----></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script src="/wiki/assets/js/runtime~app.de5fe002.js" defer></script><script src="/wiki/assets/js/768.e6d4205d.js" defer></script><script src="/wiki/assets/js/app.ae84ebda.js" defer></script>
  </body>
</html>
