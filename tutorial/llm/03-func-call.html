<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.20" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>03 Func Call   Index | 知识库</title><meta name="description" content="涵盖Java、Spring、Vue、Node.js等技术知识">
    <link rel="stylesheet" href="/wiki/assets/css/styles.2a121ef9.css">
    <link rel="preload" href="/wiki/assets/js/runtime~app.2831d094.js" as="script"><link rel="preload" href="/wiki/assets/css/styles.2a121ef9.css" as="style"><link rel="preload" href="/wiki/assets/js/768.e6d4205d.js" as="script"><link rel="preload" href="/wiki/assets/js/app.3be034a8.js" as="script">
    <link rel="prefetch" href="/wiki/assets/js/solution_smart-marketing_index.html.c6a04243.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_high-availability_index.html.1ef390b5.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_react_index.html.4aacb360.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_llm_02-prompt.html.e61f7879.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_aiops_index.html.9565eae6.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_swift_index.html.26390310.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_llm_03-func-call.html.2946c7cc.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_embedded_index.html.1d42b838.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_llm_04-ai-programming.html.b668b6f4.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_nodejs_index.html.42d74f45.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_python_index.html.e9a522b3.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_spring-boot_index.html.38761574.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_java_jdk-changes_index.html.25824bdf.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_finops_tools.html.f03a4487.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_llm_01-intro.html.d02af743.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_r_index.html.16153cc5.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_vue_index.html.63167ab5.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_java_concurrency_index.html.e362b849.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_java_advanced_index.html.71c33c5c.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_spring-cloud_index.html.fd0f185e.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_message-queue_index.html.b4b3c3e6.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_big-data_index.html.bbd64ec0.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_database_index.html.14a46108.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_java_basic_index.html.bddf19ef.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_ml_index.html.7188e38d.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_llm_index.html.b42c7983.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_java_collections_index.html.0c5ba651.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_rl_index.html.6c114c3c.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_finops_implementation.html.5e17714b.js" as="script"><link rel="prefetch" href="/wiki/assets/js/get-started.html.c4557635.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_finops_kubecost-installation.html.ab8b0c04.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_finops_risk-trends.html.6525c9fc.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_finops_case-studies.html.08c4404f.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_finops_index.html.f1c67882.js" as="script"><link rel="prefetch" href="/wiki/assets/js/index.html.6a2169db.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_finops_concept.html.0854ee3f.js" as="script"><link rel="prefetch" href="/wiki/assets/js/404.html.a5b4614e.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/wiki/"><img class="vp-site-logo" src="/wiki/logo/logo.svg" alt="知识库"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">知识库</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/wiki/" aria-label="首页"><!--[--><!--[--><!--]--><!--]-->首页<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/wiki/get-started.html" aria-label="开始阅读"><!--[--><!--[--><!--]--><!--]-->开始阅读<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="Java"><span class="title">Java</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="Java"><span class="title">Java</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/basic/" aria-label="Java基础"><!--[--><!--[--><!--]--><!--]-->Java基础<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/advanced/" aria-label="Java高级"><!--[--><!--[--><!--]--><!--]-->Java高级<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/collections/" aria-label="Java集合详解"><!--[--><!--[--><!--]--><!--]-->Java集合详解<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/concurrency/" aria-label="Java多线程详解"><!--[--><!--[--><!--]--><!--]-->Java多线程详解<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/jdk-changes/" aria-label="JDK版本变化详解"><!--[--><!--[--><!--]--><!--]-->JDK版本变化详解<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="Spring"><span class="title">Spring</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="Spring"><span class="title">Spring</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/spring-boot/" aria-label="Spring Boot"><!--[--><!--[--><!--]--><!--]-->Spring Boot<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/spring-cloud/" aria-label="Spring Cloud"><!--[--><!--[--><!--]--><!--]-->Spring Cloud<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="技术教程"><span class="title">技术教程</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="技术教程"><span class="title">技术教程</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link route-link-active auto-link" href="/wiki/tutorial/llm/" aria-label="LLM"><!--[--><!--[--><!--]--><!--]-->LLM<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="解决方案"><span class="title">解决方案</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="解决方案"><span class="title">解决方案</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/solution/aiops/" aria-label="AIOps"><!--[--><!--[--><!--]--><!--]-->AIOps<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/solution/finops/" aria-label="FinOps"><!--[--><!--[--><!--]--><!--]-->FinOps<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/solution/high-availability/" aria-label="高可用架构"><!--[--><!--[--><!--]--><!--]-->高可用架构<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/solution/smart-marketing/" aria-label="智能营销"><!--[--><!--[--><!--]--><!--]-->智能营销<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/wiki/" aria-label="首页"><!--[--><!--[--><!--]--><!--]-->首页<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/wiki/get-started.html" aria-label="开始阅读"><!--[--><!--[--><!--]--><!--]-->开始阅读<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="Java"><span class="title">Java</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="Java"><span class="title">Java</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/basic/" aria-label="Java基础"><!--[--><!--[--><!--]--><!--]-->Java基础<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/advanced/" aria-label="Java高级"><!--[--><!--[--><!--]--><!--]-->Java高级<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/collections/" aria-label="Java集合详解"><!--[--><!--[--><!--]--><!--]-->Java集合详解<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/concurrency/" aria-label="Java多线程详解"><!--[--><!--[--><!--]--><!--]-->Java多线程详解<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/jdk-changes/" aria-label="JDK版本变化详解"><!--[--><!--[--><!--]--><!--]-->JDK版本变化详解<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="Spring"><span class="title">Spring</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="Spring"><span class="title">Spring</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/spring-boot/" aria-label="Spring Boot"><!--[--><!--[--><!--]--><!--]-->Spring Boot<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/spring-cloud/" aria-label="Spring Cloud"><!--[--><!--[--><!--]--><!--]-->Spring Cloud<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="技术教程"><span class="title">技术教程</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="技术教程"><span class="title">技术教程</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link route-link-active auto-link" href="/wiki/tutorial/llm/" aria-label="LLM"><!--[--><!--[--><!--]--><!--]-->LLM<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="解决方案"><span class="title">解决方案</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="解决方案"><span class="title">解决方案</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/solution/aiops/" aria-label="AIOps"><!--[--><!--[--><!--]--><!--]-->AIOps<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/solution/finops/" aria-label="FinOps"><!--[--><!--[--><!--]--><!--]-->FinOps<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/solution/high-availability/" aria-label="高可用架构"><!--[--><!--[--><!--]--><!--]-->高可用架构<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/solution/smart-marketing/" aria-label="智能营销"><!--[--><!--[--><!--]--><!--]-->智能营销<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><a class="route-link route-link-active auto-link vp-sidebar-item vp-sidebar-heading" href="/wiki/tutorial/llm/" aria-label="LLM学习教程"><!--[--><!--[--><!--]--><!--]-->LLM学习教程<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div><h1 id="_03-func-call-index" tabindex="-1"><a class="header-anchor" href="#_03-func-call-index"><span>03 Func Call Index</span></a></h1><h1 id="结构化输出" tabindex="-1"><a class="header-anchor" href="#结构化输出"><span>结构化输出</span></a></h1><h2 id="💡-这节课会带给你" tabindex="-1"><a class="header-anchor" href="#💡-这节课会带给你"><span>💡 这节课会带给你</span></a></h2><ol><li>用自然语言连接系统的认知，面向未来思考系统间的集成</li><li>GPTs 是如何连接外部世界的</li><li>用 Function Calling 把大模型和业务连接起来</li><li>用 <code>json_schema</code> 格式化大模型的输出</li></ol><p>开始上课！</p><h2 id="什么是结构化输出" tabindex="-1"><a class="header-anchor" href="#什么是结构化输出"><span>什么是结构化输出</span></a></h2><p>结构化输出（Structed Outputs）是指让 LLM 输出符合机器可解析的格式，典型的是 JSON 结构。有三条技术路径：</p><ol><li>JSON mode - 在 Prompt Engineering 课有介绍</li><li>Function Calling - 本节课会详细讲解</li><li>JSON Schema - 本节课会简单介绍</li></ol><h2 id="function-calling-做什么的" tabindex="-1"><a class="header-anchor" href="#function-calling-做什么的"><span>Function Calling 做什么的？</span></a></h2><p><img src="/wiki/assets/img/siri_send_img.13490478.gif" alt="image"></p><h2 id="接口-interface" tabindex="-1"><a class="header-anchor" href="#接口-interface"><span>接口（Interface）</span></a></h2><p>两种常见接口：</p><ol><li>人机交互接口，User Interface，简称 UI</li><li>应用程序编程接口，Application Programming Interface，简称 API</li></ol><p>接口能「通」的关键，是两边都要遵守约定。</p><ul><li>人要按照 UI 的设计来操作。UI 的设计要符合人的习惯</li><li>程序要按照 API 的设计来调用。API 的设计要符合程序惯例</li></ul><p>你是不是有很多调接口的痛苦经历？比如：</p><ul><li>文档坑</li><li>大小写坑</li><li>参数顺序坑</li><li>参数类型坑</li><li>……</li></ul><h2 id="接口的进化" tabindex="-1"><a class="header-anchor" href="#接口的进化"><span>接口的进化</span></a></h2><p>UI 进化的趋势是：越来越适应人的习惯，越来越自然</p><ol><li>命令行，Command Line Interface，简称 CLI（DOS、Unix/Linux shell, Windows Power Shell）</li><li>图形界面，Graphical User Interface，简称 GUI（Windows、MacOS、iOS、Android）</li><li>语言界面，Conversational User Interface，简称 CUI，或 Natural-Language User Interface，简称 LUI ← <strong>我们在这里</strong></li><li>脑机接口，Brain–Computer Interface，简称 BCI</li></ol><p><img src="/wiki/assets/img/ui-evolution.ef48565f.png" alt="image"></p><p>API：</p><ol><li>从本地到远程，从同步到异步，媒介发生很多变化，但本质一直没变：<strong>程序员的约定</strong></li><li>现在，开始进化到自然语言接口，Natural-Language Interface，简称 NLI</li></ol><h2 id="自然语言连接一切-natural-language-interface" tabindex="-1"><a class="header-anchor" href="#自然语言连接一切-natural-language-interface"><span>自然语言连接一切（Natural Language Interface）</span></a></h2><p>NLI 是<a href="https://mp.weixin.qq.com/s/t0Ml7E-CvlKfdaUMBGKJBg" target="_blank" rel="noopener noreferrer">《以 ChatGPT 为代表的「大模型」会是多大的技术革命？》</a>一文中提出的概念。</p><blockquote><p>用户操作习惯的迁移，会逼所有软件，都得提供「自然语言界面（Natural Language Interface，简称 NLI）」。这是我生造的词，指的是以自然语言为输入的接口。</p><p>不仅用户界面要 NLI，API 也要 NLI 化。这是因为用户发出的宏观指令，往往不会是一个独立软件能解决的，它需要很多软件、设备的配合。</p><p>一种实现思路是，入口 AI（比如 Siri、小爱同学，机器人管家）非常强大，能充分了解所有软件和设备的能力，且能准确地把用户任务拆解和分发下去。这对入口 AI 的要求非常高。</p><p>另一种实现思路是，入口 AI 收到自然语言指令，把指令通过 NLI 广播出去（也可以基于某些规则做有选择的广播，保护用户隐私），由各个软件自主决策接不接这个指令，接了要怎么做，该和谁配合。</p><p>……</p><p>当 NLI 成为事实标准，那么互联网上软件、服务的互通性会大幅提升，不再受各种协议、接口的限制。</p></blockquote><p>最自然的接口，就是自然语言接口：</p><p>以前因为计算机处理不对自然语言，所以有了那么多编程语言，那么多接口，那么多协议，那么多界面风格。而且，它们每一次进化，都是为了「更自然」。现在，终极的自然，到来了。<strong>我们终于可以把计算机当人看了！</strong></p><p>OpenAI 是如何用自然语言连接一切的呢？</p><h2 id="为什么要大模型连接外部世界" tabindex="-1"><a class="header-anchor" href="#为什么要大模型连接外部世界"><span>为什么要大模型连接外部世界？</span></a></h2><blockquote><p>✅ <strong>Tip:</strong> 大模型两大缺陷：</p></blockquote><p>并非知晓一切</p><pre><code>训练数据不可能什么都有。垂直、非公开数据必有欠缺
不知道最新信息。大模型的训练周期很长，且更新一次耗资巨大，还有越训越傻的风险。所以 ta 不可能实时训练。OpenAI 模型知识截止日期：

GPT-3.5 知识截至 2021 年 9 月
GPT-4-turbo 知识截至 2023 年 12 月
GPT-4o-mini 知识截至 2023 年 10 月
GPT-4o 知识截至 2023 年 10 月
GPT-4 知识截至 2021 年 9 月
</code></pre><p>没有「真逻辑」。它表现出的逻辑、推理，是训练文本的统计规律，而不是真正的逻辑，所以有幻觉。</p><p>所以：大模型需要连接真实世界，并对接真逻辑系统执行确定性任务。</p><p>比如算加法：</p><ol><li>把 100 以内所有加法算式都训练给大模型，ta 就能回答 100 以内的加法算式，但仍有概率出错</li><li>如果问 ta 更大数字的加法，出错概率就会更大</li><li>因为 ta 并不懂「加法」，只是记住了 100 以内的加法算式的统计规律</li><li>Ta 是用字面意义做数学</li></ol><p>数学能力最强的软件系统是 Wolfram Alpha，推荐阅读这篇文章了解它和 ChatGPT 原理的不同：<a href="https://writings.stephenwolfram.com/2023/01/wolframalpha-as-the-way-to-bring-computational-knowledge-superpowers-to-chatgpt/" target="_blank" rel="noopener noreferrer">《Wolfram|Alpha as the Way to Bring Computational Knowledge Superpowers to ChatGPT》</a></p><p>PS. Wolfram 的书《<a href="https://u.jd.com/p8x8bdp" target="_blank" rel="noopener noreferrer">这就是 ChatGPT！</a>》是从神经网络层面解释大模型原理的最好读的书。<a href="https://writings.stephenwolfram.com/2023/02/what-is-chatgpt-doing-and-why-does-it-work/" target="_blank" rel="noopener noreferrer">英文版免费</a></p><h2 id="chatgpt-用-actions-连接外部世界" tabindex="-1"><a class="header-anchor" href="#chatgpt-用-actions-连接外部世界"><span>ChatGPT 用 Actions 连接外部世界</span></a></h2><h3 id="第一次尝试-plugins" tabindex="-1"><a class="header-anchor" href="#第一次尝试-plugins"><span>第一次尝试：Plugins</span></a></h3><ul><li>2023 年 3 月 24 日发布 Plugins，模型可以调用外部 API</li><li>2024 年 4 月 9 日正式下线，宣告失败</li></ul><p>我们在第 1 期（2023 年 7 月）就告诉大家，Plugins 会失败，不用投入精力了解细节。</p><h3 id="第二次尝试-actions" tabindex="-1"><a class="header-anchor" href="#第二次尝试-actions"><span>第二次尝试：Actions</span></a></h3><p>Actions，内置在 GPTs 中，解决了落地场景问题，但没能成功商业化。</p><p>工作流程：</p><p><img src="/wiki/assets/img/actions.cbb1ac3d.png" alt="image"></p><blockquote><p>✅ <strong>Tip:</strong> 划重点：</p></blockquote><p>通过 Actions 的 schema，GPT 能读懂各个 API 能做什么、怎么调用（相当于人读 API 文档） 拿到 prompt，GPT 分析出是否要调用 API 才能解决问题（相当于人读需求） 如果要调用 API，生成调用参数（相当于人编写调用代码） ChatGPT（注意，不是 GPT）调用 API（相当于人运行程序） API 返回结果，GPT 读懂结果，整合到回答中（相当于人整理结果，输出结论）</p><p>把 AI 当人看！</p><p>这个过程中，GPT 已经是个 agent 了。</p><h2 id="actions-开发对接" tabindex="-1"><a class="header-anchor" href="#actions-开发对接"><span>Actions <s>开发</s>对接</span></a></h2><p>Actions 官方文档：https://platform.openai.com/docs/actions</p><p>把 API 对接到 GPTs 里，只需要配置一段 API 描述信息：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code><span class="line"><span class="token key atrule">openapi</span><span class="token punctuation">:</span> 3.1.0</span>
<span class="line"><span class="token key atrule">info</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">title</span><span class="token punctuation">:</span> 高德地图</span>
<span class="line">  <span class="token key atrule">description</span><span class="token punctuation">:</span> 获取 POI 的相关信息</span>
<span class="line">  <span class="token key atrule">version</span><span class="token punctuation">:</span> v1.0.0</span>
<span class="line"><span class="token key atrule">servers</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//restapi.amap.com/v5/place</span>
<span class="line"><span class="token key atrule">paths</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">/text</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">get</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">description</span><span class="token punctuation">:</span> 根据POI名称，获得POI的经纬度坐标</span>
<span class="line">      <span class="token key atrule">operationId</span><span class="token punctuation">:</span> get_location_coordinate</span>
<span class="line">      <span class="token key atrule">parameters</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> keywords</span>
<span class="line">          <span class="token key atrule">in</span><span class="token punctuation">:</span> query</span>
<span class="line">          <span class="token key atrule">description</span><span class="token punctuation">:</span> POI名称，必须是中文</span>
<span class="line">          <span class="token key atrule">required</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">          <span class="token key atrule">schema</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">type</span><span class="token punctuation">:</span> string</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> region</span>
<span class="line">          <span class="token key atrule">in</span><span class="token punctuation">:</span> query</span>
<span class="line">          <span class="token key atrule">description</span><span class="token punctuation">:</span> POI所在的区域名，必须是中文</span>
<span class="line">          <span class="token key atrule">required</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></span>
<span class="line">          <span class="token key atrule">schema</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">type</span><span class="token punctuation">:</span> string</span>
<span class="line">      <span class="token key atrule">deprecated</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></span>
<span class="line">  <span class="token key atrule">/around</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">get</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">description</span><span class="token punctuation">:</span> 搜索给定坐标附近的POI</span>
<span class="line">      <span class="token key atrule">operationId</span><span class="token punctuation">:</span> search_nearby_pois</span>
<span class="line">      <span class="token key atrule">parameters</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> keywords</span>
<span class="line">          <span class="token key atrule">in</span><span class="token punctuation">:</span> query</span>
<span class="line">          <span class="token key atrule">description</span><span class="token punctuation">:</span> 目标POI的关键字</span>
<span class="line">          <span class="token key atrule">required</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">          <span class="token key atrule">schema</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">type</span><span class="token punctuation">:</span> string</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> location</span>
<span class="line">          <span class="token key atrule">in</span><span class="token punctuation">:</span> query</span>
<span class="line">          <span class="token key atrule">description</span><span class="token punctuation">:</span> 中心点的经度和纬度，用逗号分隔</span>
<span class="line">          <span class="token key atrule">required</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></span>
<span class="line">          <span class="token key atrule">schema</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">type</span><span class="token punctuation">:</span> string</span>
<span class="line">      <span class="token key atrule">deprecated</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></span>
<span class="line"><span class="token key atrule">components</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">schemas</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>还需要配置 API key 来满足权限要求。（高德地图 API KEY <a href="https://lbs.amap.com/" target="_blank" rel="noopener noreferrer">点此免费申请</a>）</p><p><img src="/wiki/assets/img/actions_api_key.8a87c154.png" alt="image"></p><p>这里的所有 <code>name</code>、<code>description</code> 都是 prompt，决定了 GPT 会不会调用你的 API，调用得是否正确。</p><blockquote><p>⚠️ <strong>Note:</strong> 思考：为什么不干脆整个描述文件都用自然语言写？非要用结构化的 JSON 或 YAML？</p></blockquote><h2 id="gpts-与它的平替们" tabindex="-1"><a class="header-anchor" href="#gpts-与它的平替们"><span>GPTs 与它的平替们</span></a></h2><p><a href="https://chat.openai.com/gpts/discovery" target="_blank" rel="noopener noreferrer">OpenAI GPTs</a></p><ol><li>无需编程，就能定制个性对话机器人的平台</li><li>可以放入自己的知识库，实现 RAG（后面会讲）</li><li>可以通过 actions 对接专有数据和功能</li><li>内置 DALL·E 3 文生图和 Code Interpreter 能力</li><li>只有 ChatGPT Plus 会员可以使用</li></ol><p>推荐两款平替：</p><p>字节跳动 Coze（扣子）<a href="https://www.coze.cn/" target="_blank" rel="noopener noreferrer">中国版</a> <a href="https://www.coze.com/" target="_blank" rel="noopener noreferrer">国际版</a></p><ol><li>中国版发展势头很猛，支持豆包、Moonshot 等国产大模型</li><li>功能很强大，支持工作流、API</li><li>但是……</li></ol><p><a href="https://dify.ai/" target="_blank" rel="noopener noreferrer">Dify</a></p><ol><li>开源，中国公司开发</li><li>可以本地部署，支持几乎所有大模型</li><li>有 GUI，也有 API</li></ol><p>有这类无需开发的工具，为什么还要学大模型开发技术呢？</p><ol><li>并不是所有事情都适合用对话解决</li><li>它们都无法针对业务需求做极致调优</li></ol><p>一个常见的研发场景：先在扣子/Dify 验证原型可行性，再编程落地实现。</p><p>Function Calling 技术可以把大模型和业务系统连接，实现更丰富的功能。</p><h2 id="function-calling-的机制" tabindex="-1"><a class="header-anchor" href="#function-calling-的机制"><span>Function Calling 的机制</span></a></h2><p>原理和 Actions 一样，只是使用方式有区别。</p><p><img src="/wiki/assets/img/func.584db96b.png" alt="image"></p><p>Function Calling 完整的官方接口文档：https://platform.openai.com/docs/guides/function-calling</p><h2 id="示例-1-调用本地函数" tabindex="-1"><a class="header-anchor" href="#示例-1-调用本地函数"><span>示例 1：调用本地函数</span></a></h2><p>需求：实现一个回答问题的 AI。题目中如果有加法，必须能精确计算。</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 初始化</span></span>
<span class="line"><span class="token keyword">from</span> openai <span class="token keyword">import</span> OpenAI</span>
<span class="line"><span class="token keyword">from</span> dotenv <span class="token keyword">import</span> load_dotenv<span class="token punctuation">,</span> find_dotenv</span>
<span class="line"><span class="token keyword">import</span> json</span>
<span class="line"></span>
<span class="line">_ <span class="token operator">=</span> load_dotenv<span class="token punctuation">(</span>find_dotenv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">client <span class="token operator">=</span> OpenAI<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">print_json</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;</span>
<span class="line">    打印参数。如果参数是有结构的（如字典或列表），则以格式化的 JSON 形式打印；</span>
<span class="line">    否则，直接打印该值。</span>
<span class="line">    &quot;&quot;&quot;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">&#39;model_dump_json&#39;</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">.</span>model_dump_json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">isinstance</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">for</span> item <span class="token keyword">in</span> data<span class="token punctuation">:</span></span>
<span class="line">            print_json<span class="token punctuation">(</span>item<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">elif</span> <span class="token punctuation">(</span><span class="token builtin">isinstance</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span></span>
<span class="line">            data<span class="token punctuation">,</span></span>
<span class="line">            indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span></span>
<span class="line">            ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span></span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">get_completion</span><span class="token punctuation">(</span>messages<span class="token punctuation">,</span> model<span class="token operator">=</span><span class="token string">&quot;gpt-4o-mini&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span></span>
<span class="line">        model<span class="token operator">=</span>model<span class="token punctuation">,</span></span>
<span class="line">        messages<span class="token operator">=</span>messages<span class="token punctuation">,</span></span>
<span class="line">        temperature<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span></span>
<span class="line">        tools<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span>  <span class="token comment"># 用 JSON 描述函数。可以定义多个。由大模型决定调用谁。也可能都不调用</span></span>
<span class="line">            <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;function&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;sum&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;description&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;加法器，计算一组数的和&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;parameters&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;properties&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token string">&quot;numbers&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                            <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;array&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                            <span class="token string">&quot;items&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                                <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;number&quot;</span></span>
<span class="line">                            <span class="token punctuation">}</span></span>
<span class="line">                        <span class="token punctuation">}</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> math <span class="token keyword">import</span> <span class="token operator">*</span></span>
<span class="line"></span>
<span class="line">prompt <span class="token operator">=</span> <span class="token string">&quot;Tell me the sum of 1, 2, 3, 4, 5, 6, 7, 8, 9, 10.&quot;</span></span>
<span class="line"><span class="token comment"># prompt = &quot;桌上有 2 个苹果，四个桃子和 3 本书，还有 3 个番茄，以及三个傻瓜，一共有几个水果？&quot;</span></span>
<span class="line"><span class="token comment"># prompt = &quot;1+2+3...+99+100&quot;</span></span>
<span class="line"><span class="token comment"># prompt = &quot;1024 乘以 1024 是多少？&quot;   # Tools 里没有定义乘法，会怎样？</span></span>
<span class="line"><span class="token comment"># prompt = &quot;太阳从哪边升起？&quot;           # 不需要算加法，会怎样？</span></span>
<span class="line"></span>
<span class="line">messages <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span><span class="token string">&quot;role&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;system&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;你是一个数学家&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span><span class="token string">&quot;role&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">:</span> prompt<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">]</span></span>
<span class="line">response <span class="token operator">=</span> get_completion<span class="token punctuation">(</span>messages<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 把大模型的回复加入到对话历史中。必须有</span></span>
<span class="line">messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span>response<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 如果返回的是函数调用结果，则打印出来</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>tool_calls <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># 是否要调用 sum</span></span>
<span class="line">    tool_call <span class="token operator">=</span> response<span class="token punctuation">.</span>tool_calls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>tool_call<span class="token punctuation">.</span>function<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">&quot;sum&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 调用 sum</span></span>
<span class="line">        args <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>tool_call<span class="token punctuation">.</span>function<span class="token punctuation">.</span>arguments<span class="token punctuation">)</span></span>
<span class="line">        result <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token string">&quot;numbers&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 把函数调用结果加入到对话历史中</span></span>
<span class="line">        messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&quot;tool_call_id&quot;</span><span class="token punctuation">:</span> tool_call<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>  <span class="token comment"># 用于标识函数调用的 ID</span></span>
<span class="line">                <span class="token string">&quot;role&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;tool&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;sum&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;content&quot;</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>  <span class="token comment"># 数值 result 必须转成字符串</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 再次调用大模型</span></span>
<span class="line">        response <span class="token operator">=</span> get_completion<span class="token punctuation">(</span>messages<span class="token punctuation">)</span></span>
<span class="line">        messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span>response<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;=====最终 GPT 回复=====&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>content<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;=====对话历史=====&quot;</span><span class="token punctuation">)</span></span>
<span class="line">print_json<span class="token punctuation">(</span>messages<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">=====最终 GPT 回复=====</span>
<span class="line">The sum of the numbers 1 through 10 is 55.</span>
<span class="line">=====对话历史=====</span>
<span class="line">{</span>
<span class="line">    &quot;role&quot;: &quot;system&quot;,</span>
<span class="line">    &quot;content&quot;: &quot;你是一个数学家&quot;</span>
<span class="line">}</span>
<span class="line">{</span>
<span class="line">    &quot;role&quot;: &quot;user&quot;,</span>
<span class="line">    &quot;content&quot;: &quot;Tell me the sum of 1, 2, 3, 4, 5, 6, 7, 8, 9, 10.&quot;</span>
<span class="line">}</span>
<span class="line">{</span>
<span class="line">    &quot;content&quot;: null,</span>
<span class="line">    &quot;refusal&quot;: null,</span>
<span class="line">    &quot;role&quot;: &quot;assistant&quot;,</span>
<span class="line">    &quot;function_call&quot;: null,</span>
<span class="line">    &quot;tool_calls&quot;: [</span>
<span class="line">        {</span>
<span class="line">            &quot;id&quot;: &quot;call_aAIfOBKZiohdqEK1T1S5utvg&quot;,</span>
<span class="line">            &quot;function&quot;: {</span>
<span class="line">                &quot;arguments&quot;: &quot;{\&quot;numbers\&quot;:[1,2,3,4,5,6,7,8,9,10]}&quot;,</span>
<span class="line">                &quot;name&quot;: &quot;sum&quot;</span>
<span class="line">            },</span>
<span class="line">            &quot;type&quot;: &quot;function&quot;</span>
<span class="line">        }</span>
<span class="line">    ]</span>
<span class="line">}</span>
<span class="line">{</span>
<span class="line">    &quot;tool_call_id&quot;: &quot;call_aAIfOBKZiohdqEK1T1S5utvg&quot;,</span>
<span class="line">    &quot;role&quot;: &quot;tool&quot;,</span>
<span class="line">    &quot;name&quot;: &quot;sum&quot;,</span>
<span class="line">    &quot;content&quot;: &quot;55&quot;</span>
<span class="line">}</span>
<span class="line">{</span>
<span class="line">    &quot;content&quot;: &quot;The sum of the numbers 1 through 10 is 55.&quot;,</span>
<span class="line">    &quot;refusal&quot;: null,</span>
<span class="line">    &quot;role&quot;: &quot;assistant&quot;,</span>
<span class="line">    &quot;function_call&quot;: null,</span>
<span class="line">    &quot;tool_calls&quot;: null</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>✅ <strong>Tip:</strong> 划重点：</p></blockquote><p>Function Calling 中的函数与参数的描述也是一种 prompt 这种 prompt 也需要调优，否则会影响函数的召回、参数的准确性，甚至让大模型产生幻觉，调用不存在的函数</p><h2 id="示例-2-多-function-调用" tabindex="-1"><a class="header-anchor" href="#示例-2-多-function-调用"><span>示例 2：多 Function 调用</span></a></h2><p>需求：查询某个地点附近的酒店、餐厅、景点等信息。即，查询某个 POI 附近的 POI。</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">get_completion</span><span class="token punctuation">(</span>messages<span class="token punctuation">,</span> model<span class="token operator">=</span><span class="token string">&quot;gpt-4o-mini&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span></span>
<span class="line">        model<span class="token operator">=</span>model<span class="token punctuation">,</span></span>
<span class="line">        messages<span class="token operator">=</span>messages<span class="token punctuation">,</span></span>
<span class="line">        temperature<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">        seed<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">,</span>      <span class="token comment"># 随机种子保持不变，temperature 和 prompt 不变的情况下，输出就会不变</span></span>
<span class="line">        tool_choice<span class="token operator">=</span><span class="token string">&quot;auto&quot;</span><span class="token punctuation">,</span>  <span class="token comment"># 默认值，由 GPT 自主决定返回 function call 还是返回文字回复。也可以强制要求必须调用指定的函数，详见官方文档</span></span>
<span class="line">        tools<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;function&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;get_location_coordinate&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;description&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;根据POI名称，获得POI的经纬度坐标&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;parameters&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;properties&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token string">&quot;location&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                            <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                            <span class="token string">&quot;description&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;POI名称，必须是中文&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token string">&quot;city&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                            <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                            <span class="token string">&quot;description&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;POI所在的城市名，必须是中文&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token punctuation">}</span></span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;required&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;location&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;city&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;function&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;search_nearby_pois&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;description&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;搜索给定坐标附近的poi&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;parameters&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;properties&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token string">&quot;longitude&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                            <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                            <span class="token string">&quot;description&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;中心点的经度&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token string">&quot;latitude&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                            <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                            <span class="token string">&quot;description&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;中心点的纬度&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                            <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                            <span class="token string">&quot;description&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;目标poi的关键字&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token punctuation">}</span></span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;required&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;longitude&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;latitude&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> requests</span>
<span class="line"><span class="token keyword">import</span> os</span>
<span class="line"></span>
<span class="line">amap_key <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">&quot;AMAP_KEY&quot;</span><span class="token punctuation">)</span></span>
<span class="line">amap_base_url <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">&quot;AMAP_URL&quot;</span><span class="token punctuation">)</span> <span class="token comment"># 默认是 https://restapi.amap.com/v5</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">get_location_coordinate</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> city<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>amap_base_url<span class="token punctuation">}</span></span><span class="token string">/place/text?key=</span><span class="token interpolation"><span class="token punctuation">{</span>amap_key<span class="token punctuation">}</span></span><span class="token string">&amp;keywords=</span><span class="token interpolation"><span class="token punctuation">{</span>location<span class="token punctuation">}</span></span><span class="token string">&amp;region=</span><span class="token interpolation"><span class="token punctuation">{</span>city<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span></span>
<span class="line">    r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span></span>
<span class="line">    result <span class="token operator">=</span> r<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token string">&quot;pois&quot;</span> <span class="token keyword">in</span> result <span class="token keyword">and</span> result<span class="token punctuation">[</span><span class="token string">&quot;pois&quot;</span><span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> result<span class="token punctuation">[</span><span class="token string">&quot;pois&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">None</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">search_nearby_pois</span><span class="token punctuation">(</span>longitude<span class="token punctuation">,</span> latitude<span class="token punctuation">,</span> keyword<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>amap_base_url<span class="token punctuation">}</span></span><span class="token string">/place/around?key=</span><span class="token interpolation"><span class="token punctuation">{</span>amap_key<span class="token punctuation">}</span></span><span class="token string">&amp;keywords=</span><span class="token interpolation"><span class="token punctuation">{</span>keyword<span class="token punctuation">}</span></span><span class="token string">&amp;location=</span><span class="token interpolation"><span class="token punctuation">{</span>longitude<span class="token punctuation">}</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">{</span>latitude<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span></span>
<span class="line">    r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span></span>
<span class="line">    result <span class="token operator">=</span> r<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    ans <span class="token operator">=</span> <span class="token string">&quot;&quot;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token string">&quot;pois&quot;</span> <span class="token keyword">in</span> result <span class="token keyword">and</span> result<span class="token punctuation">[</span><span class="token string">&quot;pois&quot;</span><span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token string">&quot;pois&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            name <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token string">&quot;pois&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">]</span></span>
<span class="line">            address <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token string">&quot;pois&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">]</span></span>
<span class="line">            distance <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token string">&quot;pois&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;distance&quot;</span><span class="token punctuation">]</span></span>
<span class="line">            ans <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">\n</span><span class="token interpolation"><span class="token punctuation">{</span>address<span class="token punctuation">}</span></span><span class="token string">\n距离：</span><span class="token interpolation"><span class="token punctuation">{</span>distance<span class="token punctuation">}</span></span><span class="token string">米\n\n&quot;</span></span></span>
<span class="line">    <span class="token keyword">return</span> ans</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">prompt <span class="token operator">=</span> <span class="token string">&quot;我想在五道口附近喝咖啡，给我推荐几个&quot;</span></span>
<span class="line"><span class="token comment"># prompt = &quot;我到北京出差，给我推荐三里屯的酒店，和五道口附近的咖啡&quot; # 一次请求两个调用</span></span>
<span class="line"></span>
<span class="line">messages <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span><span class="token string">&quot;role&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;system&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;你是一个地图通，你可以找到任何地址。&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span><span class="token string">&quot;role&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">:</span> prompt<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">]</span></span>
<span class="line">response <span class="token operator">=</span> get_completion<span class="token punctuation">(</span>messages<span class="token punctuation">)</span></span>
<span class="line">messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span>response<span class="token punctuation">)</span>  <span class="token comment"># 把大模型的回复加入到对话中</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;=====GPT回复=====&quot;</span><span class="token punctuation">)</span></span>
<span class="line">print_json<span class="token punctuation">(</span>response<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">while</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>tool_calls <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># 支持一次返回多个函数调用请求，所以要考虑到这种情况</span></span>
<span class="line">    <span class="token keyword">for</span> tool_call <span class="token keyword">in</span> response<span class="token punctuation">.</span>tool_calls<span class="token punctuation">:</span></span>
<span class="line">        args <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>tool_call<span class="token punctuation">.</span>function<span class="token punctuation">.</span>arguments<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;函数参数展开：&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        print_json<span class="token punctuation">(</span>args<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 函数路由</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>tool_call<span class="token punctuation">.</span>function<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">&quot;get_location_coordinate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Call: get_location_coordinate&quot;</span><span class="token punctuation">)</span></span>
<span class="line">            result <span class="token operator">=</span> get_location_coordinate<span class="token punctuation">(</span><span class="token operator">**</span>args<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">elif</span> <span class="token punctuation">(</span>tool_call<span class="token punctuation">.</span>function<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">&quot;search_nearby_pois&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Call: search_nearby_pois&quot;</span><span class="token punctuation">)</span></span>
<span class="line">            result <span class="token operator">=</span> search_nearby_pois<span class="token punctuation">(</span><span class="token operator">**</span>args<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;=====函数返回=====&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        print_json<span class="token punctuation">(</span>result<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&quot;tool_call_id&quot;</span><span class="token punctuation">:</span> tool_call<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>  <span class="token comment"># 用于标识函数调用的 ID</span></span>
<span class="line">            <span class="token string">&quot;role&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;tool&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> tool_call<span class="token punctuation">.</span>function<span class="token punctuation">.</span>name<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;content&quot;</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>  <span class="token comment"># 数值result 必须转成字符串</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    response <span class="token operator">=</span> get_completion<span class="token punctuation">(</span>messages<span class="token punctuation">)</span></span>
<span class="line">    messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span>response<span class="token punctuation">)</span>  <span class="token comment"># 把大模型的回复加入到对话中</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;=====最终回复=====&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>content<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;=====对话历史=====&quot;</span><span class="token punctuation">)</span></span>
<span class="line">print_json<span class="token punctuation">(</span>messages<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">=====GPT回复=====</span>
<span class="line">{</span>
<span class="line">    &quot;content&quot;: null,</span>
<span class="line">    &quot;refusal&quot;: null,</span>
<span class="line">    &quot;role&quot;: &quot;assistant&quot;,</span>
<span class="line">    &quot;function_call&quot;: null,</span>
<span class="line">    &quot;tool_calls&quot;: [</span>
<span class="line">        {</span>
<span class="line">            &quot;id&quot;: &quot;call_BEjN2hy7nriCqmWFGGvoyNmt&quot;,</span>
<span class="line">            &quot;function&quot;: {</span>
<span class="line">                &quot;arguments&quot;: &quot;{\&quot;location\&quot;:\&quot;五道口\&quot;,\&quot;city\&quot;:\&quot;北京\&quot;}&quot;,</span>
<span class="line">                &quot;name&quot;: &quot;get_location_coordinate&quot;</span>
<span class="line">            },</span>
<span class="line">            &quot;type&quot;: &quot;function&quot;</span>
<span class="line">        }</span>
<span class="line">    ]</span>
<span class="line">}</span>
<span class="line">函数参数展开：</span>
<span class="line">{</span>
<span class="line">    &quot;location&quot;: &quot;五道口&quot;,</span>
<span class="line">    &quot;city&quot;: &quot;北京&quot;</span>
<span class="line">}</span>
<span class="line">Call: get_location_coordinate</span>
<span class="line">=====函数返回=====</span>
<span class="line">{</span>
<span class="line">    &quot;parent&quot;: &quot;&quot;,</span>
<span class="line">    &quot;address&quot;: &quot;海淀区&quot;,</span>
<span class="line">    &quot;distance&quot;: &quot;&quot;,</span>
<span class="line">    &quot;pcode&quot;: &quot;110000&quot;,</span>
<span class="line">    &quot;adcode&quot;: &quot;110108&quot;,</span>
<span class="line">    &quot;pname&quot;: &quot;北京市&quot;,</span>
<span class="line">    &quot;cityname&quot;: &quot;北京市&quot;,</span>
<span class="line">    &quot;type&quot;: &quot;地名地址信息;热点地名;热点地名&quot;,</span>
<span class="line">    &quot;typecode&quot;: &quot;190700&quot;,</span>
<span class="line">    &quot;adname&quot;: &quot;海淀区&quot;,</span>
<span class="line">    &quot;citycode&quot;: &quot;010&quot;,</span>
<span class="line">    &quot;name&quot;: &quot;五道口&quot;,</span>
<span class="line">    &quot;location&quot;: &quot;116.338611,39.992552&quot;,</span>
<span class="line">    &quot;id&quot;: &quot;B000A8WSBH&quot;</span>
<span class="line">}</span>
<span class="line">函数参数展开：</span>
<span class="line">{</span>
<span class="line">    &quot;longitude&quot;: &quot;116.338611&quot;,</span>
<span class="line">    &quot;latitude&quot;: &quot;39.992552&quot;,</span>
<span class="line">    &quot;keyword&quot;: &quot;咖啡&quot;</span>
<span class="line">}</span>
<span class="line">Call: search_nearby_pois</span>
<span class="line">=====函数返回=====</span>
<span class="line">PAGEONE CAFE(五道口购物中心店)</span>
<span class="line">成府路28号五道口购物中心(五道口地铁站B南口步行190米)</span>
<span class="line">距离：9米</span>
<span class="line"></span>
<span class="line">星巴克(北京五道口购物中心店)</span>
<span class="line">成府路28号1层101-10B及2层201-09号</span>
<span class="line">距离：39米</span>
<span class="line"></span>
<span class="line">luckin coffee 瑞幸咖啡(五道口购物中心店)</span>
<span class="line">成府路28号五道口购物中心负一层101号</span>
<span class="line">距离：67米</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">=====最终回复=====</span>
<span class="line">在五道口附近有以下几家咖啡店推荐：</span>
<span class="line"></span>
<span class="line">1. **PAGEONE CAFE(五道口购物中心店)**</span>
<span class="line">   - 地址：成府路28号五道口购物中心(五道口地铁站B南口步行190米)</span>
<span class="line">   - 距离：9米</span>
<span class="line"></span>
<span class="line">2. **星巴克(北京五道口购物中心店)**</span>
<span class="line">   - 地址：成府路28号1层101-10B及2层201-09号</span>
<span class="line">   - 距离：39米</span>
<span class="line"></span>
<span class="line">3. **luckin coffee 瑞幸咖啡(五道口购物中心店)**</span>
<span class="line">   - 地址：成府路28号五道口购物中心负一层101号</span>
<span class="line">   - 距离：67米</span>
<span class="line"></span>
<span class="line">希望你能找到一个满意的地方享受咖啡时光！</span>
<span class="line">=====对话历史=====</span>
<span class="line">{</span>
<span class="line">    &quot;role&quot;: &quot;system&quot;,</span>
<span class="line">    &quot;content&quot;: &quot;你是一个地图通，你可以找到任何地址。&quot;</span>
<span class="line">}</span>
<span class="line">{</span>
<span class="line">    &quot;role&quot;: &quot;user&quot;,</span>
<span class="line">    &quot;content&quot;: &quot;我想在五道口附近喝咖啡，给我推荐几个&quot;</span>
<span class="line">}</span>
<span class="line">{</span>
<span class="line">    &quot;content&quot;: null,</span>
<span class="line">    &quot;refusal&quot;: null,</span>
<span class="line">    &quot;role&quot;: &quot;assistant&quot;,</span>
<span class="line">    &quot;function_call&quot;: null,</span>
<span class="line">    &quot;tool_calls&quot;: [</span>
<span class="line">        {</span>
<span class="line">            &quot;id&quot;: &quot;call_BEjN2hy7nriCqmWFGGvoyNmt&quot;,</span>
<span class="line">            &quot;function&quot;: {</span>
<span class="line">                &quot;arguments&quot;: &quot;{\&quot;location\&quot;:\&quot;五道口\&quot;,\&quot;city\&quot;:\&quot;北京\&quot;}&quot;,</span>
<span class="line">                &quot;name&quot;: &quot;get_location_coordinate&quot;</span>
<span class="line">            },</span>
<span class="line">            &quot;type&quot;: &quot;function&quot;</span>
<span class="line">        }</span>
<span class="line">    ]</span>
<span class="line">}</span>
<span class="line">{</span>
<span class="line">    &quot;tool_call_id&quot;: &quot;call_BEjN2hy7nriCqmWFGGvoyNmt&quot;,</span>
<span class="line">    &quot;role&quot;: &quot;tool&quot;,</span>
<span class="line">    &quot;name&quot;: &quot;get_location_coordinate&quot;,</span>
<span class="line">    &quot;content&quot;: &quot;{&#39;parent&#39;: &#39;&#39;, &#39;address&#39;: &#39;海淀区&#39;, &#39;distance&#39;: &#39;&#39;, &#39;pcode&#39;: &#39;110000&#39;, &#39;adcode&#39;: &#39;110108&#39;, &#39;pname&#39;: &#39;北京市&#39;, &#39;cityname&#39;: &#39;北京市&#39;, &#39;type&#39;: &#39;地名地址信息;热点地名;热点地名&#39;, &#39;typecode&#39;: &#39;190700&#39;, &#39;adname&#39;: &#39;海淀区&#39;, &#39;citycode&#39;: &#39;010&#39;, &#39;name&#39;: &#39;五道口&#39;, &#39;location&#39;: &#39;116.338611,39.992552&#39;, &#39;id&#39;: &#39;B000A8WSBH&#39;}&quot;</span>
<span class="line">}</span>
<span class="line">{</span>
<span class="line">    &quot;content&quot;: null,</span>
<span class="line">    &quot;refusal&quot;: null,</span>
<span class="line">    &quot;role&quot;: &quot;assistant&quot;,</span>
<span class="line">    &quot;function_call&quot;: null,</span>
<span class="line">    &quot;tool_calls&quot;: [</span>
<span class="line">        {</span>
<span class="line">            &quot;id&quot;: &quot;call_PuOC0rCTct8cSbHoT3rAHTee&quot;,</span>
<span class="line">            &quot;function&quot;: {</span>
<span class="line">                &quot;arguments&quot;: &quot;{\&quot;longitude\&quot;:\&quot;116.338611\&quot;,\&quot;latitude\&quot;:\&quot;39.992552\&quot;,\&quot;keyword\&quot;:\&quot;咖啡\&quot;}&quot;,</span>
<span class="line">                &quot;name&quot;: &quot;search_nearby_pois&quot;</span>
<span class="line">            },</span>
<span class="line">            &quot;type&quot;: &quot;function&quot;</span>
<span class="line">        }</span>
<span class="line">    ]</span>
<span class="line">}</span>
<span class="line">{</span>
<span class="line">    &quot;tool_call_id&quot;: &quot;call_PuOC0rCTct8cSbHoT3rAHTee&quot;,</span>
<span class="line">    &quot;role&quot;: &quot;tool&quot;,</span>
<span class="line">    &quot;name&quot;: &quot;search_nearby_pois&quot;,</span>
<span class="line">    &quot;content&quot;: &quot;PAGEONE CAFE(五道口购物中心店)\n成府路28号五道口购物中心(五道口地铁站B南口步行190米)\n距离：9米\n\n星巴克(北京五道口购物中心店)\n成府路28号1层101-10B及2层201-09号\n距离：39米\n\nluckin coffee 瑞幸咖啡(五道口购物中心店)\n成府路28号五道口购物中心负一层101号\n距离：67米\n\n&quot;</span>
<span class="line">}</span>
<span class="line">{</span>
<span class="line">    &quot;content&quot;: &quot;在五道口附近有以下几家咖啡店推荐：\n\n1. **PAGEONE CAFE(五道口购物中心店)**\n   - 地址：成府路28号五道口购物中心(五道口地铁站B南口步行190米)\n   - 距离：9米\n\n2. **星巴克(北京五道口购物中心店)**\n   - 地址：成府路28号1层101-10B及2层201-09号\n   - 距离：39米\n\n3. **luckin coffee 瑞幸咖啡(五道口购物中心店)**\n   - 地址：成府路28号五道口购物中心负一层101号\n   - 距离：67米\n\n希望你能找到一个满意的地方享受咖啡时光！&quot;,</span>
<span class="line">    &quot;refusal&quot;: null,</span>
<span class="line">    &quot;role&quot;: &quot;assistant&quot;,</span>
<span class="line">    &quot;function_call&quot;: null,</span>
<span class="line">    &quot;tool_calls&quot;: null</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="示例-3-通过-function-calling-查询数据库" tabindex="-1"><a class="header-anchor" href="#示例-3-通过-function-calling-查询数据库"><span>示例 3：通过 Function Calling 查询数据库</span></a></h2><p>需求：从订单表中查询各种信息，比如某个用户的订单数量、某个商品的销量、某个用户的消费总额等等。</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment">#  描述数据库表结构</span></span>
<span class="line">database_schema_string <span class="token operator">=</span> <span class="token triple-quoted-string string">&quot;&quot;&quot;</span>
<span class="line">CREATE TABLE orders (</span>
<span class="line">    id INT PRIMARY KEY NOT NULL, -- 主键，不允许为空</span>
<span class="line">    customer_id INT NOT NULL, -- 客户ID，不允许为空</span>
<span class="line">    product_id STR NOT NULL, -- 产品ID，不允许为空</span>
<span class="line">    price DECIMAL(10,2) NOT NULL, -- 价格，不允许为空</span>
<span class="line">    status INT NOT NULL, -- 订单状态，整数类型，不允许为空。0代表待支付，1代表已支付，2代表已退款</span>
<span class="line">    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- 创建时间，默认为当前时间</span>
<span class="line">    pay_time TIMESTAMP -- 支付时间，可以为空</span>
<span class="line">);</span>
<span class="line">&quot;&quot;&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">get_sql_completion</span><span class="token punctuation">(</span>messages<span class="token punctuation">,</span> model<span class="token operator">=</span><span class="token string">&quot;gpt-4o-mini&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span></span>
<span class="line">        model<span class="token operator">=</span>model<span class="token punctuation">,</span></span>
<span class="line">        messages<span class="token operator">=</span>messages<span class="token punctuation">,</span></span>
<span class="line">        temperature<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">        tools<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span>  <span class="token comment"># 摘自 OpenAI 官方示例 https://github.com/openai/openai-cookbook/blob/main/examples/How_to_call_functions_with_chat_models.ipynb</span></span>
<span class="line">            <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;function&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;ask_database&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;description&quot;</span><span class="token punctuation">:</span> &quot;Use this function to answer user questions about business<span class="token punctuation">.</span> \</span>
<span class="line">                            Output should be a fully formed SQL query<span class="token punctuation">.</span>&quot;<span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;parameters&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;properties&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token string">&quot;query&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                            <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                            <span class="token string">&quot;description&quot;</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f&quot;&quot;&quot;</span>
<span class="line">                            SQL query extracting info to answer the user&#39;s question.</span>
<span class="line">                            SQL should be written using this database schema:</span>
<span class="line">                            </span><span class="token interpolation"><span class="token punctuation">{</span>database_schema_string<span class="token punctuation">}</span></span><span class="token string"></span>
<span class="line">                            The query should be returned in plain text, not in JSON.</span>
<span class="line">                            The query should only contain grammars supported by SQLite.</span>
<span class="line">                            &quot;&quot;&quot;</span></span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token punctuation">}</span></span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;required&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;query&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> sqlite3</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 创建数据库连接</span></span>
<span class="line">conn <span class="token operator">=</span> sqlite3<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">&#39;:memory:&#39;</span><span class="token punctuation">)</span></span>
<span class="line">cursor <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 创建orders表</span></span>
<span class="line">cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>database_schema_string<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 插入5条明确的模拟记录</span></span>
<span class="line">mock_data <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1001</span><span class="token punctuation">,</span> <span class="token string">&#39;TSHIRT_1&#39;</span><span class="token punctuation">,</span> <span class="token number">50.00</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&#39;2023-09-12 10:00:00&#39;</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1001</span><span class="token punctuation">,</span> <span class="token string">&#39;TSHIRT_2&#39;</span><span class="token punctuation">,</span> <span class="token number">75.50</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&#39;2023-09-16 11:00:00&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;2023-08-16 12:00:00&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1002</span><span class="token punctuation">,</span> <span class="token string">&#39;SHOES_X2&#39;</span><span class="token punctuation">,</span> <span class="token number">25.25</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&#39;2023-10-17 12:30:00&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;2023-08-17 13:00:00&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1003</span><span class="token punctuation">,</span> <span class="token string">&#39;SHOES_X2&#39;</span><span class="token punctuation">,</span> <span class="token number">25.25</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&#39;2023-10-17 12:30:00&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;2023-08-17 13:00:00&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1003</span><span class="token punctuation">,</span> <span class="token string">&#39;HAT_Z112&#39;</span><span class="token punctuation">,</span> <span class="token number">60.75</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&#39;2023-10-20 14:00:00&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;2023-08-20 15:00:00&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">1002</span><span class="token punctuation">,</span> <span class="token string">&#39;WATCH_X001&#39;</span><span class="token punctuation">,</span> <span class="token number">90.00</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&#39;2023-10-28 16:00:00&#39;</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">for</span> record <span class="token keyword">in</span> mock_data<span class="token punctuation">:</span></span>
<span class="line">    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token triple-quoted-string string">&#39;&#39;&#39;</span>
<span class="line">    INSERT INTO orders (id, customer_id, product_id, price, status, create_time, pay_time)</span>
<span class="line">    VALUES (?, ?, ?, ?, ?, ?, ?)</span>
<span class="line">    &#39;&#39;&#39;</span><span class="token punctuation">,</span> record<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 提交事务</span></span>
<span class="line">conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">ask_database</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>query<span class="token punctuation">)</span></span>
<span class="line">    records <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> records</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">prompt <span class="token operator">=</span> <span class="token string">&quot;10月的销售额&quot;</span></span>
<span class="line"><span class="token comment"># prompt = &quot;统计每月每件商品的销售额&quot;</span></span>
<span class="line"><span class="token comment"># prompt = &quot;哪个用户消费最高？消费多少？&quot;</span></span>
<span class="line"></span>
<span class="line">messages <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span><span class="token string">&quot;role&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;system&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;你是一个数据分析师，基于数据库的数据回答问题&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span><span class="token string">&quot;role&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">:</span> prompt<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">]</span></span>
<span class="line">response <span class="token operator">=</span> get_sql_completion<span class="token punctuation">(</span>messages<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">if</span> response<span class="token punctuation">.</span>content <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span></span>
<span class="line">    response<span class="token punctuation">.</span>content <span class="token operator">=</span> <span class="token string">&quot;&quot;</span></span>
<span class="line">messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span>response<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;====Function Calling====&quot;</span><span class="token punctuation">)</span></span>
<span class="line">print_json<span class="token punctuation">(</span>response<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">if</span> response<span class="token punctuation">.</span>tool_calls <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span></span>
<span class="line">    tool_call <span class="token operator">=</span> response<span class="token punctuation">.</span>tool_calls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">if</span> tool_call<span class="token punctuation">.</span>function<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">&quot;ask_database&quot;</span><span class="token punctuation">:</span></span>
<span class="line">        arguments <span class="token operator">=</span> tool_call<span class="token punctuation">.</span>function<span class="token punctuation">.</span>arguments</span>
<span class="line">        args <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>arguments<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;====SQL====&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token string">&quot;query&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        result <span class="token operator">=</span> ask_database<span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token string">&quot;query&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;====DB Records====&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&quot;tool_call_id&quot;</span><span class="token punctuation">:</span> tool_call<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;role&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;tool&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;ask_database&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;content&quot;</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        response <span class="token operator">=</span> get_sql_completion<span class="token punctuation">(</span>messages<span class="token punctuation">)</span></span>
<span class="line">        messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span>response<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;====最终回复====&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>content<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;=====对话历史=====&quot;</span><span class="token punctuation">)</span></span>
<span class="line">print_json<span class="token punctuation">(</span>messages<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">====Function Calling====</span>
<span class="line">{</span>
<span class="line">    &quot;content&quot;: &quot;&quot;,</span>
<span class="line">    &quot;refusal&quot;: null,</span>
<span class="line">    &quot;role&quot;: &quot;assistant&quot;,</span>
<span class="line">    &quot;function_call&quot;: null,</span>
<span class="line">    &quot;tool_calls&quot;: [</span>
<span class="line">        {</span>
<span class="line">            &quot;id&quot;: &quot;call_aeZKffHgmyzOzcNKOXcRe3ha&quot;,</span>
<span class="line">            &quot;function&quot;: {</span>
<span class="line">                &quot;arguments&quot;: &quot;{\&quot;query\&quot;:\&quot;SELECT SUM(price) AS total_sales FROM orders WHERE strftime(&#39;%Y-%m&#39;, create_time) = &#39;2023-10&#39; AND status = 1;\&quot;}&quot;,</span>
<span class="line">                &quot;name&quot;: &quot;ask_database&quot;</span>
<span class="line">            },</span>
<span class="line">            &quot;type&quot;: &quot;function&quot;</span>
<span class="line">        }</span>
<span class="line">    ]</span>
<span class="line">}</span>
<span class="line">====SQL====</span>
<span class="line">SELECT SUM(price) AS total_sales FROM orders WHERE strftime(&#39;%Y-%m&#39;, create_time) = &#39;2023-10&#39; AND status = 1;</span>
<span class="line">====DB Records====</span>
<span class="line">[(86.0,)]</span>
<span class="line">====最终回复====</span>
<span class="line">10月的销售额为86.00元。</span>
<span class="line">=====对话历史=====</span>
<span class="line">{</span>
<span class="line">    &quot;role&quot;: &quot;system&quot;,</span>
<span class="line">    &quot;content&quot;: &quot;你是一个数据分析师，基于数据库的数据回答问题&quot;</span>
<span class="line">}</span>
<span class="line">{</span>
<span class="line">    &quot;role&quot;: &quot;user&quot;,</span>
<span class="line">    &quot;content&quot;: &quot;10月的销售额&quot;</span>
<span class="line">}</span>
<span class="line">{</span>
<span class="line">    &quot;content&quot;: &quot;&quot;,</span>
<span class="line">    &quot;refusal&quot;: null,</span>
<span class="line">    &quot;role&quot;: &quot;assistant&quot;,</span>
<span class="line">    &quot;function_call&quot;: null,</span>
<span class="line">    &quot;tool_calls&quot;: [</span>
<span class="line">        {</span>
<span class="line">            &quot;id&quot;: &quot;call_aeZKffHgmyzOzcNKOXcRe3ha&quot;,</span>
<span class="line">            &quot;function&quot;: {</span>
<span class="line">                &quot;arguments&quot;: &quot;{\&quot;query\&quot;:\&quot;SELECT SUM(price) AS total_sales FROM orders WHERE strftime(&#39;%Y-%m&#39;, create_time) = &#39;2023-10&#39; AND status = 1;\&quot;}&quot;,</span>
<span class="line">                &quot;name&quot;: &quot;ask_database&quot;</span>
<span class="line">            },</span>
<span class="line">            &quot;type&quot;: &quot;function&quot;</span>
<span class="line">        }</span>
<span class="line">    ]</span>
<span class="line">}</span>
<span class="line">{</span>
<span class="line">    &quot;tool_call_id&quot;: &quot;call_aeZKffHgmyzOzcNKOXcRe3ha&quot;,</span>
<span class="line">    &quot;role&quot;: &quot;tool&quot;,</span>
<span class="line">    &quot;name&quot;: &quot;ask_database&quot;,</span>
<span class="line">    &quot;content&quot;: &quot;[(86.0,)]&quot;</span>
<span class="line">}</span>
<span class="line">{</span>
<span class="line">    &quot;content&quot;: &quot;10月的销售额为86.00元。&quot;,</span>
<span class="line">    &quot;refusal&quot;: null,</span>
<span class="line">    &quot;role&quot;: &quot;assistant&quot;,</span>
<span class="line">    &quot;function_call&quot;: null,</span>
<span class="line">    &quot;tool_calls&quot;: null</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="示例-4-用-function-calling-实现多表查询" tabindex="-1"><a class="header-anchor" href="#示例-4-用-function-calling-实现多表查询"><span>示例 4：用 Function Calling 实现多表查询</span></a></h2><p>把多表的描述给进去就好了。</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment">#  描述数据库表结构</span></span>
<span class="line">database_schema_string <span class="token operator">=</span> <span class="token triple-quoted-string string">&quot;&quot;&quot;</span>
<span class="line">CREATE TABLE customers (</span>
<span class="line">    id INT PRIMARY KEY NOT NULL, -- 主键，不允许为空</span>
<span class="line">    customer_name VARCHAR(255) NOT NULL, -- 客户名，不允许为空</span>
<span class="line">    email VARCHAR(255) UNIQUE, -- 邮箱，唯一</span>
<span class="line">    register_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP -- 注册时间，默认为当前时间</span>
<span class="line">);</span>
<span class="line">CREATE TABLE products (</span>
<span class="line">    id INT PRIMARY KEY NOT NULL, -- 主键，不允许为空</span>
<span class="line">    product_name VARCHAR(255) NOT NULL, -- 产品名称，不允许为空</span>
<span class="line">    price DECIMAL(10,2) NOT NULL -- 价格，不允许为空</span>
<span class="line">);</span>
<span class="line">CREATE TABLE orders (</span>
<span class="line">    id INT PRIMARY KEY NOT NULL, -- 主键，不允许为空</span>
<span class="line">    customer_id INT NOT NULL, -- 客户ID，不允许为空</span>
<span class="line">    product_id INT NOT NULL, -- 产品ID，不允许为空</span>
<span class="line">    price DECIMAL(10,2) NOT NULL, -- 价格，不允许为空</span>
<span class="line">    status INT NOT NULL, -- 订单状态，整数类型，不允许为空。0代表待支付，1代表已支付，2代表已退款</span>
<span class="line">    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- 创建时间，默认为当前时间</span>
<span class="line">    pay_time TIMESTAMP -- 支付时间，可以为空</span>
<span class="line">);</span>
<span class="line">&quot;&quot;&quot;</span></span>
<span class="line"></span>
<span class="line">prompt <span class="token operator">=</span> <span class="token string">&quot;统计每月每件商品的销售额&quot;</span></span>
<span class="line">prompt <span class="token operator">=</span> <span class="token string">&quot;这星期消费最高的用户是谁？他买了哪些商品？ 每件商品买了几件？花费多少？&quot;</span></span>
<span class="line">messages <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span><span class="token string">&quot;role&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;system&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;你是一个数据分析师，基于数据库中的表回答用户问题&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span><span class="token string">&quot;role&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">:</span> prompt<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">]</span></span>
<span class="line">response <span class="token operator">=</span> get_sql_completion<span class="token punctuation">(</span>messages<span class="token punctuation">)</span></span>
<span class="line">sql <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>response<span class="token punctuation">.</span>tool_calls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>function<span class="token punctuation">.</span>arguments<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">&quot;query&quot;</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">SELECT c.customer_name, p.product_name, o.price, COUNT(o.id) as quantity</span>
<span class="line">FROM orders o</span>
<span class="line">JOIN customers c ON o.customer_id = c.id</span>
<span class="line">JOIN products p ON o.product_id = p.id</span>
<span class="line">WHERE o.create_time &gt;= date(&#39;now&#39;, &#39;weekday 0&#39;, &#39;-6 days&#39;)</span>
<span class="line">AND o.create_time &lt; date(&#39;now&#39;, &#39;weekday 0&#39;, &#39;1 day&#39;)</span>
<span class="line">GROUP BY c.id, p.id</span>
<span class="line">ORDER BY SUM(o.price) DESC</span>
<span class="line">LIMIT 1;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上技术叫 NL2SQL。演示很简单，但实际场景里，当数据表数很大，结构很复杂时，有无数细节工作要做。</p><h2 id="示例-5-stream-模式" tabindex="-1"><a class="header-anchor" href="#示例-5-stream-模式"><span>示例 5：Stream 模式</span></a></h2><p>流式（stream）输出不会一次返回完整 JSON 结构，所以需要拼接后再使用。</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">get_completion</span><span class="token punctuation">(</span>messages<span class="token punctuation">,</span> model<span class="token operator">=</span><span class="token string">&quot;gpt-4o-mini&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span></span>
<span class="line">        model<span class="token operator">=</span>model<span class="token punctuation">,</span></span>
<span class="line">        messages<span class="token operator">=</span>messages<span class="token punctuation">,</span></span>
<span class="line">        temperature<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">        tools<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;function&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;sum&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;description&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;计算一组数的加和&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;parameters&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;properties&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token string">&quot;numbers&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                            <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;array&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                            <span class="token string">&quot;items&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                                <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;number&quot;</span></span>
<span class="line">                            <span class="token punctuation">}</span></span>
<span class="line">                        <span class="token punctuation">}</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">        stream<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>    <span class="token comment"># 启动流式输出</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> response</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">prompt <span class="token operator">=</span> <span class="token string">&quot;1+2+3&quot;</span></span>
<span class="line"><span class="token comment"># prompt = &quot;你是谁&quot;</span></span>
<span class="line"></span>
<span class="line">messages <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span><span class="token string">&quot;role&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;system&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;你是一个小学数学老师，你要教学生加法&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span><span class="token string">&quot;role&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">:</span> prompt<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">]</span></span>
<span class="line">response <span class="token operator">=</span> get_completion<span class="token punctuation">(</span>messages<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">function_name<span class="token punctuation">,</span> args<span class="token punctuation">,</span> text <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;====Streaming====&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 需要把 stream 里的 token 拼起来，才能得到完整的 call</span></span>
<span class="line"><span class="token keyword">for</span> msg <span class="token keyword">in</span> response<span class="token punctuation">:</span></span>
<span class="line">    delta <span class="token operator">=</span> msg<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>delta</span>
<span class="line">    <span class="token keyword">if</span> delta<span class="token punctuation">.</span>tool_calls<span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> function_name<span class="token punctuation">:</span></span>
<span class="line">            function_name <span class="token operator">=</span> delta<span class="token punctuation">.</span>tool_calls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>function<span class="token punctuation">.</span>name</span>
<span class="line">            <span class="token keyword">print</span><span class="token punctuation">(</span>function_name<span class="token punctuation">)</span></span>
<span class="line">        args_delta <span class="token operator">=</span> delta<span class="token punctuation">.</span>tool_calls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>function<span class="token punctuation">.</span>arguments</span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span>args_delta<span class="token punctuation">)</span>  <span class="token comment"># 打印每次得到的数据</span></span>
<span class="line">        args <span class="token operator">=</span> args <span class="token operator">+</span> args_delta</span>
<span class="line">    <span class="token keyword">elif</span> delta<span class="token punctuation">.</span>content<span class="token punctuation">:</span></span>
<span class="line">        text_delta <span class="token operator">=</span> delta<span class="token punctuation">.</span>content</span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span>text_delta<span class="token punctuation">)</span></span>
<span class="line">        text <span class="token operator">=</span> text <span class="token operator">+</span> text_delta</span>
<span class="line"></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;====done!====&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">if</span> function_name <span class="token keyword">or</span> args<span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span>function_name<span class="token punctuation">)</span></span>
<span class="line">    print_json<span class="token punctuation">(</span>args<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">if</span> text<span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">====Streaming====</span>
<span class="line">sum</span>
<span class="line"></span>
<span class="line">{</span>
<span class="line">    &quot;numbers&quot;:[</span>
<span class="line">        1,</span>
<span class="line">        2,</span>
<span class="line">        3</span>
<span class="line">    ]</span>
<span class="line">}</span>
<span class="line">====done!====</span>
<span class="line">sum</span>
<span class="line">{&quot;numbers&quot;:[1,2,3]}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="function-calling-的注意事项" tabindex="-1"><a class="header-anchor" href="#function-calling-的注意事项"><span>Function Calling 的注意事项</span></a></h2><blockquote><p>✅ <strong>Tip:</strong> 划重点：</p></blockquote><p>函数声明是消耗 token 的。要在功能覆盖、省钱、节约上下文窗口之间找到最佳平衡 Function Calling 不仅可以调用读函数，也能调用写函数。但官方强烈建议，在写之前，一定要有真人做确认</p><h2 id="国产大模型-function-calling-能力仍不足" tabindex="-1"><a class="header-anchor" href="#国产大模型-function-calling-能力仍不足"><span>国产大模型 Function Calling 能力仍不足</span></a></h2><ul><li>国产大模型基本都支持 Function Calling 了</li><li>实现稳定的 FC 能力，难度挺大。需要模型推理能力强，指令遵从强，格式控制能力强，以及有好的中间层</li><li>国产大模型比起 GPT 差距仍存在</li><li>一种取巧的合规做法：<strong>用 GPT 做 FC，用国产大模型生成最终结果</strong></li></ul><h2 id="另一种声音" tabindex="-1"><a class="header-anchor" href="#另一种声音"><span>另一种声音</span></a></h2><ul><li>有人不喜欢用 FC，更愿意用 prompt 请求 JSON 结果的方式手动实现 FC 的能力。原因： <ul><li>省 token</li><li>更可控</li><li>更容易切换基础大模型</li></ul></li><li>并没有足够证据表明一定孰优孰劣</li><li>但我选 FC，因为更主流</li></ul><h2 id="function-calling-的想象空间" tabindex="-1"><a class="header-anchor" href="#function-calling-的想象空间"><span>Function Calling 的想象空间</span></a></h2><p>Function Calling 即将成为操作系统中枢</p><p><img src="/wiki/assets/img/siri_send_img.13490478.gif" alt="image"></p><p>这个集成能力由 <a href="https://developer.apple.com/documentation/appintents" target="_blank" rel="noopener noreferrer">App Intents</a> 提供。</p><p>想象你是下面产品的研发，怎样用 Function Calling 实现下面的功能？</p><ol><li>对着微信说：「给我每个好友发一条情真意切的拜年消息，还要带点儿小幽默」</li><li>对着富途牛牛说：「人工智能相关股票，市盈率最低的是哪几个？最近交易量如何？都有哪些机构持有？」</li><li>对着京东说：「我想买一台 65 寸的电视，不要日货，价格在 5000 元左右」</li><li>对着 Siri 说以上内容，Siri 调用各个 App 完成任务</li></ol><p>基本上：</p><ol><li>我们的任何功能都可以和大模型结合，提供更好的用户体验</li><li>通过大模型，完成内部功能的组合调用，逐步 agent 化设计系统架构</li></ol><p>当然，「幻觉」仍然是存在的。如何尽量减少幻觉的影响，参考以下资料：</p><ul><li>自然语言生成中关于幻觉研究的综述：https://arxiv.org/abs/2202.03629</li><li>语言模型出现的幻觉是如何滚雪球的：https://arxiv.org/abs/2305.13534</li><li>ChatGPT 在推理、幻觉和交互性上的评估：https://arxiv.org/abs/2302.04023</li><li>对比学习减少对话中的幻觉：https://arxiv.org/abs/2212.10400</li><li>自洽性提高了语言模型的思维链推理能力：https://arxiv.org/abs/2203.11171</li><li>生成式大型语言模型的黑盒幻觉检测：https://arxiv.org/abs/2303.08896</li></ul><h2 id="几条经验总结" tabindex="-1"><a class="header-anchor" href="#几条经验总结"><span>几条经验总结</span></a></h2><blockquote><p>✅ <strong>Tip:</strong> 在传统与 AI 之间徘徊：</p></blockquote><p>详细拆解业务 SOP，形成任务工作流。每个任务各个击破，当前别幻想模型一揽子解决所有问题 不是所有任务都适合用大模型解决。传统方案，包括传统 AI 方案，可能更合适 一定要能评估大模型的准确率（所以要先有测试集，否则别问「能不能做」） 评估 bad case 的影响面 大模型永远不是 100% 正确的，建立在这个假设基础上推敲产品的可行性</p><h2 id="用-json-schema-控制回复格式" tabindex="-1"><a class="header-anchor" href="#用-json-schema-控制回复格式"><span>用 <code>json_schema</code> 控制回复格式</span></a></h2><ul><li>这是 OpenAI 2024 年 8 月 6 日发布的新 API</li><li>未见国产大模型跟进，因为没那么容易跟进</li><li>但很可能又成为一个标准</li><li>比 JSON mode 更稳定，更容易控制</li></ul><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseModel</span>
<span class="line"><span class="token keyword">from</span> openai <span class="token keyword">import</span> OpenAI</span>
<span class="line"></span>
<span class="line">client <span class="token operator">=</span> OpenAI<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">CalendarEvent</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    name<span class="token punctuation">:</span> <span class="token builtin">str</span></span>
<span class="line">    date<span class="token punctuation">:</span> <span class="token builtin">str</span></span>
<span class="line">    address<span class="token punctuation">:</span> <span class="token builtin">str</span></span>
<span class="line">    participants<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line">completion <span class="token operator">=</span> client<span class="token punctuation">.</span>beta<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>parse<span class="token punctuation">(</span> <span class="token comment"># 使用 beta 接口</span></span>
<span class="line">    model<span class="token operator">=</span><span class="token string">&quot;gpt-4o-mini-2024-07-18&quot;</span><span class="token punctuation">,</span>  <span class="token comment"># 必须是版本大于 gpt-4o-mini-2024-07-18 或 gpt-4o-2024-08-06 的模型</span></span>
<span class="line">    messages<span class="token operator">=</span><span class="token punctuation">[</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;role&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;system&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;解析出事件信息。&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;role&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;一般在周一晚上，孙志岗会在他的视频号邀请一名 AI 全栈工程师课程的学员连麦直播。&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    response_format<span class="token operator">=</span>CalendarEvent<span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line">event <span class="token operator">=</span> completion<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>parsed</span>
<span class="line">print_json<span class="token punctuation">(</span>event<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">{</span>
<span class="line">    &quot;name&quot;: &quot;AI 全栈工程师课程 学员连麦直播&quot;,</span>
<span class="line">    &quot;date&quot;: &quot;每周一晚上&quot;,</span>
<span class="line">    &quot;address&quot;: &quot;&quot;,</span>
<span class="line">    &quot;participants&quot;: [</span>
<span class="line">        &quot;孙志岗&quot;,</span>
<span class="line">        &quot;AI 全栈工程师课程学员&quot;</span>
<span class="line">    ]</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="原理" tabindex="-1"><a class="header-anchor" href="#原理"><span>原理</span></a></h3><p>把 JSON 的结构定义一并给到大模型，所以能更稳定。</p><p>下面是调用时传的参数：</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;model&quot;</span><span class="token operator">:</span> <span class="token string">&quot;gpt-4o-mini-2024-07-18&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;messages&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;role&quot;</span><span class="token operator">:</span> <span class="token string">&quot;system&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;解析出事件信息。&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;role&quot;</span><span class="token operator">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;一般在周一晚上，孙志岗会在他的视频号邀请一名 AI 全栈工程师课程的学员连麦直播。&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;response_format&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;json_schema&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;json_schema&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;calendar_event&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;schema&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token property">&quot;date&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token property">&quot;participants&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;array&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">&quot;items&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span> <span class="token punctuation">}</span></span>
<span class="line">          <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token property">&quot;required&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;date&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;participants&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token property">&quot;additionalProperties&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;strict&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="作业" tabindex="-1"><a class="header-anchor" href="#作业"><span>作业</span></a></h2><p>尝试用 Function Calling 的方式实现第二课手机中流量包智能客服的例子。</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><!----><!----></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script src="/wiki/assets/js/runtime~app.2831d094.js" defer></script><script src="/wiki/assets/js/768.e6d4205d.js" defer></script><script src="/wiki/assets/js/app.3be034a8.js" defer></script>
  </body>
</html>
