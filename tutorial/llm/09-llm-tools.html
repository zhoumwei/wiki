<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.20" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>09 Llm Tools   Index | çŸ¥è¯†åº“</title><meta name="description" content="æ¶µç›–Javaã€Springã€Vueã€Node.jsç­‰æŠ€æœ¯çŸ¥è¯†">
    <link rel="stylesheet" href="/wiki/assets/css/styles.dd0ba6d4.css">
    <link rel="preload" href="/wiki/assets/js/runtime~app.2c74ba0d.js" as="script"><link rel="preload" href="/wiki/assets/css/styles.dd0ba6d4.css" as="style"><link rel="preload" href="/wiki/assets/js/768.e6d4205d.js" as="script"><link rel="preload" href="/wiki/assets/js/app.5b328b55.js" as="script">
    <link rel="prefetch" href="/wiki/assets/js/solution_smart-marketing_index.html.066d2d5f.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_llm_05-rag-embeddings.html.5b793696.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_high-availability_index.html.1ef390b5.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_react_index.html.48c1e14e.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_llm_02-prompt.html.e84448e0.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_llm_08-langchain.html.0b85e079.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_llm_06-assistants-api.html.aee72ff3.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_aiops_index.html.95469b02.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_llm_07-llamaindex.html.62de5a73.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_swift_index.html.0fd2295e.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_finops_tools.html.093c30a9.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_llm_03-func-call.html.80139b7e.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_llm_09-llm-tools.html.34caf241.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_llm_07-semantic-kernel.bak.html.91e47126.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_embedded_index.html.5d403469.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_llm_04-ai-programming.html.b02837a6.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_nodejs_index.html.5a23d5c1.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_python_index.html.b138fbf3.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_spring-boot_index.html.75c329c5.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_java_jdk-changes_index.html.1bf5685c.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_llm_01-intro.html.be7abb56.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_r_index.html.01fc91b5.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_vue_index.html.7ae1fc67.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_java_concurrency_index.html.e362b849.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_llm_llm-faq.html.f09e7381.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_llm_04-ai-programming-practice.html.fcc21d00.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_java_advanced_index.html.71c33c5c.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_spring-cloud_index.html.1230cde8.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_message-queue_index.html.604a378b.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_big-data_index.html.d9a7770e.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_database_index.html.943dfb75.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_java_basic_index.html.e6c1018a.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_ml_index.html.f03756d1.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_finops_asset_kubecost_FinOps Essentials_ Best Practices for Product Teams.html.8990a35f.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_llm_ChatALL.html.e7d49092.js" as="script"><link rel="prefetch" href="/wiki/assets/js/interview_java_collections_index.html.8d492322.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_rl_index.html.adc2eeab.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_finops_implementation.html.a3ef2295.js" as="script"><link rel="prefetch" href="/wiki/assets/js/get-started.html.776b8f4a.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_finops_kubecost-installation.html.f28b5b94.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_finops_risk-trends.html.66e797bc.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_llm_10-agent.html.5c170d47.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_finops_case-studies.html.e283feaa.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_finops_index.html.aac8183e.js" as="script"><link rel="prefetch" href="/wiki/assets/js/index.html.599be039.js" as="script"><link rel="prefetch" href="/wiki/assets/js/tutorial_llm_index.html.6b9b5f38.js" as="script"><link rel="prefetch" href="/wiki/assets/js/solution_finops_concept.html.6e93951e.js" as="script"><link rel="prefetch" href="/wiki/assets/js/404.html.66d54fed.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/wiki/"><img class="vp-site-logo" src="/wiki/logo/logo.svg" alt="çŸ¥è¯†åº“"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">çŸ¥è¯†åº“</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/wiki/" aria-label="é¦–é¡µ"><!--[--><!--[--><!--]--><!--]-->é¦–é¡µ<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/wiki/get-started.html" aria-label="å¼€å§‹é˜…è¯»"><!--[--><!--[--><!--]--><!--]-->å¼€å§‹é˜…è¯»<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="Java"><span class="title">Java</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="Java"><span class="title">Java</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/basic/" aria-label="JavaåŸºç¡€"><!--[--><!--[--><!--]--><!--]-->JavaåŸºç¡€<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/advanced/" aria-label="Javaé«˜çº§"><!--[--><!--[--><!--]--><!--]-->Javaé«˜çº§<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/collections/" aria-label="Javaé›†åˆè¯¦è§£"><!--[--><!--[--><!--]--><!--]-->Javaé›†åˆè¯¦è§£<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/concurrency/" aria-label="Javaå¤šçº¿ç¨‹è¯¦è§£"><!--[--><!--[--><!--]--><!--]-->Javaå¤šçº¿ç¨‹è¯¦è§£<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/jdk-changes/" aria-label="JDKç‰ˆæœ¬å˜åŒ–è¯¦è§£"><!--[--><!--[--><!--]--><!--]-->JDKç‰ˆæœ¬å˜åŒ–è¯¦è§£<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="Spring"><span class="title">Spring</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="Spring"><span class="title">Spring</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/spring-boot/" aria-label="Spring Boot"><!--[--><!--[--><!--]--><!--]-->Spring Boot<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/spring-cloud/" aria-label="Spring Cloud"><!--[--><!--[--><!--]--><!--]-->Spring Cloud<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="æŠ€æœ¯æ•™ç¨‹"><span class="title">æŠ€æœ¯æ•™ç¨‹</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="æŠ€æœ¯æ•™ç¨‹"><span class="title">æŠ€æœ¯æ•™ç¨‹</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link route-link-active auto-link" href="/wiki/tutorial/llm/" aria-label="LLM"><!--[--><!--[--><!--]--><!--]-->LLM<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="è§£å†³æ–¹æ¡ˆ"><span class="title">è§£å†³æ–¹æ¡ˆ</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="è§£å†³æ–¹æ¡ˆ"><span class="title">è§£å†³æ–¹æ¡ˆ</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/solution/aiops/" aria-label="AIOps"><!--[--><!--[--><!--]--><!--]-->AIOps<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/solution/finops/" aria-label="FinOps"><!--[--><!--[--><!--]--><!--]-->FinOps<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/solution/high-availability/" aria-label="é«˜å¯ç”¨æ¶æ„"><!--[--><!--[--><!--]--><!--]-->é«˜å¯ç”¨æ¶æ„<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/solution/smart-marketing/" aria-label="æ™ºèƒ½è¥é”€"><!--[--><!--[--><!--]--><!--]-->æ™ºèƒ½è¥é”€<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/wiki/" aria-label="é¦–é¡µ"><!--[--><!--[--><!--]--><!--]-->é¦–é¡µ<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/wiki/get-started.html" aria-label="å¼€å§‹é˜…è¯»"><!--[--><!--[--><!--]--><!--]-->å¼€å§‹é˜…è¯»<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="Java"><span class="title">Java</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="Java"><span class="title">Java</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/basic/" aria-label="JavaåŸºç¡€"><!--[--><!--[--><!--]--><!--]-->JavaåŸºç¡€<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/advanced/" aria-label="Javaé«˜çº§"><!--[--><!--[--><!--]--><!--]-->Javaé«˜çº§<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/collections/" aria-label="Javaé›†åˆè¯¦è§£"><!--[--><!--[--><!--]--><!--]-->Javaé›†åˆè¯¦è§£<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/concurrency/" aria-label="Javaå¤šçº¿ç¨‹è¯¦è§£"><!--[--><!--[--><!--]--><!--]-->Javaå¤šçº¿ç¨‹è¯¦è§£<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/java/jdk-changes/" aria-label="JDKç‰ˆæœ¬å˜åŒ–è¯¦è§£"><!--[--><!--[--><!--]--><!--]-->JDKç‰ˆæœ¬å˜åŒ–è¯¦è§£<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="Spring"><span class="title">Spring</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="Spring"><span class="title">Spring</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/spring-boot/" aria-label="Spring Boot"><!--[--><!--[--><!--]--><!--]-->Spring Boot<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/interview/spring-cloud/" aria-label="Spring Cloud"><!--[--><!--[--><!--]--><!--]-->Spring Cloud<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="æŠ€æœ¯æ•™ç¨‹"><span class="title">æŠ€æœ¯æ•™ç¨‹</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="æŠ€æœ¯æ•™ç¨‹"><span class="title">æŠ€æœ¯æ•™ç¨‹</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link route-link-active auto-link" href="/wiki/tutorial/llm/" aria-label="LLM"><!--[--><!--[--><!--]--><!--]-->LLM<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="è§£å†³æ–¹æ¡ˆ"><span class="title">è§£å†³æ–¹æ¡ˆ</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="è§£å†³æ–¹æ¡ˆ"><span class="title">è§£å†³æ–¹æ¡ˆ</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/solution/aiops/" aria-label="AIOps"><!--[--><!--[--><!--]--><!--]-->AIOps<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/solution/finops/" aria-label="FinOps"><!--[--><!--[--><!--]--><!--]-->FinOps<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/solution/high-availability/" aria-label="é«˜å¯ç”¨æ¶æ„"><!--[--><!--[--><!--]--><!--]-->é«˜å¯ç”¨æ¶æ„<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/wiki/solution/smart-marketing/" aria-label="æ™ºèƒ½è¥é”€"><!--[--><!--[--><!--]--><!--]-->æ™ºèƒ½è¥é”€<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><a class="route-link route-link-active auto-link vp-sidebar-item vp-sidebar-heading" href="/wiki/tutorial/llm/" aria-label="LLMå­¦ä¹ æ•™ç¨‹"><!--[--><!--[--><!--]--><!--]-->LLMå­¦ä¹ æ•™ç¨‹<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div><h1 id="_09-llm-tools-index" tabindex="-1"><a class="header-anchor" href="#_09-llm-tools-index"><span>09 Llm Tools Index</span></a></h1><h1 id="ğŸ’¡-è¿™èŠ‚è¯¾ä¼šå¸¦ç»™ä½ " tabindex="-1"><a class="header-anchor" href="#ğŸ’¡-è¿™èŠ‚è¯¾ä¼šå¸¦ç»™ä½ "><span>ğŸ’¡ è¿™èŠ‚è¯¾ä¼šå¸¦ç»™ä½ </span></a></h1><ol><li>ç³»ç»Ÿæ€§ç»´æŠ¤ã€æµ‹è¯•ã€ç›‘æ§ä¸€ä¸ª LLM åº”ç”¨</li><li>å­¦ä¹ ä½¿ç”¨ä¸»æµçš„å·¥å…·å®Œæˆä¸Šè¿°å·¥ä½œ</li></ol><h2 id="ğŸ“-è¿™èŠ‚è¯¾æ€ä¹ˆå­¦" tabindex="-1"><a class="header-anchor" href="#ğŸ“-è¿™èŠ‚è¯¾æ€ä¹ˆå­¦"><span>ğŸ“ è¿™èŠ‚è¯¾æ€ä¹ˆå­¦</span></a></h2><p>ä»£ç èƒ½åŠ›è¦æ±‚ï¼š<strong>ä¸­é«˜</strong>ï¼ŒAI/æ•°å­¦åŸºç¡€è¦æ±‚ï¼š<strong>ä½</strong></p><ol><li>æœ‰ç¼–ç¨‹åŸºç¡€çš„åŒå­¦ <ul><li>ä»è½¯ä»¶å·¥ç¨‹è§’åº¦ä½“ä¼šä¸€ä¸ª AI åº”ç”¨çš„å¼€å‘ä¸ç»´æŠ¤æµç¨‹</li></ul></li><li>æ²¡æœ‰ç¼–ç¨‹åŸºç¡€çš„åŒå­¦ <ul><li>äº†è§£ä¸€ä¸ª AI åº”ç”¨å¼€å‘ä¸ç»´æŠ¤è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„æŠ€æœ¯ä¸é—®é¢˜</li></ul></li></ol><h2 id="ç»´æŠ¤ä¸€ä¸ªç”Ÿäº§çº§çš„-llm-åº”ç”¨-æˆ‘ä»¬éœ€è¦åšä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#ç»´æŠ¤ä¸€ä¸ªç”Ÿäº§çº§çš„-llm-åº”ç”¨-æˆ‘ä»¬éœ€è¦åšä»€ä¹ˆ"><span>ç»´æŠ¤ä¸€ä¸ªç”Ÿäº§çº§çš„ LLM åº”ç”¨ï¼Œæˆ‘ä»¬éœ€è¦åšä»€ä¹ˆï¼Ÿ</span></a></h2><ol><li>å„ç§æŒ‡æ ‡ç›‘æ§ä¸ç»Ÿè®¡ï¼šè®¿é—®è®°å½•ã€å“åº”æ—¶é•¿ã€Token ç”¨é‡ã€è®¡è´¹ç­‰ç­‰</li><li>è°ƒè¯• Prompt</li><li>æµ‹è¯•/éªŒè¯ç³»ç»Ÿçš„ç›¸å…³è¯„ä¼°æŒ‡æ ‡</li><li>æ•°æ®é›†ç®¡ç†ï¼ˆä¾¿äºå›å½’æµ‹è¯•ï¼‰</li><li>Prompt ç‰ˆæœ¬ç®¡ç†ï¼ˆä¾¿äºå‡çº§/å›æ»šï¼‰</li></ol><h2 id="é’ˆå¯¹ä»¥ä¸Šéœ€æ±‚-æˆ‘ä»¬ä»‹ç»ä¸¤ä¸ªç”Ÿäº§çº§-llm-app-ç»´æŠ¤å¹³å°" tabindex="-1"><a class="header-anchor" href="#é’ˆå¯¹ä»¥ä¸Šéœ€æ±‚-æˆ‘ä»¬ä»‹ç»ä¸¤ä¸ªç”Ÿäº§çº§-llm-app-ç»´æŠ¤å¹³å°"><span>é’ˆå¯¹ä»¥ä¸Šéœ€æ±‚ï¼Œæˆ‘ä»¬ä»‹ç»ä¸¤ä¸ªç”Ÿäº§çº§ LLM App ç»´æŠ¤å¹³å°</span></a></h2><ol><li><strong>LangFuse</strong>: å¼€æº + SaaSï¼ˆå…è´¹/ä»˜è´¹ï¼‰ï¼ŒLangSmith å¹³æ›¿ï¼Œå¯é›†æˆ LangChain ä¹Ÿå¯ç›´æ¥å¯¹æ¥ OpenAI APIï¼›</li><li><strong>LangSmith</strong>: LangChain çš„å®˜æ–¹å¹³å°ï¼ŒSaaS æœåŠ¡ï¼ˆå…è´¹/ä»˜è´¹ï¼‰ï¼Œéå¼€æºï¼Œä¼ä¸šç‰ˆæ”¯æŒç§æœ‰éƒ¨ç½²ï¼›</li></ol><h2 id="_1ã€langfuse" tabindex="-1"><a class="header-anchor" href="#_1ã€langfuse"><span>1ã€LangFuse</span></a></h2><p>å¼€æºï¼Œæ”¯æŒ LangChain é›†æˆæˆ–åŸç”Ÿ OpenAI API é›†æˆ</p><p>å®˜æ–¹ç½‘ç«™ï¼šhttps://langfuse.com/</p><p>é¡¹ç›®åœ°å€ï¼šhttps://github.com/langfuse</p><p>æ–‡æ¡£åœ°å€ï¼šhttps://langfuse.com/docs</p><p>APIæ–‡æ¡£ï¼šhttps://api.reference.langfuse.com/</p><ul><li><p>Python SDK: https://python.reference.langfuse.com/</p></li><li><p>JS SDK: https://js.reference.langfuse.com/</p></li></ul><ol><li>é€šè¿‡å®˜æ–¹äº‘æœåŠ¡ä½¿ç”¨ï¼š <ul><li>æ³¨å†Œ: cloud.langfuse.com</li><li>åˆ›å»º API Key</li></ul></li></ol><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token assign-left variable">LANGFUSE_SECRET_KEY</span><span class="token operator">=</span><span class="token string">&quot;sk-lf-...&quot;</span></span>
<span class="line"><span class="token assign-left variable">LANGFUSE_PUBLIC_KEY</span><span class="token operator">=</span><span class="token string">&quot;pk-lf-...&quot;</span></span>
<span class="line"><span class="token assign-left variable">LANGFUSE_HOST</span><span class="token operator">=</span><span class="token string">&quot;https://cloud.langfuse.com&quot;</span> <span class="token comment"># EU æœåŠ¡å™¨</span></span>
<span class="line"><span class="token comment"># LANGFUSE_HOST=&quot;https://us.cloud.langfuse.com&quot; # US æœåŠ¡å™¨</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>é€šè¿‡ Docker æœ¬åœ°éƒ¨ç½²</li></ol><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token comment"># Clone repository</span></span>
<span class="line"><span class="token function">git</span> clone https://github.com/langfuse/langfuse.git</span>
<span class="line"><span class="token builtin class-name">cd</span> langfuse</span>
<span class="line"></span>
<span class="line"><span class="token comment"># Run server and db</span></span>
<span class="line"><span class="token function">docker</span> compose up <span class="token parameter variable">-d</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token comment"># åœ¨è‡ªå·±éƒ¨ç½²çš„ç³»ç»Ÿä¸­ç”Ÿæˆä¸Šè¿°ä¸¤ä¸ª KEY</span></span>
<span class="line"><span class="token comment"># å¹¶åœ¨ç¯å¢ƒå˜é‡ä¸­æŒ‡å®šæœåŠ¡åœ°å€</span></span>
<span class="line"></span>
<span class="line"><span class="token assign-left variable">LANGFUSE_SECRET_KEY</span><span class="token operator">=</span><span class="token string">&quot;sk-lf-...&quot;</span></span>
<span class="line"><span class="token assign-left variable">LANGFUSE_PUBLIC_KEY</span><span class="token operator">=</span><span class="token string">&quot;pk-lf-..&quot;</span></span>
<span class="line"><span class="token assign-left variable">LANGFUSE_HOST</span><span class="token operator">=</span><span class="token string">&quot;http://localhost:3000&quot;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># !pip install --upgrade langfuse</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_1-1ã€é€šè¿‡è£…é¥°å™¨è®°å½•" tabindex="-1"><a class="header-anchor" href="#_1-1ã€é€šè¿‡è£…é¥°å™¨è®°å½•"><span>1.1ã€é€šè¿‡è£…é¥°å™¨è®°å½•</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> langfuse<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> observe<span class="token punctuation">,</span> langfuse_context</span>
<span class="line"><span class="token keyword">from</span> langfuse<span class="token punctuation">.</span>openai <span class="token keyword">import</span> openai <span class="token comment"># OpenAI integration</span></span>
<span class="line"></span>
<span class="line"><span class="token decorator annotation punctuation">@observe</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">return</span> openai<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span></span>
<span class="line">        model<span class="token operator">=</span><span class="token string">&quot;gpt-3.5-turbo&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        messages<span class="token operator">=</span><span class="token punctuation">[</span></span>
<span class="line">          <span class="token punctuation">{</span><span class="token string">&quot;role&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;å¯¹æˆ‘è¯´Hello, World!&quot;</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>content</span>
<span class="line"> </span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">langfuse_context<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">Hello, World! Nice to meet you!</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_1-1-1ã€å‡ ä¸ªåŸºæœ¬æ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#_1-1-1ã€å‡ ä¸ªåŸºæœ¬æ¦‚å¿µ"><span>1.1.1ã€å‡ ä¸ªåŸºæœ¬æ¦‚å¿µ</span></a></h3><ul><li>Trace ä¸€èˆ¬è¡¨ç¤ºç”¨æˆ·ä¸ç³»ç»Ÿçš„ä¸€æ¬¡äº¤äº’ï¼Œå…¶ä¸­è®°å½•è¾“å…¥ã€è¾“å‡ºï¼Œä¹ŸåŒ…æ‹¬è‡ªå®šä¹‰çš„ metadata æ¯”å¦‚ç”¨æˆ·åã€session id ç­‰ï¼›</li><li>ä¸€ä¸ª trace å†…éƒ¨å¯ä»¥åŒ…å«å¤šä¸ªå­è¿‡ç¨‹ï¼Œè¿™é‡Œå« observarionsï¼›</li><li>Observation å¯ä»¥æ˜¯å¤šä¸ªç±»å‹ï¼š <ul><li>Event æ˜¯æœ€åŸºæœ¬çš„å•å…ƒï¼Œç”¨äºè®°å½•ä¸€ä¸ª trace ä¸­çš„æ¯ä¸ªäº‹ä»¶ï¼›</li><li>Span è¡¨ä¸€ä¸ª trace ä¸­çš„ä¸€ä¸ª&quot;è€—æ—¶&quot;çš„è¿‡ç¨‹ï¼›</li><li>Generation æ˜¯ç”¨äºè®°å½•ä¸ AI æ¨¡å‹äº¤äº’çš„ spanï¼Œä¾‹å¦‚ï¼šè°ƒç”¨ embedding æ¨¡å‹ã€è°ƒç”¨ LLMã€‚</li></ul></li><li>Observation å¯ä»¥åµŒå¥—ä½¿ç”¨ã€‚</li></ul><p><img src="/wiki/assets/img/span.9385f066.png" alt="image"></p><h3 id="_1-1-2ã€observe-è£…é¥°å™¨çš„å‚æ•°" tabindex="-1"><a class="header-anchor" href="#_1-1-2ã€observe-è£…é¥°å™¨çš„å‚æ•°"><span>1.1.2ã€<code>observe()</code> è£…é¥°å™¨çš„å‚æ•°</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">observe</span><span class="token punctuation">(</span></span>
<span class="line">	self<span class="token punctuation">,</span></span>
<span class="line">	<span class="token operator">*</span><span class="token punctuation">,</span></span>
<span class="line">	name<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token comment"># Trace æˆ– Span çš„åç§°ï¼Œé»˜è®¤ä¸ºå‡½æ•°å</span></span>
<span class="line">	as_type<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Literal<span class="token punctuation">[</span><span class="token string">&#39;generation&#39;</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token comment"># å°†è®°å½•å®šä¹‰ä¸º Observation (LLM è°ƒç”¨ï¼‰</span></span>
<span class="line">	capture_input<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token comment"># è®°å½•è¾“å…¥</span></span>
<span class="line">	capture_output<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token comment"># è®°å½•è¾“å‡º</span></span>
<span class="line">	transform_to_string<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Callable<span class="token punctuation">[</span><span class="token punctuation">[</span>Iterable<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span> <span class="token comment"># å°†è¾“å‡ºè½¬ä¸º string</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Callable<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">~</span>F<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">~</span>F<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> langfuse<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> observe<span class="token punctuation">,</span> langfuse_context</span>
<span class="line"><span class="token keyword">from</span> langfuse<span class="token punctuation">.</span>openai <span class="token keyword">import</span> openai</span>
<span class="line"></span>
<span class="line"><span class="token decorator annotation punctuation">@observe</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;HelloWorld&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">return</span> openai<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span></span>
<span class="line">        model<span class="token operator">=</span><span class="token string">&quot;gpt-3.5-turbo&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        messages<span class="token operator">=</span><span class="token punctuation">[</span></span>
<span class="line">          <span class="token punctuation">{</span><span class="token string">&quot;role&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;å¯¹æˆ‘è¯´Hello, World!&quot;</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>content</span>
<span class="line"> </span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">langfuse_context<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">Hello, World! Nice to meet you!</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_1-1-3ã€é€šè¿‡-langfuse-context-è®°å½•-user-idã€metadata-ç­‰" tabindex="-1"><a class="header-anchor" href="#_1-1-3ã€é€šè¿‡-langfuse-context-è®°å½•-user-idã€metadata-ç­‰"><span>1.1.3ã€é€šè¿‡ <code>langfuse_context</code> è®°å½• User IDã€Metadata ç­‰</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> langfuse<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> observe<span class="token punctuation">,</span> langfuse_context</span>
<span class="line"><span class="token keyword">from</span> langfuse<span class="token punctuation">.</span>openai <span class="token keyword">import</span> openai <span class="token comment"># OpenAI integration</span></span>
<span class="line"> </span>
<span class="line"><span class="token decorator annotation punctuation">@observe</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    langfuse_context<span class="token punctuation">.</span>update_current_trace<span class="token punctuation">(</span></span>
<span class="line">        name<span class="token operator">=</span><span class="token string">&quot;HelloWorld&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        user_id<span class="token operator">=</span><span class="token string">&quot;wzr&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        tags<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;demo&quot;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> openai<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span></span>
<span class="line">        model<span class="token operator">=</span><span class="token string">&quot;gpt-3.5-turbo&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        messages<span class="token operator">=</span><span class="token punctuation">[</span></span>
<span class="line">          <span class="token punctuation">{</span><span class="token string">&quot;role&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;å¯¹æˆ‘è¯´Hello, World!&quot;</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>content</span>
<span class="line"> </span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">langfuse_context<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">Hello, World! Nice to meet you.</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_1-2ã€é€šè¿‡-langchain-çš„å›è°ƒé›†æˆ" tabindex="-1"><a class="header-anchor" href="#_1-2ã€é€šè¿‡-langchain-çš„å›è°ƒé›†æˆ"><span>1.2ã€é€šè¿‡ LangChain çš„å›è°ƒé›†æˆ</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># æ¸…ç†ç¯å¢ƒï¼Œé¿å…é‡å¤è®°å½•</span></span>
<span class="line"><span class="token keyword">del</span> openai</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>prompts <span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    ChatPromptTemplate<span class="token punctuation">,</span></span>
<span class="line">    HumanMessagePromptTemplate<span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>output_parsers <span class="token keyword">import</span> StrOutputParser</span>
<span class="line"><span class="token keyword">from</span> langchain_openai <span class="token keyword">import</span> ChatOpenAI</span>
<span class="line"><span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>runnables <span class="token keyword">import</span> RunnablePassthrough</span>
<span class="line"></span>
<span class="line">model <span class="token operator">=</span> ChatOpenAI<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">&quot;gpt-3.5-turbo&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">prompt <span class="token operator">=</span> ChatPromptTemplate<span class="token punctuation">.</span>from_messages<span class="token punctuation">(</span><span class="token punctuation">[</span></span>
<span class="line">    HumanMessagePromptTemplate<span class="token punctuation">.</span>from_template<span class="token punctuation">(</span><span class="token string">&quot;Say hello to {input}!&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment"># å®šä¹‰è¾“å‡ºè§£æå™¨</span></span>
<span class="line">parser <span class="token operator">=</span> StrOutputParser<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">chain <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token punctuation">{</span><span class="token string">&quot;input&quot;</span><span class="token punctuation">:</span> RunnablePassthrough<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token operator">|</span> prompt</span>
<span class="line">    <span class="token operator">|</span> model</span>
<span class="line">    <span class="token operator">|</span> parser</span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> langfuse<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> langfuse_context<span class="token punctuation">,</span> observe</span>
<span class="line"></span>
<span class="line"><span class="token decorator annotation punctuation">@observe</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    langfuse_context<span class="token punctuation">.</span>update_current_trace<span class="token punctuation">(</span></span>
<span class="line">            name<span class="token operator">=</span><span class="token string">&quot;LangChainDemo&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            user_id<span class="token operator">=</span><span class="token string">&quot;wzr&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># è·å–å½“å‰ LangChain å›è°ƒå¤„ç†å™¨</span></span>
<span class="line">    langfuse_handler <span class="token operator">=</span> langfuse_context<span class="token punctuation">.</span>get_current_langchain_handler<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> chain<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token operator">=</span><span class="token string">&quot;AGIClass&quot;</span><span class="token punctuation">,</span> config<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;callbacks&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>langfuse_handler<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">langfuse_context<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># Langfuse å›ä¼ è®°å½•æ˜¯å¼‚æ­¥çš„ï¼Œå¯ä»¥é€šè¿‡ flush å¼ºåˆ¶æ›´æ–°</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">Hello AGIClass! How can I assist you today?</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="æ¢ä¸ªæ¨¡å‹è¯•è¯•" tabindex="-1"><a class="header-anchor" href="#æ¢ä¸ªæ¨¡å‹è¯•è¯•"><span>æ¢ä¸ªæ¨¡å‹è¯•è¯•</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># å…¶å®ƒæ¨¡å‹åˆ†è£…åœ¨ langchain_community åº•åŒ…ä¸­</span></span>
<span class="line"><span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>chat_models <span class="token keyword">import</span> QianfanChatEndpoint</span>
<span class="line"><span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>messages <span class="token keyword">import</span> HumanMessage</span>
<span class="line"><span class="token keyword">import</span> os</span>
<span class="line"></span>
<span class="line">ernie_model <span class="token operator">=</span> QianfanChatEndpoint<span class="token punctuation">(</span></span>
<span class="line">    qianfan_ak<span class="token operator">=</span>os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">&#39;ERNIE_CLIENT_ID&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    qianfan_sk<span class="token operator">=</span>os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">&#39;ERNIE_CLIENT_SECRET&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">chain <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token punctuation">{</span><span class="token string">&quot;input&quot;</span><span class="token punctuation">:</span> RunnablePassthrough<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token operator">|</span> prompt</span>
<span class="line">    <span class="token operator">|</span> ernie_model</span>
<span class="line">    <span class="token operator">|</span> parser</span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token decorator annotation punctuation">@observe</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    langfuse_context<span class="token punctuation">.</span>update_current_trace<span class="token punctuation">(</span></span>
<span class="line">            name<span class="token operator">=</span><span class="token string">&quot;ErnieDemo&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            user_id<span class="token operator">=</span><span class="token string">&quot;wzr&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># è·å–å½“å‰ LangChain å›è°ƒå¤„ç†å™¨</span></span>
<span class="line">    langfuse_handler <span class="token operator">=</span> langfuse_context<span class="token punctuation">.</span>get_current_langchain_handler<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> chain<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token operator">=</span><span class="token string">&quot;ç‹å“ç„¶&quot;</span><span class="token punctuation">,</span> config<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;callbacks&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>langfuse_handler<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">langfuse_context<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">Langfuse was not able to parse the LLM model. The LLM call will be recorded without model name. Please create an issue: https://github.com/langfuse/langfuse/issues/new/choose</span>
<span class="line">[INFO][2024-10-15 12:42:11.383] oauth.py:228 [t:140628858189632]: trying to refresh access_token for ak `cuTPS7***`</span>
<span class="line">[INFO][2024-10-15 12:42:12.265] oauth.py:243 [t:140628858189632]: sucessfully refresh access_token</span>
<span class="line">Hello, Wang Zhuoran!</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-3ã€æ„å»ºä¸€ä¸ªå®é™…åº”ç”¨" tabindex="-1"><a class="header-anchor" href="#_1-3ã€æ„å»ºä¸€ä¸ªå®é™…åº”ç”¨"><span>1.3ã€æ„å»ºä¸€ä¸ªå®é™…åº”ç”¨</span></a></h3><p><strong>AGI è¯¾å ‚è·Ÿè¯¾åŠ©æ‰‹</strong>ï¼Œæ ¹æ®è¯¾ç¨‹å†…å®¹ï¼Œåˆ¤æ–­å­¦ç”Ÿé—®é¢˜æ˜¯å¦éœ€è¦è€å¸ˆè§£ç­”</p><ol><li>åˆ¤æ–­è¯¥é—®é¢˜æ˜¯å¦éœ€è¦è€å¸ˆè§£ç­”ï¼Œå›å¤&#39;Y&#39;æˆ–&#39;N&#39;</li><li>åˆ¤æ–­è¯¥é—®é¢˜æ˜¯å¦å·²æœ‰åŒå­¦é—®è¿‡</li></ol><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># æ„å»º PromptTemplate</span></span>
<span class="line"><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>prompts <span class="token keyword">import</span> PromptTemplate</span>
<span class="line"></span>
<span class="line">need_answer <span class="token operator">=</span> PromptTemplate<span class="token punctuation">.</span>from_template<span class="token punctuation">(</span><span class="token triple-quoted-string string">&quot;&quot;&quot;</span>
<span class="line">*********</span>
<span class="line">ä½ æ˜¯AIGCè¯¾ç¨‹çš„åŠ©æ•™ï¼Œä½ çš„å·¥ä½œæ˜¯ä»å­¦å‘˜çš„è¯¾å ‚äº¤æµä¸­é€‰æ‹©å‡ºéœ€è¦è€å¸ˆå›ç­”çš„é—®é¢˜ï¼ŒåŠ ä»¥æ•´ç†ä»¥äº¤ç»™è€å¸ˆå›ç­”ã€‚</span>
<span class="line"> </span>
<span class="line">è¯¾ç¨‹å†…å®¹:</span>
<span class="line">{outlines}</span>
<span class="line">*********</span>
<span class="line">å­¦å‘˜è¾“å…¥:</span>
<span class="line">{user_input}</span>
<span class="line">*********</span>
<span class="line">å¦‚æœè¿™æ˜¯ä¸€ä¸ªéœ€è¦è€å¸ˆç­”ç–‘çš„é—®é¢˜ï¼Œå›å¤Yï¼Œå¦åˆ™å›å¤Nã€‚</span>
<span class="line">åªå›å¤Yæˆ–Nï¼Œä¸è¦å›å¤å…¶ä»–å†…å®¹ã€‚&quot;&quot;&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">check_duplicated <span class="token operator">=</span> PromptTemplate<span class="token punctuation">.</span>from_template<span class="token punctuation">(</span><span class="token triple-quoted-string string">&quot;&quot;&quot;</span>
<span class="line">*********</span>
<span class="line">å·²æœ‰æé—®åˆ—è¡¨:</span>
<span class="line">[</span>
<span class="line">{question_list}</span>
<span class="line">]</span>
<span class="line">*********</span>
<span class="line">æ–°æé—®:</span>
<span class="line">{user_input}</span>
<span class="line">*********</span>
<span class="line">å·²æœ‰æé—®åˆ—è¡¨æ˜¯å¦æœ‰å’Œæ–°æé—®ç±»ä¼¼çš„é—®é¢˜? å›å¤Yæˆ–N, Yè¡¨ç¤ºæœ‰ï¼ŒNè¡¨ç¤ºæ²¡æœ‰ã€‚</span>
<span class="line">åªå›å¤Yæˆ–Nï¼Œä¸è¦å›å¤å…¶ä»–å†…å®¹ã€‚&quot;&quot;&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">outlines <span class="token operator">=</span> <span class="token triple-quoted-string string">&quot;&quot;&quot;</span>
<span class="line">LangChain</span>
<span class="line">æ¨¡å‹ I/O å°è£…</span>
<span class="line">æ¨¡å‹çš„å°è£…</span>
<span class="line">æ¨¡å‹çš„è¾“å…¥è¾“å‡º</span>
<span class="line">PromptTemplate</span>
<span class="line">OutputParser</span>
<span class="line">æ•°æ®è¿æ¥å°è£…</span>
<span class="line">æ–‡æ¡£åŠ è½½å™¨ï¼šDocument Loaders</span>
<span class="line">æ–‡æ¡£å¤„ç†å™¨</span>
<span class="line">å†…ç½®RAGï¼šRetrievalQA</span>
<span class="line">è®°å¿†å°è£…ï¼šMemory</span>
<span class="line">é“¾æ¶æ„ï¼šChain/LCEL</span>
<span class="line">å¤§æ¨¡å‹æ—¶ä»£çš„è½¯ä»¶æ¶æ„ï¼šAgent</span>
<span class="line">ReAct</span>
<span class="line">SelfAskWithSearch</span>
<span class="line">LangServe</span>
<span class="line">LangChain.js</span>
<span class="line">&quot;&quot;&quot;</span></span>
<span class="line"></span>
<span class="line">question_list <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token string">&quot;LangChainå¯ä»¥å•†ç”¨å—&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&quot;LangChainå¼€æºå—&quot;</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># åˆ›å»º chain</span></span>
<span class="line">model <span class="token operator">=</span> ChatOpenAI<span class="token punctuation">(</span>temperature<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> seed<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span></span>
<span class="line">parser <span class="token operator">=</span> StrOutputParser<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">need_answer_chain <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">    need_answer</span>
<span class="line">    <span class="token operator">|</span> model</span>
<span class="line">    <span class="token operator">|</span> parser</span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">is_duplicated_chain <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">    check_duplicated</span>
<span class="line">    <span class="token operator">|</span> model</span>
<span class="line">    <span class="token operator">|</span> parser</span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-3-1ã€ç”¨-trace-è®°å½•ä¸€ä¸ªå¤šæ¬¡è°ƒç”¨-llm-çš„è¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#_1-3-1ã€ç”¨-trace-è®°å½•ä¸€ä¸ªå¤šæ¬¡è°ƒç”¨-llm-çš„è¿‡ç¨‹"><span>1.3.1ã€ç”¨ Trace è®°å½•ä¸€ä¸ªå¤šæ¬¡è°ƒç”¨ LLM çš„è¿‡ç¨‹</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> uuid</span>
<span class="line"><span class="token keyword">from</span> langfuse<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> langfuse_context<span class="token punctuation">,</span> observe</span>
<span class="line"></span>
<span class="line"><span class="token comment"># ä¸»æµç¨‹</span></span>
<span class="line"><span class="token decorator annotation punctuation">@observe</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">verify_question</span><span class="token punctuation">(</span></span>
<span class="line">    question<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span></span>
<span class="line">    outlines<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span></span>
<span class="line">    question_list<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">,</span></span>
<span class="line">    user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span></span>
<span class="line">    langfuse_context<span class="token punctuation">.</span>update_current_trace<span class="token punctuation">(</span></span>
<span class="line">            name<span class="token operator">=</span><span class="token string">&quot;AGIClassAssistant&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            user_id<span class="token operator">=</span>user_id<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># get the langchain handler for the current trace</span></span>
<span class="line">    langfuse_handler <span class="token operator">=</span> langfuse_context<span class="token punctuation">.</span>get_current_langchain_handler<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment"># åˆ¤æ–­æ˜¯å¦éœ€è¦å›ç­”</span></span>
<span class="line">    <span class="token keyword">if</span> need_answer_chain<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;user_input&quot;</span><span class="token punctuation">:</span> question<span class="token punctuation">,</span> <span class="token string">&quot;outlines&quot;</span><span class="token punctuation">:</span> outlines<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        config<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;callbacks&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>langfuse_handler<span class="token punctuation">]</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&#39;Y&#39;</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># åˆ¤æ–­æ˜¯å¦ä¸ºé‡å¤é—®é¢˜</span></span>
<span class="line">        <span class="token keyword">if</span> is_duplicated_chain<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span></span>
<span class="line">            <span class="token punctuation">{</span><span class="token string">&quot;user_input&quot;</span><span class="token punctuation">:</span> question<span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;question_list&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>question_list<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            config<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;callbacks&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>langfuse_handler<span class="token punctuation">]</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&#39;N&#39;</span><span class="token punctuation">:</span></span>
<span class="line">            question_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>question<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">True</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">False</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># å®é™…è°ƒç”¨</span></span>
<span class="line">ret <span class="token operator">=</span> verify_question<span class="token punctuation">(</span></span>
<span class="line">    <span class="token comment"># &quot;LangChainæ”¯æŒJavaå—&quot;,</span></span>
<span class="line">    <span class="token string">&quot;è€å¸ˆå¥½&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    outlines<span class="token punctuation">,</span></span>
<span class="line">    question_list<span class="token punctuation">,</span></span>
<span class="line">    user_id<span class="token operator">=</span><span class="token string">&quot;wzr&quot;</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span></span>
<span class="line">langfuse_context<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">False</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><blockquote><p>âœ… <strong>Tip:</strong> ä¸Šé¢çš„å®ç°æ˜¯ä¸ºäº†æ¼”ç¤º trace å’Œ span çš„æ¦‚å¿µã€‚å®é™…ä¸‹é¢çš„å®ç°æ–¹å¼æ›´ä¼˜ã€‚</p></blockquote><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np</span>
<span class="line"><span class="token keyword">import</span> openai</span>
<span class="line"></span>
<span class="line">cache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token decorator annotation punctuation">@observe</span><span class="token punctuation">(</span>as_type<span class="token operator">=</span><span class="token string">&quot;generation&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">get_embeddings</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&#39;&#39;&#39;å°è£… OpenAI çš„ Embedding æ¨¡å‹æ¥å£&#39;&#39;&#39;</span></span>
<span class="line">    <span class="token keyword">if</span> text <span class="token keyword">in</span> cache<span class="token punctuation">:</span> </span>
<span class="line">        <span class="token comment"># å¦‚æœå·²ç»åœ¨ç¼“å­˜ä¸­ï¼Œä¸å†é‡å¤è°ƒç”¨ï¼ˆèŠ‚çœæ—¶é—´ã€è´¹ç”¨ï¼‰</span></span>
<span class="line">        <span class="token keyword">return</span> cache<span class="token punctuation">[</span>text<span class="token punctuation">]</span></span>
<span class="line">    data <span class="token operator">=</span> openai<span class="token punctuation">.</span>embeddings<span class="token punctuation">.</span>create<span class="token punctuation">(</span></span>
<span class="line">        <span class="token builtin">input</span><span class="token operator">=</span><span class="token punctuation">[</span>text<span class="token punctuation">]</span><span class="token punctuation">,</span> </span>
<span class="line">        model<span class="token operator">=</span><span class="token string">&quot;text-embedding-3-small&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        dimensions<span class="token operator">=</span><span class="token number">256</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">.</span>data</span>
<span class="line">    cache<span class="token punctuation">[</span>text<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>embedding</span>
<span class="line">    <span class="token keyword">return</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>embedding</span>
<span class="line"></span>
<span class="line"><span class="token decorator annotation punctuation">@observe</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">cos_sim</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&#39;&#39;&#39;è®¡ç®—cosineç›¸ä¼¼åº¦&#39;&#39;&#39;</span></span>
<span class="line">    score <span class="token operator">=</span> np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>m<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>linalg<span class="token punctuation">.</span>norm<span class="token punctuation">(</span>m<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>np<span class="token punctuation">.</span>linalg<span class="token punctuation">.</span>norm<span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> score<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token decorator annotation punctuation">@observe</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">check_duplicated</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> existing<span class="token punctuation">,</span> threshold<span class="token operator">=</span><span class="token number">0.825</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&#39;&#39;&#39;é€šè¿‡cosineç›¸ä¼¼åº¦é˜ˆå€¼åˆ¤æ–­æ˜¯å¦é‡å¤&#39;&#39;&#39;</span></span>
<span class="line">    query_vec <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>get_embeddings<span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    mat <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> item <span class="token keyword">in</span> existing<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    cos <span class="token operator">=</span> cos_sim<span class="token punctuation">(</span>query_vec<span class="token punctuation">,</span> mat<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token builtin">max</span><span class="token punctuation">(</span>cos<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> threshold</span>
<span class="line"></span>
<span class="line"><span class="token decorator annotation punctuation">@observe</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">need_answer</span><span class="token punctuation">(</span>question<span class="token punctuation">,</span> outlints<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&#39;&#39;&#39;åˆ¤æ–­æ˜¯å¦éœ€è¦å›ç­”&#39;&#39;&#39;</span></span>
<span class="line">    langfuse_handler <span class="token operator">=</span> langfuse_context<span class="token punctuation">.</span>get_current_langchain_handler<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> need_answer_chain<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;user_input&quot;</span><span class="token punctuation">:</span> question<span class="token punctuation">,</span> <span class="token string">&quot;outlines&quot;</span><span class="token punctuation">:</span> outlines<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        config<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;callbacks&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>langfuse_handler<span class="token punctuation">]</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&#39;Y&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># å‡è®¾ å·²æœ‰é—®é¢˜</span></span>
<span class="line">question_list <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">(</span><span class="token string">&quot;LangChainå¯ä»¥å•†ç”¨å—&quot;</span><span class="token punctuation">,</span> get_embeddings<span class="token punctuation">(</span><span class="token string">&quot;LangChainå¯ä»¥å•†ç”¨å—&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">(</span><span class="token string">&quot;LangChainå¼€æºå—&quot;</span><span class="token punctuation">,</span> get_embeddings<span class="token punctuation">(</span><span class="token string">&quot;LangChainå¼€æºå—&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token decorator annotation punctuation">@observe</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">verify_question</span><span class="token punctuation">(</span></span>
<span class="line">    question<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span></span>
<span class="line">    outlines<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span></span>
<span class="line">    question_list<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">,</span></span>
<span class="line">    user_id<span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span></span>
<span class="line">    </span>
<span class="line">    langfuse_context<span class="token punctuation">.</span>update_current_trace<span class="token punctuation">(</span></span>
<span class="line">        name<span class="token operator">=</span><span class="token string">&quot;AGIClassAssistant2&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        user_id<span class="token operator">=</span>user_id<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># åˆ¤æ–­æ˜¯å¦éœ€è¦å›ç­”</span></span>
<span class="line">    <span class="token keyword">if</span> need_answer<span class="token punctuation">(</span>question<span class="token punctuation">,</span>outlines<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># åˆ¤æ–­æ˜¯å¦é‡å¤</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> check_duplicated<span class="token punctuation">(</span>question<span class="token punctuation">,</span> question_list<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            vec <span class="token operator">=</span> cache<span class="token punctuation">[</span>question<span class="token punctuation">]</span></span>
<span class="line">            question_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>question<span class="token punctuation">,</span>vec<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">True</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">False</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">ret <span class="token operator">=</span> verify_question<span class="token punctuation">(</span></span>
<span class="line">    <span class="token comment"># &quot;LangChainæ”¯æŒJavaå—&quot;,</span></span>
<span class="line">    <span class="token string">&quot;LangChainæœ‰å•†ç”¨è®¸å¯å—&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    outlines<span class="token punctuation">,</span></span>
<span class="line">    question_list<span class="token punctuation">,</span></span>
<span class="line">    user_id<span class="token operator">=</span><span class="token string">&quot;wzr&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span></span>
<span class="line">langfuse_context<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">False</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_1-3-2ã€ç”¨-session-è®°å½•ä¸€ä¸ªç”¨æˆ·çš„å¤šè½®å¯¹è¯" tabindex="-1"><a class="header-anchor" href="#_1-3-2ã€ç”¨-session-è®°å½•ä¸€ä¸ªç”¨æˆ·çš„å¤šè½®å¯¹è¯"><span>1.3.2ã€ç”¨ Session è®°å½•ä¸€ä¸ªç”¨æˆ·çš„å¤šè½®å¯¹è¯</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> langchain_openai <span class="token keyword">import</span> ChatOpenAI</span>
<span class="line"><span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>messages <span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    AIMessage<span class="token punctuation">,</span>  <span class="token comment"># ç­‰ä»·äºOpenAIæ¥å£ä¸­çš„assistant role</span></span>
<span class="line">    HumanMessage<span class="token punctuation">,</span>  <span class="token comment"># ç­‰ä»·äºOpenAIæ¥å£ä¸­çš„user role</span></span>
<span class="line">    SystemMessage  <span class="token comment"># ç­‰ä»·äºOpenAIæ¥å£ä¸­çš„system role</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime</span>
<span class="line"><span class="token keyword">from</span> langfuse<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> langfuse_context<span class="token punctuation">,</span> observe</span>
<span class="line"></span>
<span class="line">now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">llm <span class="token operator">=</span> ChatOpenAI<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">messages <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">    SystemMessage<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">&quot;ä½ æ˜¯AGIClassçš„è¯¾ç¨‹åŠ©ç†ã€‚&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line">session_id <span class="token operator">=</span> <span class="token string">&quot;chat-&quot;</span><span class="token operator">+</span>now<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">&quot;%d/%m/%Y %H:%M:%S&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token decorator annotation punctuation">@observe</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">chat_one_turn</span><span class="token punctuation">(</span>user_input<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> turn_id<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    langfuse_context<span class="token punctuation">.</span>update_current_trace<span class="token punctuation">(</span></span>
<span class="line">        name<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f&quot;ChatTurn</span><span class="token interpolation"><span class="token punctuation">{</span>turn_id<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span></span>
<span class="line">        user_id<span class="token operator">=</span>user_id<span class="token punctuation">,</span></span>
<span class="line">        session_id<span class="token operator">=</span>session_id</span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    langfuse_handler <span class="token operator">=</span> langfuse_context<span class="token punctuation">.</span>get_current_langchain_handler<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span>HumanMessage<span class="token punctuation">(</span>content<span class="token operator">=</span>user_input<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    response <span class="token operator">=</span> llm<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>messages<span class="token punctuation">,</span> config<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;callbacks&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>langfuse_handler<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span>response<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> response<span class="token punctuation">.</span>content</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">user_id<span class="token operator">=</span><span class="token string">&quot;wzr&quot;</span></span>
<span class="line">turn_id <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line"><span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span></span>
<span class="line">    user_input <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">&quot;User: &quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> user_input<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">break</span></span>
<span class="line">    reply <span class="token operator">=</span> chat_one_turn<span class="token punctuation">(</span>user_input<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> turn_id<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;AI: &quot;</span><span class="token operator">+</span>reply<span class="token punctuation">)</span></span>
<span class="line">    turn_id <span class="token operator">+=</span> <span class="token number">1</span></span>
<span class="line">    langfuse_context<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">User:  ä½ å¥½</span>
<span class="line">AI: ä½ å¥½ï¼æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ</span>
<span class="line">User:  ä½ æ˜¯è°</span>
<span class="line">AI: æˆ‘æ˜¯AGIClassçš„è¯¾ç¨‹åŠ©ç†ï¼Œæˆ‘å¯ä»¥å¸®åŠ©å›ç­”å…³äºè¯¾ç¨‹å†…å®¹å’Œå­¦ä¹ çš„é—®é¢˜ã€‚æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ</span>
<span class="line">User:</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-4ã€æ•°æ®é›†ä¸æµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#_1-4ã€æ•°æ®é›†ä¸æµ‹è¯•"><span>1.4ã€æ•°æ®é›†ä¸æµ‹è¯•</span></a></h3><h3 id="_1-4-1ã€åœ¨çº¿æ ‡æ³¨" tabindex="-1"><a class="header-anchor" href="#_1-4-1ã€åœ¨çº¿æ ‡æ³¨"><span>1.4.1ã€åœ¨çº¿æ ‡æ³¨</span></a></h3><p><img src="/wiki/assets/img/annotation.96eb9c4e.png" alt="image"></p><h3 id="_1-4-2ã€ä¸Šä¼ å·²æœ‰æ•°æ®é›†" tabindex="-1"><a class="header-anchor" href="#_1-4-2ã€ä¸Šä¼ å·²æœ‰æ•°æ®é›†"><span>1.4.2ã€ä¸Šä¼ å·²æœ‰æ•°æ®é›†</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> json</span>
<span class="line"></span>
<span class="line"><span class="token comment"># è°ƒæ•´æ•°æ®æ ¼å¼ {&quot;input&quot;:{...},&quot;expected_output&quot;:&quot;label&quot;}</span></span>
<span class="line">data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&#39;my_annotations.jsonl&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;r&#39;</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">for</span> line <span class="token keyword">in</span> fp<span class="token punctuation">:</span></span>
<span class="line">        example <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        item <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&quot;input&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&quot;outlines&quot;</span><span class="token punctuation">:</span> example<span class="token punctuation">[</span><span class="token string">&quot;outlines&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;user_input&quot;</span><span class="token punctuation">:</span> example<span class="token punctuation">[</span><span class="token string">&quot;user_input&quot;</span><span class="token punctuation">]</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;expected_output&quot;</span><span class="token punctuation">:</span> example<span class="token punctuation">[</span><span class="token string">&quot;label&quot;</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        data<span class="token punctuation">.</span>append<span class="token punctuation">(</span>item<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> langfuse <span class="token keyword">import</span> Langfuse</span>
<span class="line"><span class="token keyword">from</span> langfuse<span class="token punctuation">.</span>model <span class="token keyword">import</span> CreateDatasetRequest<span class="token punctuation">,</span> CreateDatasetItemRequest</span>
<span class="line"><span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm</span>
<span class="line"><span class="token keyword">import</span> langfuse</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">dataset_name <span class="token operator">=</span> <span class="token string">&quot;my-dataset&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># åˆå§‹åŒ–å®¢æˆ·ç«¯</span></span>
<span class="line">langfuse<span class="token operator">=</span>Langfuse<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># åˆ›å»ºæ•°æ®é›†ï¼Œå¦‚æœå·²å­˜åœ¨ä¸ä¼šé‡å¤åˆ›å»º</span></span>
<span class="line"><span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">    langfuse<span class="token punctuation">.</span>create_dataset<span class="token punctuation">(</span></span>
<span class="line">        name<span class="token operator">=</span>dataset_name<span class="token punctuation">,</span></span>
<span class="line">        <span class="token comment"># optional description</span></span>
<span class="line">        description<span class="token operator">=</span><span class="token string">&quot;My first dataset&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token comment"># optional metadata</span></span>
<span class="line">        metadata<span class="token operator">=</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&quot;author&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;wzr&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;demo&quot;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">except</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">pass</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># è€ƒè™‘æ¼”ç¤ºè¿è¡Œé€Ÿåº¦ï¼Œåªä¸Šä¼ å‰50æ¡æ•°æ®</span></span>
<span class="line"><span class="token keyword">for</span> item <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    langfuse<span class="token punctuation">.</span>create_dataset_item<span class="token punctuation">(</span></span>
<span class="line">        dataset_name<span class="token operator">=</span><span class="token string">&quot;my-dataset&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token builtin">input</span><span class="token operator">=</span>item<span class="token punctuation">[</span><span class="token string">&quot;input&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">        expected_output<span class="token operator">=</span>item<span class="token punctuation">[</span><span class="token string">&quot;expected_output&quot;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 50/50 [00:11&lt;00:00,  4.48it/s]</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_1-4-3ã€å®šä¹‰è¯„ä¼°å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#_1-4-3ã€å®šä¹‰è¯„ä¼°å‡½æ•°"><span>1.4.3ã€å®šä¹‰è¯„ä¼°å‡½æ•°</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">simple_evaluation</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> expected_output<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">return</span> output <span class="token operator">==</span> expected_output</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-4-4ã€è¿è¡Œæµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#_1-4-4ã€è¿è¡Œæµ‹è¯•"><span>1.4.4ã€è¿è¡Œæµ‹è¯•</span></a></h3><p>Prompt æ¨¡æ¿ä¸ Chainï¼ˆLCELï¼‰</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>prompts <span class="token keyword">import</span> PromptTemplate</span>
<span class="line"><span class="token keyword">from</span> langchain_openai <span class="token keyword">import</span> ChatOpenAI</span>
<span class="line"><span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>output_parsers <span class="token keyword">import</span> StrOutputParser</span>
<span class="line"></span>
<span class="line">need_answer <span class="token operator">=</span> PromptTemplate<span class="token punctuation">.</span>from_template<span class="token punctuation">(</span><span class="token triple-quoted-string string">&quot;&quot;&quot;</span>
<span class="line">*********</span>
<span class="line">ä½ æ˜¯AIGCè¯¾ç¨‹çš„åŠ©æ•™ï¼Œä½ çš„å·¥ä½œæ˜¯ä»å­¦å‘˜çš„è¯¾å ‚äº¤æµä¸­é€‰æ‹©å‡ºéœ€è¦è€å¸ˆå›ç­”çš„é—®é¢˜ï¼ŒåŠ ä»¥æ•´ç†ä»¥äº¤ç»™è€å¸ˆå›ç­”ã€‚</span>
<span class="line"> </span>
<span class="line">è¯¾ç¨‹å†…å®¹:</span>
<span class="line">{outlines}</span>
<span class="line">*********</span>
<span class="line">å­¦å‘˜è¾“å…¥:</span>
<span class="line">{user_input}</span>
<span class="line">*********</span>
<span class="line">å¦‚æœè¿™æ˜¯ä¸€ä¸ªéœ€è¦è€å¸ˆç­”ç–‘çš„é—®é¢˜ï¼Œå›å¤Yï¼Œå¦åˆ™å›å¤Nã€‚</span>
<span class="line">åªå›å¤Yæˆ–Nï¼Œä¸è¦å›å¤å…¶ä»–å†…å®¹ã€‚&quot;&quot;&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">model <span class="token operator">=</span> ChatOpenAI<span class="token punctuation">(</span>temperature<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> seed<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span></span>
<span class="line">parser <span class="token operator">=</span> StrOutputParser<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">chain_v1 <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">    need_answer</span>
<span class="line">    <span class="token operator">|</span> model</span>
<span class="line">    <span class="token operator">|</span> parser</span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨æ•°æ®é›†ä¸Šæµ‹è¯•æ•ˆæœ</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">import</span> ThreadPoolExecutor</span>
<span class="line"><span class="token keyword">import</span> threading</span>
<span class="line"><span class="token keyword">from</span> langfuse <span class="token keyword">import</span> Langfuse</span>
<span class="line"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime</span>
<span class="line"></span>
<span class="line">langfuse <span class="token operator">=</span> Langfuse<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">lock <span class="token operator">=</span> threading<span class="token punctuation">.</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">run_evaluation</span><span class="token punctuation">(</span>chain<span class="token punctuation">,</span> dataset_name<span class="token punctuation">,</span> run_name<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    dataset <span class="token operator">=</span> langfuse<span class="token punctuation">.</span>get_dataset<span class="token punctuation">(</span>dataset_name<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">process_item</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">with</span> lock<span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># æ³¨æ„ï¼šå¤šçº¿ç¨‹è°ƒç”¨æ­¤å¤„è¦åŠ é”ï¼Œå¦åˆ™ä¼šæœ‰idå†²çªå¯¼è‡´ä¸¢æ•°æ®</span></span>
<span class="line">            handler <span class="token operator">=</span> item<span class="token punctuation">.</span>get_langchain_handler<span class="token punctuation">(</span>run_name<span class="token operator">=</span>run_name<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># Assuming chain.invoke is a synchronous function</span></span>
<span class="line">        output <span class="token operator">=</span> chain<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">,</span> config<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;callbacks&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>handler<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># Assuming handler.root_span.score is a synchronous function</span></span>
<span class="line">        handler<span class="token punctuation">.</span>trace<span class="token punctuation">.</span>score<span class="token punctuation">(</span></span>
<span class="line">            name<span class="token operator">=</span><span class="token string">&quot;accuracy&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            value<span class="token operator">=</span>simple_evaluation<span class="token punctuation">(</span>output<span class="token punctuation">,</span> item<span class="token punctuation">.</span>expected_output<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;.&#39;</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">,</span> flush<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># for item in dataset.items:</span></span>
<span class="line">    <span class="token comment">#    process_item(item)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">with</span> ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span></span>
<span class="line">        executor<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>process_item<span class="token punctuation">,</span> dataset<span class="token punctuation">.</span>items<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">run_evaluation<span class="token punctuation">(</span>chain_v1<span class="token punctuation">,</span> <span class="token string">&quot;my-dataset&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;v1-&quot;</span><span class="token operator">+</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">&quot;%d/%m/%Y %H:%M:%S&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ä¿è¯å…¨éƒ¨æ•°æ®åŒæ­¥åˆ°äº‘ç«¯</span></span>
<span class="line">langfuse_context<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">..................................................</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_1-4-5ã€prompt-è°ƒä¼˜ä¸å›å½’æµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#_1-4-5ã€prompt-è°ƒä¼˜ä¸å›å½’æµ‹è¯•"><span>1.4.5ã€Prompt è°ƒä¼˜ä¸å›å½’æµ‹è¯•</span></a></h3><p>ä¼˜åŒ– Promptï¼šè¯•è¯•æ€ç»´é“¾ï¼ˆå›å¿†<a href="../02-prompt/index.ipynb">ç¬¬äºŒè¯¾</a>ï¼‰</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>prompts <span class="token keyword">import</span> PromptTemplate</span>
<span class="line"></span>
<span class="line">need_answer <span class="token operator">=</span> PromptTemplate<span class="token punctuation">.</span>from_template<span class="token punctuation">(</span><span class="token triple-quoted-string string">&quot;&quot;&quot;</span>
<span class="line">*********</span>
<span class="line">ä½ æ˜¯AIGCè¯¾ç¨‹çš„åŠ©æ•™ï¼Œä½ çš„å·¥ä½œæ˜¯ä»å­¦å‘˜çš„è¯¾å ‚äº¤æµä¸­é€‰æ‹©å‡ºéœ€è¦è€å¸ˆå›ç­”çš„é—®é¢˜ï¼ŒåŠ ä»¥æ•´ç†ä»¥äº¤ç»™è€å¸ˆå›ç­”ã€‚</span>
<span class="line"></span>
<span class="line">ä½ çš„é€‰æ‹©éœ€è¦éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š</span>
<span class="line">1 éœ€è¦è€å¸ˆå›ç­”çš„é—®é¢˜æ˜¯æŒ‡ä¸è¯¾ç¨‹å†…å®¹æˆ–AI/LLMç›¸å…³çš„æŠ€æœ¯é—®é¢˜ï¼›</span>
<span class="line">2 è¯„è®ºæ€§çš„è§‚ç‚¹ã€é—²èŠã€è¡¨è¾¾æ¨¡ç³Šä¸æ¸…çš„å¥å­ï¼Œä¸éœ€è¦è€å¸ˆå›ç­”ï¼›</span>
<span class="line">3 å­¦ç”Ÿè¾“å…¥ä¸æ„æˆç–‘é—®å¥çš„ï¼Œä¸éœ€è¦è€å¸ˆå›ç­”ï¼›</span>
<span class="line">4 å­¦ç”Ÿé—®é¢˜ä¸­å¦‚æœç”¨â€œè¿™â€ã€â€œé‚£â€ç­‰ä»£è¯æŒ‡ä»£ï¼Œä¸ç®—è¡¨è¾¾æ¨¡ç³Šä¸æ¸…ï¼Œè¯·æ ¹æ®é—®é¢˜å†…å®¹åˆ¤æ–­æ˜¯å¦éœ€è¦è€å¸ˆå›ç­”ã€‚</span>
<span class="line"> </span>
<span class="line">è¯¾ç¨‹å†…å®¹:</span>
<span class="line">{outlines}</span>
<span class="line">*********</span>
<span class="line">å­¦å‘˜è¾“å…¥:</span>
<span class="line">{user_input}</span>
<span class="line">*********</span>
<span class="line">Analyse the student&#39;s input according to the lecture&#39;s contents and your criteria.</span>
<span class="line">Output your analysis process step by step.</span>
<span class="line">Finally, output a single letter Y or N in a separate line.</span>
<span class="line">Y means that the input needs to be answered by the teacher.</span>
<span class="line">N means that the input does not needs to be answered by the teacher.&quot;&quot;&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>output_parsers <span class="token keyword">import</span> BaseOutputParser</span>
<span class="line"><span class="token keyword">import</span> re</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">MyOutputParser</span><span class="token punctuation">(</span>BaseOutputParser<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;è‡ªå®šä¹‰parserï¼Œä»æ€ç»´é“¾ä¸­å–å‡ºæœ€åçš„Y/N&quot;&quot;&quot;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span></span>
<span class="line">        matches <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">r&#39;[YN]&#39;</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> matches<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">if</span> matches <span class="token keyword">else</span> <span class="token string">&#39;N&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">chain_v2 <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">    need_answer</span>
<span class="line">    <span class="token operator">|</span> model</span>
<span class="line">    <span class="token operator">|</span> MyOutputParser<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å›å½’æµ‹è¯•</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">run_evaluation<span class="token punctuation">(</span>chain_v2<span class="token punctuation">,</span> <span class="token string">&quot;my-dataset&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;cot-&quot;</span><span class="token operator">+</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">&quot;%d/%m/%Y %H:%M:%S&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ä¿è¯å…¨éƒ¨æ•°æ®åŒæ­¥åˆ°äº‘ç«¯</span></span>
<span class="line">langfuse_context<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">..................................................</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_1-5ã€prompt-ç‰ˆæœ¬ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#_1-5ã€prompt-ç‰ˆæœ¬ç®¡ç†"><span>1.5ã€Prompt ç‰ˆæœ¬ç®¡ç†</span></a></h3><p><img src="/wiki/assets/img/prompt_management.f0fe2660.png" alt="image"></p><p>ç›®å‰åªæ”¯æŒ Langfuse è‡ªå·±çš„ SDK</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> langfuse <span class="token keyword">import</span> Langfuse</span>
<span class="line"></span>
<span class="line">langfuse <span class="token operator">=</span> Langfuse<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŒ‰åç§°åŠ è½½</span></span>
<span class="line">prompt <span class="token operator">=</span> langfuse<span class="token punctuation">.</span>get_prompt<span class="token punctuation">(</span><span class="token string">&quot;need_answer_v1&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŒ‰åç§°å’Œç‰ˆæœ¬å·åŠ è½½</span></span>
<span class="line">prompt <span class="token operator">=</span> langfuse<span class="token punctuation">.</span>get_prompt<span class="token punctuation">(</span><span class="token string">&quot;need_answer_v1&quot;</span><span class="token punctuation">,</span> version<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># å¯¹æ¨¡æ¿ä¸­çš„å˜é‡èµ‹å€¼</span></span>
<span class="line">compiled_prompt <span class="token operator">=</span> prompt<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token operator">=</span><span class="token string">&quot;è€å¸ˆå¥½&quot;</span><span class="token punctuation">,</span> outlines<span class="token operator">=</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>compiled_prompt<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">*********</span>
<span class="line">ä½ æ˜¯AIGCè¯¾ç¨‹çš„åŠ©æ•™ï¼Œä½ çš„å·¥ä½œæ˜¯ä»å­¦å‘˜çš„è¯¾å ‚äº¤æµä¸­é€‰æ‹©å‡ºéœ€è¦è€å¸ˆå›ç­”çš„é—®é¢˜ï¼ŒåŠ ä»¥æ•´ç†ä»¥äº¤ç»™è€å¸ˆå›ç­”ã€‚</span>
<span class="line"> </span>
<span class="line">è¯¾ç¨‹å†…å®¹:</span>
<span class="line">test</span>
<span class="line">*********</span>
<span class="line">å­¦å‘˜è¾“å…¥:</span>
<span class="line">è€å¸ˆå¥½</span>
<span class="line">*********</span>
<span class="line">å¦‚æœè¿™æ˜¯ä¸€ä¸ªéœ€è¦è€å¸ˆç­”ç–‘çš„é—®é¢˜ï¼Œå›å¤Yï¼Œå¦åˆ™å›å¤Nã€‚</span>
<span class="line">åªå›å¤Yæˆ–Nï¼Œä¸è¦å›å¤å…¶ä»–å†…å®¹ã€‚</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># è·å– config</span></span>
<span class="line"></span>
<span class="line">prompt <span class="token operator">=</span> langfuse<span class="token punctuation">.</span>get_prompt<span class="token punctuation">(</span><span class="token string">&quot;need_answer_v1&quot;</span><span class="token punctuation">,</span> version<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>prompt<span class="token punctuation">.</span>config<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">{&#39;temperature&#39;: 0}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_1-6ã€å¦‚ä½•æ¯”è¾ƒä¸¤ä¸ªå¥å­çš„ç›¸ä¼¼æ€§-ä¸€äº›ç»å…¸-nlp-çš„è¯„æµ‹æ–¹æ³•-é€‰" tabindex="-1"><a class="header-anchor" href="#_1-6ã€å¦‚ä½•æ¯”è¾ƒä¸¤ä¸ªå¥å­çš„ç›¸ä¼¼æ€§-ä¸€äº›ç»å…¸-nlp-çš„è¯„æµ‹æ–¹æ³•-é€‰"><span>1.6ã€å¦‚ä½•æ¯”è¾ƒä¸¤ä¸ªå¥å­çš„ç›¸ä¼¼æ€§ï¼šä¸€äº›ç»å…¸ NLP çš„è¯„æµ‹æ–¹æ³•ï¼ˆé€‰ï¼‰</span></a></h3><ol><li><strong>ç¼–è¾‘è·ç¦»</strong>ï¼šä¹Ÿå«è±æ–‡æ–¯å¦è·ç¦»(Levenshtein),æ˜¯é’ˆå¯¹äºŒä¸ªå­—ç¬¦ä¸²çš„å·®å¼‚ç¨‹åº¦çš„é‡åŒ–é‡æµ‹ï¼Œé‡æµ‹æ–¹å¼æ˜¯çœ‹è‡³å°‘éœ€è¦å¤šå°‘æ¬¡çš„å¤„ç†æ‰èƒ½å°†ä¸€ä¸ªå­—ç¬¦ä¸²å˜æˆå¦ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚ <ul><li>å…·ä½“è®¡ç®—è¿‡ç¨‹æ˜¯ä¸€ä¸ªåŠ¨æ€è§„åˆ’ç®—æ³•ï¼šhttps://zhuanlan.zhihu.com/p/164599274</li><li>è¡¡é‡ä¸¤ä¸ªå¥å­çš„ç›¸ä¼¼åº¦æ—¶ï¼Œå¯ä»¥ä»¥è¯ä¸ºå•ä½è®¡ç®—</li></ul></li><li><strong>BLEU Score</strong>: <ul><li>è®¡ç®—è¾“å‡ºä¸å‚ç…§å¥ä¹‹é—´çš„ n-gram å‡†ç¡®ç‡ï¼ˆn=1...4ï¼‰</li><li>å¯¹çŸ­è¾“å‡ºåšæƒ©ç½š</li><li>åœ¨æ•´ä¸ªæµ‹è¯•é›†ä¸Šå¹³å‡ä¸‹è¿°å€¼</li><li>å®Œæ•´è®¡ç®—å…¬å¼ï¼š$\mathrm{BLEU}<em>4=\min\left(1,\frac{output-length}{reference-length}\right)\left(\prod</em>{i=1}^4 precision_i\right)^{\frac{1}{4}}$</li><li>å‡½æ•°åº“ï¼šhttps://www.nltk.org/_modules/nltk/translate/bleu_score.html</li></ul></li><li><strong>Rouge Score</strong>: <ul><li>Rouge-Nï¼šå°†æ¨¡å‹ç”Ÿæˆçš„ç»“æœå’Œæ ‡å‡†ç»“æœæŒ‰ N-gram æ‹†åˆ†åï¼Œåªè®¡ç®—å¬å›ç‡ï¼›</li><li>Rouge-L: åˆ©ç”¨äº†æœ€é•¿å…¬å…±å­åºåˆ—ï¼ˆLongest Common Sequenceï¼‰ï¼Œè®¡ç®—ï¼š$P=\frac{LCS(c,r)}{len(c)}$, $R=\frac{LCS(c,r)}{len(r)}$, $F=\frac{(1+\beta^2)PR}{R+\beta^2P}$</li><li>å‡½æ•°åº“ï¼šhttps://pypi.org/project/rouge-score/</li><li>å¯¹æ¯” BLEU ä¸ ROUGEï¼š <ul><li>BLEU èƒ½è¯„ä¼°æµç•…åº¦ï¼Œä½†æŒ‡æ ‡åå‘äºè¾ƒçŸ­çš„ç¿»è¯‘ç»“æœï¼ˆbrevity penalty æ²¡æœ‰æƒ³è±¡ä¸­é‚£ä¹ˆå¼ºï¼‰</li><li>ROUGE ä¸ç®¡æµç•…åº¦ï¼Œæ‰€ä»¥åªé€‚åˆæ·±åº¦å­¦ä¹ çš„ç”Ÿæˆæ¨¡å‹ï¼šç»“æœéƒ½æ˜¯æµç•…çš„å‰æä¸‹ï¼ŒROUGE ååº”å‚ç…§å¥ä¸­å¤šå°‘å†…å®¹è¢«ç”Ÿæˆçš„å¥å­åŒ…å«ï¼ˆå¬å›ï¼‰</li></ul></li></ul></li><li><strong>METEOR</strong>: å¦ä¸€ä¸ªä»æœºå™¨ç¿»è¯‘é¢†åŸŸå€Ÿé‰´çš„æŒ‡æ ‡ã€‚ä¸ BLEU ç›¸æ¯”ï¼ŒMETEOR è€ƒè™‘äº†æ›´å¤šçš„å› ç´ ï¼Œå¦‚åŒä¹‰è¯åŒ¹é…ã€è¯å¹²åŒ¹é…ã€è¯åºç­‰ï¼Œå› æ­¤å®ƒé€šå¸¸è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªæ›´å…¨é¢çš„è¯„ä»·æŒ‡æ ‡ã€‚ <ul><li>å¯¹è¯­è¨€å­¦å’Œè¯­ä¹‰è¯è¡¨æœ‰ä¾èµ–ï¼Œæ‰€ä»¥å¯¹è¯­è¨€ä¾èµ–å¼ºã€‚</li></ul></li></ol><blockquote><p>âœ… <strong>Tip:</strong> åˆ’é‡ç‚¹ï¼šæ­¤ç±»æ–¹æ³•å¸¸ç”¨äºå¯¹æ–‡æœ¬ç”Ÿæˆæ¨¡å‹çš„è‡ªåŠ¨åŒ–è¯„ä¼°ã€‚å®é™…ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸æ›´å…³æ³¨ç›¸å¯¹å˜åŒ–è€Œä¸æ˜¯ç»å¯¹å€¼ï¼ˆè°ƒä¼˜è¿‡ç¨‹ä¸­æŒ‡æ ‡æ˜¯ä¸æ˜¯åœ¨å˜å¥½ï¼‰ã€‚</p></blockquote><h3 id="_1-7ã€åŸºäº-llm-çš„æµ‹è¯•æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#_1-7ã€åŸºäº-llm-çš„æµ‹è¯•æ–¹æ³•"><span>1.7ã€åŸºäº LLM çš„æµ‹è¯•æ–¹æ³•</span></a></h3><p>LangFuse æä¾›äº†åŸºäº LLM å’Œ Prompt çš„è‡ªåŠ¨æµ‹è¯•å·¥å…·ã€‚</p><p>å…·ä½“å‚è€ƒï¼šhttps://langfuse.com/docs/scores/model-based-evals</p><blockquote><p>âœ… <strong>Tip:</strong> åˆ’é‡ç‚¹ï¼šæ­¤ç±»æ–¹æ³•ï¼Œå¯¹äºç”¨äºè¯„ä¼°çš„ LLM è‡ªèº«èƒ½åŠ›æœ‰è¦æ±‚ã€‚éœ€æ ¹æ®å…·ä½“æƒ…å†µé€‰æ‹©ä½¿ç”¨ã€‚</p></blockquote><h3 id="_1-8ã€ä¸-llamaindex-é›†æˆ" tabindex="-1"><a class="header-anchor" href="#_1-8ã€ä¸-llamaindex-é›†æˆ"><span>1.8ã€ä¸ LlamaIndex é›†æˆ</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># !pip install --upgrade llama-index</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> llama_index<span class="token punctuation">.</span>core <span class="token keyword">import</span> Settings</span>
<span class="line"><span class="token keyword">from</span> llama_index<span class="token punctuation">.</span>core<span class="token punctuation">.</span>callbacks <span class="token keyword">import</span> CallbackManager</span>
<span class="line"><span class="token keyword">from</span> langfuse<span class="token punctuation">.</span>llama_index <span class="token keyword">import</span> LlamaIndexCallbackHandler</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å®šä¹‰ LangFuse çš„ CallbackHandler</span></span>
<span class="line">langfuse_callback_handler <span class="token operator">=</span> LlamaIndexCallbackHandler<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ä¿®æ”¹ LlamaIndex çš„å…¨å±€è®¾å®š</span></span>
<span class="line">Settings<span class="token punctuation">.</span>callback_manager <span class="token operator">=</span> CallbackManager<span class="token punctuation">(</span><span class="token punctuation">[</span>langfuse_callback_handler<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> llama_index<span class="token punctuation">.</span>core <span class="token keyword">import</span> VectorStoreIndex<span class="token punctuation">,</span> SimpleDirectoryReader</span>
<span class="line"><span class="token keyword">from</span> llama_index<span class="token punctuation">.</span>core<span class="token punctuation">.</span>node_parser <span class="token keyword">import</span> SentenceSplitter</span>
<span class="line"><span class="token keyword">from</span> llama_index<span class="token punctuation">.</span>readers<span class="token punctuation">.</span><span class="token builtin">file</span> <span class="token keyword">import</span> PyMuPDFReader</span>
<span class="line"><span class="token keyword">from</span> llama_index<span class="token punctuation">.</span>core <span class="token keyword">import</span> Settings</span>
<span class="line"><span class="token keyword">from</span> llama_index<span class="token punctuation">.</span>llms<span class="token punctuation">.</span>openai <span class="token keyword">import</span> OpenAI</span>
<span class="line"><span class="token keyword">from</span> llama_index<span class="token punctuation">.</span>embeddings<span class="token punctuation">.</span>openai <span class="token keyword">import</span> OpenAIEmbedding</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŒ‡å®šå…¨å±€llmä¸embeddingæ¨¡å‹</span></span>
<span class="line">Settings<span class="token punctuation">.</span>llm <span class="token operator">=</span> OpenAI<span class="token punctuation">(</span>temperature<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> model<span class="token operator">=</span><span class="token string">&quot;gpt-4o&quot;</span><span class="token punctuation">)</span></span>
<span class="line">Settings<span class="token punctuation">.</span>embed_model <span class="token operator">=</span> OpenAIEmbedding<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">&quot;text-embedding-3-small&quot;</span><span class="token punctuation">,</span> dimensions<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">)</span></span>
<span class="line">Settings<span class="token punctuation">.</span>transforms <span class="token operator">=</span> <span class="token punctuation">[</span>SentenceSplitter<span class="token punctuation">(</span>chunk_size<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">,</span> chunk_overlap<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># åŠ è½½ pdf æ–‡æ¡£</span></span>
<span class="line">documents <span class="token operator">=</span> SimpleDirectoryReader<span class="token punctuation">(</span><span class="token string">&quot;./data&quot;</span><span class="token punctuation">,</span> file_extractor<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;.pdf&quot;</span><span class="token punctuation">:</span> PyMuPDFReader<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>load_data<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŒ‡å®š Vector Store ç”¨äº index</span></span>
<span class="line">index <span class="token operator">=</span> VectorStoreIndex<span class="token punctuation">.</span>from_documents<span class="token punctuation">(</span>documents<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ„å»ºå•è½® query engine</span></span>
<span class="line">query_engine <span class="token operator">=</span> index<span class="token punctuation">.</span>as_query_engine<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">response <span class="token operator">=</span> query_engine<span class="token punctuation">.</span>query<span class="token punctuation">(</span><span class="token string">&quot;llama2æœ‰å¤šå°‘å‚æ•°&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">Llama 2 æœ‰ 7Bã€13B å’Œ 70B å‚æ•°çš„å˜ä½“ã€‚</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>è‡ªå®šä¹‰ Trace å‚æ•°</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">langfuse_callback_handler<span class="token punctuation">.</span>set_trace_params<span class="token punctuation">(</span></span>
<span class="line">    user_id<span class="token operator">=</span><span class="token string">&quot;wzr&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    session_id<span class="token operator">=</span><span class="token string">&quot;llamaindex-session&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    tags<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;demo&quot;</span><span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">response <span class="token operator">=</span> query_engine<span class="token punctuation">.</span>query<span class="token punctuation">(</span><span class="token string">&quot;llama2å®‰å…¨å—&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">Llama 2 æ˜¯ä¸€ç§æ–°æŠ€æœ¯ï¼Œå…·æœ‰æ½œåœ¨çš„ä½¿ç”¨é£é™©ã€‚å°½ç®¡è¿›è¡Œäº†å®‰å…¨æ€§è¯„ä¼°ï¼Œä½†ç”±äºæç¤ºé›†çš„å±€é™æ€§ã€å®¡æŸ¥æŒ‡å—çš„ä¸»è§‚æ€§ä»¥åŠè¯„ä¼°è€…çš„ä¸»è§‚æ€§ï¼Œè¿™äº›è¯„ä¼°å¯èƒ½å­˜åœ¨åè§ã€‚å› æ­¤ï¼Œåœ¨éƒ¨ç½² Llama 2-Chat çš„åº”ç”¨ç¨‹åºä¹‹å‰ï¼Œå¼€å‘äººå‘˜åº”è¿›è¡Œé’ˆå¯¹å…¶ç‰¹å®šåº”ç”¨ç¨‹åºçš„å®‰å…¨æµ‹è¯•å’Œè°ƒæ•´ã€‚</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>æ›´å¤šæ¥å£ä¸å‚æ•°ï¼Œè¯·å‚è€ƒ<a href="https://langfuse.com/docs/integrations/llama-index/get-started" target="_blank" rel="noopener noreferrer">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p><h2 id="_2ã€langsmith" tabindex="-1"><a class="header-anchor" href="#_2ã€langsmith"><span>2ã€LangSmith</span></a></h2><blockquote><p>âš ï¸ <strong>Note:</strong> è¿è¡Œä»¥ä¸‹ä»£ç å‰ï¼Œè¯·å…ˆé‡å¯ä¸€ä¸‹ kernelï¼Œä»¥é‡ç½®æ‰€æœ‰é…ç½®ã€‚</p></blockquote><p><img src="/wiki/assets/img/tips.0f182de9.png" alt="image"></p><p>LangChain å®˜æ–¹çš„ SaaS æœåŠ¡ï¼Œä¸å¼€æºã€‚</p><p>å¹³å°å…¥å£ï¼šhttps://www.langchain.com/langsmith</p><p>æ–‡æ¡£åœ°å€ï¼šhttps://python.langchain.com/docs/langsmith/walkthrough</p><p>å°†ä½ çš„ LangChain åº”ç”¨ä¸ LangSmith é“¾æ¥ï¼Œéœ€è¦ï¼š</p><ol><li>å®‰è£… LangSmith</li></ol><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># %pip install --upgrade langsmith</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ol start="2"><li>æ³¨å†Œè´¦å·ï¼Œå¹¶ç”³è¯·ä¸€ä¸ª<code>LANGCHAIN_API_KEY</code></li><li>åœ¨ç¯å¢ƒå˜é‡ä¸­è®¾ç½®ä»¥ä¸‹å€¼</li></ol><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token builtin class-name">export</span> <span class="token assign-left variable">LANGCHAIN_TRACING_V2</span><span class="token operator">=</span>true</span>
<span class="line"><span class="token builtin class-name">export</span> <span class="token assign-left variable">LANGCHAIN_PROJECT</span><span class="token operator">=</span>YOUR_PROJECT_NAME <span class="token comment">#è‡ªå®šä¹‰é¡¹ç›®åç§°ï¼ˆå¯é€‰ï¼‰</span></span>
<span class="line"><span class="token builtin class-name">export</span> <span class="token assign-left variable">LANGCHAIN_API_KEY</span><span class="token operator">=</span>LANGCHAIN_API_KEY <span class="token comment"># LangChain API Key</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>ç¨‹åºä¸­çš„è°ƒç”¨å°†è‡ªåŠ¨è¢«è®°å½•</li></ol><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> os</span>
<span class="line"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime</span>
<span class="line">os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">&quot;LANGCHAIN_TRACING_V2&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span></span>
<span class="line">os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">&quot;LANGCHAIN_PROJECT&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;HelloWorld-Demo&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-1ã€åŸºæœ¬åŠŸèƒ½æ¼”ç¤º" tabindex="-1"><a class="header-anchor" href="#_2-1ã€åŸºæœ¬åŠŸèƒ½æ¼”ç¤º"><span>2.1ã€åŸºæœ¬åŠŸèƒ½æ¼”ç¤º</span></a></h3><ol><li>Traces</li><li>LLM Calls</li><li>Monitor</li><li>Playground</li></ol><p><img src="/wiki/assets/img/langsmith-example.4d65d855.png" alt="image"></p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>prompts <span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    ChatPromptTemplate<span class="token punctuation">,</span></span>
<span class="line">    HumanMessagePromptTemplate<span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>output_parsers <span class="token keyword">import</span> StrOutputParser</span>
<span class="line"><span class="token keyword">from</span> langchain_openai <span class="token keyword">import</span> ChatOpenAI</span>
<span class="line"><span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>runnables <span class="token keyword">import</span> RunnablePassthrough</span>
<span class="line"></span>
<span class="line">model <span class="token operator">=</span> ChatOpenAI<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">&quot;gpt-3.5-turbo&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">prompt <span class="token operator">=</span> ChatPromptTemplate<span class="token punctuation">.</span>from_messages<span class="token punctuation">(</span><span class="token punctuation">[</span></span>
<span class="line">    HumanMessagePromptTemplate<span class="token punctuation">.</span>from_template<span class="token punctuation">(</span><span class="token string">&quot;Say hello to {input}!&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment"># å®šä¹‰è¾“å‡ºè§£æå™¨</span></span>
<span class="line">parser <span class="token operator">=</span> StrOutputParser<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">chain <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token punctuation">{</span><span class="token string">&quot;input&quot;</span><span class="token punctuation">:</span> RunnablePassthrough<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token operator">|</span> prompt</span>
<span class="line">    <span class="token operator">|</span> model</span>
<span class="line">    <span class="token operator">|</span> parser</span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">chain<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span><span class="token string">&quot;ç‹å“ç„¶&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">&#39;Hello ç‹å“ç„¶! Nice to meet you!&#39;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_2-2ã€æ•°æ®é›†ç®¡ç†ä¸æµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#_2-2ã€æ•°æ®é›†ç®¡ç†ä¸æµ‹è¯•"><span>2.2ã€æ•°æ®é›†ç®¡ç†ä¸æµ‹è¯•</span></a></h3><h3 id="_2-2-1ã€åœ¨çº¿æ ‡æ³¨æ¼”ç¤º" tabindex="-1"><a class="header-anchor" href="#_2-2-1ã€åœ¨çº¿æ ‡æ³¨æ¼”ç¤º"><span>2.2.1ã€åœ¨çº¿æ ‡æ³¨æ¼”ç¤º</span></a></h3><p><img src="/wiki/assets/img/langsmith-annotation.7e2fce51.png" alt="image"></p><h3 id="_2-2-2ã€ä¸Šä¼ æ•°æ®é›†" tabindex="-1"><a class="header-anchor" href="#_2-2-2ã€ä¸Šä¼ æ•°æ®é›†"><span>2.2.2ã€ä¸Šä¼ æ•°æ®é›†</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> json</span>
<span class="line"></span>
<span class="line">data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&#39;my_annotations.jsonl&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;r&#39;</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">for</span> line <span class="token keyword">in</span> fp<span class="token punctuation">:</span></span>
<span class="line">        example <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        item <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&quot;input&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">&quot;outlines&quot;</span><span class="token punctuation">:</span> example<span class="token punctuation">[</span><span class="token string">&quot;outlines&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;user_input&quot;</span><span class="token punctuation">:</span> example<span class="token punctuation">[</span><span class="token string">&quot;user_input&quot;</span><span class="token punctuation">]</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;expected_output&quot;</span><span class="token punctuation">:</span> example<span class="token punctuation">[</span><span class="token string">&quot;label&quot;</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        data<span class="token punctuation">.</span>append<span class="token punctuation">(</span>item<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> langsmith <span class="token keyword">import</span> Client</span>
<span class="line"></span>
<span class="line">client <span class="token operator">=</span> Client<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">dataset_name <span class="token operator">=</span> <span class="token string">&quot;Assistant-&quot;</span><span class="token operator">+</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">&quot;%d/%m/%Y %H:%M:%S&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">dataset <span class="token operator">=</span> client<span class="token punctuation">.</span>create_dataset<span class="token punctuation">(</span></span>
<span class="line">    dataset_name<span class="token punctuation">,</span>  <span class="token comment"># æ•°æ®é›†åç§°</span></span>
<span class="line">    description<span class="token operator">=</span><span class="token string">&quot;AGIClassçº¿ä¸Šè·Ÿè¯¾åŠ©æ‰‹çš„æ ‡æ³¨æ•°æ®&quot;</span><span class="token punctuation">,</span>  <span class="token comment"># æ•°æ®é›†æè¿°</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">inputs<span class="token punctuation">,</span> outputs <span class="token operator">=</span> <span class="token builtin">zip</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;input&quot;</span><span class="token punctuation">:</span> item<span class="token punctuation">[</span><span class="token string">&quot;input&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">&quot;label&quot;</span><span class="token punctuation">:</span> item<span class="token punctuation">[</span><span class="token string">&quot;expected_output&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">for</span> item <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line">client<span class="token punctuation">.</span>create_examples<span class="token punctuation">(</span>inputs<span class="token operator">=</span>inputs<span class="token punctuation">,</span> outputs<span class="token operator">=</span>outputs<span class="token punctuation">,</span> dataset_id<span class="token operator">=</span>dataset<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-3ã€è¯„ä¼°å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#_2-2-3ã€è¯„ä¼°å‡½æ•°"><span>2.2.3ã€è¯„ä¼°å‡½æ•°</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> langsmith<span class="token punctuation">.</span>schemas <span class="token keyword">import</span> Example<span class="token punctuation">,</span> Run</span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">correct_label</span><span class="token punctuation">(</span>root_run<span class="token punctuation">:</span> Run<span class="token punctuation">,</span> example<span class="token punctuation">:</span> Example<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span></span>
<span class="line">    score <span class="token operator">=</span> root_run<span class="token punctuation">.</span>outputs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;output&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> example<span class="token punctuation">.</span>outputs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;label&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&quot;score&quot;</span><span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;key&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;accuracy&quot;</span><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-4ã€è¿è¡Œæµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#_2-2-4ã€è¿è¡Œæµ‹è¯•"><span>2.2.4ã€è¿è¡Œæµ‹è¯•</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>prompts <span class="token keyword">import</span> PromptTemplate</span>
<span class="line"><span class="token keyword">from</span> langchain_openai <span class="token keyword">import</span> ChatOpenAI</span>
<span class="line"><span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>output_parsers <span class="token keyword">import</span> StrOutputParser </span>
<span class="line"></span>
<span class="line">need_answer <span class="token operator">=</span> PromptTemplate<span class="token punctuation">.</span>from_template<span class="token punctuation">(</span><span class="token triple-quoted-string string">&quot;&quot;&quot;</span>
<span class="line">*********</span>
<span class="line">ä½ æ˜¯AIGCè¯¾ç¨‹çš„åŠ©æ•™ï¼Œä½ çš„å·¥ä½œæ˜¯ä»å­¦å‘˜çš„è¯¾å ‚äº¤æµä¸­é€‰æ‹©å‡ºéœ€è¦è€å¸ˆå›ç­”çš„é—®é¢˜ï¼ŒåŠ ä»¥æ•´ç†ä»¥äº¤ç»™è€å¸ˆå›ç­”ã€‚</span>
<span class="line"> </span>
<span class="line">è¯¾ç¨‹å†…å®¹:</span>
<span class="line">{outlines}</span>
<span class="line">*********</span>
<span class="line">å­¦å‘˜è¾“å…¥:</span>
<span class="line">{user_input}</span>
<span class="line">*********</span>
<span class="line">å¦‚æœè¿™æ˜¯ä¸€ä¸ªéœ€è¦è€å¸ˆç­”ç–‘çš„é—®é¢˜ï¼Œå›å¤Yï¼Œå¦åˆ™å›å¤Nã€‚</span>
<span class="line">åªå›å¤Yæˆ–Nï¼Œä¸è¦å›å¤å…¶ä»–å†…å®¹ã€‚&quot;&quot;&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">model <span class="token operator">=</span> ChatOpenAI<span class="token punctuation">(</span>temperature<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> seed<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span></span>
<span class="line">parser <span class="token operator">=</span> StrOutputParser<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">chain_v1 <span class="token operator">=</span> need_answer <span class="token operator">|</span> model <span class="token operator">|</span> parser</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> langsmith<span class="token punctuation">.</span>evaluation <span class="token keyword">import</span> evaluate</span>
<span class="line"></span>
<span class="line">results <span class="token operator">=</span> evaluate<span class="token punctuation">(</span></span>
<span class="line">    <span class="token keyword">lambda</span> inputs<span class="token punctuation">:</span> chain_v1<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>inputs<span class="token punctuation">[</span><span class="token string">&quot;input&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    data<span class="token operator">=</span>dataset_name<span class="token punctuation">,</span></span>
<span class="line">    evaluators<span class="token operator">=</span><span class="token punctuation">[</span>correct_label<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    experiment_prefix<span class="token operator">=</span><span class="token string">&quot;Acc&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    description<span class="token operator">=</span><span class="token string">&quot;æµ‹è¯•ChainV1&quot;</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Output:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">/opt/conda/lib/python3.11/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html</span>
<span class="line">  from .autonotebook import tqdm as notebook_tqdm</span>
<span class="line">View the evaluation results for experiment: &#39;Acc-a48d31f8&#39; at:</span>
<span class="line">https://smith.langchain.com/o/97b8262a-9ab9-4b43-afeb-21ea05a90ba7/datasets/e7d27b2a-9f6a-4818-a716-14dbd0da3a05/compare?selectedSessions=e068df01-670a-431b-a5ee-3bbe552572a9</span>
<span class="line">50it [00:08,  5.79it/s]</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-5ã€åŸºäº-llm-çš„è¯„ä¼°å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#_2-2-5ã€åŸºäº-llm-çš„è¯„ä¼°å‡½æ•°"><span>2.2.5ã€åŸºäº LLM çš„è¯„ä¼°å‡½æ•°</span></a></h3><p>https://docs.smith.langchain.com/evaluation/faq/evaluator-implementations</p><h2 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“"><span>æ€»ç»“</span></a></h2><p>ç®¡ç†ä¸€ä¸ª LLM åº”ç”¨çš„å…¨ç”Ÿå‘½å‘¨æœŸï¼Œéœ€è¦ç”¨åˆ°ä»¥ä¸‹å·¥å…·ï¼š</p><ol><li>è°ƒè¯• Prompt çš„ Playground</li><li>æµ‹è¯•/éªŒè¯ç³»ç»Ÿçš„ç›¸å…³æŒ‡æ ‡</li><li>æ•°æ®é›†ç®¡ç†</li><li>å„ç§æŒ‡æ ‡ç›‘æ§ä¸ç»Ÿè®¡ï¼šè®¿é—®é‡ã€å“åº”æ—¶é•¿ã€Token è´¹ç­‰ç­‰</li></ol><p>æ ¹æ®è‡ªå·±çš„æŠ€æœ¯æ ˆï¼Œé€‰æ‹©ï¼š</p><ol><li>LangFuseï¼šå¼€æºå¹³å°ï¼Œæ”¯æŒ LangChainã€LlamaIndex å’ŒåŸç”Ÿ OpenAI API</li><li>LangSmith: LangChain çš„åŸå§‹ç®¡ç†å¹³å°</li></ol><h2 id="ä½œä¸š" tabindex="-1"><a class="header-anchor" href="#ä½œä¸š"><span>ä½œä¸š</span></a></h2><p>é€‰æ‹©ä¸€ä¸ªå·¥å…·å¹³å°ï¼Œå¯¹è‡ªå·±ä¹‹å‰å¼€å‘çš„ç³»ç»Ÿæˆ–æ¨¡å‹åšæ‰¹é‡æµ‹è¯•</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><!----><!----></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script src="/wiki/assets/js/runtime~app.2c74ba0d.js" defer></script><script src="/wiki/assets/js/768.e6d4205d.js" defer></script><script src="/wiki/assets/js/app.5b328b55.js" defer></script>
  </body>
</html>
